# file opened: Banco_de_pruebas.asm
   1  0000              ;	9/1/24
   2  0000
   3  0000              	DEVICE ZXSPECTRUM48
   4  0000
   5  0000              ;	Reloj del juego. IM2 *******************************************************************************************************************************************************************
   6  0000              ;
   7  0000              ;	13/08/24
   8  0000              ;
   9  0000              ;
  10  0000
  11  0000              	org $fdff															; (Debajo de la pila).
  12  FDFF
  13  FDFF FC 82        	defw $82fc															; Indica al vector de interrupciones, (IM2), que el clock del programa se encuentra en $82a0.
  14  FE01
  15  FE01              ;
  16  FE01              ;	13/08/24
  17  FE01              ;
  18  FE01              ; 	Constantes del programa.
  19  FE01              ;
  20  FE01
  21  FE01              FRAMES equ $5c78														; Variable de 24 bits. Almacena el nº de cuadros, (frames) que llevamos construidos. Reloj en tiempo real.
  22  FE01              FRAMES_3 equ $5c7a
  23  FE01
  24  FE01              Sprite_vacio equ $eae0													; ($eae0 - $eb10) 48 Bytes de "0".
  25  FE01
  26  FE01              Centro_arriba equ $0160 												; Emplearemos estas constantes en la rutina de `recolocación´ del objeto:_
  27  FE01              Centro_abajo equ $0180 													; _[Comprueba_limite_horizontal]. El byte alto en las dos primeras constantes_
  28  FE01              Centro_izquierda equ $0f 												; _indica el tercio de pantalla, (línea $60 y $80 del 2º tercio de pantalla).
  29  FE01              Centro_derecha equ $10 													; Las constantes (Centro_izquierda) y (Centro_derecha) indican la columna $0f y $10 de pantalla.
  30  FE01
  31  FE01              Almacen_de_movimientos_masticados_Entidad_1 equ $eb20					; $eb20 - $f87b ..... 3419 bytes.
  32  FE01              Almacen_de_movimientos_masticados_Amadeus equ $e000						; ($e000 - $e1e3), 483 bytes. Movimientos masticados de Amadeus.
  33  FE01
  34  FE01              Scanlines_album equ $8000	;	($8000 - $8118) 						; Inicialmente 280 bytes, $118.
  35  FE01              Scanlines_album_2 equ $811a	;    ($811a - $8232)
  36  FE01              Amadeus_scanlines_album equ $8234	;	($8234 - $8256) 				; Inicialmente 34 bytes, $22.
  37  FE01              Amadeus_scanlines_album_2 equ $8258	;	($8258 - $827a)
  38  FE01              Disparos_Amadeus_scanlines_album equ $827c	;	($827c - $8286) 		; Inicialmente 10 bytes, $0a.
  39  FE01              Disparos_Amadeus_scanlines_album_2 equ $8288	;	($8288 - $8292)
  40  FE01              Disparos_Entidades_scanlines_album equ $8294	;	($8294 - $82c6)		; Inicialmente 50 bytes, $32.
  41  FE01              Disparos_Entidades_scanlines_album_2 equ $82c8	;	($82c8 - $82fa)
  42  FE01
  43  FE01
  44  FE01
  45  FE01
  46  FE01              ;																		; Scanlines_album.
  47  FE01
  48  FE01              ;                                                       				; 35 bytes por entidad, (7 entidades).
  49  FE01
  50  FE01              ;																		; 1. 2 Bytes ..... .defw  Puntero_objeto, (mem. address donde se encuentran los .db que forman los distintos sprites).
  51  FE01              ;                                                       				; 2. 1 Byte ..... .db  Indica el nº de scanlines que vamos a imprimir del sprite. Generalmente 16 scanlines.
  52  FE01              ;																		; El nº de scanlines será menor cuando estemos `desapareciendo´ por la parte baja de la pantalla.
  53  FE01              ; 																		; 3. 32 Bytes, (como máximo). Screen mem. address de cada uno de los scanlines que forman el sprite.
  54  FE01
  55  FE01              ;	Reloj del juego. IM2 ---------------------------------------------------------------------------------------------------------------------------------------------------
  56  FE01              ;
  57  FE01              ;	13/08/24
  58  FE01              ;
  59  FE01
  60  FE01              	org $82fc
  61  82FC
  62  82FC F5           	push af
  63  82FD E5           	push hl
  64  82FE
  65  82FE              ;! ------------------- STOP si no hemos terminado de construir el FRAME.
  66  82FE 21 6D 8C     	ld hl,Ctrl_3
  67  8301 CB 46        	bit 0,(hl)
  68  8303 28 FE        	jr z,$
  69  8305              ;! -------------------
  70  8305
  71  8305              ; Shield -----------------------
  72  8305
  73  8305              Temporizacion_shield
  74  8305
  75  8305 21 92 8C     	ld hl,Shield
  76  8308 7E           	ld a,(hl)
  77  8309 A7           	and a
  78  830A 28 1C        	jr z,Incrementa_FRAMES		;	No hay escudo. Se agotó el tiempo Shield.
  79  830C
  80  830C 35           	dec (hl)					;	Decrementa tiempo Shield, (Shield).
  81  830D
  82  830D 23           	inc hl
  83  830E 35           	dec (hl)					;	Decrementa temporizador de estados, (Shield_2).
  84  830F
  85  830F 20 17        	jr nz,Incrementa_FRAMES
  86  8311
  87  8311              ; El temporizador de estados a llegado a "0". HL apunta a (Shield_2).
  88  8311
  89  8311              Cambio_de_estado
  90  8311
  91  8311              ;	Indica cambio de estado.
  92  8311
  93  8311 23           	inc hl						;	Sitúa en (Shield_3).
  94  8312
  95  8312 CB 5E        	bit 3,(hl)
  96  8314 28 05        	jr z,2F
  97  8316
  98  8316 CD C8 90     	call Inicia_Shield
  99  8319
 100  8319 18 0D        	jr Incrementa_FRAMES
 101  831B
 102  831B CB 06        2 rlc (hl)						; 	Sitúa en (Shield_3) y rotamos bit. (Indica cambio de comportamiento).
 103  831D
 104  831D              ;	Carga en (Shield_2) la siguiente temporización.
 105  831D
 106  831D 2A 90 8C     	ld hl,(Puntero_datos_shield)
 107  8320 23           	inc hl
 108  8321 22 90 8C     	ld (Puntero_datos_shield),hl
 109  8324 7E           	ld a,(hl)
 110  8325 32 93 8C     	ld (Shield_2),a				;	Iniciamos (Shield_2) con la nueva temporización.
 111  8328
 112  8328              Incrementa_FRAMES
 113  8328
 114  8328 2A 78 5C     	ld hl,(FRAMES)
 115  832B 23           	inc hl
 116  832C 22 78 5C     	ld (FRAMES),hl
 117  832F
 118  832F 7C           	ld a,h
 119  8330 B5           	or l
 120  8331 20 04        	jr nz,1F
 121  8333
 122  8333 21 7A 5C     	ld hl,FRAMES_3
 123  8336 34           	inc (hl)
 124  8337
 125  8337 D5           1 push de
 126  8338 C5           	push bc
 127  8339
 128  8339 CD D8 90     	call Actualiza_pantalla
 129  833C
 130  833C C1           	pop bc
 131  833D D1           	pop de
 132  833E E1           	pop hl
 133  833F F1           	pop af
 134  8340
 135  8340 FB           	ei
 136  8341
 137  8341 C9           	ret
 138  8342
 139  8342              ; --------------------------------------------------------------------------------
 140  8342
 141  8342              	include "Sprites_e_indices.asm"						; Comienza en $83a0
# file opened: Sprites_e_indices.asm
   1+ 8342              ; ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   2+ 8342              ;
   3+ 8342              ;	17/02/23
   4+ 8342              ;
   5+ 8342              ;	Sprites e índices.
   6+ 8342
   7+ 8342              	org $83a0
   8+ 83A0
   9+ 83A0              ; Disparo.
  10+ 83A0
  11+ 83A0 A8 83        Indice_disparo defw Disparo_0
  12+ 83A2 AE 83        	defw Disparo_f9
  13+ 83A4 B4 83        	defw Disparo_fb
  14+ 83A6 BA 83        	defw Disparo_fd
  15+ 83A8
  16+ 83A8              ; Disparo (CTRL_DESPLZ)="0".
  17+ 83A8 01 80 01 80  Disparo_0 DEFB $01,$80,$01,$80,$01,$80
  17+ 83AC 01 80
  18+ 83AE              ; Disparo (CTRL_DESPLZ)="f9"
  19+ 83AE 00 60 00 60  Disparo_f9 DEFB $00,$60,$00,$60,$00,$60
  19+ 83B2 00 60
  20+ 83B4              ; Disparo (CTRL_DESPLZ)="fb"
  21+ 83B4 18 00 18 00  Disparo_fb DEFB $18,$00,$18,$00,$18,$00
  21+ 83B8 18 00
  22+ 83BA              ; Disparo (CTRL_DESPLZ)="fd"
  23+ 83BA 06 00 06 00  Disparo_fd DEFB $06,$00,$06,$00,$06,$00
  23+ 83BE 06 00
  24+ 83C0
  25+ 83C0              ; ----------------------------------------------------------------------------------------
  26+ 83C0
  27+ 83C0              ; Badsat_izq. 2x2.
  28+ 83C0
  29+ 83C0 D0 83        Indice_Badsat_izq defw Badsat_izquierda
  30+ 83C2 30 85        	defw Badsat_izq_fe
  31+ 83C4 00 85        	defw Badsat_izq_fd
  32+ 83C6 C0 84        	defw Badsat_izq_fc
  33+ 83C8 90 84        	defw Badsat_izq_fb
  34+ 83CA 60 84        	defw Badsat_izq_fa
  35+ 83CC 30 84        	defw Badsat_izq_f9
  36+ 83CE 00 84        	defw Badsat_izq_f8
  37+ 83D0
  38+ 83D0 00 08 00     Badsat_izquierda DEFB $00,$08,$00
  39+ 83D3 02 14 00     	DEFB 	$02,$14,$00
  40+ 83D6 02 2A 00     	DEFB 	$02,$2A,$00
  41+ 83D9 02 55 00     	DEFB 	$02,$55,$00
  42+ 83DC 02 AA 00     	DEFB	$02,$AA,$00
  43+ 83DF 02 54 00     	DEFB 	$02,$54,$00
  44+ 83E2 7F E8 00     	DEFB 	$7F,$E8,$00
  45+ 83E5 03 60 00     	DEFB 	$03,$60,$00
  46+ 83E8 0A E0 00     	DEFB	$0A,$E0,$00
  47+ 83EB 17 F8 00     	DEFB 	$17,$F8,$00
  48+ 83EE 2B E8 00     	DEFB 	$2B,$E8,$00
  49+ 83F1 54 40 00     	DEFB 	$54,$40,$00
  50+ 83F4 AA 60 00     	DEFB	$AA,$60,$00
  51+ 83F7 54 00 00     	DEFB 	$54,$00,$00
  52+ 83FA 28 00 00     	DEFB 	$28,$00,$00
  53+ 83FD 10 00 00     	DEFB 	$10,$00,$00	 ; Sprite principal a izquierda, (sin desplazar).
  54+ 8400
  55+ 8400 00 04 00 01  Badsat_izq_f8 DEFB $00,$04,$00,$01,$0A,$00,$01,$15
  55+ 8404 0A 00 01 15
  56+ 8408 00 01 2A 80  	DEFB	$00,$01,$2A,$80,$01,$55,$00,$01
  56+ 840C 01 55 00 01
  57+ 8410 2A 00 3F F4  	DEFB	$2A,$00,$3F,$F4,$00,$01,$B0,$00
  57+ 8414 00 01 B0 00
  58+ 8418 05 70 00 0B  	DEFB	$05,$70,$00,$0B,$FC,$00,$15,$F4
  58+ 841C FC 00 15 F4
  59+ 8420 00 2A 20 00  	DEFB	$00,$2A,$20,$00,$55,$30,$00,$2A
  59+ 8424 55 30 00 2A
  60+ 8428 00 00 14 00  	DEFB	$00,$00,$14,$00,$00,$08,$00,$00 ; $F8 (7º DESPLZ a izquierda).
  60+ 842C 00 08 00 00
  61+ 8430
  62+ 8430 00 02 00 00  Badsat_izq_f9 DEFB $00,$02,$00,$00,$85,$00,$00,$8A
  62+ 8434 85 00 00 8A
  63+ 8438 80 00 95 40  	DEFB	$80,$00,$95,$40,$00,$AA,$80,$00
  63+ 843C 00 AA 80 00
  64+ 8440 95 00 1F FA  	DEFB	$95,$00,$1F,$FA,$00,$00,$D8,$00
  64+ 8444 00 00 D8 00
  65+ 8448 02 B8 00 05  	DEFB	$02,$B8,$00,$05,$FE,$00,$0A,$FA
  65+ 844C FE 00 0A FA
  66+ 8450 00 15 10 00  	DEFB	$00,$15,$10,$00,$2A,$98,$00,$15
  66+ 8454 2A 98 00 15
  67+ 8458 00 00 0A 00  	DEFB	$00,$00,$0A,$00,$00,$04,$00,$00 ; $F9 (6º DESPLZ a izquierda).
  67+ 845C 00 04 00 00
  68+ 8460
  69+ 8460 00 01 00 00  Badsat_izq_fa DEFB $00,$01,$00,$00,$42,$80,$00,$45
  69+ 8464 42 80 00 45
  70+ 8468 40 00 4A A0  	DEFB	$40,$00,$4A,$A0,$00,$55,$40,$00
  70+ 846C 00 55 40 00
  71+ 8470 4A 80 0F FD  	DEFB	$4A,$80,$0F,$FD,$00,$00,$6C,$00
  71+ 8474 00 00 6C 00
  72+ 8478 01 5C 00 02  	DEFB	$01,$5C,$00,$02,$FF,$00,$05,$7D
  72+ 847C FF 00 05 7D
  73+ 8480 00 0A 88 00  	DEFB	$00,$0A,$88,$00,$15,$4C,$00,$0A
  73+ 8484 15 4C 00 0A
  74+ 8488 80 00 05 00  	DEFB	$80,$00,$05,$00,$00,$02,$00,$00 ; $Fa (5º DESPLZ a izquierda).
  74+ 848C 00 02 00 00
  75+ 8490
  76+ 8490 00 00 80 00  Badsat_izq_fb DEFB $00,$00,$80,$00,$21,$40,$00,$22
  76+ 8494 21 40 00 22
  77+ 8498 A0 00 25 50  	DEFB	$A0,$00,$25,$50,$00,$2A,$A0,$00
  77+ 849C 00 2A A0 00
  78+ 84A0 25 40 07 FE  	DEFB	$25,$40,$07,$FE,$80,$00,$36,$00
  78+ 84A4 80 00 36 00
  79+ 84A8 00 AE 00 01  	DEFB	$00,$AE,$00,$01,$7F,$80,$02,$BE
  79+ 84AC 7F 80 02 BE
  80+ 84B0 80 05 44 00  	DEFB	$80,$05,$44,$00,$0A,$A6,$00,$05
  80+ 84B4 0A A6 00 05
  81+ 84B8 40 00 02 80  	DEFB	$40,$00,$02,$80,$00,$01,$00,$00 ; $Fb (4º DESPLZ a izquierda).
  81+ 84BC 00 01 00 00
  82+ 84C0
  83+ 84C0 00 00 40 00  Badsat_izq_fc DEFB $00,$00,$40,$00,$10,$A0,$00,$11
  83+ 84C4 10 A0 00 11
  84+ 84C8 50 00 12 A8  	DEFB	$50,$00,$12,$A8,$00,$15,$50,$00
  84+ 84CC 00 15 50 00
  85+ 84D0 12 A0 03 FF  	DEFB	$12,$A0,$03,$FF,$40,$00,$1B,$00
  85+ 84D4 40 00 1B 00
  86+ 84D8 00 57 00 00  	DEFB	$00,$57,$00,$00,$BF,$C0,$01,$5F
  86+ 84DC BF C0 01 5F
  87+ 84E0 40 02 A2 00  	DEFB	$40,$02,$A2,$00,$05,$53,$00,$02
  87+ 84E4 05 53 00 02
  88+ 84E8 A0 00 01 40  	DEFB	$A0,$00,$01,$40,$00,$00,$80,$00 ; $Fc (3er DESPLZ a izquierda).
  88+ 84EC 00 00 80 00
  89+ 84F0
  90+ 84F0              	org $8500
  91+ 8500
  92+ 8500 00 00 20 00  Badsat_izq_fd DEFB $00,$00,$20,$00,$08,$50,$00,$08
  92+ 8504 08 50 00 08
  93+ 8508 A8 00 09 54  	DEFB	$A8,$00,$09,$54,$00,$0A,$A8,$00
  93+ 850C 00 0A A8 00
  94+ 8510 09 50 01 FF  	DEFB	$09,$50,$01,$FF,$A0,$00,$0D,$80
  94+ 8514 A0 00 0D 80
  95+ 8518 00 2B 80 00  	DEFB	$00,$2B,$80,$00,$5F,$F8,$00,$AF
  95+ 851C 5F F8 00 AF
  96+ 8520 80 01 51 00  	DEFB	$80,$01,$51,$00,$02,$A9,$00,$01
  96+ 8524 02 A9 00 01
  97+ 8528 51 00 00 A0  	DEFB	$51,$00,$00,$A0,$00,$00,$40,$00 ; $Fd (2º DESPLZ a izquierda).
  97+ 852C 00 00 40 00
  98+ 8530
  99+ 8530 00 00 10 00  Badsat_izq_fe DEFB $00,$00,$10,$00,$04,$28,$00,$04
  99+ 8534 04 28 00 04
 100+ 8538 54 00 04 AA  	DEFB	$54,$00,$04,$AA,$00,$05,$54,$00
 100+ 853C 00 05 54 00
 101+ 8540 04 A8 00 FF  	DEFB	$04,$A8,$00,$FF,$D0,$00,$06,$C0
 101+ 8544 D0 00 06 C0
 102+ 8548 00 15 C0 00  	DEFB	$00,$15,$C0,$00,$2F,$FC,$00,$57
 102+ 854C 2F FC 00 57
 103+ 8550 C0 00 A8 80  	DEFB	$C0,$00,$A8,$80,$01,$54,$80,$00
 103+ 8554 01 54 80 00
 104+ 8558 A8 80 00 50  	DEFB	$A8,$80,$00,$50,$00,$00,$20,$00 ; $Fe (1er DESPLZ a izquierda).
 104+ 855C 00 00 20 00
 105+ 8560
 106+ 8560
 107+ 8560 70 85        Indice_Badsat_der defw Badsat_derecha
 108+ 8562 A0 85        	defw Badsat_der_f8
 109+ 8564 D0 85        	defw Badsat_der_f9
 110+ 8566 00 86        	defw Badsat_der_fa
 111+ 8568 30 86        	defw Badsat_der_fb
 112+ 856A 60 86        	defw Badsat_der_fc
 113+ 856C 90 86        	defw Badsat_der_fd
 114+ 856E C0 86        	defw Badsat_der_fe
 115+ 8570
 116+ 8570 10 00 00     Badsat_derecha DEFB	$10,$00,$00
 117+ 8573 28 40 00     	DEFB    $28,$40,$00
 118+ 8576 54 40 00     	DEFB	$54,$40,$00
 119+ 8579 AA 40 00     	DEFB	$AA,$40,$00
 120+ 857C 55 40 00     	DEFB	$55,$40,$00
 121+ 857F 2A 40 00     	DEFB	$2A,$40,$00
 122+ 8582 17 FE 00     	DEFB	$17,$FE,$00
 123+ 8585 06 C0 00     	DEFB	$06,$C0,$00
 124+ 8588 07 50 00     	DEFB	$07,$50,$00
 125+ 858B 1F E8 00     	DEFB	$1F,$E8,$00
 126+ 858E 17 D4 00     	DEFB	$17,$D4,$00
 127+ 8591 02 2A 00     	DEFB	$02,$2A,$00
 128+ 8594 06 55 00     	DEFB	$06,$55,$00
 129+ 8597 00 2A 00     	DEFB	$00,$2A,$00
 130+ 859A 00 14 00     	DEFB	$00,$14,$00
 131+ 859D 00 08 00     	DEFB	$00,$08,$00 ; Sprite principal a derecha, (sin desplazar).
 132+ 85A0
 133+ 85A0 08 00 00 14  Badsat_der_f8 DEFB $08,$00,$00,$14,$20,$00,$2A,$20
 133+ 85A4 20 00 2A 20
 134+ 85A8 00 55 20 00  	DEFB	$00,$55,$20,$00,$2A,$A0,$00,$15
 134+ 85AC 2A A0 00 15
 135+ 85B0 20 00 0B FF  	DEFB	$20,$00,$0B,$FF,$00,$03,$60,$00
 135+ 85B4 00 03 60 00
 136+ 85B8 03 A8 00 0F  	DEFB	$03,$A8,$00,$0F,$F4,$00,$0B,$EA
 136+ 85BC F4 00 0B EA
 137+ 85C0 00 01 15 00  	DEFB	$00,$01,$15,$00,$03,$2A,$80,$00
 137+ 85C4 03 2A 80 00
 138+ 85C8 15 00 00 0A  	DEFB	$15,$00,$00,$0A,$00,$00,$04,$00 ; $F8 (1er DESPLZ a derecha).
 138+ 85CC 00 00 04 00
 139+ 85D0
 140+ 85D0 04 00 00 0A  Badsat_der_f9 DEFB $04,$00,$00,$0A,$10,$00,$15,$10
 140+ 85D4 10 00 15 10
 141+ 85D8 00 2A 90 00  	DEFB	$00,$2A,$90,$00,$15,$50,$00,$0A
 141+ 85DC 15 50 00 0A
 142+ 85E0 90 00 05 FF  	DEFB	$90,$00,$05,$FF,$80,$01,$B0,$00
 142+ 85E4 80 01 B0 00
 143+ 85E8 01 D4 00 07  	DEFB	$01,$D4,$00,$07,$FA,$00,$05,$F5
 143+ 85EC FA 00 05 F5
 144+ 85F0 00 00 8A 80  	DEFB	$00,$00,$8A,$80,$01,$95,$40,$00
 144+ 85F4 01 95 40 00
 145+ 85F8 0A 80 00 05  	DEFB	$0A,$80,$00,$05,$00,$00,$02,$00 ; $F9 (2º DESPLZ a derecha).
 145+ 85FC 00 00 02 00
 146+ 8600
 147+ 8600 02 00 00 05  Badsat_der_fa DEFB $02,$00,$00,$05,$08,$00,$0A,$88
 147+ 8604 08 00 0A 88
 148+ 8608 00 15 48 00  	DEFB	$00,$15,$48,$00,$0A,$A8,$00,$05
 148+ 860C 0A A8 00 05
 149+ 8610 48 00 02 FF  	DEFB	$48,$00,$02,$FF,$C0,$00,$D8,$00
 149+ 8614 C0 00 D8 00
 150+ 8618 00 EA 00 03  	DEFB	$00,$EA,$00,$03,$FD,$00,$02,$FA
 150+ 861C FD 00 02 FA
 151+ 8620 80 00 45 40  	DEFB	$80,$00,$45,$40,$00,$CA,$A0,$00
 151+ 8624 00 CA A0 00
 152+ 8628 05 40 00 02  	DEFB	$05,$40,$00,$02,$80,$00,$01,$00 ; $Fa (3er DESPLZ a derecha).
 152+ 862C 80 00 01 00
 153+ 8630
 154+ 8630 01 00 00 02  Badsat_der_fb DEFB $01,$00,$00,$02,$84,$00,$05,$44
 154+ 8634 84 00 05 44
 155+ 8638 00 0A A4 00  	DEFB	$00,$0A,$A4,$00,$05,$54,$00,$02
 155+ 863C 05 54 00 02
 156+ 8640 A4 00 01 7F  	DEFB	$A4,$00,$01,$7F,$E0,$00,$6C,$00
 156+ 8644 E0 00 6C 00
 157+ 8648 00 75 00 01  	DEFB	$00,$75,$00,$01,$FE,$80,$01,$7D
 157+ 864C FE 80 01 7D
 158+ 8650 40 00 22 A0  	DEFB	$40,$00,$22,$A0,$00,$65,$50,$00
 158+ 8654 00 65 50 00
 159+ 8658 02 A0 00 01  	DEFB	$02,$A0,$00,$01,$40,$00,$00,$80 ; $Fb (4º DESPLZ a derecha).
 159+ 865C 40 00 00 80
 160+ 8660
 161+ 8660 00 80 00 01  Badsat_der_fc DEFB $00,$80,$00,$01,$42,$00,$02,$A2
 161+ 8664 42 00 02 A2
 162+ 8668 00 05 52 00  	DEFB	$00,$05,$52,$00,$02,$AA,$00,$01
 162+ 866C 02 AA 00 01
 163+ 8670 52 00 00 BF  	DEFB	$52,$00,$00,$BF,$F0,$00,$36,$00
 163+ 8674 F0 00 36 00
 164+ 8678 00 3A 80 00  	DEFB	$00,$3A,$80,$00,$FF,$40,$00,$BE
 164+ 867C FF 40 00 BE
 165+ 8680 A0 00 11 50  	DEFB	$A0,$00,$11,$50,$00,$32,$A8,$00
 165+ 8684 00 32 A8 00
 166+ 8688 01 50 00 00  	DEFB	$01,$50,$00,$00,$A0,$00,$00,$40 ; $Fc (5º DESPLZ a derecha).
 166+ 868C A0 00 00 40
 167+ 8690
 168+ 8690 00 40 00 00  Badsat_der_fd DEFB $00,$40,$00,$00,$A1,$00,$01,$51
 168+ 8694 A1 00 01 51
 169+ 8698 00 02 A9 00  	DEFB	$00,$02,$A9,$00,$01,$55,$00,$00
 169+ 869C 01 55 00 00
 170+ 86A0 A9 00 00 5F  	DEFB	$A9,$00,$00,$5F,$F8,$00,$1B,$00
 170+ 86A4 F8 00 1B 00
 171+ 86A8 00 1D 40 01  	DEFB	$00,$1D,$40,$01,$FF,$A0,$00,$1F
 171+ 86AC FF A0 00 1F
 172+ 86B0 50 00 08 A8  	DEFB	$50,$00,$08,$A8,$00,$09,$54,$00
 172+ 86B4 00 09 54 00
 173+ 86B8 08 A8 00 00  	DEFB	$08,$A8,$00,$00,$50,$00,$00,$20 ; $Fd (6º DESPLZ a derecha).
 173+ 86BC 50 00 00 20
 174+ 86C0
 175+ 86C0 00 20 00 00  Badsat_der_fe DEFB $00,$20,$00,$00,$50,$80,$00,$A8
 175+ 86C4 50 80 00 A8
 176+ 86C8 80 01 54 80  	DEFB	$80,$01,$54,$80,$00,$AA,$80,$00
 176+ 86CC 00 AA 80 00
 177+ 86D0 54 80 00 2F  	DEFB	$54,$80,$00,$2F,$FC,$00,$0D,$80
 177+ 86D4 FC 00 0D 80
 178+ 86D8 00 0E A0 00  	DEFB	$00,$0E,$A0,$00,$FF,$D0,$00,$0F
 178+ 86DC FF D0 00 0F
 179+ 86E0 A8 00 04 54  	DEFB	$A8,$00,$04,$54,$00,$04,$AA,$00
 179+ 86E4 00 04 AA 00
 180+ 86E8 04 54 00 00  	DEFB	$04,$54,$00,$00,$28,$00,$00,$10 ; $Fe (7º DESPLZ a derecha).
 180+ 86EC 28 00 00 10
 181+ 86F0
 182+ 86F0              ; ----------------------------------------------------------------------------------------
 183+ 86F0
 184+ 86F0              ; Amadeus. 2x2.
 185+ 86F0
 186+ 86F0 10 87        Indice_Amadeus_der defw Amadeus
 187+ 86F2 00 00        	defw 0
 188+ 86F4 40 87        	defw Amadeus_F9							; [$F9] right - [$FA] left
 189+ 86F6 00 00        	defw 0
 190+ 86F8 70 87        	defw Amadeus_Fb     					; [$FB] right - [$FC] left
 191+ 86FA 00 00        	defw 0
 192+ 86FC A0 87        	defw Amadeus_Fd							; [$FD] right - [$FE] left
 193+ 86FE 00 00        	defw 0	 								; (Fín de índice).
 194+ 8700
 195+ 8700 10 87        Indice_Amadeus_izq defw Amadeus
 196+ 8702 00 00        	defw 0
 197+ 8704 A0 87        	defw Amadeus_Fd							; [$F9] right - [$FA] left
 198+ 8706 00 00        	defw 0
 199+ 8708 70 87        	defw Amadeus_Fb     					; [$FB] right - [$FC] left
 200+ 870A 00 00        	defw 0
 201+ 870C 40 87        	defw Amadeus_F9							; [$FD] right - [$FE] left
 202+ 870E 00 00        	defw 0	 								; (Fín de índice).
 203+ 8710
 204+ 8710 01 80 00     Amadeus DEFB $01,$80,0
 205+ 8713 23 C4 00     	DEFB	$23,$C4,0
 206+ 8716 26 64 00     	DEFB	$26,$64,0
 207+ 8719 24 24 00     	DEFB	$24,$24,0
 208+ 871C 2C 34 00     	DEFB	$2C,$34,0
 209+ 871F 6D B6 00     	DEFB	$6D,$B6,0
 210+ 8722 6F F6 00     	DEFB	$6F,$F6,0
 211+ 8725 67 E6 00     	DEFB	$67,$E6,0
 212+ 8728 E7 E7 00     	DEFB	$E7,$E7,0
 213+ 872B F3 CF 00     	DEFB	$F3,$CF,0
 214+ 872E F7 EF 00     	DEFB	$F7,$EF,0
 215+ 8731 FF FF 00     	DEFB	$FF,$FF,0
 216+ 8734 FB DF 00     	DEFB	$FB,$DF,0
 217+ 8737 FB DF 00     	DEFB	$FB,$DF,0
 218+ 873A 8B D1 00     	DEFB	$8B,$D1,0
 219+ 873D 71 8E 00     	DEFB	$71,$8E,0 						; Sprite principal, (sin desplazar).
 220+ 8740
 221+ 8740 00 60 00 08  Amadeus_F9 DEFB	$00,$60,$00,$08,$F1,$00,$09,$99
 221+ 8744 F1 00 09 99
 222+ 8748 00 09 09 00  	DEFB	$00,$09,$09,$00,$0B,$0D,$00,$1B
 222+ 874C 0B 0D 00 1B
 223+ 8750 6D 80 1B FD  	DEFB	$6D,$80,$1B,$FD,$80,$19,$F9,$80
 223+ 8754 80 19 F9 80
 224+ 8758 39 F9 C0 3C  	DEFB	$39,$F9,$C0,$3C,$F3,$C0,$3D,$FB
 224+ 875C F3 C0 3D FB
 225+ 8760 C0 3F FF C0  	DEFB	$C0,$3F,$FF,$C0,$3E,$F7,$C0,$3E
 225+ 8764 3E F7 C0 3E
 226+ 8768 F7 C0 22 F4  	DEFB	$F7,$C0,$22,$F4,$40,$1C,$63,$80 ; $F9 (2º DESPLZ a derecha).
 226+ 876C 40 1C 63 80
 227+ 8770
 228+ 8770 00 18 00 02  Amadeus_Fb DEFB	$00,$18,$00,$02,$3C,$40,$02,$66
 228+ 8774 3C 40 02 66
 229+ 8778 40 02 42 40  	DEFB	$40,$02,$42,$40,$02,$C3,$40,$06
 229+ 877C 02 C3 40 06
 230+ 8780 DB 60 06 FF  	DEFB	$DB,$60,$06,$FF,$60,$06,$7E,$60
 230+ 8784 60 06 7E 60
 231+ 8788 0E 7E 70 0F  	DEFB	$0E,$7E,$70,$0F,$3C,$F0,$0F,$7E
 231+ 878C 3C F0 0F 7E
 232+ 8790 F0 0F FF F0  	DEFB	$F0,$0F,$FF,$F0,$0F,$BD,$F0,$0F
 232+ 8794 0F BD F0 0F
 233+ 8798 BD F0 08 BD  	DEFB	$BD,$F0,$08,$BD,$10,$07,$18,$E0 ; $Fb (4º DESPLZ a derecha).
 233+ 879C 10 07 18 E0
 234+ 87A0
 235+ 87A0 00 06 00 00  Amadeus_Fd DEFB	$00,$06,$00,$00,$8F,$10,$00,$99
 235+ 87A4 8F 10 00 99
 236+ 87A8 90 00 90 90  	DEFB	$90,$00,$90,$90,$00,$B0,$D0,$01
 236+ 87AC 00 B0 D0 01
 237+ 87B0 B6 D8 01 BF  	DEFB	$B6,$D8,$01,$BF,$D8,$01,$9F,$98
 237+ 87B4 D8 01 9F 98
 238+ 87B8 03 9F 9C 03  	DEFB	$03,$9F,$9C,$03,$CF,$3C,$03,$DF
 238+ 87BC CF 3C 03 DF
 239+ 87C0 BC 03 FF FC  	DEFB	$BC,$03,$FF,$FC,$03,$EF,$7C,$03
 239+ 87C4 03 EF 7C 03
 240+ 87C8 EF 7C 02 2F  	DEFB	$EF,$7C,$02,$2F,$44,$01,$C6,$38 ; $Fd (6º DESPLZ a derecha).
 240+ 87CC 44 01 C6 38
 241+ 87D0
 242+ 87D0              ; ----------------------------------------------------------------------------------------
 243+ 87D0
 244+ 87D0 00 88        Indice_Explosion_entidades defw Explosion_entidades_1
 245+ 87D2 30 88        	defw Explosion_entidades_2
 246+ 87D4 60 88        	defw Explosion_entidades_3
 247+ 87D6
 248+ 87D6              	org $8800
 249+ 8800
 250+ 8800 00 10 00     Explosion_entidades_1 DEFB $00,$10,$00
 251+ 8803 08 10 00     	DEFB 	$08,$10,$00
 252+ 8806 04 38 40     	DEFB	$04,$38,$40
 253+ 8809 03 7D 80     	DEFB	$03,$7D,$80
 254+ 880C 02 E6 80     	DEFB	$02,$E6,$80
 255+ 880F 01 B7 00     	DEFB	$01,$B7,$00
 256+ 8812 01 7F 00     	DEFB	$01,$7F,$00
 257+ 8815 03 DD 80     	DEFB	$03,$DD,$80
 258+ 8818 0F FF E0     	DEFB	$0F,$FF,$E0
 259+ 881B 03 3B 80     	DEFB	$03,$3B,$80
 260+ 881E 01 9D 00     	DEFB	$01,$9D,$00
 261+ 8821 01 F6 00     	DEFB	$01,$F6,$00
 262+ 8824 02 FD 80     	DEFB	$02,$FD,$80
 263+ 8827 03 00 40     	DEFB	$03,$00,$40
 264+ 882A 04 00 00     	DEFB	$04,$00,$00
 265+ 882D 08 00 00     	DEFB	$08,$00,$00
 266+ 8830
 267+ 8830 08 00 00 05  Explosion_entidades_2 DEFB $08,$00,$00,$05,$38,$10,$03,$BC
 267+ 8834 38 10 03 BC
 268+ 8838 20 06 00 C0  	DEFB	$20,$06,$00,$C0,$04,$06,$C0,$00
 268+ 883C 04 06 C0 00
 269+ 8840 37 00 00 7F  	DEFB	$37,$00,$00,$7F,$00,$03,$DD,$80
 269+ 8844 00 03 DD 80
 270+ 8848 03 FE 00 03  	DEFB	$03,$FE,$00,$03,$3A,$70,$01,$9C
 270+ 884C 3A 70 01 9C
 271+ 8850 60 01 F6 40  	DEFB	$60,$01,$F6,$40,$04,$F8,$80,$06
 271+ 8854 04 F8 80 06
 272+ 8858 00 00 08 00  	DEFB	$00,$00,$08,$00,$00,$00,$00,$00
 272+ 885C 00 00 00 00
 273+ 8860
 274+ 8860 03 18 10 04  Explosion_entidades_3 DEFB $03,$18,$10,$04,$00,$20,$08,$00
 274+ 8864 00 20 08 00
 275+ 8868 40 00 00 C0  	DEFB	$40,$00,$00,$C0,$00,$06,$00,$00
 275+ 886C 00 06 00 00
 276+ 8870 15 00 08 1E  	DEFB	$15,$00,$08,$1E,$00,$00,$14,$30
 276+ 8874 00 00 14 30
 277+ 8878 08 66 00 00  	DEFB	$08,$66,$00,$00,$38,$00,$01,$08
 277+ 887C 38 00 01 08
 278+ 8880 00 01 80 00  	DEFB	$00,$01,$80,$00,$00,$80,$00,$04
 278+ 8884 00 80 00 04
 279+ 8888 03 20 06 00  	DEFB	$03,$20,$06,$00,$10,$08,$00,$20
 279+ 888C 10 08 00 20
 280+ 8890
 281+ 8890              ; ------------------------------------------
 282+ 8890
 283+ 8890 96 88        Indice_Explosion_Amadeus defw Explosion_Amadeus_1
 284+ 8892 C6 88        	defw Explosion_Amadeus_2
 285+ 8894 00 89        	defw Explosion_Amadeus_3
 286+ 8896
 287+ 8896 00 18 02     Explosion_Amadeus_1	DEFB $00,$18,$02
 288+ 8899 02 3C 36     	DEFB	$02,$3C,$36
 289+ 889C 02 66 56     	DEFB	$02,$66,$56
 290+ 889F 02 42 48     	DEFB	$02,$42,$48
 291+ 88A2 02 C3 32     	DEFB	$02,$C3,$32
 292+ 88A5 06 DB 0C     	DEFB	$06,$DB,$0C
 293+ 88A8 06 FE 46     	DEFB	$06,$FE,$46
 294+ 88AB 06 79 68     	DEFB	$06,$79,$68
 295+ 88AE 0E 76 D8     	DEFB	$0E,$76,$D8
 296+ 88B1 1E 34 6C     	DEFB	$1E,$34,$6C
 297+ 88B4 0F 6E BE     	DEFB	$0F,$6E,$BE
 298+ 88B7 0F EF B0     	DEFB	$0F,$EF,$B0
 299+ 88BA 0F B5 A0     	DEFB	$0F,$B5,$A0
 300+ 88BD 0F B1 8A     	DEFB	$0F,$B1,$8A
 301+ 88C0 08 BA 4C     	DEFB	$08,$BA,$4C
 302+ 88C3 07 19 80     	DEFB	$07,$19,$80
 303+ 88C6
 304+ 88C6 00 18 02     Explosion_Amadeus_2	DEFB $00,$18,$02
 305+ 88C9 00 3C 36     	DEFB	$00,$3C,$36
 306+ 88CC 00 66 56     	DEFB	$00,$66,$56
 307+ 88CF 04 42 48     	DEFB	$04,$42,$48
 308+ 88D2 0A 03 32     	DEFB	$0A,$03,$32
 309+ 88D5 14 DB 0C     	DEFB	$14,$DB,$0C
 310+ 88D8 1C DE 46     	DEFB	$1C,$DE,$46
 311+ 88DB 36 49 68     	DEFB 	$36,$49,$68
 312+ 88DE 0C 76 D8     	DEFB	$0C,$76,$D8
 313+ 88E1 10 34 6C     	DEFB	$10,$34,$6C
 314+ 88E4 2B 6E BE     	DEFB	$2B,$6E,$BE
 315+ 88E7 0E AF B0     	DEFB	$0E,$AF,$B0
 316+ 88EA 29 B5 A0     	DEFB	$29,$B5,$A0
 317+ 88ED 0C 91 8A     	DEFB	$0C,$91,$8A
 318+ 88F0 08 BA 4C     	DEFB	$08,$BA,$4C
 319+ 88F3 07 19 80     	DEFB	$07,$19,$80
 320+ 88F6
 321+ 88F6              	org $8900
 322+ 8900
 323+ 8900 00 00 00     Explosion_Amadeus_3	DEFB $00,$00,$00
 324+ 8903 00 00 00     	DEFB	$00,$00,$00
 325+ 8906 00 00 00     	DEFB	$00,$00,$00
 326+ 8909 00 00 40     	DEFB	$00,$00,$40
 327+ 890C 00 00 30     	DEFB	$00,$00,$30
 328+ 890F 00 00 08     	DEFB	$00,$00,$08
 329+ 8912 00 82 40     	DEFB	$00,$82,$40
 330+ 8915 04 04 68     	DEFB	$04,$04,$68
 331+ 8918 04 20 58     	DEFB	$04,$20,$58
 332+ 891B 18 12 2C     	DEFB	$18,$12,$2C
 333+ 891E 2A 40 3C     	DEFB	$2A,$40,$3C
 334+ 8921 0F C2 30     	DEFB	$0F,$C2,$30
 335+ 8924 29 80 A0     	DEFB	$29,$80,$A0
 336+ 8927 0F 84 88     	DEFB	$0F,$84,$88
 337+ 892A 08 A0 4C     	DEFB	$08,$A0,$4C
 338+ 892D 07 11 80     	DEFB	$07,$11,$80
 339+ 8930
# file closed: Sprites_e_indices.asm
 142  8930              	include "Cajas_y_disparos.asm"
# file opened: Cajas_y_disparos.asm
   1+ 8930              ; ---------------------------------------------------------------------
   2+ 8930              ; Cajas de entidades, Amadeus y disparos. Índices de disparos y cajas.
   3+ 8930              ; Índice de Patrón de movimiento para tipo de entidad.
   4+ 8930              ; ---------------------------------------------------------------------
   5+ 8930
   6+ 8930              ; 30/05/24
   7+ 8930              ;
   8+ 8930              ;	En esta tabla iremos almacenando:
   9+ 8930              ;
  10+ 8930              ;	(Columna_Y),(Dirección de memoria donde se encuentran almacenados los scanlines masticados de cada entidad, (Scanlines_album)).
  11+ 8930              ;
  12+ 8930              ;	Los 6 últimos bytes contienen el borrado/pintado de Amadeus, (Amadeus_scanlines_album).
  13+ 8930
  14+ 8930 00 00 00...  Numeros_aleatorios ds 7
  15+ 8937
  16+ 8937 00 00 00...  Tabla_de_pintado ds 27
  17+ 8952
  18+ 8952              ;	db 0, defw 0
  19+ 8952              ;	db 0, defw 0
  20+ 8952              ;	db 0, defw 0
  21+ 8952              ;	db 0, defw 0
  22+ 8952              ;	db 0, defw 0
  23+ 8952              ;	db 0, defw 0
  24+ 8952              ;	db 0, defw 0
  25+ 8952
  26+ 8952 47 8A        Indice_de_mov_segun_tipo_de_entidad defw Indice_mov_Baile_de_BadSat
  27+ 8954              ;	defw ...
  28+ 8954              ; 	defw ...
  29+ 8954 00 00        	defw 0
  30+ 8956
  31+ 8956 5A 89        Indice_de_disparos_Amadeus defw Disparo_1A
  32+ 8958 5F 89        	defw Disparo_2A
  33+ 895A
  34+ 895A 00 00        Disparo_1A defw 0									; Puntero objeto.
  35+ 895C 00 00        	defw 0											; Puntero de impresión.
  36+ 895E 00           	db 0											; Impacto.
  37+ 895F
  38+ 895F 00 00        Disparo_2A defw 0									; Puntero objeto.
  39+ 8961 00 00        	defw 0											; Puntero de impresión.
  40+ 8963 00           	db 0											; Impacto.
  41+ 8964
  42+ 8964 78 89        Indice_de_disparos_entidades defw Disparo_1
  43+ 8966 7D 89        	defw Disparo_2
  44+ 8968 82 89        	defw Disparo_3
  45+ 896A 87 89        	defw Disparo_4
  46+ 896C 8C 89        	defw Disparo_5
  47+ 896E 91 89        	defw Disparo_6
  48+ 8970 96 89        	defw Disparo_7
  49+ 8972 9B 89        	defw Disparo_8
  50+ 8974 A0 89        	defw Disparo_9
  51+ 8976 A5 89        	defw Disparo_10
  52+ 8978
  53+ 8978 00 00        Disparo_1 defw 0									; Puntero objeto.
  54+ 897A 00 00        	defw 0											; Puntero de impresión.
  55+ 897C 00           	db 0											; Control.
  56+ 897D
  57+ 897D 00 00        Disparo_2 defw 0									; Puntero objeto.
  58+ 897F 00 00        	defw 0											; Puntero de impresión.
  59+ 8981 00           	db 0											; Control.
  60+ 8982
  61+ 8982 00 00        Disparo_3 defw 0									; Puntero objeto.
  62+ 8984 00 00        	defw 0											; Puntero de impresión.
  63+ 8986 00           	db 0											; Control.
  64+ 8987
  65+ 8987 00 00        Disparo_4 defw 0									; Puntero objeto.
  66+ 8989 00 00        	defw 0											; Puntero de impresión.
  67+ 898B 00           	db 0											; Control.
  68+ 898C
  69+ 898C 00 00        Disparo_5 defw 0									; Puntero objeto.
  70+ 898E 00 00        	defw 0											; Puntero de impresión.
  71+ 8990 00           	db 0											; Control.
  72+ 8991
  73+ 8991 00 00        Disparo_6 defw 0									; Puntero objeto.
  74+ 8993 00 00        	defw 0											; Puntero de impresión.
  75+ 8995 00           	db 0											; Control.
  76+ 8996
  77+ 8996 00 00        Disparo_7 defw 0									; Puntero objeto.
  78+ 8998 00 00        	defw 0											; Puntero de impresión.
  79+ 899A 00           	db 0											; Control.
  80+ 899B
  81+ 899B 00 00        Disparo_8 defw 0									; Puntero objeto.
  82+ 899D 00 00        	defw 0											; Puntero de impresión.
  83+ 899F 00           	db 0											; Control.
  84+ 89A0
  85+ 89A0 00 00        Disparo_9 defw 0									; Puntero objeto.
  86+ 89A2 00 00        	defw 0											; Puntero de impresión.
  87+ 89A4 00           	db 0											; Control.
  88+ 89A5
  89+ 89A5 00 00        Disparo_10 defw 0									; Puntero objeto.
  90+ 89A7 00 00        	defw 0											; Puntero de impresión.
  91+ 89A9 00           	db 0											; Control.
  92+ 89AA
  93+ 89AA              ; -------------------------------------------------------------------------------------
  94+ 89AA              ;
  95+ 89AA              ;	Índice de cajas de entidades.
  96+ 89AA              ;
  97+ 89AA              ;	18/1/24
  98+ 89AA              ;
  99+ 89AA
 100+ 89AA              Indice_de_cajas_de_entidades
 101+ 89AA
 102+ 89AA C8 89        	defw Caja_1
 103+ 89AC D4 89        	defw Caja_2
 104+ 89AE E0 89        	defw Caja_3
 105+ 89B0 EC 89        	defw Caja_4
 106+ 89B2 F8 89        	defw Caja_5
 107+ 89B4 04 8A        	defw Caja_6
 108+ 89B6 10 8A        	defw Caja_7
 109+ 89B8
 110+ 89B8 00 00        	defw 0
 111+ 89BA 00 00        	defw 0
 112+ 89BC
 113+ 89BC              ; -------------------------
 114+ 89BC
 115+ 89BC              ; Relleno para que no se corrompa el movimiento. ?????
 116+ 89BC
 117+ 89BC              ;	db 0
 118+ 89BC
 119+ 89BC              ; ---------- ---------- ---------- ---------- ----------
 120+ 89BC              ;
 121+ 89BC              ;	28/05/24
 122+ 89BC              ;
 123+ 89BC              ; 	Cada caja tiene 14 bytes !!!
 124+ 89BC              ;
 125+ 89BC              ;	En principio Amadeus mo utiliza los parámetros: (Contador_de_vueltas) y (Velocidad). Estarán a "0" aunque no descarto utilizarlos más adelante para otra función.
 126+ 89BC
 127+ 89BC 00           Amadeus_BOX db 0										; (Tipo).
 128+ 89BD 00 15        CX_Amadeus db 0,$15                                     ; (Coordenada_X), (Coordenada_Y).
 129+ 89BF 00           	db 0												; (Contador_de_vueltas).
 130+ 89C0 00           Impacto_Amadeus	db 0									; (Impacto).
 131+ 89C1 00 00        p.imp.amadeus defw 0									; (Puntero_de_impresion).
 132+ 89C3 00 00        Pamm_Amadeus defw 0										; (Puntero_de_almacen_de_mov_masticados).
 133+ 89C5 00 00        Comm_Amadeus defw 0 									; (Contador_de_mov_masticados).
 134+ 89C7 00           	db 0												; (Velocidad).
 135+ 89C8
 136+ 89C8              ; ---------- ---------- ---------- ---------- ----------
 137+ 89C8              ;
 138+ 89C8              ;	22/01/24
 139+ 89C8              ;
 140+ 89C8              ; 	Cada caja tiene 12 bytes !!!
 141+ 89C8
 142+ 89C8 00 00 00     Caja_1 db 0,0,0											; (Tipo) / (Coordenada_X) / (Coordenada_Y).
 143+ 89CB 00           	db 0												; (Contador_de_vueltas).
 144+ 89CC 00           	db 0												; (Impacto).
 145+ 89CD 00 00        	defw 0												; (Puntero_de_impresion).
 146+ 89CF 00 00        	defw 0												; (Puntero_de_almacen_de_mov_masticados).
 147+ 89D1 00 00        	defw 0 												; (Contador_de_mov_masticados).
 148+ 89D3 00           	db 0												; (Velocidad).
 149+ 89D4
 150+ 89D4              ; ---------- ---------- ---------- ---------- ----------
 151+ 89D4
 152+ 89D4 00 00 00     Caja_2 db 0,0,0											; (Tipo) / (Coordenada_X) / (Coordenada_Y).
 153+ 89D7 00           	db 0 												; (Contador_de_vueltas).
 154+ 89D8 00           	db 0												; (Impacto).
 155+ 89D9 00 00        	defw 0												; (Puntero_de_impresion).
 156+ 89DB 00 00        	defw 0												; (Puntero_de_almacen_de_mov_masticados).
 157+ 89DD 00 00        	defw 0 												; (Contador_de_mov_masticados).
 158+ 89DF 00           	db 0												; (Velocidad).
 159+ 89E0
 160+ 89E0              ; ---------- ---------- ---------- ---------- ----------
 161+ 89E0
 162+ 89E0 00 00 00     Caja_3 db 0,0,0											; (Tipo) / (Coordenada_X) / (Coordenada_Y).
 163+ 89E3 00           	db 0 												; (Contador_de_vueltas).
 164+ 89E4 00           	db 0												; (Impacto).
 165+ 89E5 00 00        	defw 0												; (Puntero_de_impresion).
 166+ 89E7 00 00        	defw 0												; (Puntero_de_almacen_de_mov_masticados).
 167+ 89E9 00 00        	defw 0 												; (Contador_de_mov_masticados).
 168+ 89EB 00           	db 0												; (Velocidad).
 169+ 89EC
 170+ 89EC              ; ---------- ---------- ---------- ---------- ----------
 171+ 89EC
 172+ 89EC 00 00 00     Caja_4 db 0,0,0											; (Tipo) / (Coordenada_X) / (Coordenada_Y).
 173+ 89EF 00           	db 0 												; (Contador_de_vueltas).
 174+ 89F0 00           	db 0												; (Impacto).
 175+ 89F1 00 00        	defw 0												; (Puntero_de_impresion).
 176+ 89F3 00 00        	defw 0												; (Puntero_de_almacen_de_mov_masticados).
 177+ 89F5 00 00        	defw 0 												; (Contador_de_mov_masticados).
 178+ 89F7 00           	db 0												; (Velocidad).
 179+ 89F8
 180+ 89F8              ; ---------- ---------- ---------- ---------- ----------
 181+ 89F8
 182+ 89F8 00 00 00     Caja_5 db 0,0,0											; (Tipo) / (Coordenada_X) / (Coordenada_Y).
 183+ 89FB 00           	db 0 												; (Contador_de_vueltas).
 184+ 89FC 00           	db 0												; (Impacto).
 185+ 89FD 00 00        	defw 0												; (Puntero_de_impresion).
 186+ 89FF 00 00        	defw 0												; (Puntero_de_almacen_de_mov_masticados).
 187+ 8A01 00 00        	defw 0 												; (Contador_de_mov_masticados).
 188+ 8A03 00           	db 0												; (Velocidad).
 189+ 8A04
 190+ 8A04              ; ---------- ---------- ---------- ---------- ----------
 191+ 8A04
 192+ 8A04 00 00 00     Caja_6 db 0,0,0											; (Tipo) / (Coordenada_X) / (Coordenada_Y)..
 193+ 8A07 00           	db 0 												; (Contador_de_vueltas).
 194+ 8A08 00           	db 0												; (Impacto).
 195+ 8A09 00 00        	defw 0												; (Puntero_de_impresion).
 196+ 8A0B 00 00        	defw 0												; (Puntero_de_almacen_de_mov_masticados).
 197+ 8A0D 00 00        	defw 0 												; (Contador_de_mov_masticados).
 198+ 8A0F 00           	db 0												; (Velocidad).
 199+ 8A10
 200+ 8A10              ; ---------- ---------- ---------- ---------- ----------
 201+ 8A10
 202+ 8A10 00 00 00     Caja_7 db 0,0,0											; (Tipo) / (Coordenada_X) / (Coordenada_Y)..
 203+ 8A13 00           	db 0 												; (Contador_de_vueltas).
 204+ 8A14 00           	db 0												; (Impacto).
 205+ 8A15 00 00        	defw 0												; (Puntero_de_impresion).
 206+ 8A17 00 00        	defw 0												; (Puntero_de_almacen_de_mov_masticados).
 207+ 8A19 00 00        	defw 0 												; (Contador_de_mov_masticados).
 208+ 8A1B 00           	db 0												; (Velocidad).
 209+ 8A1C
 210+ 8A1C              ; -------------------------------------------------------------------------------------
 211+ 8A1C              ;
 212+ 8A1C              ;	11/1/24
 213+ 8A1C              ;
 214+ 8A1C              ;	TIPOS de "Entidades maliciosas" que quieren conquistar la Tierra.
 215+ 8A1C              ;
 216+ 8A1C              ;	Notas de funcionamiento: (Cuad_objeto) siempre será "1" independientemente de su (Posicion_inicio).
 217+ 8A1C              ;		De no ser así, la rutina [Recompone_posicion_inicio] generará problemas a la hora de hacer que_
 218+ 8A1C              ;		_ la entidad aparezca `al píxel', por la parte derecha de la pantalla. Esto se debe a como están_
 219+ 8A1C              ;		_ construidas las rutinas [Mov_right] y [Mov_left].
 220+ 8A1C
 221+ 8A1C              Indice_de_definiciones_de_entidades
 222+ 8A1C
 223+ 8A1C 20 8A        	defw Entidad_1
 224+ 8A1E 2D 8A        	defw Entidad_2
 225+ 8A20
 226+ 8A20              ;	DEFINICIONES DE ENTIDADES. (20 Bytes).
 227+ 8A20
 228+ 8A20              ;	BADSAT, (Satélite malvado).
 229+ 8A20
 230+ 8A20 01 02 02     Entidad_1 db 1,2,2		                     			; (Tipo) / (Filas) / (Columns).
 231+ 8A23 01           	db 1												; (Contador_de_vueltas).
 232+ 8A24 60 85        	defw Indice_Badsat_der								; (Indice_Sprite_der).
 233+ 8A26 C0 83        	defw Indice_Badsat_izq								; (Indice_Sprite_izq).
 234+ 8A28 03 40        	defw $4003	                                     	; (Posicion_inicio).
 235+ 8A2A 01           	db 1												; (Cuad_objeto).
 236+ 8A2B 20 EB        	defw Almacen_de_movimientos_masticados_Entidad_1	; (Puntero_de_almacen_de_mov_masticados)
 237+ 8A2D
 238+ 8A2D 01 02 02     Entidad_2 db 1,2,2		                     			; (Tipo) / (Filas) / (Columns).
 239+ 8A30 01           	db 1												; (Contador_de_vueltas).
 240+ 8A31 60 85        	defw Indice_Badsat_der								; (Indice_Sprite_der).
 241+ 8A33 C0 83        	defw Indice_Badsat_izq								; (Indice_Sprite_izq).
 242+ 8A35 40 50        	defw $5040                                      	; (Posicion_inicio).
 243+ 8A37 01           	db 1												; (Cuad_objeto).
 244+ 8A38 20 EB        	defw Almacen_de_movimientos_masticados_Entidad_1	; (Puntero_de_almacen_de_mov_masticados)
 245+ 8A3A
 246+ 8A3A              ; -------------------------------------------------------------------------------------
 247+ 8A3A              ;
 248+ 8A3A              ;	28/05/24
 249+ 8A3A              ;
 250+ 8A3A              ;	Definición de Amadeus.
 251+ 8A3A              ;
 252+ 8A3A              ;	Amadeus no utiliza el parámetro: (Contador_de_vueltas). Lo colocamos a "0".
 253+ 8A3A              ;	Inicialmente situamos a Amadeus en el centro de la pantalla.
 254+ 8A3A
 255+ 8A3A 00 02 02     Definicion_Amadeus db 0,2,2		                     	; (Tipo) / (Filas) / (Columns).
 256+ 8A3D 00           	db 0												; (Contador_de_vueltas).
 257+ 8A3E F0 86        	defw Indice_Amadeus_der								; (Indice_Sprite_der).
 258+ 8A40 00 87        	defw Indice_Amadeus_izq								; (Indice_Sprite_izq).
 259+ 8A42 C1 50        	defw $50c1	                                     	; (Posicion_inicio).
 260+ 8A44 03           	db 3												; (Cuad_objeto).
 261+ 8A45 00 E0        	defw Almacen_de_movimientos_masticados_Amadeus		; (Puntero_de_almacen_de_mov_masticados).
# file closed: Cajas_y_disparos.asm
 143  8A47              	include "Patrones_de_mov.asm"
# file opened: Patrones_de_mov.asm
   1+ 8A47
   2+ 8A47
   3+ 8A47              ;   07/07/23
   4+ 8A47              ;
   5+ 8A47              ;   Base de datos. PATRONES DE MOVIMIENTO.
   6+ 8A47              ;
   7+ 8A47              ;   Codificación:
   8+ 8A47              ;
   9+ 8A47              ;   La descripción de un movimiento consta de 1 o más desplazamientos.
  10+ 8A47              ;
  11+ 8A47              ;   Un desplazamiento tiene la siguiente estructura:
  12+ 8A47              ;
  13+ 8A47              ;   (Byte1),(Byte2),(Byte3),(Cola_de_desplazamiento).   (4 Bytes).
  14+ 8A47              ;
  15+ 8A47              ;                       Los bytes 1 y 2 definen la velocidad del desplazamiento.
  16+ 8A47              ;
  17+ 8A47              ;                       (Byte1) ..... % (Vel_up),(Vel_down)
  18+ 8A47              ;                               ..... %01000010 Vel_up 4
  19+ 8A47              ;                                               Vel_down 2
  20+ 8A47              ;                               ..... $42
  21+ 8A47              ;
  22+ 8A47              ;                       (Byte2) ..... % (Vel_left),(Vel_right)
  23+ 8A47              ;
  24+ 8A47              ;                               ..... %01000010 Vel_left 4
  25+ 8A47              ;                                               Vel_right 2
  26+ 8A47              ;                               ..... $42
  27+ 8A47              ;
  28+ 8A47              ;                       El 3er byte describe la dirección y repeticiones del desplazamiento.
  29+ 8A47              ;
  30+ 8A47              ;                       (Byte3) ..... Descripción del desplazamiento.
  31+ 8A47              ;
  32+ 8A47              ;                       % up,down,left,right, Repetición del desplazamiento, (1-15).
  33+ 8A47              ;
  34+ 8A47              ;                                     %01010011 ..... (Abajo-derecha), 3 veces.
  35+ 8A47              ;                                     $53
  36+ 8A47              ;
  37+ 8A47              ;                       Nota: (Repetimos_desplazamiento) nunca será "0".
  38+ 8A47              ;
  39+ 8A47              ;                       Esta tabla nos ayudará a codificar rápido los desplazamientos del mov.
  40+ 8A47              ;                       Supongamos que solo ejecutamos 1 vez, cada desplazamiento:
  41+ 8A47              ;
  42+ 8A47              ;                       Arriba ..... $81
  43+ 8A47              ;                       Arriba - izquierda ..... $a1
  44+ 8A47              ;                       Arriba - derecha ..... $91
  45+ 8A47              ;
  46+ 8A47              ;                       Abajo ..... $41
  47+ 8A47              ;                       Abajo - izquierda ..... $61
  48+ 8A47              ;                       Abajo - derecha ..... $51
  49+ 8A47              ;
  50+ 8A47              ;   (Cola_de_desplazamiento) db 0			; Este byte indica:
  51+ 8A47              ;
  52+ 8A47              ;											;	"$00" , "0" ..... Hemos finalizado la cadena de movimiento.
  53+ 8A47              ;											;				En este caso hemos de incrementar (Puntero_indice_mov)_
  54+ 8A47              ;											;				_ y pasar a la siguiente cadena de movimiento del índice.
  55+ 8A47              ;
  56+ 8A47              ;											;	"$fd" , "1-253" ..... Repetición del MOVIMIENTO.
  57+ 8A47              ;											;						         Nº de veces que vamos a repetir el movimiento completo.
  58+ 8A47              ;											;					             En este caso, volveremos a inicializar (Puntero_mov),_
  59+ 8A47              ;							    			;						         _ con (Puntero_indice_mov) y decrementaremos (Cola_de_desplazamiento).
  60+ 8A47              ;
  61+ 8A47              ;											;	"$ff"  , "255" ..... Bucle infinito de repetición del último MOVIMIENTO.
  62+ 8A47              ;											;				         Nunca vamos a saltar a la siguiente cadena de movimiento del índice,_
  63+ 8A47              ;											;				         _ (si es que la hay). Volvemos a inicializar (Puntero_mov) con (Puntero_indice_mov).
  64+ 8A47              ;
  65+ 8A47              ;                                           ;   "$fe" ..... Activamos el bucle principal del patrón de movimiento. La direccíon de memoria_
  66+ 8A47              ;                                           ;               _ del siguiente MOVIMIENTO del índice se almacenará en la variable (Puntero_indice_mov_bucle).
  67+ 8A47              ;                                           ;               La subrutina [Inicializa_Puntero_indice_mov] inicializará (Puntero_indice_mov) con_
  68+ 8A47              ;                                           ;               _ esta dirección y no se situará al comienzo del índice del patrón de movimiento.
  69+ 8A47
  70+ 8A47              ; ----- ----- ----- ----- -----
  71+ 8A47
  72+ 8A47 73 8A        Indice_mov_Baile_de_BadSat defw Bajo_decelerando
  73+ 8A49 7B 8A            defw F_1
  74+ 8A4B 85 8A            defw F_2
  75+ 8A4D 8F 8A            defw Codo_abajo_derecha
  76+ 8A4F C3 8A            defw Derecha_y_subiendo
  77+ 8A51 CD 8A            defw Derecha_y_subiendo_1
  78+ 8A53 D7 8A            defw F_3
  79+ 8A55 E1 8A            defw F_4
  80+ 8A57 EB 8A            defw Derecha_y_bajando
  81+ 8A59 F5 8A            defw Derecha_y_bajando_1
  82+ 8A5B FF 8A            defw Derecha_y_bajando_2
  83+ 8A5D 09 8B            defw Codo_derecha_abajo
  84+ 8A5F 39 8B            defw Codo_abajo_izq.
  85+ 8A61 6D 8B            defw Izquierda_y_subiendo
  86+ 8A63 77 8B            defw Izquierda_y_subiendo_1
  87+ 8A65 81 8B            defw F_5
  88+ 8A67 8B 8B            defw F_6
  89+ 8A69 95 8B            defw Izquierda_y_bajando
  90+ 8A6B 9F 8B            defw Izquierda_y_bajando_1
  91+ 8A6D A9 8B            defw Izquierda_y_bajando_2
  92+ 8A6F B3 8B            defw Codo_izquierda_abajo
  93+ 8A71 00 00            defw 0                                  ; Fin de patrón de movimiento.
  94+ 8A73
  95+ 8A73 12 11 4F 01  Bajo_decelerando db $12,$11,$4f,1           ; Abajo (vel_2). 15rep.
  96+ 8A77 11 11 42 00      db $11,$11,$42,0                        ; Abajo.  2rep. --- Termina movimiento.
  97+ 8A7B
  98+ 8A7B 11 11 41 01  F_1 db $11,$11,$41,1
  99+ 8A7F 11 11 01 FD      db $11,$11,$01,253,8,0                  ; Abajo - Pausa1. 8rep.
  99+ 8A83 08 00
 100+ 8A85
 101+ 8A85 11 11 41 01  F_2 db $11,$11,$41,1
 102+ 8A89 11 11 02 FD      db $11,$11,$02,253,15,254               ; Abajo - Pausa2. 15rep --- Fija puntero de bucle. (Voy por aquí 23/7/23).
 102+ 8A8D 0F FE
 103+ 8A8F
 104+ 8A8F 11 11 51 01  Codo_abajo_derecha db $11,$11,$51,1         ; Abajo/Derecha. 1rep.
 105+ 8A93 11 11 43 01      db $11,$11,$43,1                        ; Abajo. 3rep.
 106+ 8A97 11 11 52 01      db $11,$11,$52,1                        ; Abajo/Derecha. 2rep.
 107+ 8A9B 11 11 41 01      db $11,$11,$41,1                        ; Abajo. 1rep.
 108+ 8A9F 11 11 52 01      db $11,$11,$52,1                        ; Abajo/Derecha. 2rep.
 109+ 8AA3 11 11 11 01      db $11,$11,$11,1                        ; Derecha. 1rep.s
 110+ 8AA7 11 11 52 01      db $11,$11,$52,1                        ; Abajo/Derecha. 2rep.
 111+ 8AAB 11 11 13 01      db $11,$11,$13,1                        ; Derecha. 3rep.
 112+ 8AAF 11 11 51 01      db $11,$11,$51,1                        ; Abajo/Derecha. 1rep.
 113+ 8AB3 11 12 12 01      db $11,$12,$12,1                        ; Derecha. 2rep. vel.2
 114+ 8AB7 11 11 91 01      db $11,$11,$91,1                        ; Arriba/Derecha. 1rep.
 115+ 8ABB 11 12 12 01      db $11,$12,$12,1                        ; Derecha. 2rep. vel.2
 116+ 8ABF 11 11 92 00      db $11,$11,$92,0                        ; Arriba/Derecha. 2rep. --- Termina movimiento.
 117+ 8AC3
 118+ 8AC3 11 12 13 01  Derecha_y_subiendo db $11,$12,$13,1         ; Derecha. 4rep. vel.2
 119+ 8AC7 11 11 91 FD      db $11,$11,$91,253,6,0                  ; Arriba/Derecha. 1rep. --- Repite Mov 12rep. --- Termina movimiento.
 119+ 8ACB 06 00
 120+ 8ACD
 121+ 8ACD 11 11 16 01  Derecha_y_subiendo_1 db $11,$11,$16,1       ; Derecha. 4rep. vel.2
 122+ 8AD1 11 11 91 FD      db $11,$11,$91,253,2,0                  ; Arriba/Derecha. 1rep. --- Repite Mov 12rep. --- Termina movimiento.
 122+ 8AD5 02 00
 123+ 8AD7
 124+ 8AD7 11 11 11 01  F_3 db $11,$11,$11,1
 125+ 8ADB 11 11 01 FD      db $11,$11,$01,253,4,0
 125+ 8ADF 04 00
 126+ 8AE1
 127+ 8AE1 11 11 11 01  F_4 db $11,$11,$11,1
 128+ 8AE5 11 11 02 FD      db $11,$11,$02,253,8,0
 128+ 8AE9 08 00
 129+ 8AEB
 130+ 8AEB 11 11 16 01  Derecha_y_bajando db $11,$11,$16,1          ; Derecha. 4rep. vel.2
 131+ 8AEF 11 11 51 FD      db $11,$11,$51,253,2,0
 131+ 8AF3 02 00
 132+ 8AF5
 133+ 8AF5 11 12 13 01  Derecha_y_bajando_1 db $11,$12,$13,1        ; Derecha. 4rep. vel.2
 134+ 8AF9 11 11 51 FD      db $11,$11,$51,253,6,0
 134+ 8AFD 06 00
 135+ 8AFF
 136+ 8AFF 11 11 16 01  Derecha_y_bajando_2 db $11,$11,$16,1        ; Derecha. 4rep. vel.2
 137+ 8B03 11 11 51 FD      db $11,$11,$51,253,6,0
 137+ 8B07 06 00
 138+ 8B09
 139+ 8B09              ; Medio círculo bajando. Entra de izq. a derecha y sale de derecha a izq.
 140+ 8B09
 141+ 8B09 11 11 51 01  Codo_derecha_abajo db $11,$11,$51,1         ; Abajo/Derecha. 1rep.
 142+ 8B0D 11 11 13 01      db $11,$11,$13,1                        ; Derecha. 3rep.
 143+ 8B11 11 11 51 01      db $11,$11,$51,1                        ; Abajo/Derecha. 1rep.
 144+ 8B15 11 11 13 01      db $11,$11,$13,1                        ; Derecha. 3rep.
 145+ 8B19 11 11 52 01      db $11,$11,$52,1                        ; Abajo/Derecha. 2rep.
 146+ 8B1D 11 11 11 01      db $11,$11,$11,1                        ; Derecha. 1rep.
 147+ 8B21 11 11 52 01      db $11,$11,$52,1                        ; Abajo/Derecha. 2rep.
 148+ 8B25 11 11 41 01      db $11,$11,$41,1                        ; Abajo. 1rep.
 149+ 8B29 11 11 52 01      db $11,$11,$52,1                        ; Abajo/Derecha. 2rep.
 150+ 8B2D 11 11 43 01      db $11,$11,$43,1                        ; Abajo. 3rep.
 151+ 8B31 11 11 51 01      db $11,$11,$51,1                        ; Abajo/Derecha. 1rep.
 152+ 8B35 11 11 43 00      db $11,$11,$43,0                        ; Abajo. 3rep.
 153+ 8B39
 154+ 8B39 11 11 61 01  Codo_abajo_izq. db $11,$11,$61,1            ; Abajo/izq. 1rep.
 155+ 8B3D 11 11 43 01      db $11,$11,$43,1                        ; Abajo. 3rep.
 156+ 8B41 11 11 62 01      db $11,$11,$62,1                        ; Abajo/izq. 2rep.
 157+ 8B45 11 11 41 01      db $11,$11,$41,1                        ; Abajo. 1rep.
 158+ 8B49 11 11 62 01      db $11,$11,$62,1                        ; Abajo/izq. 2rep.
 159+ 8B4D 11 11 21 01      db $11,$11,$21,1                        ; izq. 1rep.
 160+ 8B51 11 11 62 01      db $11,$11,$62,1                        ; Abajo/izq. 2rep.
 161+ 8B55 11 11 23 01      db $11,$11,$23,1                        ; izq. 3rep.
 162+ 8B59 11 11 61 01      db $11,$11,$61,1                        ; Abajo/izq. 1rep.
 163+ 8B5D 11 21 22 01      db $11,$21,$22,1                        ; izq. 2rep. vel.2
 164+ 8B61 11 11 A1 01      db $11,$11,$a1,1                        ; Arriba/izq. 1rep.
 165+ 8B65 11 21 22 01      db $11,$21,$22,1                        ; izq. 2rep. vel.2
 166+ 8B69 11 11 A2 00      db $11,$11,$a2,0                        ; Arriba/izq. 2rep. --- Termina movimiento.
 167+ 8B6D
 168+ 8B6D 11 21 23 01  Izquierda_y_subiendo db $11,$21,$23,1       ; Derecha. 4rep. vel.2
 169+ 8B71 11 11 A1 FD      db $11,$11,$a1,253,6,0                  ; Arriba/Derecha. 1rep. --- Repite Mov 12rep. --- Termina movimiento.
 169+ 8B75 06 00
 170+ 8B77
 171+ 8B77 11 11 26 01  Izquierda_y_subiendo_1 db $11,$11,$26,1     ; Derecha. 4rep. vel.2
 172+ 8B7B 11 11 A1 FD      db $11,$11,$a1,253,2,0                  ; Arriba/Derecha. 1rep. --- Repite Mov 12rep. --- Termina movimiento.
 172+ 8B7F 02 00
 173+ 8B81
 174+ 8B81 11 11 21 01  F_5 db $11,$11,$21,1
 175+ 8B85 11 11 01 FD      db $11,$11,$01,253,4,0
 175+ 8B89 04 00
 176+ 8B8B
 177+ 8B8B 11 11 21 01  F_6 db $11,$11,$21,1
 178+ 8B8F 11 11 02 FD      db $11,$11,$02,253,8,0
 178+ 8B93 08 00
 179+ 8B95
 180+ 8B95 11 11 26 01  Izquierda_y_bajando db $11,$11,$26,1          ; Derecha. 4rep. vel.2
 181+ 8B99 11 11 61 FD      db $11,$11,$61,253,2,0
 181+ 8B9D 02 00
 182+ 8B9F
 183+ 8B9F 11 21 23 01  Izquierda_y_bajando_1 db $11,$21,$23,1        ; Derecha. 4rep. vel.2
 184+ 8BA3 11 11 61 FD      db $11,$11,$61,253,6,0
 184+ 8BA7 06 00
 185+ 8BA9
 186+ 8BA9 11 11 26 01  Izquierda_y_bajando_2 db $11,$11,$26,1        ; Derecha. 4rep. vel.2
 187+ 8BAD 11 11 61 FD      db $11,$11,$61,253,6,0
 187+ 8BB1 06 00
 188+ 8BB3
 189+ 8BB3 11 11 A1 01  Codo_izquierda_abajo db $11,$11,$a1,1          ; Arriba/Izq. 1rep.
 190+ 8BB7 11 11 23 01      db $11,$11,$23,1                           ; Izq. 3rep.
 191+ 8BBB 11 11 61 01      db $11,$11,$61,1                           ; Abajo/Izq. 1rep.
 192+ 8BBF 11 11 23 01      db $11,$11,$23,1                           ; Izq. 3rep.
 193+ 8BC3 11 11 62 01      db $11,$11,$62,1                           ; Abajo/Izq. 2rep.
 194+ 8BC7 11 11 21 01      db $11,$11,$21,1                           ; Izq. 1rep.
 195+ 8BCB 11 11 62 01      db $11,$11,$62,1                           ; Abajo/Izq. 2rep.
 196+ 8BCF 11 11 41 01      db $11,$11,$41,1                           ; Abajo. 1rep.
 197+ 8BD3 11 11 62 01      db $11,$11,$62,1                           ; Abajo/Izq. 2rep.
 198+ 8BD7 11 11 43 01      db $11,$11,$43,1                           ; Abajo. 3rep.
 199+ 8BDB 11 11 61 01      db $11,$11,$61,1                           ; Abajo/Izq. 1rep.
 200+ 8BDF 11 11 43 00      db $11,$11,$43,0                           ; Abajo. 3rep.
 201+ 8BE3
 202+ 8BE3
 203+ 8BE3
 204+ 8BE3
 205+ 8BE3
 206+ 8BE3
 207+ 8BE3
 208+ 8BE3
 209+ 8BE3
 210+ 8BE3
# file closed: Patrones_de_mov.asm
 144  8BE3              	include "Niveles.asm"
# file opened: Niveles.asm
   1+ 8BE3              ; 19/1/24
   2+ 8BE3
   3+ 8BE3              Indice_de_niveles
   4+ 8BE3
   5+ 8BE3 EB 8B        	defw Nivel_1
   6+ 8BE5 F6 8B        	defw Nivel_2
   7+ 8BE7
   8+ 8BE7              ;	...
   9+ 8BE7              ;	...
  10+ 8BE7              ;	+ Niveles ...
  11+ 8BE7
  12+ 8BE7 00 00        	defw 0
  13+ 8BE9 00 00        	defw 0
  14+ 8BEB
  15+ 8BEB 06           Nivel_1 db 6									; Nº de entidades.
  16+ 8BEC 01 01 01 01  	db 1,1,1,1	                                ; Velocidades. Vel_left, Vel_right, Vel_up, Vel_downa. (1, 2, 4 u 8 px).
  17+ 8BF0 01 01 01 01  	db 1,1,1,1,1,1								; Tipo de entidad que vamos a introducir en las 7 cajas de DRAW.
  17+ 8BF4 01 01
  18+ 8BF6
  19+ 8BF6 0C           Nivel_2 db 12									; Nº de entidades.
  20+ 8BF7 01 01 01 02  	db 1,1,1,2									; Velocidades. Vel_left, Vel_right, Vel_up, Vel_downa. (1, 2, 4 u 8 px).
  21+ 8BFB 02 01 01 01  	db 2,1,1,1,1,2								; Tipo de entidad que vamos a introducir en las 7 cajas de DRAW.
  21+ 8BFF 01 02
  22+ 8C01 02 01 01 01  	db 2,1,1,1,1,2
  22+ 8C05 01 02
  23+ 8C07
# file closed: Niveles.asm
 145  8C07
 146  8C07              ; --------------------------------------------------------------------------------
 147  8C07              ;
 148  8C07              ; 12/05/24
 149  8C07              ;
 150  8C07              ; Parámetros DRAW.
 151  8C07              ;
 152  8C07
 153  8C07              Bandeja_DRAW ; -----------------------------------------------------------------------------------------------
 154  8C07
 155  8C07 00           Tipo db 0												; Clase de la entidad. Cada `tipo´ de Entidad tiene unas características únicas que lo distinguen de otros tipos:
 156  8C08              ;															- Patrón de movimiento.
 157  8C08 00           Coordenada_X db 0 										; Coordenada X del objeto. (En chars.)
 158  8C09 00           Coordenada_y db 0 										; Coordenada Y del objeto. (En chars.)
 159  8C0A
 160  8C0A 00           Contador_de_vueltas db 0								; Contador de vueltas de entidades. Inicialmente su valor es "1". El bit se desplaza una posición a la izquierda cada vez que la entidad_
 161  8C0B              ;														; _desaparece por la parte baja de la pantalla. Esta variable se utiliza para incrementar el perfil de velocidad de las entidades.
 162  8C0B
 163  8C0B              ; Incrementa el contador de vueltas, (el contador cuenta 4 vueltas máximo).
 164  8C0B              ; El perfil de velocidad de la entidad será: (Contador_de_vueltas)/8.
 165  8C0B              ; Ejemplos.
 166  8C0B
 167  8C0B              ;	1ª vuelta: (Contador_de_vueltas)="$02" --- (Velocidad)="0".
 168  8C0B              ;	2ª vuelta: 	""	""	""	""	""  ="$04" ---   ""	 ""	  ="1".
 169  8C0B              ;	3ª vuelta: 	""	""	""	""	""  ="$08" ---   ""	 ""	  ="2".
 170  8C0B              ;	4ª vuelta: 	""	""	""	""	""  ="$10" ---   ""	 ""	  ="4".
 171  8C0B              ;	5ª vuelta: 	""	""	""	""	""  ="$20" ---   ""	 ""	  ="8".
 172  8C0B
 173  8C0B 00           Impacto db 0											; Si después del movimiento de la entidad, (Impacto) se coloca a "1",_
 174  8C0C              ;														; _ existen muchas posibilidades de que esta entidad haya colisionado con Amadeus.
 175  8C0C              ; 														; Hay que comprobar la posible colisión después de mover Amadeus. En este caso, (Impacto2)="3".
 176  8C0C
 177  8C0C 00 00        Puntero_de_impresion defw 0								; Contiene el puntero de impresión, (calculado por DRAW). Esta dirección la utilizará la rutina_
 178  8C0E              ;														; _ [Guarda_coordenadas_X] y [Compara_coordenadas_X] para detectar la colisión ENTIDAD-AMADEUS.
 179  8C0E
 180  8C0E 00 00        Puntero_de_almacen_de_mov_masticados defw 0
 181  8C10
 182  8C10              ;	Almacén donde la entidad guía va guardando comportamiento ya calculado, (rutinas DRAW).
 183  8C10              ;	Almacén donde una entidad "sombra" recoge el siguiente desplazamiento ya masticado, (para imprimir).
 184  8C10
 185  8C10 00 00        Contador_de_mov_masticados defw 0						; Contador de 16bits. La "Entidad_guía" lo aumenta en una unidad cada vez que hace el "pushado" de las tres_
 186  8C12              ;														; _palabras que componen el "movimiento_masticado".
 187  8C12
 188  8C12              ; Variables de funcionamiento de las rutinas de movimiento. (Mov_left), (Mov_right), (Mov_up), (Mov_down).
 189  8C12
 190  8C12 00           Velocidad db 0 											; 5 vueltas max. 5 vueltas       1 - 0 (1ª vuelta - velocidad 0)
 191  8C13              ;																						 2 - 0 (2ª vuelta - velocidad 0)
 192  8C13              ;																						 4 - 1 (3ª vuelta - velocidad 1)
 193  8C13              ;																						 8 - 2 (4ª vuelta - velocidad 2)
 194  8C13              ;																					   $10 - 4 (5ª vuelta - velocidad 3)
 195  8C13
 196  8C13 00           Ctrl_2 db 0
 197  8C14              ;														BIT 0, Los sprites se inician con un `sprite vacío', (sprite formado por "ceros"), cuando la rutina_
 198  8C14              ;															_ [Genera_datos_de_impresion] guarda su 1ª imagen.
 199  8C14              ;															_ Más adelante las rutinas [Mov_left] y [Mov_right] restauraran (Puntero_objeto). Si el 1er movimiento
 200  8C14              ; 															_ que hace la entidad después de iniciarse es hacia arriba/abajo no se restaurará (Puntero_objeto), pués_
 201  8C14              ; 															_ las rutinas [Mov_up] y [Mov_down] no necesitan modificar el sprite.
 202  8C14              ;															_ El bit5 a "1" nos indica que el sprite se inicia por arriba o por abajo y por lo tanto hay que restaurar_
 203  8C14              ;															_ (Puntero_objeto) con (Repone_puntero_objeto) una vez iniciado y realizada su 1ª `foto'.
 204  8C14              ;
 205  8C14              ;														BIT 1, Este bit a "1" indica que se ha iniciado el proceso de EXPLOSIÓN en una entidad.
 206  8C14              ;														BIT 2, Este bit es activado por [Movimiento]. Indica que hemos `iniciado un desplazamiento'._
 207  8C14              ;															_ Evita que volvamos a iniciar el desplazamiento cada vez que ejecutemos [Movimiento].
 208  8C14              ;														BIT 3, Indica que (Cola_de_desplazamiento)="254". Esto quiere decir que repetiremos (1-255 veces),_
 209  8C14              ;															_ el último MOVIMIENTO que hayamos ejecutado.
 210  8C14              ;														BIT 4, ???
 211  8C14              ;														BIT 5, Este bit a "1" indica que esta entidad es una "Entidad_guía".
 212  8C14
 213  8C14 00           Ctrl_0 db 0 											; Byte de control. A través de este byte de control. Las rutinas de desplazamiento: [Mov_right], [Mov_left], [Mov_up] y [Mov_down],_
 214  8C15              ;														; _indican a las subrutinas de recolocación del objeto de la rutina [DRAW]: [Comprueba_limite_horizontal] y [Comprueba_limite_vertical],_
 215  8C15              ; 														; _que desaparecemos por un extremo de la pantalla y hemos de `reaparecer´ por el contrario.
 216  8C15              ; 														; Este dato es necesario debido a que las rutinas de recolocación, están ideadas para recolocar el puntero (Posicion_actual), cuando pasamos_
 217  8C15              ; 														; _de un cuadrante a otro de la pantalla pero no preveen la `desaparición´ por un extremo del cuadrante y la `reaparición´ por el otro.
 218  8C15              ;
 219  8C15              ; 														DESCRIPCIÖN:
 220  8C15              ;
 221  8C15              ; 														SET 0, [Reaparece_derecha]. El bit 0 de (Ctrl_0) se coloca a "1" cuando la rutina [Mov_left] detecta que el objeto ha `desaparecido´ por el_
 222  8C15              ; 																_lado izquierdo de la pantalla y ha de `reaparecer´ por el derecho. ([Comprueba_limite_vertical]).
 223  8C15              ; 														SET 1, [Reaparece_izquierda]. El bit 1 de (Ctrl_0) se coloca a "1" cuando la rutina [Mov_right] detecta que el objeto ha `desaparecido´ por el_
 224  8C15              ; 																_lado derecho de la pantalla y ha de `reaparecer´ por el izquierdo. ([Comprueba_limite_vertical]).
 225  8C15              ; 														SET 2, [Reaparece_abajo]. El bit 2 de (Ctrl_0) se coloca a "1" cuando la rutina [Mov_up] detecta que el objeto ha `desaparecido´ por la_
 226  8C15              ; 																_parte superior de la pantalla y ha de `reaparecer´ por el inferior. ([Comprueba_limite_horizontal]).
 227  8C15              ; 														SET 3, [Reaparece_arriba]. El bit 3 de (Ctrl_0) se coloca a "1" cuando la rutina [Mov_down] detecta que el objeto ha `desaparecido´ por la_
 228  8C15              ; 																_parte inferior de la pantalla y ha de `reaparecer´ por la superior. ([Comprueba_limite_horizontal]).
 229  8C15              ; 														SET 4, El Bit4 a "1", indica que hubo movimiento de la entidad. Necesitamos esta información
 230  8C15              ;												                _para "NO BORRAR/PINTAR" en objeto si NO hubo MOVIMIENTO.
 231  8C15              ;														SET 5, La rutina [Inicializacion] de Draw_XOR.asm, pone este bit a "1". Con esta información evitamos ejecutar las
 232  8C15              ;																_rutinas: (Comprueba_limite_horizontal) y (Comprueba_limite_vertical) justo después de `inicializar´ un objeto.
 233  8C15              ; 														SET 6, Está a "1" si el Sprite que tenemos cargado en el `Engine´ es AMADEUS.
 234  8C15              ;
 235  8C15              ; 														SET 7, El bit 7 se encuentra alto, ("1"), cuando el último movimiento horizontal se ha producido a la "DERECHA".
 236  8C15              ; 															   _ Utilizo la información que proporciona este BIT para modificar (CTRL_DESPLZ) si el siguiente movimiento_
 237  8C15              ; 															   _ se va a producir a la izquierda. "1" DERECHA - "0" IZQUIERDA.
 238  8C15
 239  8C15              ; ----- ----- De aquí para arriba son los datos que se trasfieren a las cajas de entidades. ¡¡¡¡¡
 240  8C15
 241  8C15 00           Filas db 0												; Filas. [DRAW]
 242  8C16 00           Columns db 0 	  										; Nº de columnas. [DRAW]
 243  8C17 00 00        Posicion_actual defw 0									; Dirección actual del Sprite. [DRAW]
 244  8C19 00 00        Puntero_objeto defw 0									; Donde están los datos para pintar el Sprite.
 245  8C1B
 246  8C1B              ; ---------- ---------- ---------- ---------;      ;--------- ---------- ---------- ----------
 247  8C1B
 248  8C1B 00           CTRL_DESPLZ db 0										; Este byte nos indica la posición que tiene el Sprite dentro del mapa de desplazamientos.
 249  8C1C              ; 														; El hecho de que este byte sea distinto de "0", indica que se ha modificado el nº de columnas del objeto.
 250  8C1C              ; 														; Cuando vamos a imprimir un Sprite en pantalla, la rutina de pintado consultará este byte para situar (Puntero_objeto). [Mov_left].
 251  8C1C
 252  8C1C              ; ---------- ---------- ---------- ---------;      ;--------- ---------- ---------- ----------
 253  8C1C
 254  8C1C              ;	El formato: FBPPPIII (Flash, Brillo, Papel, Tinta).
 255  8C1C              ;
 256  8C1C              ;	COLORES: 0 ..... NEGRO
 257  8C1C              ;    		 1 ..... AZUL
 258  8C1C              ; 			 2 ..... ROJO
 259  8C1C              ;			 3 ..... MAGENTA
 260  8C1C              ; 			 4 ..... VERDE
 261  8C1C              ; 			 5 ..... CIAN
 262  8C1C              ;			 6 ..... AMARILLO
 263  8C1C              ; 			 7 ..... BLANCO
 264  8C1C
 265  8C1C 00 00        Indice_Sprite_der defw 0
 266  8C1E 00 00        Indice_Sprite_izq defw 0
 267  8C20 00 00        Puntero_DESPLZ_der defw 0
 268  8C22 00 00        Puntero_DESPLZ_izq defw 0
 269  8C24
 270  8C24 00 00        Posicion_inicio defw 0									; Dirección de pantalla donde aparece el objeto. [DRAW].
 271  8C26 00           Cuad_objeto db 0										; Almacena el cuadrante de pantalla donde se encuentra el objeto, (1,2,3,4). [DRAW]
 272  8C27 00           Columnas db 0
 273  8C28 00 00        Limite_horizontal defw 0 								; Dirección de pantalla, (scanline), calculado en función del tamaño del Sprite. Si el objeto llega a esta línea se modifica_
 274  8C2A              ; 														; _(Posicion_actual) para poder asignar un nuevo (Cuad_objeto).
 275  8C2A 00           Limite_vertical db 0 									; Nº de columna. Si el objeto llega a esta columna se modifica (Posicion_actual) para poder asignar un nuevo (Cuad_objeto).
 276  8C2B
 277  8C2B              ; variables de control general.
 278  8C2B
 279  8C2B 00           Frames_explosion db 0 									; Nº de Frames que tiene la explosión.
 280  8C2C
 281  8C2C              ; Variables de funcionamiento, (No incluidas en base de datos de entidades), a partir de aquí!!!!!
 282  8C2C
 283  8C2C              Perfiles_de_velocidad
 284  8C2C
 285  8C2C 00           Vel_left db 0 											; Velocidad izquierda. Nº de píxeles que desplazamos el objeto a izquierda. 1, 2, 4 u 8 px.
 286  8C2D 00           Vel_right db 0 											; Velocidad derecha. Nº de píxeles que desplazamos el objeto a derecha. 1, 2, 4 u 8 px.
 287  8C2E 00           Vel_up db 0 											; Velocidad subida. Nº de píxeles que desplazamos el objeto hacia arriba. (De 1 a 7px).
 288  8C2F 00           Vel_down db 0 											; Velocidad bajada. Nº de píxeles que desplazamos el objeto hacia abajo. (De 1 a 7px).
 289  8C30
 290  8C30              ; Contadores de 16 bits.
 291  8C30
 292  8C30 00 00        Contador_general_de_mov_masticados_Entidad_1 defw 0
 293  8C32 00 00        Contador_general_de_mov_masticados_Entidad_2 defw 0
 294  8C34 00 00        Contador_general_de_mov_masticados_Entidad_3 defw 0
 295  8C36 00 00        Contador_general_de_mov_masticados_Entidad_4 defw 0
 296  8C38
 297  8C38              ; Movimiento. ------------------------------------------------------------------------------------------------------
 298  8C38
 299  8C38 00 00        Puntero_indice_mov defw 0							    ; Puntero índice del patrón de movimiento de la entidad. "0" No hay movimiento.
 300  8C3A 00 00        Puntero_mov defw 0										; Guarda la posición de memoria en la que nos encontramos dentro de la cadena de movimiento.
 301  8C3C 00 00        Puntero_indice_mov_bucle defw 0							;
 302  8C3E              ;
 303  8C3E              ;
 304  8C3E 00           Incrementa_puntero db 0									; Byte que iremos sumando a (Puntero_indice_mov) para ir escalando por las_
 305  8C3F              ;														; _ distintas cadenas de movimiento del índice de movimiento de la entidad._
 306  8C3F              ;														; Va aumentando su valor en saltos de 2 uds, (0,2,4,6,8).
 307  8C3F 00           Incrementa_puntero_backup db 0
 308  8C40 00           Repetimos_desplazamiento db 0							; El nibble bajo del 3er byte que compone un desplazamiento, indica el nº de veces que_
 309  8C41              ;														; repetimos dicho desplazamiento. Ese valor se almacena en esta variable, ($1-$f). NUNCA SERÁ "0".
 310  8C41 00           Repetimos_desplazamiento_backup db 0					; Restaura (Repetimos_desplazamiento) cuando este llega a "0".
 311  8C42 00           Repetimos_movimiento db 0								; Byte que indica el nº de veces que repetimos el último MOVIMIENTO.
 312  8C43 00           Cola_de_desplazamiento db 0								; Este byte indica:
 313  8C44              ;
 314  8C44              ;														;	"$00" ..... Hemos finalizado la cadena de movimiento.
 315  8C44              ;														;				En este caso hemos de incrementar (Puntero_indice_mov)_
 316  8C44              ;														;				_ y pasar a la siguiente cadena de movimiento del índice.
 317  8C44              ;
 318  8C44              ;														;	"$01 - "$fe" ..... Repetición del movimiento.
 319  8C44              ;														;						Nº de veces que vamos a repetir el movimiento completo.
 320  8C44              ;														;						En este caso, volveremos a inicializar (Puntero_mov),_
 321  8C44              ;														;						_ con (Puntero_indice_mov) y decrementaremos (Cola_de_desplazamiento).
 322  8C44              ;
 323  8C44              ;														;	"$ff" ..... Bucle infinito de repetición.
 324  8C44              ;														;				Nunca vamos a saltar a la siguiente cadena de movimiento del índice,_
 325  8C44              ;														;				,_ (si es que la hay). Volvemos a inicializar (Puntero_mov) con (Puntero_indice_mov).
 326  8C44
 327  8C44 00           Ctrl_1 db 0 											; Byte de control de propósito general.
 328  8C45
 329  8C45              ;														DESCRIPCIÓN:
 330  8C45              ;
 331  8C45              ;														BIT 0, La rutina de generación de disparos, [Genera_disparo], pone este bit a "1" para indicar a la_
 332  8C45              ;															_ rutina [Genera_datos_de_impresion] que los datos a guardar pertenecen a un disparo y no a una entidad,_
 333  8C45              ;															_ por lo tanto hemos de almacenarlos en `Scanlines_album_disparos´ en lugar de `Scanlines_album´.
 334  8C45              ;														BIT 1, Este bit indica que el disparo sale de la pantalla, ($4000-$57ff).
 335  8C45              ;														BIT 2, Este bit a "1" indica que un disparo de Amadeus ha alcanzado a una entidad. Como no sabemos cual,_
 336  8C45              ;															_ hemos de comparar las coordenadas de (Coordenadas_disparo_certero) con las de cada entidad.
 337  8C45
 338  8C45              ;														BIT 3, Recarga de nueva oleada.
 339  8C45              ;														BIT 4, Recarga de nueva oleada.
 340  8C45              ;														BIT 5, FREEEEEEEEE !!!!!!!!!!!!!!!!!
 341  8C45              ;														BIT 6, **** Frame completo.
 342  8C45              ;														BIT 7, Indica que ya está tomada la foto de Amadeus. No tomaremos otra hasta el próximo FRAME.
 343  8C45
 344  8C45 00 00        Repone_puntero_objeto defw 0							; Almacena (Puntero_objeto). Cuando el Sprite se inicia por arriba o por abajo,_
 345  8C47              ; 														; _ hay que sustituirlo por un `sprite vacío' para que no se vea el 1er o último scanline.
 346  8C47              ; 														; _ Cuando hemos terminado de iniciarlo y guardado su foto, hemos de recuperar su (Puntero_objeto).
 347  8C47              ;														; (Repone_puntero_objeto) es una copia de respaldo de (Puntero_objeto) y su función es restaurarlo.
 348  8C47
 349  8C47              ; Gestión de ENTIDADES y CAJAS.
 350  8C47
 351  8C47 00 00        Puntero_store_caja defw 0
 352  8C49 00 00        Puntero_restore_caja defw 0
 353  8C4B 00 00        Indice_restore_caja defw 0
 354  8C4D 00           Numero_de_entidades db 0								; Nº total de entidades maliciosas que contiene el nivel.
 355  8C4E 07           Numero_parcial_de_entidades db 7						; Nº de cajas que contiene un bloque de entidades. (7 Cajas).
 356  8C4F 00           Entidades_en_curso db 0									; ..... ..... .....
 357  8C50              ;Numero_de_malotes db 0									; Inicialmente, (Numero_de_malotes)=(Numero_de_entidades).
 358  8C50              ;														; Esta variable es utilizada por la rutina [Genera_datos_de_impresion]_
 359  8C50              ;														; _ para actualizar el puntero (Scanlines_album_SP) o reiniciarlo cuando_
 360  8C50              ;														; _ (Numero_de_malotes)="0".
 361  8C50 00 00        Puntero_indice_ENTIDADES defw 0 						; Se desplazará por el índice de entidades para `meterlas' en cajas.
 362  8C52 00 00        Datos_de_entidad defw 0									; Contiene los bytes de información de la entidad hacia la que apunta el
 363  8C54              ;														; _ puntero (Indice_entidades).
 364  8C54
 365  8C54              ;---------------------------------------------------------------------------------------------------------------
 366  8C54              ;
 367  8C54              ;	12/08/24
 368  8C54              ;
 369  8C54              ;	Álbumes.
 370  8C54
 371  8C54 00 00        Stack defw 0 											; La rutinas de pintado, utilizan esta_
 372  8C56              ;														; _variable para almacenar lo posición del puntero_
 373  8C56              ; 														; _de pila, SP.
 374  8C56 00 00        Stack_2 defw 0											; 2º variable destinada a almacenar el puntero de pila, SP.
 375  8C58              ;														; La utiliza la rutina [Extrae_foto_registros].
 376  8C58
 377  8C58              ; Impresión. ----------------------------------------------------------------------------------------------------
 378  8C58
 379  8C58 00 00        Album_de_pintado defw 0
 380  8C5A 00 00        Album_de_borrado defw 0
 381  8C5C 00 00        Album_de_pintado_Amadeus defw 0
 382  8C5E 00 00        Album_de_borrado_Amadeus defw 0
 383  8C60 00 00        Techo_Scanlines_album defw 0
 384  8C62 00 00        Techo_Scanlines_album_2 defw 0
 385  8C64 00           Switch db 0
 386  8C65 00 00        Techo defw 0
 387  8C67 00 00        Scanlines_album_SP defw 0
 388  8C69 37 89        India_SP defw Tabla_de_pintado
 389  8C6B 3A 89        India_2_SP defw Tabla_de_pintado+3
 390  8C6D
 391  8C6D 00           Ctrl_3 db 0												; 2º Byte de Ctrl. general, (no específico) a una única entidad.
 392  8C6E              ;
 393  8C6E              ;															BIT 0, "1" Indica que el FRAME está completo, (hemos podido hacer la foto de todas las entidades).
 394  8C6E              ;															BIT 1, "1" Indica que hemos completado todo el patrón de movimientos de este tipo de entidad.
 395  8C6E              ;																_ El almacén de movimientos masticados de este tipo de entidad quedará completo. ([Inicia_entidad]).
 396  8C6E              ;															BIT 2, "1" Indica que se produce movimiento en alguna entidad, (modificamos el último FRAME impreso en pantalla).
 397  8C6E              ;																Habilita el borrado/pintado de sprites.
 398  8C6E              ;															BIT 3, "1" Este bit lo coloca a "1" la rutina [Borra_diferencia] para indicar que hemos actualizado el (Techo_de_pintado)_
 399  8C6E              ;																_ a la baja.
 400  8C6E              ; 															BIT 4, "1" Indica que hemos terminado de ordenar la Tabla_de_pintado. Podremos salir así de la rutina [Ordena_tabla_de_impresion].
 401  8C6E              ;															BIT 5, "1" Indica que existe movimiento de Amadeus.
 402  8C6E              ;															BIT 6, "1" Indica que Amadeus ha sido destruido. Este bit lo activa la rutina [Genera_explosion_Amadeus] despues de pintar_
 403  8C6E              ; 																_ el último frame de la explosión de nuestra nave.
 404  8C6E              ;															BIT 7, "1" Indica que se ha iniciado el proceso de explosión en Amadeus.
 405  8C6E              ;																_ Mientras este bit este activo, no se generarán dos explosiones de entidades a la vez.
 406  8C6E
 407  8C6E 00           Ctrl_4 db 0 											; 3er Byte de Ctrl. general, (no específico) a una única entidad. Lo utiliza la rutina [Inicia_entidad].
 408  8C6F              ;
 409  8C6F              ;                                                           Los bits (0-3) indican el (Tipo) de entidad que estamos iniciando.
 410  8C6F              ;
 411  8C6F              ;                                                          	BIT 0 (Ctrl_4) ..... Entidad de (Tipo)_1.
 412  8C6F              ;															BIT 1 (Ctrl_4) ..... Entidad de (Tipo)_2.
 413  8C6F              ;	                                                        BIT 2 (Ctrl_4) ..... Entidad de (Tipo)_3.
 414  8C6F              ;	                                                        BIT 3 (Ctrl_4) ..... Entidad de (Tipo)_4.
 415  8C6F              ;
 416  8C6F              ;															Los bits (4-7) indican que (Tipo) de entidad tiene todos sus movimientos_
 417  8C6F              ;															_ masticados ya generados.
 418  8C6F              ;
 419  8C6F              ;															BIT 4 (Ctrl_4) ..... MOV_MASTICADOS GENERADOS. Entidad de (Tipo)_1.
 420  8C6F              ;															BIT 5 (Ctrl_4) ..... MOV_MASTICADOS GENERADOS. Entidad de (Tipo)_2.
 421  8C6F              ;	                                                        BIT 6 (Ctrl_4) ..... MOV_MASTICADOS GENERADOS. Entidad de (Tipo)_3.
 422  8C6F              ;	                                                        BIT 7 (Ctrl_4) ..... MOV_MASTICADOS GENERADOS. Entidad de (Tipo)_4.
 423  8C6F
 424  8C6F
 425  8C6F              ; Gestión de Disparos.
 426  8C6F
 427  8C6F              ;Numero_de_disparotes db 0
 428  8C6F
 429  8C6F 00 00        Puntero_DESPLZ_DISPARO_ENTIDADES defw 0
 430  8C71 00 00        Puntero_DESPLZ_DISPARO_AMADEUS defw 0
 431  8C73
 432  8C73 00           Impacto2 db 0											; Byte de control de impactos.
 433  8C74
 434  8C74              ;
 435  8C74              ;														; bit_2. La rutina [Genera_coordenadas_X] coloca este bit a "1" para indicar que hay una posible colisión entre una entidad y Amadeus.
 436  8C74              ;																 Una de la entidades ha entrado en zona de Amadeus y alguna de sus columnas coincide con las de nuestra nave.
 437  8C74              ;																 El bit indica que hay que ejecutar [Detecta_colision_nave_entidad] al principio de [Main], (Construcción del frame).
 438  8C74              ;														; bit_3. La rutina [Genera_coordenadas_de_disparo_Amadeus] pone este bit a "1" para indicar que un disparo de Amadeus ha alcanzado a una entidad.
 439  8C74
 440  8C74
 441  8C74
 442  8C74
 443  8C74
 444  8C74
 445  8C74
 446  8C74 00 00        Entidad_sospechosa_de_colision defw 0					; Almacena la dirección de memoria donde se encuentra el .db_
 447  8C76              ;														; _(Impacto) de la entidad que ocupa el mismo espacio que Amadeus.
 448  8C76              ;														; Necesitaremos poner a "0" este .db en el caso de que finalmente no se produzca colisión.
 449  8C76
 450  8C76 00 00        Coordenadas_disparo_certero ds 2						; Almacenamos aquí las coordenadas del disparo que alcanza a una entidad, (Fila, Columna).
 451  8C78              ;											            ; (Coordenadas_disparo_certero)=Y ..... (Coordenadas_disparo_certero +1)=X.
 452  8C78 00 00 00     Coordenadas_X_Entidad ds 3  							; 3 Bytes reservados para almacenar las 3 posibles columnas_
 453  8C7B              ;														; _ que puede ocupar el sprite de una entidad. (Colisión).
 454  8C7B 00 00 00     Coordenadas_X_Amadeus ds 3								; 3 Bytes reservados para almacenar las 3 posibles columnas_
 455  8C7E              ;														; _ que puede ocupar el sprite de Amadeus. (Colisión).
 456  8C7E
 457  8C7E              ;---------------------------------------------------------------------------------------------------------------
 458  8C7E
 459  8C7E              ; Relojes y temporizaciones.
 460  8C7E
 461  8C7E 04           Clock_explosion db 4									; Temporización de las explosiones, (velocidad de la explosión).
 462  8C7F 05           Clock_explosion_Amadeus db 5
 463  8C80 64           Temp_new_live db 100									; Tiempo que tarda en aparecer una nueva nave Amadeus tras ser destruida.
 464  8C81
 465  8C81 30 89        RND_SP defw Numeros_aleatorios							; Puntero que se irá desplazando por el SET de nº aleatorios.
 466  8C83
 467  8C83 00 00        Clock_next_entity defw 0								; Transcurrido este tiempo aparece una nueva entidad.
 468  8C85 00           Activa_recarga_cajas db 0								; Esta señal espera (Secundero)+X para habilitar el Loop.
 469  8C86              ;														; Repite la oleada de entidades.
 470  8C86 01           Disparo_Amadeus db 1									; A "1", se puede generar disparo.
 471  8C87
 472  8C87              ;CLOCK_repone_disparo_Amadeus_BACKUP db 30				; Restaura (CLOCK_repone_disparo_Amadeus).
 473  8C87              ;CLOCK_repone_disparo_Amadeus db 30 						; Reloj, decreciente.
 474  8C87
 475  8C87              ;Disparo_entidad db 1									; A "1", se puede generar disparo.
 476  8C87              ;CLOCK_repone_disparo_entidad_BACKUP db 20				; Restaura (CLOCK_repone_disparo_entidad).
 477  8C87              ;CLOCK_repone_disparo_entidad db 20						; Reloj, decreciente.
 478  8C87
 479  8C87              ;---------------------------------------------------------------------------------------------------------------
 480  8C87
 481  8C87              ; Gestión de NIVELES.
 482  8C87
 483  8C87 00           Nivel db 0												; Nivel actual del juego.
 484  8C88 00 00        Puntero_indice_NIVELES defw 0
 485  8C8A 00 00        Datos_de_nivel defw 0									; Este puntero se va desplazando por los distintos bytes_
 486  8C8C              ; 														; _ que definen el NIVEL.
 487  8C8C
 488  8C8C              ; ---------------------------------------------------------------------------------------------------------------
 489  8C8C
 490  8C8C              ; Temporizaciones Shield.
 491  8C8C
 492  8C8C 02 01 02 01  Datos_Shield db 2,1,2,1									; Tiempos.
 493  8C90 00 00        Puntero_datos_shield defw 0								; Señala distintos tiempos para introducirlos en (Shield_2).
 494  8C92 5A           Shield db 90											; Temporización principal. Indica el tiempo que el escudo está activo. No hay escudo cuando (Shield)="0".
 495  8C93 00           Shield_2 db 0 											; Almacena un tiempo, ( hacía el que apunta:  Puntero_datos_shield ).
 496  8C94 00           Shield_3 db 0
 497  8C95
 498  8C95 06           Lives db 6
 499  8C96
 500  8C96              ; 	INICIO  *************************************************************************************************************************************************************************
 501  8C96              ;
 502  8C96              ;	5/1/24
 503  8C96
 504  8C96              START
 505  8C96
 506  8C96 31 00 00     	ld sp,0												; Situamos el inicio de Stack.
 507  8C99 3E FD        	ld a,$fd 											; IM2 ON. Vector de interrupciones a $fdff, (defw debajo de la pila).
 508  8C9B ED 47        	ld i,a 												; Byte alto de la dirección donde se encuentra nuestro vector de interrupciones en el registro I. ($a9). El byte bajo será siempre $ff.
 509  8C9D ED 5E        	IM 2 											    ; Habilitamos el modo 2 de INTERRUPCIONES.
 510  8C9F F3           	DI
 511  8CA0
 512  8CA0              ; Limpiamos pantalla.
 513  8CA0
 514  8CA0 3E 07        	ld a,%00000111
 515  8CA2              ;	call Cls
 516  8CA2 CD BD 90     	call Pulsa_ENTER									 ; PULSA ENTER para disparar el programa.
 517  8CA5
 518  8CA5              ; INICIALIZACIÓN.
 519  8CA5
 520  8CA5 06 07        	ld b,7   											 ; Generamos 7 nº aleatorios.
 521  8CA7 CD 0E 92     	call Derivando_RND 									 ; Rutina de generación de nº aleatorios.
 522  8CAA CD 64 8E     	call Extrae_numero_aleatorio_y_avanza
 523  8CAD
 524  8CAD 6F           	ld l,a
 525  8CAE 26 00        	ld h,0
 526  8CB0 22 83 8C     	ld (Clock_next_entity),hl 							 ; El 1er nº aleatorio define cuando aparece la 1ª entidad en pantalla.
 527  8CB3
 528  8CB3              ;	Inicializa 1er Nivel.
 529  8CB3
 530  8CB3 21 E3 8B     	ld hl,Indice_de_niveles
 531  8CB6 22 88 8C     	ld (Puntero_indice_NIVELES),hl						 ; Situamos (Puntero_indice_NIVELES) en el 1er Nivel del índice.
 532  8CB9 CD 3E 92     	call Inicializa_Nivel								 ; Prepara el 1er Nivel del juego.
 533  8CBC              ;														 ; Situa (Puntero_indice_NIVELES) el el primer defw., (nivel) del índice de niveles.
 534  8CBC              ;														 ; Inicializa (Numero_de_entidades) con el nº total de malotes del nivel.
 535  8CBC              ;														 ; Inicializa (Datos_de_nivel) con el `tipo´ de la 1ª entidad del nivel.
 536  8CBC CD 19 90     	call Inicia_albumes_de_lineas
 537  8CBF              ;
 538  8CBF CD 29 90     	call Inicia_albumes_de_lineas_Amadeus
 539  8CC2
 540  8CC2 CD 83 92     4 call Inicia_Entidades
 541  8CC5 CD E6 92     	call Inicia_Amadeus
 542  8CC8
 543  8CC8              ;														 ; La rutina [Genera_datos_de_impresion] habilita las interrupciones antes del RET.
 544  8CC8              ;														 ; DI nos asegura que no vamos a ejecutar FRAME hasta que no tengamos todas las entidades iniciadas.
 545  8CC8              ;														 ; La rutina [Genera_datos_de_impresion] activa las interrupciones antes del RET.
 546  8CC8
 547  8CC8 11 BC 89     	ld de,Amadeus_BOX
 548  8CCB CD 39 94     	call Parametros_de_bandeja_DRAW_a_caja	 			 ; Volcamos Amadeus en (Amadeus_BOX).
 549  8CCE CD 29 93     	call Limpiamos_bandeja_DRAW
 550  8CD1
 551  8CD1              ; 	Situamos a Amadeus en el centro de la pantalla y pintamos.
 552  8CD1
 553  8CD1 06 3C        	ld b,60
 554  8CD3 CD 0B 9D     2 call Amadeus_a_izquierda
 555  8CD6 10 FB        	djnz 2B
 556  8CD8
 557  8CD8 CD F7 8F     	call Genera_datos_de_impresion_Amadeus
 558  8CDB
 559  8CDB              ;! ---------------------------------------------------------------------------------------------------------------------------------------------------------
 560  8CDB
 561  8CDB CD 36 90     	call Inicia_punteros_de_cajas						 ; Situa (Puntero_store_caja) en el 1er .db de la 1ª caja del índice de entidades.
 562  8CDE              ;														 ; Situa (Puntero_restore_caja) en el 1er .db de la 2ª caja del índice de cajas de entidades.
 563  8CDE
 564  8CDE              ; Si Amadeus ya está iniciado, saltamos a [Inicia_punteros_de_cajas] y [Restore_entidad].
 565  8CDE              ; (Esto se dá cuando se inicia una nueva oleada).
 566  8CDE
 567  8CDE              ;	ld a,(Ctrl_1)
 568  8CDE              ;	bit 3,a
 569  8CDE              ;	jr nz,5F											 ; Loop
 570  8CDE
 571  8CDE              ;	ld de,Amadeus_db
 572  8CDE              ;	call Store_Amadeus
 573  8CDE
 574  8CDE              ; 	INICIA DISPAROS !!!!!
 575  8CDE
 576  8CDE CD 4C 90     	call Inicia_Puntero_Disparo_Entidades
 577  8CE1 CD 53 90     	call Inicia_Puntero_Disparo_Amadeus
 578  8CE4
 579  8CE4              ; Una vez inicializadas las entidades y Amadeus, Cargamos la 1ª entidad en DRAW.
 580  8CE4
 581  8CE4              ;5 call Inicia_punteros_de_cajas
 582  8CE4              ;	call Restore_entidad
 583  8CE4
 584  8CE4              ;	ld a,(Ctrl_1)
 585  8CE4              ;	bit 3,a
 586  8CE4              ;	jr z,6F
 587  8CE4
 588  8CE4              ; Se ha producido `RECARGA' de las cajas DRAW, RES 3(HL).
 589  8CE4
 590  8CE4              ;	ld hl,Ctrl_1
 591  8CE4              ;	res 3,(hl)
 592  8CE4              ;	jr Main
 593  8CE4
 594  8CE4              ; Damos por concluida la construcción del FRAME.
 595  8CE4              ;
 596  8CE4
 597  8CE4 CD C8 90     	call Inicia_Shield
 598  8CE7
 599  8CE7
 600  8CE7 2A 67 8C     6 ld hl,(Scanlines_album_SP)
 601  8CEA 22 60 8C     	ld (Techo_Scanlines_album),hl
 602  8CED
 603  8CED 2A 5A 8C     	ld hl,(Album_de_borrado)
 604  8CF0 22 67 8C     	ld (Scanlines_album_SP),hl
 605  8CF3
 606  8CF3 21 37 89     	ld hl,Tabla_de_pintado
 607  8CF6 22 69 8C     	ld (India_SP),hl
 608  8CF9
 609  8CF9 21 6D 8C     	ld hl,Ctrl_3
 610  8CFC CB C6        	set 0,(hl) 											; Indica Frame completo.
 611  8CFE CB D6        	set 2,(hl)
 612  8D00 CB EE        	set 5,(hl)											; Imprimimos Amadeus.
 613  8D02
 614  8D02 FB           	ei 													; Ha de apuntar a $5c3a.
 615  8D03
 616  8D03 76           	halt
 617  8D04
 618  8D04              ; ------------------------------------
 619  8D04
 620  8D04              Main
 621  8D04              ;
 622  8D04              ; 13/05/24
 623  8D04
 624  8D04              ; En el FRAME que acabamos de pintar puede existir una posible colisión entre alguna entidad y Amadeus.
 625  8D04              ; Si alguna de las coordenadas_X de alguna entidad que esté en zona de Amadeus coincide con alguna de las coordenadas_X de Amadeus, habrá que comprobar si existe colisión.
 626  8D04              ; Este hecho lo indica el bit2 de (Impacto2).
 627  8D04
 628  8D04 CD D5 9F     	call Detecta_colision_nave_entidad 					; La rutina verifica la colisión entre una entidad y Amadeus, (RES 2 Impacto2).
 629  8D07
 630  8D07 2A 83 8C     16 ld hl,(Clock_next_entity)
 631  8D0A ED 4B 78 5C  	ld bc,(FRAMES)
 632  8D0E A7           	and a
 633  8D0F ED 42        	sbc hl,bc
 634  8D11 20 16        	jr nz,13F
 635  8D13
 636  8D13              ; Si aún quedan entidades por aparecer del bloque de entidades, (7 cajas), incrementaremos (Entidades_en_curso) y calcularemos_
 637  8D13              ; _ (Clock_next_entity) para la siguiente entidad.
 638  8D13
 639  8D13 3A 4E 8C     21 ld a,(Numero_parcial_de_entidades)
 640  8D16 47           	ld b,a
 641  8D17 3A 4F 8C     	ld a,(Entidades_en_curso)
 642  8D1A B8           	cp b
 643  8D1B 28 0C        	jr z,13F
 644  8D1D 30 0A        	jr nc,13F
 645  8D1F
 646  8D1F 3C           	inc a
 647  8D20 32 4F 8C     	ld (Entidades_en_curso),a
 648  8D23
 649  8D23              ; - Define el tiempo que ha de transcurrir para que aparezca la siguiente entidad. ----------------------------
 650  8D23
 651  8D23 CD 64 8E     	call Extrae_numero_aleatorio_y_avanza 				; A contiene un nº aleatorio (0-255). De 0 a 5 segundos, aproximadamente.
 652  8D26 CD 80 8E     	call Define_Clock_next_entity
 653  8D29
 654  8D29              ; -------------------------------------------------------------------------------------------------------------
 655  8D29
 656  8D29              ; Habilita disparos.
 657  8D29
 658  8D29              13
 659  8D29
 660  8D29              ;	ld hl,Disparo_Amadeus
 661  8D29              ;	ld de,CLOCK_repone_disparo_Amadeus
 662  8D29              ;	call Habilita_disparos 								; 30 Frames como mínimo entre cada disparo de Amadeus.
 663  8D29
 664  8D29              ;	ld hl,Disparo_entidad 								; El nº de frames mínimo entre disparos de entidad será_
 665  8D29              ;	ld de,CLOCK_repone_disparo_entidad 					; _ variable y variará en función de la dificultad.
 666  8D29              ;	call Habilita_disparos
 667  8D29
 668  8D29              ; COLISIONES.
 669  8D29
 670  8D29              ;	call Selector_de_impactos							; Analizamos el contenido de (Impacto2).
 671  8D29
 672  8D29              ; Bit 0 a "1" Impacto en entidad por disparo. ($01)
 673  8D29              ; Bit 1 a "1" Impacto en Amadeus por disparo. ($02)
 674  8D29              ; Bit 2 a "1" Colisión de Amadeus con entidad, (sin disparo). ($04)
 675  8D29
 676  8D29              ;	xor a
 677  8D29              ;	ld (Impacto2),a										; Flag (Impacto2) a "0".
 678  8D29
 679  8D29              ;	call Inicia_punteros_de_cajas
 680  8D29              ;12 call Restore_entidad 								; Vuelca los datos de la entidad, hacia la que apunta (Puntero_store_caja),_
 681  8D29              ; 														; _ en DRAW.
 682  8D29
 683  8D29              ;	ld a,(Filas)
 684  8D29              ;	and a
 685  8D29              ;	jr nz,10F 											; Nos situamos en la 1ª entidad NO VACÍA del índice de ENTIDADES.
 686  8D29              ;	call Incrementa_punteros_de_cajas
 687  8D29              ;	jr 12B
 688  8D29
 689  8D29              ; ---------------------------------------------------------------------------------------
 690  8D29
 691  8D29              ;10 ld a,(Numero_parcial_de_entidades)
 692  8D29              ;    ld b,a
 693  8D29              ;	and a
 694  8D29              ;	jr nz,11F
 695  8D29
 696  8D29              ;	ld hl,Ctrl_1;
 697  8D29              ;	bit 4,(hl)
 698  8D29              ;	jp nz,16F
 699  8D29
 700  8D29              ;! Cuando hemos destruido a todas las entidades del bloque preparamos una NUEVA OLEADA !!!!!
 701  8D29
 702  8D29              ;	ld hl,Ctrl_1
 703  8D29              ;	set 3,(hl)											; Señal de RECARGA de las cajas DRAW activada. NUEVA OLEADA !!!!!!!!
 704  8D29
 705  8D29              ;	ld a,(Contador_de_frames)
 706  8D29              ;	inc a
 707  8D29              ;	ld (Activa_recarga_cajas),a
 708  8D29
 709  8D29              ; ----- ----- ----- ----- ----- ---------- ----- ----- ----- ----- ----- ---------- -----
 710  8D29
 711  8D29 3A 4F 8C     11 ld a,(Entidades_en_curso)
 712  8D2C A7           	and a
 713  8D2D CA 95 8D     	jp z,Gestion_de_Amadeus								; Si no hay entidades en curso saltamos a [Avanza_puntero_de_Scanlines_album_de_entidades].
 714  8D30 47           	ld b,a												; No hay entidades que gestionar.
 715  8D31
 716  8D31              ; ( Código que ejecutamos con cada entidad: ).
 717  8D31
 718  8D31              ;	--------------------------------------- GESTIÓN DE ENTIDADES. !!!!!!!!!!
 719  8D31              ;
 720  8D31              ;	Se produce MOVIMIENTO. Intercambio de Álbumes, (borrado-pintado).
 721  8D31
 722  8D31 21 37 89     	ld hl,Tabla_de_pintado
 723  8D34 22 69 8C     	ld (India_SP),hl
 724  8D37
 725  8D37 21 6D 8C     	ld hl,Ctrl_3
 726  8D3A CB D6        	set 2,(hl)
 727  8D3C CD 39 8E     	call Change
 728  8D3F
 729  8D3F C5           15 push bc 												; Nº de entidades en curso.
 730  8D40
 731  8D40 CD 95 90     	call Restore_entidad								; Vuelca en la BANDEJA_DRAW la "Caja_de_Entidades" hacia la que apunta (Puntero_store_caja).
 732  8D43 ED 5B 67 8C  	ld de,(Scanlines_album_SP)
 733  8D47
 734  8D47              ; Datos de la entidad en curso en la bandeja DRAW y puntero (Scanlines_album_SP) en DE.
 735  8D47
 736  8D47              ; En 1er lugar, ... existe (Impacto) en esta entidad ???
 737  8D47
 738  8D47 3A 0B 8C     	ld a,(Impacto)
 739  8D4A A7           	and a
 740  8D4B 28 13        	jr z,8F
 741  8D4D
 742  8D4D              ; 5/7/24
 743  8D4D              ; Nota importante:
 744  8D4D              ; Dos entidades pueden chocar entre ellas en zona de Amadeus. La rutina [Detecta_colision_nave_entidad] comprobará si existe colisión con la última entidad gestionada, (colisionada) y _
 745  8D4D              ;	_en caso de no existir colisión pondrá su .db (Impacto) a "0" pero esa 1ª entidad "colisionada" seguirá manteniendo su .db (Impacto) a "1" por lo que para considerarse "colisión",_
 746  8D4D              ;	_es requisito imprescindible que Amadeus tenga su .db (Impacto) también a "1"; en caso contrario colocaremos el .db (Impacto) de la entidad a "0" para que se vuelva a gestionar.
 747  8D4D
 748  8D4D 3A 6D 8C     	ld a,(Ctrl_3)
 749  8D50 CB 7F        	bit 7,a
 750  8D52 20 0C        	jr nz,8F												; El bit 7 de (Ctrl_3) indica que Amadeus esta explotando.
 751  8D54              ;															; No vamos a generar una nueva explosión en más de una entidad a la vez.
 752  8D54 3A C0 89     	ld a,(Impacto_Amadeus)
 753  8D57 A7           	and a
 754  8D58 C4 A5 91     	call nz,Genera_explosion
 755  8D5B 20 1B        	jr nz,Gestiona_siguiente_entidad
 756  8D5D
 757  8D5D              ; Falsa colisión !!!
 758  8D5D
 759  8D5D 32 0B 8C     	ld (Impacto),a											; Colocamos el .db (Impacto) de la entidad en curso a "0".
 760  8D60
 761  8D60              ;19 ld hl,Ctrl_2											; Activamos el proceso de explosión.
 762  8D60              ;	set 1,(hl)
 763  8D60              ;	jr 7F
 764  8D60
 765  8D60              ; Si el bit2 de (Ctrl_1) está alzado, "1", hemos de comparar (Coordenadas_disparo_certero)_
 766  8D60              ; _con las coordenadas de la entidad almacenada en DRAW.
 767  8D60
 768  8D60              ;	ld a,(Ctrl_1)
 769  8D60              ;	bit 2,a
 770  8D60              ;	jr z,7F
 771  8D60
 772  8D60              ;	ld hl,(Coordenadas_disparo_certero)
 773  8D60              ;	ex de,hl 											; D contiene la coordenada_y del disparo.
 774  8D60              ;														; E contiene la coordenada_X del disparo.
 775  8D60              ;	ld hl,(Coordenada_X) 								; L COLUMNA (Coordenada_x de la entidad).
 776  8D60              ;														; H FILA, (Coordenada_y de la entidad).
 777  8D60              ;	and a
 778  8D60              ;	sbc hl,de
 779  8D60
 780  8D60              ;	call Determina_resultado_comparativa
 781  8D60
 782  8D60              ;	ld a,b
 783  8D60              ;	and a
 784  8D60              ;	jr z,7F												; B="0" significa que esta entidad no es la impactada.
 785  8D60
 786  8D60              ; ----- ----- -----
 787  8D60
 788  8D60              ;	ld a,1												; Esta entidad ha sido alcanzada por un disparo_
 789  8D60              ;	ld (Impacto),a 										; _de Amadeus. Lo indicamos activando su .db (Impacto).
 790  8D60
 791  8D60              ;	ld hl,Ctrl_1
 792  8D60              ;	res 2,(hl)
 793  8D60
 794  8D60              ;7 call Mov_obj											; MOVEMOS y decrementamos (Numero_de_malotes)
 795  8D60
 796  8D60              ;	ld a,(Ctrl_0)
 797  8D60              ;	bit 4,a
 798  8D60              ;	jr z,17F                                       	    ; Si no ha habido movimiento, NO HEMOS BORRADO, NI VAMOS A PINTAR NADA.!!!
 799  8D60
 800  8D60              ; Voy a utilizar una rutina de lectura de teclado para disparar con cualquier entidad.
 801  8D60              ; [[[
 802  8D60              ;	call Detecta_disparo_entidad
 803  8D60              ; ]]]
 804  8D60
 805  8D60              ;	dec a
 806  8D60              ;	ld (Impacto),a
 807  8D60
 808  8D60              ; Existe "Entidad_guía" ???.
 809  8D60              ; Si la Entidad_guía ha sido fulminada hemos de reemplazarla.
 810  8D60
 811  8D60              ;	ld a,(Ctrl_3)
 812  8D60              ;	bit 1,a
 813  8D60              ;	jr nz,22F
 814  8D60
 815  8D60              ; Almacén de "Movimientos_masticados" lleno ???
 816  8D60              ; Una "Entidad_guía" a dejado de serlo ???, (Reinicio??).
 817  8D60              ; En ese caso NO SE ACTIVA UNA NUEVA "ENTIDAD_GUÍA".
 818  8D60
 819  8D60              ;;	ld a,(Ctrl_3)
 820  8D60              ;;	bit 3,a
 821  8D60              ;;	jr nz,22F
 822  8D60
 823  8D60              ; Activa "Entidad_guía" siempre que no esté ya completo el almacén de productos_masticados.
 824  8D60
 825  8D60              ;	ld hl,Ctrl_2
 826  8D60              ;	set 5,(hl)
 827  8D60              ;	ld hl,Ctrl_3
 828  8D60              ;	set 1,(hl)
 829  8D60
 830  8D60              ; -------------------------------------------
 831  8D60
 832  8D60 CD C4 8E     8 call Recauda_informacion_de_entidad_en_curso					; Almacena la Coordenada_Y y (Scanlines_album_SP) de la entidad en curso en la TABLA_DE_PINTADO.
 833  8D63 CD 19 8E     	call Ajusta_velocidad_entidad								; Ajusta el perfil de velocidad de la entidad en función de (Contader_de_vueltas).
 834  8D66 CD B0 8F     	call Cargamos_registros_con_mov_masticado					; Cargamos los registros con el movimiento actual y `saltamos' al movimiento siguiente.
 835  8D69 CD A9 94     	call Genera_datos_de_impresion
 836  8D6C CD 4C 93     	call Decrementa_Contador_de_mov_masticados
 837  8D6F
 838  8D6F              ; -------------------------------------------
 839  8D6F
 840  8D6F              ;	Generamos las coordenadas de la entidad que hemos iniciado o desplazado.
 841  8D6F
 842  8D6F 2A 0C 8C     	ld hl,(Puntero_de_impresion)
 843  8D72 CD 7D 94     	call Genera_coordenadas
 844  8D75
 845  8D75 CD 53 9F     	call Colision_Entidad_Amadeus								; Si hay posibilidad de COLISION, set 2,(Impacto2) y (Impacto) de entidad en curso a "1".
 846  8D78
 847  8D78              ;	ld hl,Ctrl_0
 848  8D78              ; 	res 4,(hl)													; Inicializamos el FLAG de movimiento de la entidad.
 849  8D78
 850  8D78              Gestiona_siguiente_entidad
 851  8D78
 852  8D78 CD 1E 93      	call Store_Restore_cajas
 853  8D7B C1           	pop bc
 854  8D7C 10 C1        	djnz 15B
 855  8D7E
 856  8D7E              ; Hemos gestionado todas las entidades.
 857  8D7E
 858  8D7E CD D4 8E     	call Inicializa_India_y_limpia_Tabla_de_impresion 			; Inicializa el puntero (India_SP) y sanea la (Tabla_para_ordenar_entidades_antes_de_pintar).
 859  8D81 CD EB 8E     	call Ordena_tabla_de_impresion
 860  8D84 CD 36 90     	call Inicia_punteros_de_cajas 								; Hemos terminado de mover todas las entidades. Nos situamos al principio del índice de entidades.
 861  8D87
 862  8D87              ;! Activando estas líneas podemos habilitar 2 explosiones en el mismo FRAME.
 863  8D87              ; Hemos gestionado todas las unidades.
 864  8D87              ; Desactivamos el flag de impacto en entidad por disparo de amadeus.
 865  8D87
 866  8D87              ;	ld hl,Ctrl_1
 867  8D87              ;	res 2,(hl)
 868  8D87
 869  8D87 CD 95 8E     	call Borra_diferencia
 870  8D8A
 871  8D8A 3A 6D 8C     	ld a,(Ctrl_3)
 872  8D8D CB 5F        	bit 3,a
 873  8D8F 20 04        	jr nz,Gestion_de_Amadeus
 874  8D91
 875  8D91 EB           	ex de,hl
 876  8D92 71           	ld (hl),c
 877  8D93 2C           	inc l
 878  8D94 70           	ld (hl),b																; Nuevo techo, mayor que el anterior.
 879  8D95
 880  8D95
 881  8D95              ;! GESTIONA AMADEUS !!!!!!!!!!
 882  8D95
 883  8D95              Gestion_de_Amadeus
 884  8D95
 885  8D95 21 6D 8C     	ld hl,Ctrl_3
 886  8D98 CB 76        	bit 6,(hl)
 887  8D9A 28 13        	jr z,Amadeus_vivo
 888  8D9C
 889  8D9C              ; Amadeus ha sido destruido.
 890  8D9C              ; Decrementa (Temp_new_live).
 891  8D9C
 892  8D9C 21 80 8C     	ld hl,Temp_new_live
 893  8D9F 35           	dec (hl)
 894  8DA0 20 26        	jr nz,End_frame
 895  8DA2
 896  8DA2              ; Una vida menos. Reinicia Amadeus, reinicia Shield. (aparece nueva nave).
 897  8DA2
 898  8DA2 21 95 8C     	ld hl,Lives
 899  8DA5 35           	dec (hl)
 900  8DA6
 901  8DA6              ;! Fin del juego
 902  8DA6
 903  8DA6 F3           	di
 904  8DA7 28 FE        	jr z,$
 905  8DA9 FB           	ei
 906  8DAA
 907  8DAA              ; Nueva nave.
 908  8DAA
 909  8DAA CD DF 8D     	call Reinicia_Amadeus
 910  8DAD 18 19        	jr End_frame
 911  8DAF
 912  8DAF              ; Hay Impacto???, Existe movimiento???, Disparamos???, Pausamos el juego???
 913  8DAF
 914  8DAF              Amadeus_vivo
 915  8DAF
 916  8DAF 3A C0 89     	ld a,(Impacto_Amadeus)
 917  8DB2 A7           	and a
 918  8DB3 C4 D5 91     	call nz, Genera_explosion_Amadeus
 919  8DB6 20 10        	jr nz, End_frame
 920  8DB8
 921  8DB8 CD 82 91     	call Teclado
 922  8DBB
 923  8DBB 21 6D 8C     	ld hl,Ctrl_3
 924  8DBE CB 6E        	bit 5,(hl)
 925  8DC0 28 06        	jr z,End_frame
 926  8DC2
 927  8DC2              ; Existe movimiento de Amadeus, Cambiamos álbum borrado-pintado y generamos los datos de impresión.
 928  8DC2
 929  8DC2 CD 54 8E     	call Change_Amadeus
 930  8DC5 CD F7 8F     	call Genera_datos_de_impresion_Amadeus
 931  8DC8
 932  8DC8              End_frame
 933  8DC8
 934  8DC8 2A 5A 8C     	ld hl,(Album_de_borrado)
 935  8DCB 22 67 8C     	ld (Scanlines_album_SP),hl
 936  8DCE
 937  8DCE 21 6D 8C     	ld hl,Ctrl_3
 938  8DD1 CB C6        	set 0,(hl) 											; Indica Frame completo.
 939  8DD3 CB 9E        	res 3,(hl)
 940  8DD5 CB A6        	res 4,(hl)
 941  8DD7
 942  8DD7 AF           	xor a
 943  8DD8 D3 FE        	out ($fe),a
 944  8DDA
 945  8DDA 76           	halt
 946  8DDB
 947  8DDB              ; ----------------------------------------
 948  8DDB
 949  8DDB              ;	ld a,(Ctrl_1) 										; Existe Loop?
 950  8DDB              ;	bit 3,a												; Si este bit es "1". Hay recarga de nueva oleada.
 951  8DDB CA 04 8D     	jp z,Main
 952  8DDE
 953  8DDE              ; RECARGA DE NUEVA OLEADA.
 954  8DDE
 955  8DDE              ;	ld a,(Contador_de_frames)
 956  8DDE              ;	ld b,a
 957  8DDE              ;	ld a,(Activa_recarga_cajas)
 958  8DDE              ;	cp b
 959  8DDE              ;	jr z,20F
 960  8DDE
 961  8DDE              ;	ld hl,Ctrl_1
 962  8DDE              ;	set 4,(hl)
 963  8DDE              ;	jp Main
 964  8DDE
 965  8DDE              ;20 ld hl,Ctrl_1
 966  8DDE              ;	res 4,(hl)
 967  8DDE
 968  8DDE              ;	ld a,(Contador_de_frames)
 969  8DDE
 970  8DDE              ;! Este valor ha de ser pseudo-aleatorio. El tiempo de aparición de cada entidad ha de ser parecido, pero_
 971  8DDE              ;! _ IMPREDECIBLE !!!!
 972  8DDE
 973  8DDE              ;	add 10
 974  8DDE              ;	ld (Clock_next_entity),a
 975  8DDE
 976  8DDE              ;	jp 4B
 977  8DDE
 978  8DDE C9           	ret
 979  8DDF
 980  8DDF              ; ----- ----- ----- ----- ----- ---------- ----- ----- ----- ----- ----- ---------- -----
 981  8DDF              ;
 982  8DDF              ;	16/11/23
 983  8DDF
 984  8DDF              ;;Gestiona_Amadeus
 985  8DDF
 986  8DDF              ;! Activa/desactiva impacto con Amadeus.
 987  8DDF
 988  8DDF              ;	ld a,(Impacto)
 989  8DDF              ;	and a
 990  8DDF              ;	jr nz,2F
 991  8DDF
 992  8DDF              ;;	call Mov_Amadeus
 993  8DDF
 994  8DDF              ;;2 ld a,(Ctrl_0)
 995  8DDF              ;;	bit 4,a
 996  8DDF              ;;	jr z,1F                                            ; Omitimos BORRAR/PINTAR si no hay movimiento.
 997  8DDF
 998  8DDF              ;;	call Guarda_foto_entidad_a_pintar
 999  8DDF              ;;	call Guarda_datos_de_borrado_Amadeus
1000  8DDF
1001  8DDF              ;;1 ld hl,Ctrl_0
1002  8DDF              ;;    res 4,(hl)											; Inicializamos el FLAG de movimiento de la entidad.
1003  8DDF
1004  8DDF              ;;	call Motor_de_disparos								; Borra/mueve/pinta cada uno de los disparos y crea un nuevo album de fotos.
1005  8DDF
1006  8DDF              ; Calculamos el nº de malotes y de disparotes para pintarlos nada más comenzar el siguiente FRAME.
1007  8DDF
1008  8DDF              ;	call Calcula_numero_de_disparotes
1009  8DDF
1010  8DDF              ;;	ret
1011  8DDF
1012  8DDF              ; -----------------------------
1013  8DDF              ;
1014  8DDF              ;	Prepara los registros HL' y B para ejecutar la rutina Borra_sprites.
1015  8DDF              ;
1016  8DDF              ;	INPUTS: B a de estar a "0".
1017  8DDF
1018  8DDF              ;Prepara_Borra_sprites
1019  8DDF
1020  8DDF              ;	ld hl,(Puntero_de_scanlines_masticados_a_borrar)
1021  8DDF              ;	ld a,l
1022  8DDF              ;	ret z
1023  8DDF
1024  8DDF              ;	srl a
1025  8DDF
1026  8DDF              ;2 sub 16
1027  8DDF              ;	jr z,1F
1028  8DDF              ;	inc b
1029  8DDF              ;	jr 2B
1030  8DDF
1031  8DDF              ;1 inc b
1032  8DDF
1033  8DDF              ;	exx
1034  8DDF              ;	ld hl,Semaforo_de_rutinas_de_impresion_utilizadas
1035  8DDF              ;	exx
1036  8DDF
1037  8DDF              ;	ld hl,Almacen_de_scanlines_masticados_a_borrar
1038  8DDF              ;	ld (Puntero_de_scanlines_masticados_a_borrar),hl
1039  8DDF
1040  8DDF              ;	ret
1041  8DDF
1042  8DDF              ; --------------------------------------------------------------------------------------------------------------
1043  8DDF              ;
1044  8DDF              ;	15/12/23
1045  8DDF
1046  8DDF              ;Mov_obj
1047  8DDF
1048  8DDF              ;	ld a,(Ctrl_2)
1049  8DDF              ;	bit 1,a
1050  8DDF              ;	jr z,2F											; Se ha iniciado la EXPLOSIÓN???
1051  8DDF
1052  8DDF              ; Explosión:
1053  8DDF
1054  8DDF              ;	ld a,(Frames_explosion)
1055  8DDF              ;	and a
1056  8DDF              ;	jr nz,4F
1057  8DDF
1058  8DDF              ;!  Una alimaña menos!!!!!!!!!1
1059  8DDF
1060  8DDF              ; Se trataba de una Entidad_guía ???
1061  8DDF
1062  8DDF              ;	ld a,(Ctrl_2)
1063  8DDF              ;	bit 5,a 										; El bit5 de (Ctrl_2) indica si se trata de una Entidad_guía.
1064  8DDF              ;	jr z,5F
1065  8DDF
1066  8DDF              ;	ld hl,Ctrl_3
1067  8DDF              ;	res 1,(hl) 										; FLAG (Existencia de Entidad_guía) a "0".
1068  8DDF
1069  8DDF              ;!! Cuando se elimina a una entidad_guía tenemos que limpiar el almacen_de_mov_masticados de esta entidad. Así el siguiente movimiento_
1070  8DDF              ;!! _generado puede ser distinto, (aletoriedad).
1071  8DDF
1072  8DDF              ;5 call Borra_datos_entidad							; Borramos todos los datos de la entidad.
1073  8DDF              ;	ld hl,Numero_parcial_de_entidades				; Una alimaña menos.
1074  8DDF              ;	dec (hl)
1075  8DDF              ;	ld hl,Entidades_en_curso
1076  8DDF              ;	dec (hl)
1077  8DDF              ;	ld hl,Numero_de_entidades
1078  8DDF              ;	dec (hl)
1079  8DDF              ;	jr 3F
1080  8DDF
1081  8DDF              ; -----
1082  8DDF
1083  8DDF              ;	`Movemos´ la explosión.
1084  8DDF
1085  8DDF              ;4 ld hl,(Puntero_DESPLZ_der)
1086  8DDF              ;	inc hl
1087  8DDF              ;	inc hl
1088  8DDF              ;	call Extrae_address
1089  8DDF              ;;	ld (Puntero_objeto),hl
1090  8DDF
1091  8DDF              ;;	ld hl,Frames_explosion
1092  8DDF              ;;	dec (hl)
1093  8DDF
1094  8DDF              ;;	ld hl,Ctrl_0
1095  8DDF              ;;	set 4,(hl);;
1096  8DDF
1097  8DDF              ;;	jr 3F
1098  8DDF
1099  8DDF              ;	NO HAY EXPLOSIÓN ----- ----- ----- ----- -----
1100  8DDF
1101  8DDF              ;2 xor a
1102  8DDF              ;	ld (Ctrl_0),a 										; El bit4 de (Ctrl_0) puede estar alzado debido al movimiento de Amadeus. Inicializamos.
1103  8DDF
1104  8DDF              ; Movemos Entidades malignas.
1105  8DDF              ; Se trata de una "Entidad_guía" ???. Si es así ejecutamos la rutina que construye el patrón de movimiento.
1106  8DDF
1107  8DDF              ;	ld a,(Ctrl_2)
1108  8DDF              ;	bit 5,a
1109  8DDF              ;	jr nz,8F
1110  8DDF
1111  8DDF              ;	ld hl,Ctrl_0										; Movemos una entidad "FANTASMA". Activamos el FLAG de movimiento y evitamos_
1112  8DDF              ;	set 4,(hl)											; _ ejecutar la rutina de Movimiento.
1113  8DDF              ;	jr 7F
1114  8DDF
1115  8DDF              ;8 call Movimiento										; Desplazamos el objeto. MOVEMOS !!!!!
1116  8DDF
1117  8DDF              ;	ld a,(Ctrl_0) 										; Salimos de la rutina SI NO HA HABIDO MOVIMIENTO !!!!!
1118  8DDF              ;	bit 4,a
1119  8DDF              ;	ret z
1120  8DDF
1121  8DDF              ; Ha habido desplazamiento de la entidad maligna.
1122  8DDF              ; Ha llegado a zona de AMADEUS ???
1123  8DDF
1124  8DDF              ;7 ld a,(Coordenada_y)
1125  8DDF              ;	cp $14
1126  8DDF              ;	jr c,1F
1127  8DDF
1128  8DDF              ; ---------
1129  8DDF
1130  8DDF              ;	Si la entidad en curso entra en zona de Amadeus, generamos y guardamos las 2 o 3 columnas que ocupa la entidad_
1131  8DDF              ;	_ y las 2 o 3 columnas que ocupa Amadeus y las comparamos por si hubiera coincidencia.
1132  8DDF
1133  8DDF              ;	di
1134  8DDF              ;	call Genera_coordenadas_X
1135  8DDF              ;	call Compara_coordenadas_X
1136  8DDF              ;	ei
1137  8DDF
1138  8DDF              ;	En el caso de existir coincidencia colocamos a "1" el .db (Impacto) de la entidad en curso y el bit2 del flag (Impacto2).
1139  8DDF
1140  8DDF              ; ---------
1141  8DDF
1142  8DDF              ;1 call Prepara_var_pintado	 			                		; HEMOS DESPLAZADO LA ENTIDAD!!!. Almaceno las `VARIABLES DE PINTADO´en su {Variables_de_pintado}.
1143  8DDF              ;	call Repone_datos_de_borrado 								; ! BORRAMOS !!!. Guardamos la foto de las {Variables_de_borrado} en Scanlines_album.
1144  8DDF              ;	call Limpia_Variables_de_borrado
1145  8DDF
1146  8DDF              ;3 ret
1147  8DDF
1148  8DDF              ; ----- ----- ----- ----- ----- ----- ----- ----- -----
1149  8DDF              ;
1150  8DDF              ;	24/07/24
1151  8DDF
1152  8DDF              Reinicia_Amadeus
1153  8DDF
1154  8DDF              ;	Reinicia posición y estado.
1155  8DDF
1156  8DDF 21 CF 50     	ld hl,$50cf
1157  8DE2 22 C1 89     	ld (p.imp.amadeus),hl
1158  8DE5 21 F0 E0     	ld hl,$e0f0
1159  8DE8 22 C3 89     	ld (Pamm_Amadeus),hl
1160  8DEB 21 3D 00     	ld hl,$003d
1161  8DEE 22 C5 89     	ld (Comm_Amadeus),hl
1162  8DF1
1163  8DF1              ;	limpiamos el álbum de borrado.
1164  8DF1
1165  8DF1 2A 5E 8C     	ld hl,(Album_de_borrado_Amadeus)
1166  8DF4
1167  8DF4 AF           	xor a
1168  8DF5 77           	ld (hl),a
1169  8DF6
1170  8DF6 E5           	push hl
1171  8DF7 D1           	pop de
1172  8DF8 13           	inc de
1173  8DF9
1174  8DF9 01 23 00     	ld bc,35
1175  8DFC ED B0        	ldir
1176  8DFE
1177  8DFE CD F7 8F     	call Genera_datos_de_impresion_Amadeus
1178  8E01
1179  8E01              ;	Reinicia temporizaciones.
1180  8E01
1181  8E01 CD C8 90     	call Inicia_Shield
1182  8E04
1183  8E04 3E 5A        	ld a,90
1184  8E06 32 92 8C     	ld (Shield),a
1185  8E09
1186  8E09 3E 64        	ld a,100
1187  8E0B 32 80 8C     	ld (Temp_new_live),a
1188  8E0E
1189  8E0E              ; 	Restauramos el FLAG: Amadeus vivo.
1190  8E0E
1191  8E0E 21 6D 8C     	ld hl,Ctrl_3
1192  8E11 CB B6        	res 6,(hl)
1193  8E13
1194  8E13              ;	Fuerza la impresión de la nave en el siguiente frame.
1195  8E13
1196  8E13 21 6D 8C      	ld hl,Ctrl_3
1197  8E16 CB EE        	set 5,(hl)
1198  8E18
1199  8E18 C9           	ret
1200  8E19
1201  8E19              ; --------------------------------------------------------------------------------------------------------------
1202  8E19              ;
1203  8E19              ;	12/05/24
1204  8E19
1205  8E19 3A 12 8C     Ajusta_velocidad_entidad ld a,(Velocidad)
1206  8E1C CB 27        	sla a
1207  8E1E 32 12 8C     	ld (Velocidad),a
1208  8E21 E6 10        	and $10
1209  8E23 C8           	ret z
1210  8E24
1211  8E24              ; Restaura (Velocidad) a razón del nº de vueltas.
1212  8E24
1213  8E24 3A 0A 8C     	ld a,(Contador_de_vueltas)
1214  8E27 CB 2F        	sra a
1215  8E29 CB 2F        	sra a
1216  8E2B 32 12 8C     	ld (Velocidad),a
1217  8E2E
1218  8E2E 2A 0E 8C     	ld hl,(Puntero_de_almacen_de_mov_masticados)
1219  8E31 23           	inc hl
1220  8E32 23           	inc hl
1221  8E33 23           	inc hl
1222  8E34 23           	inc hl
1223  8E35 22 0E 8C     	ld (Puntero_de_almacen_de_mov_masticados),hl
1224  8E38
1225  8E38 C9           	ret
1226  8E39
1227  8E39              ; --------------------------------------------------------------------------------------------------------------
1228  8E39              ;
1229  8E39              ;	18/06/24
1230  8E39
1231  8E39              Change
1232  8E39
1233  8E39 3A 64 8C     	ld a,(Switch)
1234  8E3C EE 01        	xor 1
1235  8E3E 32 64 8C     	ld (Switch),a
1236  8E41 2A 58 8C     	ld hl,(Album_de_pintado)
1237  8E44 ED 5B 5A 8C  	ld de,(Album_de_borrado)
1238  8E48 EB           	ex de,hl
1239  8E49 22 58 8C     	ld (Album_de_pintado),hl
1240  8E4C 22 67 8C     	ld (Scanlines_album_SP),hl
1241  8E4F ED 53 5A 8C  	ld (Album_de_borrado),de
1242  8E53 C9           	ret
1243  8E54
1244  8E54              Change_Amadeus
1245  8E54
1246  8E54 2A 5C 8C     	ld hl,(Album_de_pintado_Amadeus)
1247  8E57 ED 5B 5E 8C  	ld de,(Album_de_borrado_Amadeus)
1248  8E5B EB           	ex de,hl
1249  8E5C 22 5C 8C     	ld (Album_de_pintado_Amadeus),hl
1250  8E5F ED 53 5E 8C  	ld (Album_de_borrado_Amadeus),de
1251  8E63 C9           	ret
1252  8E64
1253  8E64              ; ------------------------------------
1254  8E64              ;
1255  8E64              ; 1/05/24
1256  8E64
1257  8E64              ; Fija en A un nº aleatorio comprendido entre 0-255 y desplaza el puntero (RND_SP) al siguiente nº.
1258  8E64              ; Si el puntero está situado en el último nº, lo volvemos a situar al principio.
1259  8E64
1260  8E64              ;	DESTRUYE: HL,DE,A
1261  8E64              ;	OUTPUTS: A contiene un Nº aleatorio. Actualizamos (RND_SP).
1262  8E64
1263  8E64              ;	Variables implicadas: (RND_SP).
1264  8E64
1265  8E64              Extrae_numero_aleatorio_y_avanza
1266  8E64
1267  8E64 21 37 89     	ld hl,Tabla_de_pintado
1268  8E67 EB           	ex de,hl
1269  8E68 2A 81 8C     	ld hl,(RND_SP)
1270  8E6B EB           	ex de,hl
1271  8E6C A7           	and a
1272  8E6D ED 52        	sbc hl,de
1273  8E6F
1274  8E6F 2A 81 8C     	ld hl,(RND_SP)
1275  8E72 20 06        	jr nz,1F
1276  8E74
1277  8E74              ; Sitúa HL al principio de la tabla de nº aleatorios.
1278  8E74
1279  8E74 21 30 89     	ld hl,Numeros_aleatorios
1280  8E77 22 81 8C     	ld (RND_SP),HL
1281  8E7A
1282  8E7A              ; Coloca el nº aleatorio en A y mueve el puntero al siguiente nº.
1283  8E7A
1284  8E7A 7E           1 ld a,(hl)
1285  8E7B 23           	inc hl
1286  8E7C 22 81 8C     	ld (RND_SP),hl
1287  8E7F C9           	ret
1288  8E80
1289  8E80              ; ------------------------------------
1290  8E80              ;
1291  8E80              ; 1/05/24
1292  8E80
1293  8E80              ; Hacemos que el nº contenido en el registro A tenga un valor comprendido entre ($32 y $c8).
1294  8E80              ; (1 a 4 segundos).
1295  8E80              ; Actualizamos (Clock_next_entity) con A.
1296  8E80
1297  8E80              ;	DESTRUYE: A y B.
1298  8E80              ;	OUTPUTS: A contiene un Nº aleatorio comprendido entre ($32 y $c8).
1299  8E80              ;			 Actualiza (Clock_next_entity) con A.
1300  8E80
1301  8E80              ;	Variables implicadas: (Clock_next_entity).
1302  8E80
1303  8E80              ; Notas:
1304  8E80
1305  8E80              ; 	$32 1 seg.
1306  8E80              ; 	$64 2 seg.
1307  8E80              ; 	$96 3 seg.
1308  8E80              ; 	$c8 4 seg.
1309  8E80              ; 	$fa 5 seg.
1310  8E80
1311  8E80              ; $ffff 1310,7 seg, 22 minutos.
1312  8E80
1313  8E80              ;	$0100  5 seg. aproximadamente.
1314  8E80              ;	$0200 10 seg. aproximadamente.
1315  8E80              ;	$0300 15 seg. aproximadamente.
1316  8E80              ;	$0400 20 seg. aproximadamente.
1317  8E80              ;	$0500 25 seg. aproximadamente.
1318  8E80              ;	$0600 30 seg. aproximadamente.
1319  8E80
1320  8E80              Define_Clock_next_entity
1321  8E80
1322  8E80 FE 34        	cp $34
1323  8E82 38 0D        	jr c,1F  						; nº demasiado bajo, < 1 seg.
1324  8E84
1325  8E84              ; En función de los minutos que llevemos de juego las entidades irán apareciendo más lentamente.
1326  8E84
1327  8E84 4F           3 ld c,a
1328  8E85 06 00        	ld b,0							; BC contendrá un valor entre 5-10 segundos.
1329  8E87 2A 78 5C     	ld hl,(FRAMES)
1330  8E8A A7           	and a
1331  8E8B ED 4A        	adc hl,bc
1332  8E8D 22 83 8C     	ld (Clock_next_entity),hl  		; Actualizamos variable.
1333  8E90 C9           	ret
1334  8E91
1335  8E91 3E 34        1 ld a,$34
1336  8E93 18 EF        	jr 3B
1337  8E95
1338  8E95              ; ------------------------------------
1339  8E95              ;
1340  8E95              ; 18/03/24
1341  8E95
1342  8E95              Borra_diferencia
1343  8E95
1344  8E95 ED 4B 67 8C  	ld bc,(Scanlines_album_SP)
1345  8E99
1346  8E99 3A 64 8C     	ld a,(Switch)
1347  8E9C A7           	and a
1348  8E9D 28 08        	jr z,2F
1349  8E9F
1350  8E9F 2A 62 8C     	ld hl,(Techo_Scanlines_album_2)
1351  8EA2 11 62 8C     	ld de,Techo_Scanlines_album_2
1352  8EA5 18 06        	jr 3F
1353  8EA7
1354  8EA7 2A 60 8C     2 ld hl,(Techo_Scanlines_album)
1355  8EAA 11 60 8C     	ld de,Techo_Scanlines_album
1356  8EAD
1357  8EAD              ; Diferencia.
1358  8EAD
1359  8EAD ED 42        3 sbc hl,bc
1360  8EAF
1361  8EAF C8           	ret z
1362  8EB0 D8           	ret c
1363  8EB1
1364  8EB1              ; Nuevo techo, (más bajo que el anterior).
1365  8EB1              ; Fijamos nuevo techo y borramos bytes sobrantes.
1366  8EB1
1367  8EB1 EB           	ex de,hl
1368  8EB2
1369  8EB2 71           	ld (hl),c
1370  8EB3 2C           	inc l
1371  8EB4 70           	ld (hl),b
1372  8EB5
1373  8EB5 AF           	xor a
1374  8EB6 43           	ld b,e
1375  8EB7
1376  8EB7 2A 67 8C     	ld hl,(Scanlines_album_SP)
1377  8EBA
1378  8EBA 77           1 ld (hl),a
1379  8EBB 23           	inc hl
1380  8EBC 10 FC        	djnz 1B
1381  8EBE
1382  8EBE              ; Indicamos que tenemos nuevo techo más bajo con el FLAG:
1383  8EBE
1384  8EBE 21 6D 8C     	ld hl,Ctrl_3
1385  8EC1 CB DE        	set 3,(hl)
1386  8EC3
1387  8EC3 C9           	ret
1388  8EC4
1389  8EC4              ; --------------------------------------------------------------------------------------------------------------
1390  8EC4              ;
1391  8EC4              ;	26/3/24
1392  8EC4
1393  8EC4              Recauda_informacion_de_entidad_en_curso
1394  8EC4
1395  8EC4              ; Almacena la Coordenada Y de la entidad en curso.
1396  8EC4
1397  8EC4              ; El 1er .db de la tabla almacena (Columna_Y) de la entidad en curso.
1398  8EC4
1399  8EC4 3A 09 8C     	ld a,(Coordenada_y)
1400  8EC7 2A 69 8C     	ld hl,(India_SP)
1401  8ECA 77           	ld (hl),a
1402  8ECB 2C           	inc l
1403  8ECC
1404  8ECC              ; Almacena la dirección de memoria, (dentro del album de scanlines), de la entidad en curso.
1405  8ECC
1406  8ECC              ;	ld de,(Scanlines_album_SP)
1407  8ECC
1408  8ECC 73           	ld (hl),e
1409  8ECD 2C           	inc l
1410  8ECE 72           	ld (hl),d
1411  8ECF 2C           	inc l
1412  8ED0
1413  8ED0 22 69 8C     	ld (India_SP),hl
1414  8ED3
1415  8ED3 C9           	ret
1416  8ED4
1417  8ED4              ; --------------------------------------------------------------------------------------------------------------
1418  8ED4              ;
1419  8ED4              ;	27/03/24
1420  8ED4              ;
1421  8ED4
1422  8ED4              Inicializa_India_y_limpia_Tabla_de_impresion
1423  8ED4
1424  8ED4 2A 69 8C     	ld hl,(India_SP)
1425  8ED7 01 4F 89     	ld bc,Tabla_de_pintado+24							; Bytes de (Tabla_de_pintado)-1.
1426  8EDA
1427  8EDA 79           	ld a,c
1428  8EDB 95           	sub l
1429  8EDC 28 06        	jr z,2F
1430  8EDE 47           	ld b,a												; Nº de bytes a limpiar de la tabla. Si la Tabla está completa, omitimos limpiar_
1431  8EDF              ;														; _ y pasamos a inicializar (India_SP).
1432  8EDF AF           	xor a
1433  8EE0
1434  8EE0 77           1 ld (hl),a
1435  8EE1 2C           	inc l
1436  8EE2 10 FC        	djnz 1B												; Limpia Tabla.
1437  8EE4
1438  8EE4 21 37 89     2 ld hl,Tabla_de_pintado								; Inicializa (India_SP).
1439  8EE7 22 69 8C     	ld (India_SP),hl
1440  8EEA
1441  8EEA C9           	ret
1442  8EEB
1443  8EEB              ; --------------------------------------------------------------------------------------------------------------
1444  8EEB              ;
1445  8EEB              ;	31/3/24
1446  8EEB
1447  8EEB              Ordena_tabla_de_impresion
1448  8EEB
1449  8EEB              ; 5794 T/states.
1450  8EEB              ; 6278 T/states.
1451  8EEB              ; 5310 T/states.
1452  8EEB
1453  8EEB              ; Inicializamos punteros (India_SP) e (India_2_SP).
1454  8EEB              ; Inicializamos contador de comparaciones, [C].
1455  8EEB              ; Cargamos los registros A y B para efectuar comparación.
1456  8EEB
1457  8EEB FD 2E 00     	ld iyl,0
1458  8EEE
1459  8EEE 3A 4F 8C     	ld a,(Entidades_en_curso)
1460  8EF1 FE 04        	cp 4 	;	4
1461  8EF3 D8           	ret c 										; Tiene que haber 4 (Entidades_en_curso) en pantalla para poder ejecutar esta rutina.
1462  8EF4
1463  8EF4 3D           	dec a
1464  8EF5 4F           	ld c,a 										; (Entidades_en_curso)-1 en C. Puede haber menos de 7 ebtidades.
1465  8EF6 51           	ld d,c 										; Copia de respaldo.
1466  8EF7
1467  8EF7 7E           	ld a,(hl)									; Nº de Fila de la 1ª entidad, (1er byte de la tabla).
1468  8EF8
1469  8EF8 21 3A 89     	ld hl,Tabla_de_pintado+3
1470  8EFB 46           	ld b,(hl)
1471  8EFC 22 6B 8C     	ld (India_2_SP),hl
1472  8EFF
1473  8EFF B8           1 cp b  				 						; Compara filas, (entidad X & entidad X).
1474  8F00 DC 28 8F     	call c, Avanza_India_2_SP
1475  8F03 CC 28 8F     	call z, Avanza_India_2_SP
1476  8F06
1477  8F06 FD 2D        	dec iyl
1478  8F08 28 18        	jr z,2F
1479  8F0A
1480  8F0A
1481  8F0A              ; --------------------------------------------------------------------------------------------------------------
1482  8F0A              ;
1483  8F0A              ;	7/4/24
1484  8F0A
1485  8F0A              Trueque
1486  8F0A
1487  8F0A              ; INPUTS:   B contiene el nº de fila de (India_2_SP).
1488  8F0A              ;  			A contiene en nº de fila de (India_SP).
1489  8F0A              ;			HL contiene (India_2_SP).
1490  8F0A
1491  8F0A D5           	push de 									; Preservo DE pues D contiene una copia de respaldo.
1492  8F0B E5           	push hl										; Preservo (India_2_SP).
1493  8F0C
1494  8F0C ED 5B 69 8C  	ld de,(India_SP)
1495  8F10 EB           	ex de,hl
1496  8F11 70           	ld (hl),b
1497  8F12 12           	ld (de),a									; (Flia) de (India_SP) ---- NTERCAMBIADA ---- (Flia) de (India_2_SP).
1498  8F13
1499  8F13 CD 54 8F     	call Intercambia_1_byte
1500  8F16 CD 54 8F     	call Intercambia_1_byte
1501  8F19
1502  8F19
1503  8F19              ; Volvemos a iniciar A. Vuelve a contener `el nuevo contenido, (Fila), de (India_SP).
1504  8F19              ; Recuperamos (India_2_SP) en HL.
1505  8F19
1506  8F19 2A 69 8C     	ld hl,(India_SP)
1507  8F1C 7E           	ld a,(hl)
1508  8F1D
1509  8F1D E1           	pop hl
1510  8F1E D1           	pop de
1511  8F1F
1512  8F1F              ; --------------------------------------------------------------------------------------------------------------
1513  8F1F
1514  8F1F CD 28 8F     	call Avanza_India_2_SP
1515  8F22
1516  8F22 14           2 inc d
1517  8F23 15           	dec d
1518  8F24 C8           	ret z 										; Todas las (Entidades_en_curso) ordenadas.
1519  8F25 18 D8        	jr 1B
1520  8F27
1521  8F27 C9           	ret
1522  8F28
1523  8F28              ; ----- ----- ----- ----- -----
1524  8F28
1525  8F28              Avanza_India_2_SP
1526  8F28
1527  8F28 0D           	dec c
1528  8F29 28 0A        	jr z,Avanza_punteros_indios
1529  8F2B
1530  8F2B FD 2C        	inc iyl
1531  8F2D
1532  8F2D 2C           	inc l
1533  8F2E 2C           	inc l
1534  8F2F 2C           	inc l
1535  8F30
1536  8F30 46           	ld b,(hl)
1537  8F31 22 6B 8C     	ld (India_2_SP),hl 							; Siguiente entidad en la Tabla.
1538  8F34
1539  8F34 C9           	ret
1540  8F35
1541  8F35              ; ----- ----- ----- ----- -----
1542  8F35
1543  8F35              Avanza_punteros_indios
1544  8F35
1545  8F35 15           	dec d
1546  8F36 28 15        	jr z,Prepara_salida
1547  8F38
1548  8F38 4A           	ld c,d
1549  8F39
1550  8F39 2A 69 8C     	ld hl,(India_SP)
1551  8F3C 2C           	inc l
1552  8F3D 2C           	inc l
1553  8F3E 2C           	inc l
1554  8F3F 7E           	ld a,(hl)
1555  8F40 22 69 8C     	ld (India_SP),hl
1556  8F43
1557  8F43 2C           	inc l
1558  8F44 2C           	inc l
1559  8F45 2C           	inc l
1560  8F46 46           	ld b,(hl)
1561  8F47 22 6B 8C     	ld (India_2_SP),hl
1562  8F4A
1563  8F4A FD 2C        	inc iyl
1564  8F4C
1565  8F4C C9           	ret
1566  8F4D
1567  8F4D              Prepara_salida
1568  8F4D
1569  8F4D 21 37 89     	ld hl,Tabla_de_pintado
1570  8F50 22 69 8C     	ld (India_SP),hl
1571  8F53 C9           	ret
1572  8F54
1573  8F54
1574  8F54 2C           Intercambia_1_byte inc l
1575  8F55 1C           	inc e
1576  8F56 46           	ld b,(hl)
1577  8F57 1A           	ld a,(de)
1578  8F58 EB           	ex de,hl
1579  8F59 70           	ld (hl),b
1580  8F5A 12           	ld (de),a												; Byte de menor peso de las dos direcciones de memoria, ----- INTERCAMBIADAS -----.
1581  8F5B C9           	ret
1582  8F5C
1583  8F5C              ; -----------------------------------------------------------------------------------
1584  8F5C              ;
1585  8F5C              ;	20/01/24
1586  8F5C              ;
1587  8F5C              ;
1588  8F5C
1589  8F5C              Construye_movimientos_masticados_entidad
1590  8F5C
1591  8F5C 2A 0E 8C     	ld hl,(Puntero_de_almacen_de_mov_masticados)			; Guardamos en la pila la dirección inicial del puntero, (para reiniciarlo más tarde).
1592  8F5F E5           	push hl
1593  8F60 CD A3 8F     	call Actualiza_Puntero_de_almacen_de_mov_masticados 	; Actualizamos (Puntero_de_almacen_de_mov_masticados) e incrementa_
1594  8F63              ;															; _ el (Contador_de_mov_masticados).
1595  8F63 CD 60 90     	call Inicia_Puntero_objeto								; Inicializa (Puntero_DESPLZ_der) y (Puntero_DESPLZ_izq).
1596  8F66              ;															; Inicializa (Puntero_objeto) en función de la (Posicion_inicio) de la entidad.
1597  8F66 CD 91 99     	call Recompone_posicion_inicio
1598  8F69
1599  8F69 CD C1 96     1 call Draw
1600  8F6C CD 88 8F     	call Guarda_movimiento_masticado
1601  8F6F
1602  8F6F CD 3E 9D     	call Movimiento
1603  8F72
1604  8F72 3A 6D 8C     	ld a,(Ctrl_3)											; El bit1 de (Ctrl_3) a "1" indica que hemos completado todo el patrón de movimiento_
1605  8F75 CB 4F        	bit 1,a 												; _ que corresponde a esta entidad.
1606  8F77 28 F0        	jr z,1B
1607  8F79
1608  8F79              ;	Hemos completado el almacén de movimientos masticados de la entidad.
1609  8F79              ;	Reinicializamos (Puntero_de_almacen_de_mov_masticados).
1610  8F79
1611  8F79 E1           	pop hl 													; Recuperamos la dirección inicial de (Puntero_de_almacen_de_mov_masticados).
1612  8F7A 22 0E 8C     	ld (Puntero_de_almacen_de_mov_masticados),hl
1613  8F7D
1614  8F7D              ; Guardamos el nº total de movimientos masticados de esta entidad en su (Contador_general_de_mov_masticados).
1615  8F7D
1616  8F7D CD A2 9E     	call Situa_en_contador_general_de_mov_masticados
1617  8F80
1618  8F80              ; HL apunta al 1er byte del (Contador_general_de_mov_masticados) de esta entidad.
1619  8F80              ; Guardamos (Contador_de_mov_masticados) en el (Contador_general_de_mov_masticados) de esta entidad.
1620  8F80
1621  8F80 ED 4B 10 8C  	ld bc,(Contador_de_mov_masticados)
1622  8F84
1623  8F84 71           	ld (hl),c
1624  8F85 23           	inc hl
1625  8F86 70           	ld (hl),b
1626  8F87
1627  8F87 C9           	ret
1628  8F88
1629  8F88              ; -----------------------------------------------------------------------------------
1630  8F88              ;
1631  8F88              ;	28/12/23
1632  8F88              ;
1633  8F88              ;	Guarda el "movimiento_masticado" en el {Almacen_de_movimientos_masticados} de la entidad.
1634  8F88              ;	Actualiza el (Puntero_de_almacen_de_mov_masticados) tras el guardado.
1635  8F88
1636  8F88              Guarda_movimiento_masticado
1637  8F88
1638  8F88 ED 73 54 8C  	ld (Stack),sp
1639  8F8C ED 7B 0E 8C  	ld sp,(Puntero_de_almacen_de_mov_masticados)			; Guardamos el movimiento masticado en el almacén.
1640  8F90
1641  8F90 DD E5            push ix 												; Pushea el Puntero_de_impresión, (1er scanline).
1642  8F92 FD E5            push iy 												; Pushea Puntero_objeto.
1643  8F94
1644  8F94 ED 7B 54 8C      ld sp,(Stack)
1645  8F98
1646  8F98 2A 10 8C        	ld hl,(Contador_de_mov_masticados)						; Incrementa en una unidad el (Contador_de_mov_masticados).
1647  8F9B 23           	inc hl
1648  8F9C 22 10 8C     	ld (Contador_de_mov_masticados),hl
1649  8F9F
1650  8F9F CD A3 8F         call Actualiza_Puntero_de_almacen_de_mov_masticados 	; Actualizamos (Puntero_de_almacen_de_mov_masticados) e incrementa_
1651  8FA2              ;															; _ el (Contador_de_mov_masticados).
1652  8FA2 C9               ret
1653  8FA3
1654  8FA3              ; --------------------------------------------------------------------------------------------------------------
1655  8FA3              ;
1656  8FA3              ;	12/1/24
1657  8FA3              ;
1658  8FA3              ;	INPUTS: HL a de contener (Puntero_de_almacen_de_mov_masticados).
1659  8FA3
1660  8FA3              Actualiza_Puntero_de_almacen_de_mov_masticados
1661  8FA3
1662  8FA3 2A 0E 8C     	ld hl,(Puntero_de_almacen_de_mov_masticados)
1663  8FA6 01 04 00     	ld bc,4
1664  8FA9 A7           	and a
1665  8FAA ED 4A        	adc hl,bc
1666  8FAC 22 0E 8C     	ld (Puntero_de_almacen_de_mov_masticados),hl
1667  8FAF C9           	ret
1668  8FB0
1669  8FB0              ; --------------------------------------------------------------------------------------------------------------
1670  8FB0              ;
1671  8FB0              ;	24/03/24
1672  8FB0              ;
1673  8FB0              ;	Cargamos los registros DE e IX y actualizamos (Puntero_de_almacen_de_mov_masticados).
1674  8FB0              ;
1675  8FB0              ;	IX contiene el puntero de impresión.
1676  8FB0              ;	DE contiene (Puntero_objeto).
1677  8FB0
1678  8FB0
1679  8FB0              Cargamos_registros_con_mov_masticado
1680  8FB0
1681  8FB0 ED 73 54 8C  	ld (Stack),sp
1682  8FB4 ED 7B 0E 8C  	ld sp,(Puntero_de_almacen_de_mov_masticados)
1683  8FB8
1684  8FB8 D1           	pop de 															; DE contiene Puntero_objeto
1685  8FB9 DD E1        	pop ix 															; IX contiene Puntero_de_impresion
1686  8FBB
1687  8FBB ED 73 0E 8C  	ld (Puntero_de_almacen_de_mov_masticados),sp 					; Actualiza (Puntero_de_almacen_de_mov_masticados).
1688  8FBF ED 7B 54 8C  	ld sp,(Stack)
1689  8FC3
1690  8FC3 7B           	ld a,e
1691  8FC4 82           	add d															; Comprueba si ya no hay datos en el almacén.
1692  8FC5
1693  8FC5 CC 54 93     	call z,Reinicia_entidad_maliciosa
1694  8FC8
1695  8FC8 C9           	ret
1696  8FC9
1697  8FC9              ; ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
1698  8FC9              ;
1699  8FC9              ;	22/7/24
1700  8FC9
1701  8FC9              Cargamos_registros_con_explosion
1702  8FC9
1703  8FC9
1704  8FC9 2A 0E 8C     	ld hl,(Puntero_de_almacen_de_mov_masticados)
1705  8FCC CD 5A 90     	call Extrae_address
1706  8FCF
1707  8FCF 5D           	ld e,l
1708  8FD0 54           	ld d,h 															; Puntero objeto, (Explosión), en DE.
1709  8FD1
1710  8FD1 DD 2A 0C 8C  	ld ix,(Puntero_de_impresion)									; IX contiene Puntero_de_impresion.
1711  8FD5
1712  8FD5 C9           	ret
1713  8FD6
1714  8FD6
1715  8FD6              Cargamos_registros_con_explosion_Amadeus
1716  8FD6
1717  8FD6 2A C3 89     	ld hl,(Pamm_Amadeus)
1718  8FD9 CD 5A 90     	call Extrae_address
1719  8FDC
1720  8FDC 5D           	ld e,l
1721  8FDD 54           	ld d,h
1722  8FDE
1723  8FDE DD 2A C1 89  	ld ix,(p.imp.amadeus)
1724  8FE2
1725  8FE2 C9           	ret
1726  8FE3
1727  8FE3              ; --------------------------------------------------------------------------------------------------------------
1728  8FE3              ;
1729  8FE3              ;	17/06/24
1730  8FE3              ;
1731  8FE3              ;	Cargamos los registros DE e IX, (Puntero_de_almacen_de_mov_masticados) de Amadeus.
1732  8FE3              ;
1733  8FE3              ;	IX contiene el puntero de impresión.
1734  8FE3              ;	DE contiene (Puntero_objeto).
1735  8FE3
1736  8FE3
1737  8FE3              Cargamos_registros_con_mov_masticado_Amadeus
1738  8FE3
1739  8FE3 ED 73 54 8C  	ld (Stack),sp
1740  8FE7 ED 7B C3 89  	ld sp,(Pamm_Amadeus)											; (Puntero_de_almacen_de_mov_masticados_Amadeus) en su correspondiente caja.
1741  8FEB D1           	pop de 															; DE contiene Puntero_objeto
1742  8FEC DD E1        	pop ix 															; IX contiene Puntero_de_impresion
1743  8FEE DD 22 C1 89  	ld (p.imp.amadeus),ix											; (Puntero_de_impresion_Amadeus) en su correspondiente caja.
1744  8FF2 ED 7B 54 8C  	ld sp,(Stack)
1745  8FF6 C9           	ret
1746  8FF7
1747  8FF7              ; ---------------------------------------------------------------------------------------------------------------------
1748  8FF7              ;
1749  8FF7              ;	18/6/24
1750  8FF7              ;
1751  8FF7              ;	Genera la coordenada X de Amadeus y los datos de impresión de la nave en su (Album_de_pintado_Amadeus).
1752  8FF7
1753  8FF7              Genera_datos_de_impresion_Amadeus
1754  8FF7
1755  8FF7 3A C0 89     	ld a,(Impacto_Amadeus)
1756  8FFA A7           	and a
1757  8FFB 20 03        	jr nz,1F
1758  8FFD
1759  8FFD              ; Si existe impacto en Amadeus ya tendremos modificados los registros DE con (Puntero_objeto)_
1760  8FFD              ; _apuntando a la correspondiente explosión.
1761  8FFD
1762  8FFD CD E3 8F     	call Cargamos_registros_con_mov_masticado_Amadeus
1763  9000
1764  9000 DD 7D        1 ld a,ixl
1765  9002 E6 1F        	and $1f
1766  9004 32 BD 89     	ld (CX_Amadeus),a 												; Coordenada X del Amadeus, (0-$1f). Columnas.
1767  9007
1768  9007 2A 67 8C     	ld hl,(Scanlines_album_SP)
1769  900A E5           	push hl
1770  900B
1771  900B 2A 5C 8C     	ld hl,(Album_de_pintado_Amadeus)
1772  900E 22 67 8C     	ld (Scanlines_album_SP),hl
1773  9011
1774  9011 CD A9 94     	call Genera_datos_de_impresion
1775  9014
1776  9014 E1           	pop hl
1777  9015 22 67 8C     	ld (Scanlines_album_SP),hl
1778  9018
1779  9018 C9           	ret
1780  9019
1781  9019              ; ---------------------------------------------------------------------------------------------------------------------
1782  9019              ;
1783  9019              ;	13/03/24
1784  9019              ;
1785  9019
1786  9019              Inicia_albumes_de_lineas
1787  9019
1788  9019              ;	Entidades.
1789  9019
1790  9019 21 00 80     	ld hl,Scanlines_album
1791  901C 22 58 8C     	ld (Album_de_pintado),hl
1792  901F 22 67 8C     	ld (Scanlines_album_SP),hl
1793  9022
1794  9022 21 1A 81     	ld hl,Scanlines_album_2
1795  9025 22 5A 8C     	ld (Album_de_borrado),hl
1796  9028
1797  9028 C9           	ret
1798  9029
1799  9029              Inicia_albumes_de_lineas_Amadeus
1800  9029
1801  9029 21 34 82     	ld hl,Amadeus_scanlines_album
1802  902C 22 5C 8C     	ld (Album_de_pintado_Amadeus),hl
1803  902F 21 58 82     	ld hl,Amadeus_scanlines_album_2
1804  9032 22 5E 8C     	ld (Album_de_borrado_Amadeus),hl
1805  9035
1806  9035 C9           	ret
1807  9036
1808  9036              ; ---------------------------------------------------------------------------------------------------------------------
1809  9036              ;
1810  9036              ; 8/1/23
1811  9036              ;
1812  9036              ; (Puntero_store_caja) contendrá la dirección donde se encuentran los parámetros de la 1ª entidad del índice.
1813  9036              ; (Indice_restore_caja) se sitúa en la 2ª entidad del índice.
1814  9036              ; (Puntero_restore_caja) contendrá la dirección donde se encuentran los parámetros de la 2ª entidad del índice.
1815  9036
1816  9036              ; Destruye HL y DE !!!!!
1817  9036
1818  9036              Inicia_punteros_de_cajas
1819  9036
1820  9036 21 AA 89     	ld hl,Indice_de_cajas_de_entidades
1821  9039 CD 5A 90         call Extrae_address
1822  903C 22 47 8C         ld (Puntero_store_caja),hl
1823  903F 21 AC 89     	ld hl,Indice_de_cajas_de_entidades+2
1824  9042 22 4B 8C     	ld (Indice_restore_caja),hl
1825  9045 CD 5A 90     	call Extrae_address
1826  9048 22 49 8C     	ld (Puntero_restore_caja),hl
1827  904B C9               ret
1828  904C
1829  904C              ; *************************************************************************************************************************************************************
1830  904C              ;
1831  904C              ; 8/1/23
1832  904C              ;
1833  904C              ;	Inicializamos los punteros de selección de los 2 índices de disparo, Amadeus y Entidades.
1834  904C
1835  904C 21 64 89     Inicia_Puntero_Disparo_Entidades ld hl,Indice_de_disparos_entidades
1836  904F 22 6F 8C     	ld (Puntero_DESPLZ_DISPARO_ENTIDADES),hl
1837  9052 C9           	ret
1838  9053 21 56 89     Inicia_Puntero_Disparo_Amadeus ld hl,Indice_de_disparos_Amadeus
1839  9056 22 71 8C     	ld (Puntero_DESPLZ_DISPARO_AMADEUS),hl
1840  9059 C9           	ret
1841  905A
1842  905A              ; *************************************************************************************************************************************************************
1843  905A              ;
1844  905A              ; 20/10/22
1845  905A              ;
1846  905A              ; Extrae la direccioń que contiene un puntero, (HL), también en HL.
1847  905A              ;
1848  905A              ; Destruye el puntero y DE !!!!!
1849  905A
1850  905A 5E           Extrae_address ld e,(hl)
1851  905B 23           	inc hl
1852  905C 56           	ld d,(hl)
1853  905D 2B           	dec hl
1854  905E EB           	ex de,hl
1855  905F C9           	ret
1856  9060
1857  9060              ; *************************************************************************************************************************************************************
1858  9060              ;
1859  9060              ;	20/1/24
1860  9060              ;
1861  9060              ;	Iniciamos (Puntero_DESPLZ_der) y (Puntero_DESPLZ_izq).
1862  9060              ;	Sitúa (Puntero_objeto) en el Sprite correspondiente en función de su (Posicion_inicio).
1863  9060              ;
1864  9060              ;   Destruye HL y BC !!!!!,
1865  9060              ;
1866  9060              ;	BIT 7 (Ctrl_0). "1" ..... Derecha.
1867  9060              ;					"0" ..... Izquierda.
1868  9060
1869  9060              Inicia_Puntero_objeto
1870  9060
1871  9060 3A 26 8C     	ld a,(Cuad_objeto)
1872  9063 E6 01        	and 1
1873  9065 F5           	push af
1874  9066 CC 82 90     	call z,Inicia_puntero_objeto_izq
1875  9069 F1           	pop af
1876  906A C8           	ret z
1877  906B CD 6F 90     	call Inicia_puntero_objeto_der
1878  906E C9           	ret
1879  906F
1880  906F              ; Arrancamos desde la parte izquierda de la pantalla.
1881  906F              ; Iniciamos (Indice_Sprite_der).
1882  906F
1883  906F 2A 1C 8C     Inicia_puntero_objeto_der ld hl,(Indice_Sprite_der)
1884  9072 22 20 8C     	ld (Puntero_DESPLZ_der),hl
1885  9075 CD 5A 90     	call Extrae_address
1886  9078 22 19 8C     	ld (Puntero_objeto),hl
1887  907B
1888  907B 2A 1E 8C     	ld hl,(Indice_Sprite_izq)							; Cuando "Iniciamos el Sprite a derecha",_
1889  907E 22 22 8C     	ld (Puntero_DESPLZ_izq),hl
1890  9081 C9           	ret
1891  9082
1892  9082              ; Arrancamos desde la parte derecha de la pantalla.
1893  9082              ; Iniciamos (Indice_Sprite_izq).
1894  9082
1895  9082 2A 1E 8C     Inicia_puntero_objeto_izq ld hl,(Indice_Sprite_izq)
1896  9085 22 22 8C     	ld (Puntero_DESPLZ_izq),hl
1897  9088 CD 5A 90     	call Extrae_address
1898  908B 22 19 8C     	ld (Puntero_objeto),hl
1899  908E
1900  908E 2A 1C 8C     	ld hl,(Indice_Sprite_der)							; Cuando "Iniciamos el Sprite a izquierda",_
1901  9091 22 20 8C     	ld (Puntero_DESPLZ_der),hl							; _situamos (Puntero_DESPLZ_der) en el último defw_
1902  9094 C9           	ret
1903  9095
1904  9095              ; **************************************************************************************************
1905  9095              ;
1906  9095              ;	06/07/24
1907  9095              ;
1908  9095              ;	Cargamos los datos de la caja de entidades señalada por el puntero (Puntero_store_caja) a la BANDEJA_DRAW.
1909  9095
1910  9095              Restore_entidad
1911  9095
1912  9095 2A 47 8C     	ld hl,(Puntero_store_caja)
1913  9098 7E           	ld a,(hl)
1914  9099 A7           	and a
1915  909A CC A8 90     	call z,Incrementa_punteros_de_cajas					; Caja vacía. Saltamos a la siguiente caja.
1916  909D 28 F6        	jr z,Restore_entidad
1917  909F
1918  909F 11 07 8C     	ld de,Bandeja_DRAW
1919  90A2 01 0C 00     	ld bc,12
1920  90A5 ED B0        	ldir
1921  90A7 C9           	ret
1922  90A8
1923  90A8              ; **************************************************************************************************
1924  90A8              ;
1925  90A8              ;	08/05/23
1926  90A8              ;
1927  90A8              ;	Incrementamos los dos punteros de entidades. (+1).
1928  90A8
1929  90A8              Incrementa_punteros_de_cajas
1930  90A8
1931  90A8 2A 49 8C     	ld hl,(Puntero_restore_caja)
1932  90AB 22 47 8C     	ld (Puntero_store_caja),hl
1933  90AE 2A 4B 8C     	ld hl,(Indice_restore_caja)
1934  90B1 23           	inc hl
1935  90B2 23           	inc hl
1936  90B3 22 4B 8C     	ld (Indice_restore_caja),hl
1937  90B6 CD 5A 90         call Extrae_address
1938  90B9 22 49 8C         ld (Puntero_restore_caja),hl
1939  90BC C9               ret
1940  90BD
1941  90BD              ; -----------------------------------------------------------
1942  90BD
1943  90BD              ; Teclado.
1944  90BD
1945  90BD 3E BF        Pulsa_ENTER ld a,$bf 									; Esperamos la pulsación de la tecla "ENTER".
1946  90BF DB FE        	in a,($fe)
1947  90C1 E6 01        	and $01
1948  90C3 28 02        	jr z,1f
1949  90C5 18 F6        	jr Pulsa_ENTER
1950  90C7 C9           1 ret
1951  90C8
1952  90C8              ; **************************************************************************************************
1953  90C8              ;
1954  90C8              ; Temporización.
1955  90C8
1956  90C8              ; $0320 ..... El RASTER va a empezar a pintar el 1er scanline de la primera FILA de la pantalla.
1957  90C8              ;       ..... (14175 T/States) + 71 es lo que tarda el RASTER en llegar al 1er SCANLINE de la 1ª FILA.
1958  90C8              ; $00ff ..... Es lo que tarda el RASTER en pintar 1 SCANLINE. (31 T/States) + 71. ..... 102 T/States aprox.
1959  90C8              ;		..... 224 T/States es lo que tarda el raster en pintar 1 scanline.
1960  90C8
1961  90C8              ; $0045 ..... Es lo que tardamos en pintar 1 FILA completa, (8 Scanlines). (1794 T/States) + 71 ..... 1 FILA.
1962  90C8              ;       ..... (14920 T/States) + 71  ..... Es lo que tarda el RASTER en pintar 1 TERCIO.
1963  90C8              ; $0365 ..... Llegamos al final de la 1ª FILA, (8 Scanlines).
1964  90C8
1965  90C8              ; A partir de $4f61 no hace falta DELAY.
1966  90C8
1967  90C8              ;	!!!!!!!! DESTRUYE BC !!!!!!!!!!!
1968  90C8
1969  90C8              ;DELAY LD BC,$0900							;$0320 ..... Delay mínimo
1970  90C8              ;wait DEC BC  								;Sumaremos $0045 por FILA a esta cantidad inicial. Ejempl: si el Sprite ocupa la 1ª y 2ª_
1971  90C8              ;	LD A,B
1972  90C8              ;	AND A
1973  90C8              ;	JR NZ,wait
1974  90C8              ;	RET
1975  90C8
1976  90C8              ; ---------------------------------------------------------------------------------------------------------------
1977  90C8              ;
1978  90C8              ;	13/07/24
1979  90C8              ;
1980  90C8
1981  90C8              Inicia_Shield
1982  90C8
1983  90C8 21 8C 8C     	ld hl,Datos_Shield
1984  90CB 22 90 8C     	ld (Puntero_datos_shield),hl 						; Inicia el puntero (Puntero_datos_shield), lo situamos en la 1ª temporización.
1985  90CE
1986  90CE 7E           	ld a,(hl)
1987  90CF 32 93 8C     	ld (Shield_2),a										; (Shield_2) contiene la primera temporización.
1988  90D2
1989  90D2 3E 01        	ld a,1
1990  90D4 32 94 8C     	ld (Shield_3),a										; (Shield_3) se inicia con "1".
1991  90D7
1992  90D7 C9           	ret
1993  90D8
1994  90D8              ; ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
1995  90D8              ;
1996  90D8              ;	4/6/24
1997  90D8              ;
1998  90D8              ;	Es la 1ª rutina que se ejcuta tras la rutina de interrupciones.
1999  90D8              ;
2000  90D8              ;	ACTUALIZA LA PANTALLA siempre que se haya producido algún movimiento, (entidades, Amadeus).
2001  90D8              ;
2002  90D8
2003  90D8              Actualiza_pantalla
2004  90D8
2005  90D8 3E 02        	ld a,2
2006  90DA D3 FE        	out ($fe),a
2007  90DC
2008  90DC 3A 6D 8C     	ld a,(Ctrl_3)
2009  90DF              ;	bit 0,a
2010  90DF              ;	jr z,Ejecuta_escudo									 		  	; No pintamos si el FRAME no se ha completado.
2011  90DF CB 57        	bit 2,a
2012  90E1 28 28        	jr z,Ejecuta_escudo                                             ; No hay movimiento de entidades. Saltamos a Amadeus.
2013  90E3
2014  90E3              Borrando_entidades
2015  90E3
2016  90E3 2A 67 8C     	ld hl,(Scanlines_album_SP)
2017  90E6 CD 5A 90     	call Extrae_address
2018  90E9 24           	inc h
2019  90EA 25           	dec h
2020  90EB 28 05        	jr z,Pintando_entidades
2021  90ED CD 9E 95     	call Pinta_Sprites
2022  90F0 18 F1        	jr Borrando_entidades
2023  90F2
2024  90F2              Pintando_entidades
2025  90F2
2026  90F2 2A 69 8C     	ld hl,(India_SP)
2027  90F5 2C           	inc l
2028  90F6 CD 5A 90     	call Extrae_address
2029  90F9 24           	inc h
2030  90FA 25           	dec h
2031  90FB 28 0E        	jr z,Ejecuta_escudo
2032  90FD 1C           	inc e
2033  90FE 1C           	inc e
2034  90FF ED 53 69 8C  	ld (India_SP),de
2035  9103 CD 5A 90     	call Extrae_address
2036  9106 CD 9E 95     	call Pinta_Sprites
2037  9109 18 E7        	jr Pintando_entidades
2038  910B
2039  910B              ; --------------------- ----------------------- ---------------------- ---------------------- ---------------
2040  910B
2041  910B              Ejecuta_escudo
2042  910B
2043  910B 3A 92 8C     	ld a,(Shield)
2044  910E A7           	and a
2045  910F 20 2F        	jr nz,Aplica_Shield
2046  9111
2047  9111              Borrando_Amadeus
2048  9111
2049  9111 21 6D 8C     	ld hl,Ctrl_3
2050  9114 CB 6E        	bit 5,(hl)
2051  9116 28 1A        	jr z,1F												; No borramos. No ha habido movimiento.
2052  9118
2053  9118 2A 5E 8C     	ld hl,(Album_de_borrado_Amadeus)
2054  911B CD 5A 90     	call Extrae_address
2055  911E 24           	inc h
2056  911F 25           	dec h
2057  9120 28 03        	jr z,Pintando_Amadeus
2058  9122 CD 9E 95     	call Pinta_Sprites
2059  9125
2060  9125              Pintando_Amadeus
2061  9125
2062  9125 2A 5C 8C     	ld hl,(Album_de_pintado_Amadeus)
2063  9128 CD 5A 90     	call Extrae_address
2064  912B 24           	inc h
2065  912C 25           	dec h
2066  912D 28 03        	jr z,1F
2067  912F CD 9E 95     	call Pinta_Sprites
2068  9132
2069  9132              ; --------------------- ----------------------- ---------------------- ---------------------- ---------------
2070  9132
2071  9132 21 6D 8C     1 ld hl,Ctrl_3
2072  9135 CB 86        	res 0,(hl)											; Reinicia el flag de FRAME completo.
2073  9137 CB 96        	res 2,(hl)											; Reinicia el flag DETECTA MOVIMIENTO.
2074  9139 CB AE        	res 5,(hl)
2075  913B
2076  913B 3E 01        	ld a,1												; Borde azul.
2077  913D D3 FE        	out ($fe),a
2078  913F
2079  913F C9           	ret
2080  9140
2081  9140
2082  9140
2083  9140              Aplica_Shield
2084  9140
2085  9140              ;	Bit 1 "1" (Shield_3) Sólo borra.
2086  9140              ;		  "0"     ""     Borra/Pinta.
2087  9140              ;	Bit 2    ""  RET.	 No borra, no pinta.
2088  9140
2089  9140 21 94 8C     	ld hl,Shield_3
2090  9143
2091  9143 CB 5E        	bit 3,(hl)
2092  9145 20 DE        	jr nz,Pintando_Amadeus
2093  9147
2094  9147 CB 56        	bit 2,(hl)
2095  9149 20 E7        	jr nz,1B
2096  914B
2097  914B CB 4E        	bit 1,(hl)
2098  914D C4 54 91     	call nz,Borra_Amadeus_shield
2099  9150
2100  9150 28 BF        	jr z,Borrando_Amadeus
2101  9152 18 DE        	jr 1B
2102  9154
2103  9154              ; ----- ----- ----- ----- ----- ----- ----- ----- -----
2104  9154
2105  9154              Borra_Amadeus_shield
2106  9154
2107  9154 3A 6D 8C     	ld a,(Ctrl_3)
2108  9157 CB 6F        	bit 5,a
2109  9159 28 08        	jr z,1F
2110  915B
2111  915B 2A 5E 8C     	ld hl,(Album_de_borrado_Amadeus)
2112  915E CD 5A 90     	call Extrae_address
2113  9161 18 06        	jr 2F
2114  9163
2115  9163 2A 5C 8C     1 ld hl,(Album_de_pintado_Amadeus)
2116  9166 CD 5A 90     	call Extrae_address
2117  9169
2118  9169 CD 9E 95     2 call Pinta_Sprites
2119  916C
2120  916C AF           	xor a
2121  916D 3C           	inc a											; Asegura NZ en la salida de la rutina.
2122  916E
2123  916E C9           	ret
2124  916F
2125  916F              Pinta_Amadeus_shield
2126  916F
2127  916F 2A 5C 8C     	ld hl,(Album_de_pintado_Amadeus)
2128  9172 CD 5A 90     	call Extrae_address
2129  9175 CD 9E 95     	call Pinta_Sprites
2130  9178
2131  9178 AF           	xor a
2132  9179 3C           	inc a											; Asegura NZ en la salida de la rutina.
2133  917A
2134  917A C9           	ret
2135  917B
2136  917B              Borra_Pinta_Amadeus_shield
2137  917B
2138  917B CD 54 91     	call Borra_Amadeus_shield
2139  917E CD 6F 91     	call Pinta_Amadeus_shield
2140  9181 C9           	ret
2141  9182
2142  9182              ; ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
2143  9182              ;
2144  9182              ;	19/6/24
2145  9182              ;
2146  9182
2147  9182              Teclado
2148  9182
2149  9182              ; Está habilitado el disparo de Amadeus??, podemos disparar??. Si no es así saltamos a 1F.
2150  9182
2151  9182 3E F7        	ld a,$f7												; "5" para disparar.
2152  9184 DB FE        	in a,($fe)
2153  9186 E6 10        	and $10
2154  9188
2155  9188 CC B8 9E     	call z,Genera_disparo_Amadeus
2156  918B
2157  918B 3E F7        	ld a,$f7		  											; Rutina de TECLADO. Detecta cuando se pulsan las teclas "1" y "2"  y llama a las rutinas de "Mov_izq" y "Mov_der". $f7  detecta fila de teclas: (5,4,3,2,1).
2158  918D DB FE        	in a,($fe)												; Carga en A la información proveniente del puerto $FE, teclado.
2159  918F E6 01        	and $01													; Detecta cuando la tecla (1) está actuada. "1" no pulsada "0" pulsada. Cuando la operación AND $01 resulta "0"  llama a la rutina "Mov_izq".
2160  9191 CC 0B 9D         call z,Amadeus_a_izquierda
2161  9194
2162  9194 3E F7        	ld a,$f7
2163  9196 DB FE        	in a,($fe)
2164  9198 E6 01        	and $01
2165  919A C8           	ret z
2166  919B
2167  919B 3E F7        	ld a,$f7
2168  919D DB FE        	in a,($fe)												; Carga en A la información proveniente del puerto $FE, teclado.
2169  919F E6 02        	and $02													; Detecta cuando la tecla (1) está actuada. "1" no pulsada "0" pulsada. Cuando la operación AND $02 resulta "0"  llama a la rutina "Mov_der".
2170  91A1 CC 23 9D     	call z,Amadeus_a_derecha
2171  91A4
2172  91A4 C9           	ret
2173  91A5
2174  91A5              ; ------------------------------------------------------------------------------------------------------------------------
2175  91A5              ;
2176  91A5              ;	06/07/24
2177  91A5              ;
2178  91A5
2179  91A5              Genera_explosion
2180  91A5
2181  91A5 21 7E 8C     	ld hl,Clock_explosion
2182  91A8 35           	dec (hl)
2183  91A9 28 0C        	jr z,Siguiente_frame_explosion									; Gestionamos la siguiente entidad.
2184  91AB
2185  91AB              Borra_entidad_colisionada
2186  91AB
2187  91AB CD C4 8E     	call Recauda_informacion_de_entidad_en_curso					; Almacena la Coordenada_Y y (Scanlines_album_SP) de la entidad en curso en la TABLA_DE_PINTADO.
2188  91AE CD C9 8F     	call Cargamos_registros_con_explosion
2189  91B1 CD A9 94     	call Genera_datos_de_impresion
2190  91B4
2191  91B4 AF           	xor a
2192  91B5 3C           	inc a 															; Necesario NZ a la salida de la subrutina.
2193  91B6
2194  91B6 C9           	ret
2195  91B7
2196  91B7              Siguiente_frame_explosion
2197  91B7
2198  91B7 36 04        	ld (hl),4 														; Inicializamos (Clock_explosion), (velocidad de la explosión).
2199  91B9
2200  91B9              ; Avanza Frame de explosión.
2201  91B9
2202  91B9 2A 0E 8C     	ld hl,(Puntero_de_almacen_de_mov_masticados)
2203  91BC 01 FE 87     	ld bc,Explosion_entidades_1-2
2204  91BF 79           	ld a,c
2205  91C0 95           	sub l
2206  91C1 20 0B        	jr nz,1F
2207  91C3
2208  91C3              ; Fín de la entidad !!!!!!!!!!!!!
2209  91C3
2210  91C3 21 4E 8C     	ld hl,Numero_parcial_de_entidades
2211  91C6 35           	dec (hl)
2212  91C7 23           	inc hl
2213  91C8 35           	dec (hl)														; Decrementa (Numero_de_entidades) y (Numero_parcial_de_entidades).
2214  91C9
2215  91C9 CD 29 93     	call Limpiamos_bandeja_DRAW
2216  91CC 18 DD        	jr Borra_entidad_colisionada
2217  91CE
2218  91CE 2C           1 inc l
2219  91CF 2C           	inc l
2220  91D0 22 0E 8C     	ld (Puntero_de_almacen_de_mov_masticados),hl
2221  91D3 18 D6        	jr Borra_entidad_colisionada
2222  91D5
2223  91D5              ; ----- ----- ----- ----- -----
2224  91D5
2225  91D5              Genera_explosion_Amadeus
2226  91D5
2227  91D5 21 7F 8C     	ld hl,Clock_explosion_Amadeus
2228  91D8 35           	dec (hl)
2229  91D9 28 11        	jr z,Siguiente_frame_explosion_Amadeus							; Gestionamos la siguiente entidad.
2230  91DB
2231  91DB              Borra_Amadeus_impactado
2232  91DB
2233  91DB CD 54 8E     	call Change_Amadeus
2234  91DE CD D6 8F     	call Cargamos_registros_con_explosion_Amadeus
2235  91E1 CD F7 8F     	call Genera_datos_de_impresion_Amadeus
2236  91E4
2237  91E4 21 6D 8C     	ld hl,Ctrl_3
2238  91E7 CB EE        	set 5,(hl)														; Indicamos que hay movimiento, (se modifica el Sprite debido a la explosión).
2239  91E9
2240  91E9 AF           	xor a
2241  91EA 3C           	inc a 															; Necesario NZ a la salida de la subrutina.
2242  91EB
2243  91EB C9           	ret
2244  91EC
2245  91EC              Siguiente_frame_explosion_Amadeus
2246  91EC
2247  91EC 36 05        	ld (hl),5 														; Inicializamos (Clock_explosion_Amadeus), (velocidad de la explosión).
2248  91EE
2249  91EE              ; Avanza Frame de explosión.
2250  91EE
2251  91EE 2A C3 89     	ld hl,(Pamm_Amadeus)
2252  91F1 01 94 88     	ld bc,Explosion_Amadeus_1-2
2253  91F4 79           	ld a,c
2254  91F5 95           	sub l
2255  91F6 20 0F        	jr nz,1F
2256  91F8
2257  91F8              ; Fín de Amadeus !!!!!!!!!!!!!
2258  91F8              ; Activamos el FLAG de Amadeus destruido, ( bit_6 Ctrl_3 ).
2259  91F8
2260  91F8 AF           	xor a
2261  91F9 32 C0 89     	ld (Impacto_Amadeus),a
2262  91FC 21 6D 8C     	ld hl,Ctrl_3
2263  91FF CB F6        	set 6,(hl)
2264  9201
2265  9201 F3           	di
2266  9202 18 FE        	jr $
2267  9204 FB           	ei
2268  9205
2269  9205 18 D4        	jr Borra_Amadeus_impactado
2270  9207
2271  9207 2C           1 inc l
2272  9208 2C           	inc l
2273  9209 22 C3 89     	ld (Pamm_Amadeus),hl
2274  920C 18 CD        	jr Borra_Amadeus_impactado
2275  920E
2276  920E              ; ---------------------------------------------------------------
2277  920E
2278  920E              	include "RND_Derivando.asm"
# file opened: RND_Derivando.asm
   1+ 920E              ; ******************************************************************************************************************************************************************************************
   2+ 920E              ;
   3+ 920E              ;   21/04/24
   4+ 920E              ;
   5+ 920E              ;   Construyo un nº aleatorio. Método: "DERIVANDO."
   6+ 920E              ;   (XOR) bit a bit.
   7+ 920E              ;
   8+ 920E              ;   INPUTS: B contendrá el nº de números aleatorios que queremos generar, (0-$ff).
   9+ 920E
  10+ 920E              Derivando_RND
  11+ 920E
  12+ 920E 21 30 89         ld hl,Numeros_aleatorios
  13+ 9211
  14+ 9211 ED 5F        3 ld a,r      			                ; La semilla inicial de nuestro nº aleatorio la proporciona el registro `R´. Cargamos A con R.
  15+ 9213 C5               push bc
  16+ 9214              ;                                       ; El registro R, es un registro de 8 bits que actúa como contador de refresco de la memoria dinámica. ($00 - $ff).
  17+ 9214 01 00 07         ld bc,$0700                         ; C contendrá nuestro nº aleatorio: $0 - $ff. Inicialmente está a "0".
  18+ 9217              ;                                       ; B actuará como contador de bits. Requerimos de 1 byte, ($ff).
  19+ 9217
  20+ 9217 A7           6 and a                                 ; Carry a "0".
  21+ 9218 CB 3F            srl a                               ; Desplazamiento a la derecha.
  22+ 921A 30 02            jr nc,1F
  23+ 921C
  24+ 921C CB C1            set 0,c
  25+ 921E
  26+ 921E 57           1 ld d,a                                ; D contiene la copia de nuestra semilla después del DESPLAZAMIENTO.
  27+ 921F E6 01            and %00000001                       ; Extraigo el último bit de A y lo guardamos en E.
  28+ 9221 5F               ld e,a
  29+ 9222
  30+ 9222 7A               ld a,d
  31+ 9223 E6 02            and %00000010                       ; Extraigo el penúltimo bit de A y lo `traslado´ al último bit de A. El objetivo es implementar una función XOR_
  32+ 9225 28 02            jr z,2F                             ; _con el último y penúltimo bit de nuestra semilla.
  33+ 9227
  34+ 9227 CB 3F            srl a
  35+ 9229
  36+ 9229 AB           2 xor e                                 ; XOR entre el último y penúltimo bit de A.
  37+ 922A
  38+ 922A 7A               ld a,d                              ; A vuelve a contener la copia de nuestra semilla después del DESPLAZAMIENTO.
  39+ 922B 28 04            jr z,4F
  40+ 922D
  41+ 922D CB FF            set 7,a
  42+ 922F 18 02            jr 5F
  43+ 9231
  44+ 9231 CB BF        4 res 7,a
  45+ 9233
  46+ 9233 CB 21        5 sla c
  47+ 9235 10 E0            djnz 6B
  48+ 9237
  49+ 9237 79               ld a,c                              ; Nº aleatorio (1 Byte) en A.
  50+ 9238
  51+ 9238 77               ld (hl),a
  52+ 9239 23               inc hl
  53+ 923A C1               pop bc
  54+ 923B 10 D4            djnz 3B
  55+ 923D
  56+ 923D C9               ret
  57+ 923E
  58+ 923E
  59+ 923E
# file closed: RND_Derivando.asm
2279  923E              	include "Rutinas_de_inicio_y_niveles.asm"
# file opened: Rutinas_de_inicio_y_niveles.asm
   1+ 923E              ;---------------------------------------------------------------------------------------------------------------
   2+ 923E              ;
   3+ 923E              ;   8/3/24
   4+ 923E              ;
   5+ 923E              ;	Carga el nº de entidades del nivel en (Numero_de_entidades).
   6+ 923E              ;	Fija los perfiles de velocidad según el Nivel de dificultad.
   7+ 923E              ;	Sitúa el puntero (Datos_de_nivel) en la dirección de memoria donde se encuentra el .db que define el (Tipo)_
   8+ 923E              ;	_ de la 1ª entidad del Nivel.
   9+ 923E              ;
  10+ 923E              ;	Sitúa (Puntero_indice_mov) en la coreografía correcta.
  11+ 923E
  12+ 923E              ;	MODIFICA: HL,DE y A.
  13+ 923E              ;	ACTUALIZA: (Puntero_indice_NIVELES), (Numero_de_entidades) y (Datos_de_nivel).
  14+ 923E
  15+ 923E              Inicializa_Nivel
  16+ 923E
  17+ 923E 2A 88 8C     	ld hl,(Puntero_indice_NIVELES)
  18+ 9241 CD 5A 90     	call Extrae_address
  19+ 9244 7E           	ld a,(hl)
  20+ 9245 32 4D 8C     	ld (Numero_de_entidades),a					 ; Fijamos el nº de entidades que tiene el nivel.
  21+ 9248 23           	inc hl
  22+ 9249 CD 56 92     	call Fija_velocidades					     ; Perfiles_de_velocidad según Nivel.
  23+ 924C 22 8A 8C     	ld (Datos_de_nivel),hl						 ; (Datos_de_nivel) ahora apunta a la dirección de mem. donde se encuentra el .db que indica el (Tipo) de la 1ª entidad del Nivel.
  24+ 924F CD 5F 92     	call Inicializa_Puntero_indice_mov			 ; Inicializa (Puntero_indice_mov) según el (Tipo) de Entidad. Nos situamos en la coreografía correcta.
  25+ 9252
  26+ 9252 CD 70 92     	call Inicializa_Puntero_de_almacen_de_mov_masticados	; Selecciona el almacén adecuado de mov_masticados según el (Tipo) de entidad.
  27+ 9255 C9           	ret
  28+ 9256
  29+ 9256              ; ----------------------
  30+ 9256
  31+ 9256 11 2C 8C     Fija_velocidades ld de,Perfiles_de_velocidad
  32+ 9259 01 04 00     	ld bc,4
  33+ 925C ED B0        	ldir
  34+ 925E C9           	ret
  35+ 925F
  36+ 925F 7E           Inicializa_Puntero_indice_mov ld a,(hl)     	 ; Cargamos A con el (Tipo) de la 1ª entidad del Nivel.
  37+ 9260 CD FA 93         call Calcula_salto_en_BC
  38+ 9263 21 52 89         ld hl,Indice_de_mov_segun_tipo_de_entidad
  39+ 9266 A7               and a
  40+ 9267 ED 4A            adc hl,bc
  41+ 9269 CD 5A 90         call Extrae_address
  42+ 926C 22 38 8C         ld (Puntero_indice_mov),hl
  43+ 926F C9               ret
  44+ 9270
  45+ 9270 3A 07 8C     Inicializa_Puntero_de_almacen_de_mov_masticados ld a,(Tipo)
  46+ 9273 CD FA 93     	call Calcula_salto_en_BC
  47+ 9276 21 20 EB     	ld hl,Almacen_de_movimientos_masticados_Entidad_1
  48+ 9279 A7               and a
  49+ 927A ED 4A            adc hl,bc
  50+ 927C CD 5A 90         call Extrae_address
  51+ 927F 22 0E 8C     	ld (Puntero_de_almacen_de_mov_masticados),hl
  52+ 9282 C9           	ret
  53+ 9283
  54+ 9283              ;---------------------------------------------------------------------------------------------------------------
  55+ 9283              ;
  56+ 9283              ;   5/1/24
  57+ 9283              ;
  58+ 9283              ;	Destruye A,BC,HL,DE
  59+ 9283
  60+ 9283              ;	Esta rutina se encarga de preparar las CAJAS DE ENTIDADES.
  61+ 9283              ;	El tipo de entidad que vamos a `volcar´ en cada caja viene determinado por el valor de (Datos_de_nivel).
  62+ 9283
  63+ 9283              Inicia_Entidades
  64+ 9283
  65+ 9283              ; Preparamos los punteros de las cajas de entidades:
  66+ 9283
  67+ 9283 CD 36 90     	call Inicia_punteros_de_cajas								; Situa (Puntero_store_caja) en el 1er .db de la 1ª caja del índice de entidades.
  68+ 9286              ;																; Situa (Puntero_restore_caja) en el 1er .db de la 2ª caja del índice de cajas de entidades.
  69+ 9286 CD 42 94     	call Inicializa_Numero_parcial_de_entidades					; Actualiza (Numero_de_entidades) y (Numero_parcial_de_entidades).
  70+ 9289
  71+ 9289 2A 8A 8C     	ld hl,(Datos_de_nivel)										; Tipo de la 1ª entidad del Nivel.
  72+ 928C
  73+ 928C 22 8A 8C     2 ld (Datos_de_nivel),hl 										; Actualizamos. Ahora nos encontramos en la siguiente entidad del Nivel.
  74+ 928F
  75+ 928F CD A8 93     	call Activa_FLAG_Tipo_de_entidad							; La rutina identifica el (Tipo) de entidad que vamos a iniciar.
  76+ 9292
  77+ 9292 2A 8A 8C     	ld hl,(Datos_de_nivel)
  78+ 9295
  79+ 9295              ; En este punto:
  80+ 9295              ;
  81+ 9295              ; HL está situado en los .db del Nivel que indican el `tipo´ de entidad a volcar en la caja de entidades.
  82+ 9295              ; B contiene (Numero_parcial_de_entidades), (nº de cajas que vamos a rellenar).
  83+ 9295
  84+ 9295 C5           1 push bc 														; Guardo el nº de cajas a rellenar.
  85+ 9296
  86+ 9296 7E           	ld a,(hl)
  87+ 9297 CD 14 93     	call Definicion_segun_tipo 									; Nos situamos en el 1er .db de datos de la definición de este tipo de entidad.
  88+ 929A
  89+ 929A CD 0C 94     	call Definicion_de_entidad_a_bandeja_DRAW					; Vuelca los datos de la definición en DRAW.
  90+ 929D
  91+ 929D              ;	Este (Tipo) de entidad ya dispone de movimientos masticados ???
  92+ 929D
  93+ 929D CD CA 93     	call Busca_mov_masticados_segun_tipo
  94+ 92A0
  95+ 92A0 A7           	and a
  96+ 92A1 28 08        	jr z,3F														; A="1" Indica que los mov_masticados de este (Tipo) de entidad ya están generados.
  97+ 92A3
  98+ 92A3              ; 	Este (Tipo) de entidad DISPONE DE MOV_MASTICADOS.
  99+ 92A3
 100+ 92A3              ;	Actualizamos el (Contador_de_mov_masticados) de esta entidad con el (Contador_general_de_mov_masticados)_
 101+ 92A3              ;	_ de este tipo de entidad.
 102+ 92A3
 103+ 92A3 CD A2 9E     	call Situa_en_contador_general_de_mov_masticados
 104+ 92A6 CD AF 9E     	call Transfiere_datos_de_contadores
 105+ 92A9
 106+ 92A9 18 06        	jr 4F
 107+ 92AB
 108+ 92AB CD 5C 8F     3 call Construye_movimientos_masticados_entidad
 109+ 92AE
 110+ 92AE              ; Tenemos todos los movimientos masticados de este tipo de entidad generados y guardados en su correspondiente almacén.
 111+ 92AE              ; (Puntero_de_almacen_de_mov_masticados) de esta entidad está situado al principio del almacen.
 112+ 92AE              ; (Contador_de_mov_masticados) de esta entidad contiene: el nº total de mov. masticados de este tipo de entidad.
 113+ 92AE              ; Contador_general_de_mov_masticados de este tipo de entidad actualizado.
 114+ 92AE              ; Lo tenemos todo preparado para cargar los registros con el mov. masticado y hacer la correspondiente foto.
 115+ 92AE
 116+ 92AE CD 88 93     	call Activa_FLAG_mov_masticados_completos					; Activa el FLAG que indica que este (Tipo) de entidad tiene todos sus_
 117+ 92B1              ;																; _ Mov_masticados ya generados.
 118+ 92B1
 119+ 92B1 CD B0 8F     4 call Cargamos_registros_con_mov_masticado						; Cargamos los registros con el movimiento actual y `saltamos' al movimiento siguiente.
 120+ 92B4
 121+ 92B4 DD E5        	push ix
 122+ 92B6 E1           	pop hl 														; (Puntero_de_impresion) en HL.
 123+ 92B7
 124+ 92B7 D5           	push de
 125+ 92B8 CD 7D 94     	call Genera_coordenadas
 126+ 92BB
 127+ 92BB ED 5B 67 8C  	ld de,(Scanlines_album_SP)
 128+ 92BF CD C4 8E     	call Recauda_informacion_de_entidad_en_curso				; Almacena la Coordenada_Y y (Scanlines_album_SP) de la entidad en curso.
 129+ 92C2 D1           	pop de
 130+ 92C3
 131+ 92C3 CD A9 94     	call Genera_datos_de_impresion
 132+ 92C6              ;																; La rutina [Genera_datos_de_impresion] habilita las interrupciones antes del RET.
 133+ 92C6              ;																; DI nos asegura que no vamos a ejecutar FRAME hasta que no tengamos todas las entidades iniciadas.
 134+ 92C6              ;																; La rutina [Genera_datos_de_impresion] activa las interrupciones antes del RET.
 135+ 92C6              ; Actualizamos (Contador_de_mov_masticados) tras la foto.
 136+ 92C6
 137+ 92C6 CD 4C 93     	call Decrementa_Contador_de_mov_masticados
 138+ 92C9
 139+ 92C9              ; Antes de guardar los parámetros de esta entidad en su correspondiente caja hay que actualizar coordenadas.
 140+ 92C9
 141+ 92C9 ED 5B 47 8C  	ld de,(Puntero_store_caja)
 142+ 92CD CD 39 94     	call Parametros_de_bandeja_DRAW_a_caja	 					; Caja de entidades completa.
 143+ 92D0
 144+ 92D0 CD 29 93     	call Limpiamos_bandeja_DRAW
 145+ 92D3 CD A8 90     	call Incrementa_punteros_de_cajas
 146+ 92D6
 147+ 92D6              ; Inicializa los FLAGS que indican el (Tipo) de entidad que vamos a iniciar, pues pasamos a iniciar la siguiente_
 148+ 92D6              ; _ entidad del Nivel.
 149+ 92D6
 150+ 92D6 3A 6E 8C     	ld a,(Ctrl_4)
 151+ 92D9 E6 F0        	and $f0
 152+ 92DB 32 6E 8C     	ld (Ctrl_4),a 												; Mantenemos FLAGS que indican MOV_MASTICADOS.
 153+ 92DE
 154+ 92DE              ; Siguiente entidad del Nivel.
 155+ 92DE
 156+ 92DE 2A 8A 8C     	ld hl,(Datos_de_nivel)										; Nos situamos en el .db que define el (Tipo) de la siguiente_
 157+ 92E1 23           	inc hl 														; _ entidad del Nivel.
 158+ 92E2
 159+ 92E2 C1           	pop bc 														; Recuperamos (Numero_parcial_de_entidades), (nº de cajas que vamos a rellenar)
 160+ 92E3
 161+ 92E3 10 A7        	djnz 2B
 162+ 92E5
 163+ 92E5 C9           	ret
 164+ 92E6
 165+ 92E6              ; -------------------------------------------------------------------------------------------------------------------
 166+ 92E6              ;
 167+ 92E6              ;	27/5/24
 168+ 92E6              ;
 169+ 92E6              ;	Inicia,genera mov. masticados y sitúa en el centro de la pantalla a Amadeus.
 170+ 92E6              ;
 171+ 92E6
 172+ 92E6              ; 	Cargamos la definición de Amadeus en DRAW.
 173+ 92E6              ;	Nos situamos en el 1er .db, (Tipo), de la definición de Amadeus.
 174+ 92E6
 175+ 92E6 21 3A 8A     Inicia_Amadeus ld hl,Definicion_Amadeus
 176+ 92E9 CD 0C 94     	call Definicion_de_entidad_a_bandeja_DRAW				; Vuelca los datos de la definición de Amadeus en DRAW.
 177+ 92EC
 178+ 92EC
 179+ 92EC              Construye_movimientos_masticados_Amadeus
 180+ 92EC
 181+ 92EC 2A 0E 8C     	ld hl,(Puntero_de_almacen_de_mov_masticados)			; Guardamos en la pila la dirección inicial del puntero, (para reiniciarlo más tarde).
 182+ 92EF CD A3 8F     	call Actualiza_Puntero_de_almacen_de_mov_masticados 	; Actualizamos (Puntero_de_almacen_de_mov_masticados) e incrementa_
 183+ 92F2              ;															; _ el (Contador_de_mov_masticados).
 184+ 92F2 CD 60 90     	call Inicia_Puntero_objeto								; Inicializa (Puntero_DESPLZ_der) y (Puntero_DESPLZ_izq).
 185+ 92F5              ;															; Inicializa (Puntero_objeto) en función de la (Posicion_inicio) de la entidad.
 186+ 92F5
 187+ 92F5              ; Generamos movimientos masticados de Amadeus.
 188+ 92F5
 189+ 92F5 06 79        	ld b,121												; $0079, 121d.
 190+ 92F7
 191+ 92F7 C5           1 push bc
 192+ 92F8 CD C1 96     	call Draw
 193+ 92FB CD 88 8F     	call Guarda_movimiento_masticado
 194+ 92FE
 195+ 92FE CD 35 9A     	call Mov_right
 196+ 9301 CD 35 9A     	call Mov_right											; Amadeus se mueve x2 pixel.
 197+ 9304
 198+ 9304 C1           	pop bc
 199+ 9305 10 F0        	djnz 1B
 200+ 9307
 201+ 9307              ; Todos los movimientos masticados de Amadeus se han creado.
 202+ 9307
 203+ 9307              ;	(Contador_de_mov_masticados) de Amadeus ="$0079", 121d movimientos en total. Amadeus se encuentra ahora en el extremo derecho de la pantalla.
 204+ 9307              ;	Ahora hay que modificar la posición del (Puntero_de_almacen_de_mov_masticados), (está 4 posiciones de memoria adelantado para seguir creando desplazamientos).
 205+ 9307
 206+ 9307 2A 0E 8C     	ld hl,(Puntero_de_almacen_de_mov_masticados)
 207+ 930A 01 08 00     	ld bc,8
 208+ 930D A7           	and a
 209+ 930E ED 42        	sbc hl,bc
 210+ 9310 22 0E 8C     	ld (Puntero_de_almacen_de_mov_masticados),hl
 211+ 9313
 212+ 9313 C9           	ret
 213+ 9314
 214+ 9314              ; ---------------------------------------------------------------------
 215+ 9314              ;
 216+ 9314              ;	10/02/24
 217+ 9314              ;
 218+ 9314              ;	Nos situamos en el 1er .db de datos de la definición de este tipo de entidad.
 219+ 9314              ;
 220+ 9314              ;	INPUT: A contiene el TIPO de ENTIDAD que almacenaremos en la caja.
 221+ 9314
 222+ 9314              Definicion_segun_tipo
 223+ 9314
 224+ 9314 CD FA 93     	call Calcula_salto_en_BC									; Calcula el salto para situarnos en la definición de entidad correcta de indice de [Indice_de_definiciones_de_entidades].
 225+ 9317 21 1C 8A     	ld hl,Indice_de_definiciones_de_entidades
 226+ 931A CD 02 94     	call Situa_en_datos_de_definicion							; Sitúa HL en el 1er .db de la definición de entidad tipo que tenemos que volcar en DRAW.
 227+ 931D C9           	ret
 228+ 931E
 229+ 931E              ; ---------------------------------------------------------------------
 230+ 931E              ;
 231+ 931E              ;	6/7/24
 232+ 931E
 233+ 931E
 234+ 931E              Store_Restore_cajas
 235+ 931E
 236+ 931E ED 5B 47 8C  	ld de,(Puntero_store_caja)
 237+ 9322 CD 39 94     	call Parametros_de_bandeja_DRAW_a_caja	 					; Caja de entidades completa.
 238+ 9325 CD A8 90     	call Incrementa_punteros_de_cajas
 239+ 9328 C9           	ret
 240+ 9329
 241+ 9329              ; ---------------------------------------------------------------------
 242+ 9329              ;
 243+ 9329              ;	23/6/24
 244+ 9329              ;
 245+ 9329              ;	Limpiamos lo más rápido posible la Bandeja DRAW.
 246+ 9329              ;
 247+ 9329              ;	MODIFY: HL
 248+ 9329
 249+ 9329              Limpiamos_bandeja_DRAW
 250+ 9329
 251+ 9329 ED 73 54 8C  	ld (Stack),sp
 252+ 932D 31 2C 8C     	ld sp,Vel_left
 253+ 9330
 254+ 9330 AF           	xor a
 255+ 9331 67           	ld h,a
 256+ 9332 6F           	ld l,a
 257+ 9333
 258+ 9333 E5           	push hl
 259+ 9334 E5           	push hl
 260+ 9335 E5           	push hl
 261+ 9336 E5           	push hl
 262+ 9337 E5           	push hl
 263+ 9338 E5           	push hl
 264+ 9339 E5           	push hl
 265+ 933A E5           	push hl
 266+ 933B E5           	push hl
 267+ 933C E5           	push hl
 268+ 933D E5           	push hl
 269+ 933E E5           	push hl
 270+ 933F E5           	push hl
 271+ 9340 E5           	push hl
 272+ 9341 E5           	push hl
 273+ 9342 E5           	push hl
 274+ 9343 E5           	push hl
 275+ 9344 E5           	push hl
 276+ 9345
 277+ 9345 33           	inc sp
 278+ 9346
 279+ 9346 E5           	push hl
 280+ 9347 ED 7B 54 8C  	ld sp,(Stack)
 281+ 934B
 282+ 934B C9           	ret
 283+ 934C
 284+ 934C              ; ---------------------------------------------------------------------
 285+ 934C              ;
 286+ 934C              ;	24/03/24
 287+ 934C
 288+ 934C 2A 10 8C     Decrementa_Contador_de_mov_masticados ld hl,(Contador_de_mov_masticados)
 289+ 934F 2B           	dec hl
 290+ 9350 22 10 8C     	ld (Contador_de_mov_masticados),hl
 291+ 9353 C9           	ret
 292+ 9354
 293+ 9354              ; ---------------------------------------------------------------------
 294+ 9354              ;
 295+ 9354              ;	8/5/24
 296+ 9354
 297+ 9354              Reinicia_entidad_maliciosa
 298+ 9354
 299+ 9354              ;	En 1er lugar actualizamos el (Contador_de_mov_masticados).
 300+ 9354
 301+ 9354 CD A2 9E     	call Situa_en_contador_general_de_mov_masticados
 302+ 9357 CD AF 9E     	call Transfiere_datos_de_contadores
 303+ 935A
 304+ 935A              ; 	En 2º lugar hay que inicializar el (Puntero_de_almacen_de_mov_masticados).
 305+ 935A
 306+ 935A 3A 07 8C     	ld a,(Tipo)
 307+ 935D CD 14 93     	call Definicion_segun_tipo
 308+ 9360
 309+ 9360 E5           	push hl
 310+ 9361 DD E1        	pop ix
 311+ 9363
 312+ 9363 DD 6E 0B     	ld l,(ix+11)
 313+ 9366 DD 66 0C     	ld h,(ix+12)
 314+ 9369
 315+ 9369 22 0E 8C     	ld (Puntero_de_almacen_de_mov_masticados),hl
 316+ 936C
 317+ 936C CD B0 8F     	call Cargamos_registros_con_mov_masticado
 318+ 936F
 319+ 936F              ; Incrementa el contador de vueltas, (el contador cuenta 4 vueltas máximo).
 320+ 936F              ; El perfil de velocidad de la entidad será: (Contador_de_vueltas)/8.
 321+ 936F              ; Ejemplos.
 322+ 936F
 323+ 936F              ;	1ª vuelta: (Contador_de_vueltas)="$02" --- (Velocidad)="0".
 324+ 936F              ;	2ª vuelta: 	""	""	""	""	""  ="$04" ---   ""	 ""	  ="1".
 325+ 936F              ;	3ª vuelta: 	""	""	""	""	""  ="$08" ---   ""	 ""	  ="2".
 326+ 936F              ;	4ª vuelta: 	""	""	""	""	""  ="$10" ---   ""	 ""	  ="4".
 327+ 936F              ;	5ª vuelta: 	""	""	""	""	""  ="$20" ---   ""	 ""	  ="8".
 328+ 936F
 329+ 936F 21 0A 8C     	ld hl,Contador_de_vueltas
 330+ 9372 CB 26        	sla (hl)									; Incrementa el contador, (desplaza el bit a izquierda).
 331+ 9374
 332+ 9374 7E           	ld a,(hl)
 333+ 9375 CB 2F        	sra a
 334+ 9377 CB 2F        	sra a
 335+ 9379
 336+ 9379 32 12 8C     	ld (Velocidad),a
 337+ 937C
 338+ 937C 3E 40        	ld a,$40
 339+ 937E BE           	cp (hl)
 340+ 937F C0           	ret nz
 341+ 9380
 342+ 9380              ; Límitador.
 343+ 9380
 344+ 9380              ;	Limita el valor de (Contador_de_vueltas) a "$20" y de (Velocidad) a "$04".
 345+ 9380
 346+ 9380 CB 2E        	sra (hl)
 347+ 9382 21 12 8C     	ld hl,Velocidad
 348+ 9385 CB 2E        	sra (hl)
 349+ 9387
 350+ 9387 C9           	ret
 351+ 9388
 352+ 9388              ; ---------------------------------------------------------------------
 353+ 9388              ;
 354+ 9388              ;	22/01/24
 355+ 9388
 356+ 9388 21 6E 8C     Activa_FLAG_mov_masticados_completos ld hl,Ctrl_4
 357+ 938B CB 46        	bit 0,(hl)
 358+ 938D 20 0D        	jr nz,1F
 359+ 938F CB 4E        	bit 1,(hl)
 360+ 9391 20 0C        	jr nz,2F
 361+ 9393 CB 56        	bit 2,(hl)
 362+ 9395 20 0B        	jr nz,3F
 363+ 9397 CB 5E        	bit 3,(hl)
 364+ 9399 20 0A        	jr nz,4F
 365+ 939B C9           	ret
 366+ 939C
 367+ 939C CB E6        1 set 4,(hl)
 368+ 939E C9           	ret
 369+ 939F CB EE        2 set 5,(hl)
 370+ 93A1 C9           	ret
 371+ 93A2 CB F6        3 set 6,(hl)
 372+ 93A4 C9           	ret
 373+ 93A5 CB FE        4 set 7,(hl)
 374+ 93A7 C9           	ret
 375+ 93A8
 376+ 93A8              ; ---------------------------------------------------------------------
 377+ 93A8              ;
 378+ 93A8              ;	23/01/24
 379+ 93A8              ;
 380+ 93A8              ;	Activamos el FLAG correspondiente a cada tipo de entidad.
 381+ 93A8              ;
 382+ 93A8              ;	bit_0 (Ctrl_4) ..... Entidad de (Tipo)_1.
 383+ 93A8              ;	bit_1 (Ctrl_4) ..... Entidad de (Tipo)_2.
 384+ 93A8              ;	bit_2 (Ctrl_4) ..... Entidad de (Tipo)_3.
 385+ 93A8              ;	bit_3 (Ctrl_4) ..... Entidad de (Tipo)_4.
 386+ 93A8
 387+ 93A8              ;	INPUTS: HL contiene (Datos_de_nivel), (tipo de entidad que estamos iniciando).
 388+ 93A8
 389+ 93A8 7E           Activa_FLAG_Tipo_de_entidad ld a,(hl)
 390+ 93A9 3D           	dec a
 391+ 93AA 20 06        	jr nz,1F
 392+ 93AC
 393+ 93AC              ; --- Tipo_1
 394+ 93AC
 395+ 93AC 21 6E 8C     	ld hl,Ctrl_4
 396+ 93AF CB C6        	set 0,(hl)
 397+ 93B1 C9           	ret
 398+ 93B2
 399+ 93B2 3D           1 dec a
 400+ 93B3 20 06        	jr nz,2F
 401+ 93B5
 402+ 93B5              ; --- Tipo_2
 403+ 93B5
 404+ 93B5 21 6E 8C     	ld hl,Ctrl_4
 405+ 93B8 CB CE        	set 1,(hl)
 406+ 93BA C9           	ret
 407+ 93BB
 408+ 93BB 3D           2 dec a
 409+ 93BC 20 06        	jr nz,3F
 410+ 93BE
 411+ 93BE              ; --- Tipo_3
 412+ 93BE
 413+ 93BE 21 6E 8C     	ld hl,Ctrl_4
 414+ 93C1 CB D6        	set 2,(hl)
 415+ 93C3 C9           	ret
 416+ 93C4
 417+ 93C4              ; --- Tipo_3
 418+ 93C4
 419+ 93C4 21 6E 8C     3 ld hl,Ctrl_4
 420+ 93C7 CB D6        	set 2,(hl)
 421+ 93C9 C9           	ret
 422+ 93CA
 423+ 93CA              ; ---------------------------------------------------------------------
 424+ 93CA              ;
 425+ 93CA              ;	22/01/24
 426+ 93CA
 427+ 93CA 21 6E 8C     Busca_mov_masticados_segun_tipo ld hl,Ctrl_4
 428+ 93CD CB 46        	bit 0,(hl)
 429+ 93CF 20 0E        	jr nz,1F
 430+ 93D1
 431+ 93D1 CB 4E        	bit 1,(hl)
 432+ 93D3 20 10        	jr nz,2F
 433+ 93D5
 434+ 93D5 CB 56        	bit 2,(hl)
 435+ 93D7 20 12        	jr nz,3F
 436+ 93D9
 437+ 93D9 CB 5E        	bit 3,(hl)
 438+ 93DB 20 14        	jr nz,4F
 439+ 93DD 18 19        	jr 6F
 440+ 93DF
 441+ 93DF              ; Entidad_de_Tipo_1.
 442+ 93DF
 443+ 93DF CB 66        1 bit 4,(hl)
 444+ 93E1 28 15        	jr z,6F
 445+ 93E3 18 10        	jr 5F
 446+ 93E5
 447+ 93E5              ; Entidad_de_Tipo_2.
 448+ 93E5
 449+ 93E5 CB 6E        2 bit 5,(hl)
 450+ 93E7 28 0F        	jr z,6F
 451+ 93E9 18 0A        	jr 5F
 452+ 93EB
 453+ 93EB              ; Entidad_de_Tipo_3.
 454+ 93EB
 455+ 93EB CB 76        3 bit 6,(hl)
 456+ 93ED 28 09        	jr z,6F
 457+ 93EF 18 04        	jr 5F
 458+ 93F1
 459+ 93F1              ; Entidad_de_Tipo_4.
 460+ 93F1
 461+ 93F1 CB 7E        4 bit 7,(hl)
 462+ 93F3 28 03        	jr z,6F
 463+ 93F5
 464+ 93F5              ; Esta entidad TIENE MOV_MASTICADOS.
 465+ 93F5
 466+ 93F5 AF           5 xor a
 467+ 93F6 3C           	inc a
 468+ 93F7 C9           	ret
 469+ 93F8
 470+ 93F8              ; Esta entidad NO TIENE MOV_MASTICADOS.
 471+ 93F8
 472+ 93F8 AF           6 xor a
 473+ 93F9 C9           	ret
 474+ 93FA
 475+ 93FA              ;	------------------------------------------------------------------------------------
 476+ 93FA              ;
 477+ 93FA              ;	12/01/24
 478+ 93FA              ;
 479+ 93FA              ;	INPUTS:	A contiene el (Tipo) de entidad.
 480+ 93FA              ;
 481+ 93FA              ;	Esta pequeña sub-rutina carga BC con 0,2,4,6,8 ... en función del tipo de entidad: (1,2,3,4,...).
 482+ 93FA              ;	Calcula "el salto" para situarnos en los DATOS de la ENTIDAD correcta del índice de entidades según el tipo de entidad.
 483+ 93FA
 484+ 93FA CB 27        Calcula_salto_en_BC sla a
 485+ 93FC D6 02        	sub 2										; ("Tipo_de_entidad")*2-2.
 486+ 93FE 4F           	ld c,a
 487+ 93FF 06 00        	ld b,0
 488+ 9401 C9           	ret
 489+ 9402
 490+ 9402              ; ------------------------------------------------------------------
 491+ 9402              ;
 492+ 9402              ;	19/1/24
 493+ 9402              ;
 494+ 9402              ;	Sitúa HL en el 1er .db de la definición de la entidad que tenemos que volcar en la bandeja DRAW.
 495+ 9402              ;	Actualiza (Datos_de_entidad) con esa dirección.
 496+ 9402
 497+ 9402 A7           Situa_en_datos_de_definicion and a
 498+ 9403 ED 4A        	adc hl,bc
 499+ 9405 CD 5A 90     	call Extrae_address
 500+ 9408 22 52 8C         ld (Datos_de_entidad),hl
 501+ 940B C9           	ret
 502+ 940C
 503+ 940C              ; ------------------------------------------------------------------
 504+ 940C
 505+ 940C              ; Avanza_caja_de_entidades ld (Puntero_store_caja),hl
 506+ 940C              ; 	inc de
 507+ 940C              ; 	inc de
 508+ 940C              ; 	ex de,hl
 509+ 940C              ; 	ld (Indice_restore_caja),hl 				; Indice_de_cajas_de_entidades +2.
 510+ 940C              ; 	ret
 511+ 940C
 512+ 940C              ; ----------------------------------------------------------------------------------------------------------
 513+ 940C              ;
 514+ 940C              ;	24/6/24
 515+ 940C              ;
 516+ 940C              ;	Introduce una definición de entidad en la bandeja DRAW para generar los "movimientos masticados" de este tipo_
 517+ 940C              ;	_ de entidad.
 518+ 940C              ;
 519+ 940C              ;	INPUTS: HL apunta al 1er .db de datos de la definición de la entidad.
 520+ 940C              ;
 521+ 940C              ;
 522+ 940C              ;	MODIFICA: HL,DE y BC
 523+ 940C
 524+ 940C
 525+ 940C              Definicion_de_entidad_a_bandeja_DRAW
 526+ 940C
 527+ 940C 11 07 8C     	ld de,Bandeja_DRAW	 						; DE apunta al 1er .db de la bandeja_DRAW, (Tipo).
 528+ 940F 7E           	ld a,(hl) 									; Volcamos Tipo.
 529+ 9410 12           	ld (de),a
 530+ 9411 23           	inc hl
 531+ 9412              ;
 532+ 9412 11 15 8C     	ld de,Filas									; Volcamos (Filas) y (Columns).
 533+ 9415 01 02 00     	ld bc,2
 534+ 9418 ED B0        	ldir										; Hemos volcado (Contador_de_vueltas), (Indice_Sprite_der) y (Indice_Sprite_izq).
 535+ 941A              ;												; HL, (origen), apunta ahora al .db (Posicion_inicio), hay que situar DE.
 536+ 941A 11 0A 8C     	ld de,Contador_de_vueltas
 537+ 941D 7E           	ld a,(hl)
 538+ 941E 12           	ld (de),a
 539+ 941F 23           	inc hl										; Hemos volcado (Posicion_inicio) y (Cuad_objeto).
 540+ 9420
 541+ 9420 11 1C 8C     	ld de,Indice_Sprite_der
 542+ 9423 01 04 00     	ld bc,4
 543+ 9426 ED B0        	ldir 										; Hemos volcado (Puntero_de_almacen_de_mov_masticados).
 544+ 9428
 545+ 9428 11 24 8C     	ld de,Posicion_inicio
 546+ 942B 01 03 00     	ld bc,3									; 3 FRAMES de explosión.!!!!!!!!!!!!!!
 547+ 942E ED B0        	ldir 									; Vuelco (Frames_explosion).
 548+ 9430
 549+ 9430 11 0E 8C     	ld de,Puntero_de_almacen_de_mov_masticados
 550+ 9433 01 02 00     	ld bc,2
 551+ 9436 ED B0        	ldir
 552+ 9438
 553+ 9438 C9           	ret
 554+ 9439
 555+ 9439              ; ----------------------------------------------------------------------------------------------------------
 556+ 9439              ;
 557+ 9439              ;	1/8/24
 558+ 9439              ;
 559+ 9439
 560+ 9439              Parametros_de_bandeja_DRAW_a_caja
 561+ 9439
 562+ 9439 21 07 8C     	ld hl,Bandeja_DRAW
 563+ 943C 01 0C 00     	ld bc,12
 564+ 943F ED B0        	ldir
 565+ 9441 C9           	ret
 566+ 9442
 567+ 9442              ;---------------------------------------------------------------------------------------------------------------
 568+ 9442              ;
 569+ 9442              ;	5/1/24
 570+ 9442              ;
 571+ 9442              ;	INICIALIZA (Numero_parcial_de_entidades).
 572+ 9442              ;	DETECTA cuando hemos completado el nivel, (Numero_de_entidades)="0".
 573+ 9442              ;
 574+ 9442              ;	Si el nº total de entidades del nivel, (Numero_de_entidades) > 7, (nº de cajas de entidades):
 575+ 9442              ;
 576+ 9442              ;	(Numero_parcial_de_entidades)="7".
 577+ 9442              ;
 578+ 9442              ;	Si el nº total de entidades del nivel, (Numero_de_entidades) < 7, (nº de cajas de entidades):
 579+ 9442              ;
 580+ 9442              ;	(Numero_parcial_de_entidades)=(Numero_de_entidades).
 581+ 9442              ;
 582+ 9442              ;	OUTPUT: B contiene (Numero_parcial_de_entidades). Nº de cajas que vamos a preparar o rellenar.
 583+ 9442              ;	MODIFICA: A y B.
 584+ 9442              ;	ACTUALIZA: (Numero_parcial_de_entidades).
 585+ 9442
 586+ 9442              Inicializa_Numero_parcial_de_entidades
 587+ 9442
 588+ 9442              ;	Si (Numero_de_entidades)="0", hemos superado el nivel actual.
 589+ 9442
 590+ 9442 3A 4D 8C     	ld a,(Numero_de_entidades)
 591+ 9445 A7           	and a
 592+ 9446
 593+ 9446              ; !!!!!!!!!!! NIVEL SUPERADOOOOOOOOOOOOOO !!!!!!!!!!!!!
 594+ 9446              ;	jr z,$
 595+ 9446              ; !!!!!!!!!!! NIVEL SUPERADOOOOOOOOOOOOOO !!!!!!!!!!!!!
 596+ 9446
 597+ 9446 20 03        	jr nz,3F
 598+ 9448
 599+ 9448              ; ---------- ---------- ----------
 600+ 9448
 601+ 9448              ;! RESET para pruebas. Omitir esta línea en modo normal.
 602+ 9448              ;! REINICIA EL NIVEL !!!!!!!!!!!!!!!!!!!!!!!!!!
 603+ 9448
 604+ 9448 CD 3E 92     	call Inicializa_Nivel							 	 ; Inicializa el 1er NIVEL.
 605+ 944B
 606+ 944B              ; ---------- ---------- ----------
 607+ 944B
 608+ 944B 3A 4D 8C     3 ld a,(Numero_de_entidades)							 ; Nº TOTAL de las entidades del NIVEL.
 609+ 944E FE 07        	cp 7												 ; "7" es el nº total de cajas de entidades de las que disponemos.
 610+ 9450 38 08        	jr c,1F
 611+ 9452
 612+ 9452              ; El nº de entidades es superior al que cabe en las cajas DRAW.
 613+ 9452              ; Actualizamos variables.
 614+ 9452
 615+ 9452 3E 07        	ld a,7
 616+ 9454 32 4E 8C     	ld (Numero_parcial_de_entidades),a
 617+ 9457 47           	ld b,a
 618+ 9458 18 04        	jr 2F
 619+ 945A
 620+ 945A              ; El nº total de entidades no llena las 7 cajas de entidades. (Numero_parcial_de_entidades)=(Numero_de_entidades)
 621+ 945A              ; (Numero_de_entidades)="0".
 622+ 945A
 623+ 945A 32 4E 8C     1 ld (Numero_parcial_de_entidades),a
 624+ 945D 47           	ld b,a
 625+ 945E C9           2 ret
 626+ 945F
# file closed: Rutinas_de_inicio_y_niveles.asm
2280  945F              	include "calcula_tercio.asm"
# file opened: calcula_tercio.asm
   1+ 945F              ; ******************************************* Indica el tercio de pantalla en el que nos encontramos según el valor del registro H ********************************************************
   2+ 945F              ;
   3+ 945F              ;	NOTA: Entrega "0", "1" o "2" en A en función del tercio en el que nos encontremos.
   4+ 945F              ;
   5+ 945F              ; *****************************************************************************************************************************************************************************************
   6+ 945F              ; 010T TSSS LLLC CCCC (Codificación de la memoria de pantalla). $4000 - $57FF, (256 x 192 pixeles).
   7+ 945F
   8+ 945F 7C           calcula_tercio ld a,h
   9+ 9460 E6 18        	and $18
  10+ 9462 CB 2F        	sra a
  11+ 9464 CB 2F        	sra a
  12+ 9466 CB 2F        	sra a
  13+ 9468 C9           	ret
  14+ 9469
# file closed: calcula_tercio.asm
2281  9469              	include "Cls.asm"
# file opened: Cls.asm
   1+ 9469              ; *********************************** Limpia la pantalla, CLEAR SCREEN ****************************************************************
   2+ 9469              ;
   3+ 9469              ;
   4+ 9469              ;	CLS.
   5+ 9469              ;
   6+ 9469              ;	Limpia la pantalla y define sus atributos.
   7+ 9469              ;	El formato: FBPPPIII (Flash, Brillo, Papel, Tinta).
   8+ 9469              ;
   9+ 9469              ;	COLORES: 0 ..... NEGRO
  10+ 9469              ;    		 1 ..... AZUL
  11+ 9469              ; 			 2 ..... ROJO
  12+ 9469              ;			 3 ..... MAGENTA
  13+ 9469              ; 			 4 ..... VERDE
  14+ 9469              ; 			 5 ..... CIAN
  15+ 9469              ;			 6 ..... AMARILLO
  16+ 9469              ; 			 7 ..... BLANCO
  17+ 9469              ;
  18+ 9469              ;	INPUT: A contiene los atributos de pantalla.
  19+ 9469              ;
  20+ 9469              ;	DESTRUIDOS: F,BC,DE,HL !!!!!
  21+ 9469
  22+ 9469
  23+ 9469 21 00 40     Cls LD HL,$4000											; HL => Comienzo de pantalla.
  24+ 946C 11 01 40     	LD DE,$4001
  25+ 946F 01 00 18     	LD BC,6144											; Tamaño de la pantalla, $17ff
  26+ 9472 36 00        	LD (HL),0 											; Ponemos a "0" todos los pixels de la pantalla.
  27+ 9474 ED B0        	LDIR
  28+ 9476 01 FF 02     	LD BC,767
  29+ 9479 77           	LD (HL),a						 					; Atributos de pantalla, % 00 xxx xxx en [A].
  30+ 947A ED B0        	LDIR
  31+ 947C C9           	ret
  32+ 947D
# file closed: Cls.asm
2282  947D              	include "Genera_coordenadas.asm"
# file opened: Genera_coordenadas.asm
   1+ 947D              ; ------------------------------------------------------------------------
   2+ 947D              ;
   3+ 947D              ;	30/1/24
   4+ 947D              ;
   5+ 947D              ;	Proporciona las coordenadas del objeto a imprimir.
   6+ 947D              ;	Fila superior "0", Columna izquierda "0".
   7+ 947D              ;
   8+ 947D              ;	Input: HL contendrá la (Posicion_actual) del Sprite.
   9+ 947D              ;
  10+ 947D              ;	Modifica: A,BC y DE.
  11+ 947D
  12+ 947D 7D           Genera_coordenadas ld a,l
  13+ 947E E6 1F        	and $1f
  14+ 9480 32 08 8C     	ld (Coordenada_X),a 								; Coordenada Y del sprite, (0-$1f). Columnas.
  15+ 9483
  16+ 9483 7C           	ld a,h 												; (Coordenada_y) = "0" si estamos por debajo del 1er scanline de pantalla, (ROM).
  17+ 9484 FE 40        	cp $40
  18+ 9486 38 1C        	jr c,4F
  19+ 9488
  20+ 9488 CD 5F 94     	call calcula_tercio
  21+ 948B 47           	ld b,a 												; "0", "1" o "1" en función del tercio de pantalla.
  22+ 948C
  23+ 948C 1E 00        	ld e,0
  24+ 948E 7D           	ld a,l
  25+ 948F E6 E0        	and $e0
  26+ 9491 28 01        	jr z,1F
  27+ 9493 04           	inc b
  28+ 9494
  29+ 9494 04           1 inc b
  30+ 9495 05           	dec b
  31+ 9496 28 07        	jr z,2F												; Si estamos en el 1er tercio de pantalla y en la línea "0".
  32+ 9498              ;														; _ , salimos.
  33+ 9498 1C           3 inc e
  34+ 9499 D6 20        	sub 32
  35+ 949B 20 FB        	jr nz,3B
  36+ 949D 10 F5        	djnz 1B
  37+ 949F
  38+ 949F 7B           2 ld a,e
  39+ 94A0 32 09 8C     	ld (Coordenada_y),a
  40+ 94A3 C9           	ret
  41+ 94A4
  42+ 94A4 AF           4 xor a
  43+ 94A5 32 09 8C     	ld (Coordenada_y),a
  44+ 94A8 C9           	ret
  45+ 94A9
# file closed: Genera_coordenadas.asm
2283  94A9              	include "Genera_datos_de_impresion.asm"
# file opened: Genera_datos_de_impresion.asm
   1+ 94A9              ; ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   2+ 94A9              ;
   3+ 94A9              ;	11/03/24
   4+ 94A9              ;
   5+ 94A9              ;   (Scanlines_album_SP) se sitúa inicialmente al comienzo de Scanlines_album.
   6+ 94A9              ;   DE contiene Puntero_objeto.
   7+ 94A9              ;   IX contiene el Puntero de impresión.
   8+ 94A9
   9+ 94A9              Genera_datos_de_impresion
  10+ 94A9
  11+ 94A9 ED 73 54 8C      ld (Stack),sp                                 ; Guardo SP en (Stack).
  12+ 94AD
  13+ 94AD 31 0E 8C         ld sp,Puntero_de_impresion+2                  ; Almacenamos el (Puntero_de_impresion) actual de la entidad.
  14+ 94B0 DD E5            push ix                                       ; Utilizaremos este dato para generar las coordenadas_X que ocupa la entidad y compararlas_
  15+ 94B2
  16+ 94B2 2A 67 8C         ld hl,(Scanlines_album_SP)
  17+ 94B5
  18+ 94B5 3E 05            ld a,5
  19+ 94B7 85               add l
  20+ 94B8 6F               ld l,a
  21+ 94B9
  22+ 94B9 F9               ld sp,hl
  23+ 94BA 22 67 8C         ld (Scanlines_album_SP),hl
  24+ 94BD
  25+ 94BD 21 00 00         ld hl,0
  26+ 94C0
  27+ 94C0 DD E5            push ix
  28+ 94C2 3B               dec sp
  29+ 94C3 ED 7A            adc hl,sp
  30+ 94C5 D5               push de
  31+ 94C6
  32+ 94C6              ; Recuperamos SP.
  33+ 94C6
  34+ 94C6 ED 7B 54 8C      ld sp,(Stack)
  35+ 94CA
  36+ 94CA E5               push hl
  37+ 94CB F1               pop af
  38+ 94CC 08               ex af,af'                                       ; AF´ almacena la casilla donde vamos a almacenar el nº de scanlines que vamos a generar a continuación.
  39+ 94CD
  40+ 94CD              ; Tenemos el encabezado listo.
  41+ 94CD              ; Preparamos registros para generar los scanlines.
  42+ 94CD
  43+ 94CD DD E5            push ix
  44+ 94CF E1               pop hl                                          ; 1er scanline en HL.
  45+ 94D0
  46+ 94D0 ED 5B 67 8C      ld de,(Scanlines_album_SP)
  47+ 94D4
  48+ 94D4              ; Voy a utilizar 2 rutinas para generar las líneas. Una será rápida y otra lenta. La lenta sólo se empleará cuando el sprite esté desapareciendo o apareciendo_
  49+ 94D4              ; _por la parte baja de la pantalla, en este caso no se podrán imprimir las 16 líneas pues entramos en attr. mem.
  50+ 94D4
  51+ 94D4 7C               ld a,h
  52+ 94D5 FE 50            cp $50
  53+ 94D7 38 0D            jr c,Genera_scanlines_rapidos                   ; No hemos llegado a la parte baja de la pantalla.
  54+ 94D9
  55+ 94D9 20 05            jr nz,2F
  56+ 94DB
  57+ 94DB 7D               ld a,l
  58+ 94DC FE E0            cp $e0
  59+ 94DE 38 06            jr c,Genera_scanlines_rapidos                   ; El 1er scanline está en una dirección $50xx. Si estamos en la FILA $C0-$DF, podemos imprimir todos los scanlines del sprite.
  60+ 94E0
  61+ 94E0 7D           2 ld a,l
  62+ 94E1 FE C0            cp $c0
  63+ 94E3 D2 75 95         jp nc,Genera_scanlines_lentos                   ; En las 2 últimas líneas el Sprite sólo se imprime completo cuando el primer scanline está en una dirección $50xx.
  64+ 94E6
  65+ 94E6              Genera_scanlines_rapidos ; -------------------------------------------------------------------------------------------------------------------------------------
  66+ 94E6
  67+ 94E6 CD 73 99         call NextScan
  68+ 94E9 EB               ex de,hl
  69+ 94EA
  70+ 94EA 73               ld (hl),e
  71+ 94EB 23               inc hl
  72+ 94EC 72               ld (hl),d
  73+ 94ED 23               inc hl
  74+ 94EE
  75+ 94EE EB               ex de,hl
  76+ 94EF
  77+ 94EF CD 73 99         call NextScan
  78+ 94F2 EB               ex de,hl
  79+ 94F3
  80+ 94F3 73               ld (hl),e
  81+ 94F4 23               inc hl
  82+ 94F5 72               ld (hl),d
  83+ 94F6 23               inc hl
  84+ 94F7
  85+ 94F7 EB               ex de,hl
  86+ 94F8
  87+ 94F8 CD 73 99         call NextScan
  88+ 94FB EB               ex de,hl
  89+ 94FC
  90+ 94FC 73               ld (hl),e
  91+ 94FD 23               inc hl
  92+ 94FE 72               ld (hl),d
  93+ 94FF 23               inc hl
  94+ 9500
  95+ 9500 EB               ex de,hl
  96+ 9501
  97+ 9501 CD 73 99         call NextScan
  98+ 9504 EB               ex de,hl
  99+ 9505
 100+ 9505 73               ld (hl),e
 101+ 9506 23               inc hl
 102+ 9507 72               ld (hl),d
 103+ 9508 23               inc hl
 104+ 9509
 105+ 9509 EB               ex de,hl
 106+ 950A
 107+ 950A CD 73 99         call NextScan
 108+ 950D EB               ex de,hl
 109+ 950E
 110+ 950E 73               ld (hl),e
 111+ 950F 23               inc hl
 112+ 9510 72               ld (hl),d
 113+ 9511 23               inc hl
 114+ 9512
 115+ 9512 EB               ex de,hl
 116+ 9513
 117+ 9513 CD 73 99         call NextScan
 118+ 9516 EB               ex de,hl
 119+ 9517
 120+ 9517 73               ld (hl),e
 121+ 9518 23               inc hl
 122+ 9519 72               ld (hl),d
 123+ 951A 23               inc hl
 124+ 951B
 125+ 951B EB               ex de,hl
 126+ 951C
 127+ 951C CD 73 99         call NextScan
 128+ 951F EB               ex de,hl
 129+ 9520
 130+ 9520 73               ld (hl),e
 131+ 9521 23               inc hl
 132+ 9522 72               ld (hl),d
 133+ 9523 23               inc hl
 134+ 9524
 135+ 9524 EB               ex de,hl
 136+ 9525
 137+ 9525 CD 73 99         call NextScan
 138+ 9528 EB               ex de,hl
 139+ 9529
 140+ 9529 73               ld (hl),e
 141+ 952A 23               inc hl
 142+ 952B 72               ld (hl),d
 143+ 952C 23               inc hl
 144+ 952D
 145+ 952D EB               ex de,hl
 146+ 952E
 147+ 952E CD 73 99         call NextScan
 148+ 9531 EB               ex de,hl
 149+ 9532
 150+ 9532 73               ld (hl),e
 151+ 9533 23               inc hl
 152+ 9534 72               ld (hl),d
 153+ 9535 23               inc hl
 154+ 9536
 155+ 9536 EB               ex de,hl
 156+ 9537
 157+ 9537 CD 73 99         call NextScan
 158+ 953A EB               ex de,hl
 159+ 953B
 160+ 953B 73               ld (hl),e
 161+ 953C 23               inc hl
 162+ 953D 72               ld (hl),d
 163+ 953E 23               inc hl
 164+ 953F
 165+ 953F EB               ex de,hl
 166+ 9540
 167+ 9540 CD 73 99         call NextScan
 168+ 9543 EB               ex de,hl
 169+ 9544
 170+ 9544 73               ld (hl),e
 171+ 9545 23               inc hl
 172+ 9546 72               ld (hl),d
 173+ 9547 23               inc hl
 174+ 9548
 175+ 9548 EB               ex de,hl
 176+ 9549
 177+ 9549 CD 73 99         call NextScan
 178+ 954C EB               ex de,hl
 179+ 954D
 180+ 954D 73               ld (hl),e
 181+ 954E 23               inc hl
 182+ 954F 72               ld (hl),d
 183+ 9550 23               inc hl
 184+ 9551
 185+ 9551 EB               ex de,hl
 186+ 9552
 187+ 9552 CD 73 99         call NextScan
 188+ 9555 EB               ex de,hl
 189+ 9556
 190+ 9556 73               ld (hl),e
 191+ 9557 23               inc hl
 192+ 9558 72               ld (hl),d
 193+ 9559 23               inc hl
 194+ 955A
 195+ 955A EB               ex de,hl
 196+ 955B
 197+ 955B CD 73 99         call NextScan
 198+ 955E EB               ex de,hl
 199+ 955F
 200+ 955F 73               ld (hl),e
 201+ 9560 23               inc hl
 202+ 9561 72               ld (hl),d
 203+ 9562 23               inc hl
 204+ 9563
 205+ 9563 EB               ex de,hl
 206+ 9564
 207+ 9564 CD 73 99         call NextScan
 208+ 9567 EB               ex de,hl
 209+ 9568
 210+ 9568 73               ld (hl),e
 211+ 9569 23               inc hl
 212+ 956A 72               ld (hl),d
 213+ 956B 23               inc hl
 214+ 956C
 215+ 956C              ; Todos los scanlines generados. actualizamos el puntero (Scanlines_album_SP).
 216+ 956C
 217+ 956C 22 67 8C         ld (Scanlines_album_SP),hl
 218+ 956F
 219+ 956F              ; Completamos la casilla pendiente, (define el nº total de scanlines).
 220+ 956F
 221+ 956F 08               ex af,af
 222+ 9570
 223+ 9570 F5               push af
 224+ 9571 E1               pop hl
 225+ 9572
 226+ 9572 36 10            ld (hl),16
 227+ 9574
 228+ 9574 C9               ret
 229+ 9575
 230+ 9575              Genera_scanlines_lentos ; -------------------------------------------------------------------------------------------------------------------------------------
 231+ 9575
 232+ 9575              ; En 1er lugar calculamos el nº de scanlines que podemos imprimir.
 233+ 9575
 234+ 9575 3E 57            ld a,$57
 235+ 9577 94               sub h
 236+ 9578 47               ld b,a
 237+ 9579
 238+ 9579 3E DF            ld a,$df
 239+ 957B BD               cp l
 240+ 957C 38 04            jr c,1F
 241+ 957E
 242+ 957E 3E 08            ld a,8
 243+ 9580 80               add b
 244+ 9581 47               ld b,a
 245+ 9582
 246+ 9582              ; Tenemos en el registro B el nº de scanlines que podemos imprimir del sprite.
 247+ 9582              ; Generamos scanlines de objeto que desaparece por la parte baja de la pantalla.
 248+ 9582
 249+ 9582 48           1 ld c,b
 250+ 9583 0C               inc c
 251+ 9584
 252+ 9584 04               inc b
 253+ 9585 05               dec b
 254+ 9586 20 02            jr nz,3F
 255+ 9588
 256+ 9588 18 0B            jr 6F
 257+ 958A
 258+ 958A CD 73 99     3 call NextScan
 259+ 958D EB               ex de,hl
 260+ 958E
 261+ 958E 73               ld (hl),e
 262+ 958F 23               inc hl
 263+ 9590 72               ld (hl),d
 264+ 9591 23               inc hl
 265+ 9592
 266+ 9592 EB               ex de,hl
 267+ 9593 10 F5            djnz 3B
 268+ 9595
 269+ 9595 ED 53 67 8C  6 ld (Scanlines_album_SP),de
 270+ 9599
 271+ 9599 08           5 ex af,af
 272+ 959A F5               push af
 273+ 959B E1               pop hl
 274+ 959C
 275+ 959C 71               ld (hl),c
 276+ 959D
 277+ 959D C9               ret
 278+ 959E
# file closed: Genera_datos_de_impresion.asm
2284  959E              	include "Pinta_Sprites.asm"
# file opened: Pinta_Sprites.asm
   1+ 959E              ; -----------------------------------------------------------------------------
   2+ 959E              ;
   3+ 959E              ;   11/03/24
   4+ 959E              ;
   5+ 959E
   6+ 959E              Pinta_Sprites
   7+ 959E
   8+ 959E              ;    ld hl,(Scanlines_album_SP)
   9+ 959E              ;    call Extrae_address
  10+ 959E
  11+ 959E              ;    inc h
  12+ 959E              ;    dec h
  13+ 959E              ;    ret z                              ; Salimos si hemos terminado de pintar o el album de líneas está vacío.
  14+ 959E
  15+ 959E ED 73 54 8C      ld (Stack),sp
  16+ 95A2
  17+ 95A2 EB               ex de,hl                            ; HL se encuentra en el álbum de líneas.
  18+ 95A3              ;                                       ; DE se encuentra en los datos del sprite.
  19+ 95A3 2C               inc l
  20+ 95A4 2C               inc l
  21+ 95A5
  22+ 95A5 46               ld b,(hl)                           ; B contiene el nº de scanlines a imprimir.
  23+ 95A6
  24+ 95A6 2C               inc l
  25+ 95A7 F9               ld sp,hl                            ; El SP irá extrayendo scanlines en HL.
  26+ 95A8
  27+ 95A8              ;   Seleccionamos rutina de impresión:
  28+ 95A8
  29+ 95A8 3E 10            ld a,16
  30+ 95AA B8               cp b
  31+ 95AB C2 A7 96         jp nz,Pinta_lento                   ; Si el sprite no se imprime completo utilizamos la 2ª rutina de pintado.
  32+ 95AE
  33+ 95AE              ;   Rutinas:
  34+ 95AE
  35+ 95AE              Pinta_rapido    ;   1520 t/states.
  36+ 95AE
  37+ 95AE E1               pop hl
  38+ 95AF
  39+ 95AF 1A               ld a,(de)
  40+ 95B0 AE               xor (hl)
  41+ 95B1 77               ld (hl),a
  42+ 95B2 2C               inc l
  43+ 95B3 1C               inc e
  44+ 95B4 1A               ld a,(de)
  45+ 95B5 AE               xor (hl)
  46+ 95B6 77               ld (hl),a
  47+ 95B7 2C               inc l
  48+ 95B8 1C               inc e
  49+ 95B9 1A               ld a,(de)
  50+ 95BA AE               xor (hl)
  51+ 95BB 77               ld (hl),a
  52+ 95BC 13               inc de
  53+ 95BD
  54+ 95BD E1               pop hl
  55+ 95BE
  56+ 95BE 1A               ld a,(de)
  57+ 95BF AE               xor (hl)
  58+ 95C0 77               ld (hl),a
  59+ 95C1 2C               inc l
  60+ 95C2 1C               inc e
  61+ 95C3 1A               ld a,(de)
  62+ 95C4 AE               xor (hl)
  63+ 95C5 77               ld (hl),a
  64+ 95C6 2C               inc l
  65+ 95C7 1C               inc e
  66+ 95C8 1A               ld a,(de)
  67+ 95C9 AE               xor (hl)
  68+ 95CA 77               ld (hl),a
  69+ 95CB 13               inc de
  70+ 95CC
  71+ 95CC E1               pop hl
  72+ 95CD
  73+ 95CD 1A               ld a,(de)
  74+ 95CE AE               xor (hl)
  75+ 95CF 77               ld (hl),a
  76+ 95D0 2C               inc l
  77+ 95D1 1C               inc e
  78+ 95D2 1A               ld a,(de)
  79+ 95D3 AE               xor (hl)
  80+ 95D4 77               ld (hl),a
  81+ 95D5 2C               inc l
  82+ 95D6 1C               inc e
  83+ 95D7 1A               ld a,(de)
  84+ 95D8 AE               xor (hl)
  85+ 95D9 77               ld (hl),a
  86+ 95DA 13               inc de
  87+ 95DB
  88+ 95DB E1               pop hl
  89+ 95DC
  90+ 95DC 1A               ld a,(de)
  91+ 95DD AE               xor (hl)
  92+ 95DE 77               ld (hl),a
  93+ 95DF 2C               inc l
  94+ 95E0 1C               inc e
  95+ 95E1 1A               ld a,(de)
  96+ 95E2 AE               xor (hl)
  97+ 95E3 77               ld (hl),a
  98+ 95E4 2C               inc l
  99+ 95E5 1C               inc e
 100+ 95E6 1A               ld a,(de)
 101+ 95E7 AE               xor (hl)
 102+ 95E8 77               ld (hl),a
 103+ 95E9 13               inc de
 104+ 95EA
 105+ 95EA E1               pop hl
 106+ 95EB
 107+ 95EB 1A               ld a,(de)
 108+ 95EC AE               xor (hl)
 109+ 95ED 77               ld (hl),a
 110+ 95EE 2C               inc l
 111+ 95EF 1C               inc e
 112+ 95F0 1A               ld a,(de)
 113+ 95F1 AE               xor (hl)
 114+ 95F2 77               ld (hl),a
 115+ 95F3 2C               inc l
 116+ 95F4 1C               inc e
 117+ 95F5 1A               ld a,(de)
 118+ 95F6 AE               xor (hl)
 119+ 95F7 77               ld (hl),a
 120+ 95F8 13               inc de
 121+ 95F9
 122+ 95F9 E1               pop hl
 123+ 95FA
 124+ 95FA 1A               ld a,(de)
 125+ 95FB AE               xor (hl)
 126+ 95FC 77               ld (hl),a
 127+ 95FD 2C               inc l
 128+ 95FE 1C               inc e
 129+ 95FF 1A               ld a,(de)
 130+ 9600 AE               xor (hl)
 131+ 9601 77               ld (hl),a
 132+ 9602 2C               inc l
 133+ 9603 1C               inc e
 134+ 9604 1A               ld a,(de)
 135+ 9605 AE               xor (hl)
 136+ 9606 77               ld (hl),a
 137+ 9607 13               inc de
 138+ 9608
 139+ 9608 E1               pop hl
 140+ 9609
 141+ 9609 1A               ld a,(de)
 142+ 960A AE               xor (hl)
 143+ 960B 77               ld (hl),a
 144+ 960C 2C               inc l
 145+ 960D 1C               inc e
 146+ 960E 1A               ld a,(de)
 147+ 960F AE               xor (hl)
 148+ 9610 77               ld (hl),a
 149+ 9611 2C               inc l
 150+ 9612 1C               inc e
 151+ 9613 1A               ld a,(de)
 152+ 9614 AE               xor (hl)
 153+ 9615 77               ld (hl),a
 154+ 9616 13               inc de
 155+ 9617
 156+ 9617 E1               pop hl
 157+ 9618
 158+ 9618 1A               ld a,(de)
 159+ 9619 AE               xor (hl)
 160+ 961A 77               ld (hl),a
 161+ 961B 2C               inc l
 162+ 961C 1C               inc e
 163+ 961D 1A               ld a,(de)
 164+ 961E AE               xor (hl)
 165+ 961F 77               ld (hl),a
 166+ 9620 2C               inc l
 167+ 9621 1C               inc e
 168+ 9622 1A               ld a,(de)
 169+ 9623 AE               xor (hl)
 170+ 9624 77               ld (hl),a
 171+ 9625 13               inc de
 172+ 9626
 173+ 9626 E1               pop hl
 174+ 9627
 175+ 9627 1A               ld a,(de)
 176+ 9628 AE               xor (hl)
 177+ 9629 77               ld (hl),a
 178+ 962A 2C               inc l
 179+ 962B 1C               inc e
 180+ 962C 1A               ld a,(de)
 181+ 962D AE               xor (hl)
 182+ 962E 77               ld (hl),a
 183+ 962F 2C               inc l
 184+ 9630 1C               inc e
 185+ 9631 1A               ld a,(de)
 186+ 9632 AE               xor (hl)
 187+ 9633 77               ld (hl),a
 188+ 9634 13               inc de
 189+ 9635
 190+ 9635 E1               pop hl
 191+ 9636
 192+ 9636 1A               ld a,(de)
 193+ 9637 AE               xor (hl)
 194+ 9638 77               ld (hl),a
 195+ 9639 2C               inc l
 196+ 963A 1C               inc e
 197+ 963B 1A               ld a,(de)
 198+ 963C AE               xor (hl)
 199+ 963D 77               ld (hl),a
 200+ 963E 2C               inc l
 201+ 963F 1C               inc e
 202+ 9640 1A               ld a,(de)
 203+ 9641 AE               xor (hl)
 204+ 9642 77               ld (hl),a
 205+ 9643 13               inc de
 206+ 9644
 207+ 9644 E1               pop hl
 208+ 9645
 209+ 9645 1A               ld a,(de)
 210+ 9646 AE               xor (hl)
 211+ 9647 77               ld (hl),a
 212+ 9648 2C               inc l
 213+ 9649 1C               inc e
 214+ 964A 1A               ld a,(de)
 215+ 964B AE               xor (hl)
 216+ 964C 77               ld (hl),a
 217+ 964D 2C               inc l
 218+ 964E 1C               inc e
 219+ 964F 1A               ld a,(de)
 220+ 9650 AE               xor (hl)
 221+ 9651 77               ld (hl),a
 222+ 9652 13               inc de
 223+ 9653
 224+ 9653 E1               pop hl
 225+ 9654
 226+ 9654 1A               ld a,(de)
 227+ 9655 AE               xor (hl)
 228+ 9656 77               ld (hl),a
 229+ 9657 2C               inc l
 230+ 9658 1C               inc e
 231+ 9659 1A               ld a,(de)
 232+ 965A AE               xor (hl)
 233+ 965B 77               ld (hl),a
 234+ 965C 2C               inc l
 235+ 965D 1C               inc e
 236+ 965E 1A               ld a,(de)
 237+ 965F AE               xor (hl)
 238+ 9660 77               ld (hl),a
 239+ 9661 13               inc de
 240+ 9662
 241+ 9662 E1               pop hl
 242+ 9663
 243+ 9663 1A               ld a,(de)
 244+ 9664 AE               xor (hl)
 245+ 9665 77               ld (hl),a
 246+ 9666 2C               inc l
 247+ 9667 1C               inc e
 248+ 9668 1A               ld a,(de)
 249+ 9669 AE               xor (hl)
 250+ 966A 77               ld (hl),a
 251+ 966B 2C               inc l
 252+ 966C 1C               inc e
 253+ 966D 1A               ld a,(de)
 254+ 966E AE               xor (hl)
 255+ 966F 77               ld (hl),a
 256+ 9670 13               inc de
 257+ 9671
 258+ 9671 E1               pop hl
 259+ 9672
 260+ 9672 1A               ld a,(de)
 261+ 9673 AE               xor (hl)
 262+ 9674 77               ld (hl),a
 263+ 9675 2C               inc l
 264+ 9676 1C               inc e
 265+ 9677 1A               ld a,(de)
 266+ 9678 AE               xor (hl)
 267+ 9679 77               ld (hl),a
 268+ 967A 2C               inc l
 269+ 967B 1C               inc e
 270+ 967C 1A               ld a,(de)
 271+ 967D AE               xor (hl)
 272+ 967E 77               ld (hl),a
 273+ 967F 13               inc de
 274+ 9680
 275+ 9680 E1               pop hl
 276+ 9681
 277+ 9681 1A               ld a,(de)
 278+ 9682 AE               xor (hl)
 279+ 9683 77               ld (hl),a
 280+ 9684 2C               inc l
 281+ 9685 1C               inc e
 282+ 9686 1A               ld a,(de)
 283+ 9687 AE               xor (hl)
 284+ 9688 77               ld (hl),a
 285+ 9689 2C               inc l
 286+ 968A 1C               inc e
 287+ 968B 1A               ld a,(de)
 288+ 968C AE               xor (hl)
 289+ 968D 77               ld (hl),a
 290+ 968E 13               inc de
 291+ 968F
 292+ 968F E1               pop hl
 293+ 9690
 294+ 9690 1A               ld a,(de)
 295+ 9691 AE               xor (hl)
 296+ 9692 77               ld (hl),a
 297+ 9693 2C               inc l
 298+ 9694 1C               inc e
 299+ 9695 1A               ld a,(de)
 300+ 9696 AE               xor (hl)
 301+ 9697 77               ld (hl),a
 302+ 9698 2C               inc l
 303+ 9699 1C               inc e
 304+ 969A 1A               ld a,(de)
 305+ 969B AE               xor (hl)
 306+ 969C 77               ld (hl),a
 307+ 969D 13               inc de
 308+ 969E
 309+ 969E ED 73 67 8C      ld (Scanlines_album_SP),sp
 310+ 96A2 ED 7B 54 8C      ld sp,(Stack)
 311+ 96A6 C9               ret
 312+ 96A7
 313+ 96A7              Pinta_lento
 314+ 96A7
 315+ 96A7 E1           1 pop hl
 316+ 96A8
 317+ 96A8 1A               ld a,(de)
 318+ 96A9 AE               xor (hl)
 319+ 96AA 77               ld (hl),a
 320+ 96AB 2C               inc l
 321+ 96AC 1C               inc e
 322+ 96AD 1A               ld a,(de)
 323+ 96AE AE               xor (hl)
 324+ 96AF 77               ld (hl),a
 325+ 96B0 2C               inc l
 326+ 96B1 1C               inc e
 327+ 96B2 1A               ld a,(de)
 328+ 96B3 AE               xor (hl)
 329+ 96B4 77               ld (hl),a
 330+ 96B5 13               inc de
 331+ 96B6
 332+ 96B6 10 EF            djnz 1B
 333+ 96B8
 334+ 96B8 ED 73 67 8C      ld (Scanlines_album_SP),sp
 335+ 96BC ED 7B 54 8C      ld sp,(Stack)
 336+ 96C0 C9               ret
# file closed: Pinta_Sprites.asm
2285  96C1              	include "Draw_XOR.asm"
# file opened: Draw_XOR.asm
   1+ 96C1              ; ******************************************************************************************************************************************************************************************
   2+ 96C1              ;
   3+ 96C1              ; 26/06/23
   4+ 96C1              ;
   5+ 96C1              ; DRAW. ************************************************************************************************************************************************************************************
   6+ 96C1
   7+ 96C1              Draw
   8+ 96C1
   9+ 96C1 CD 67 99     	call Prepara_draw
  10+ 96C4 7C           	ld a,h 						 					; El objeto existe, o se está iniciando?. Si se está iniciando, (Posicion_inicio = Posicion_actual) y saltamos_
  11+ 96C5 A7           	and a 											; _a la subrutina [Inicializacion] donde asignaremos cuadrante y límites.
  12+ 96C6 28 05        	jr z,2F
  13+ 96C8
  14+ 96C8 3A 26 8C     	ld a,(Cuad_objeto)			 					; El objeto ya se inició. Cargamos en A el cuadrante de pantalla en el que lo hizo y saltamos a 1F.
  15+ 96CB 18 0C        	jr 1F
  16+ 96CD
  17+ 96CD 2A 24 8C     2 ld hl,(Posicion_inicio) 							; No hay (Posicion_actual), por lo que el objeto se está iniciando.
  18+ 96D0 22 17 8C     	ld (Posicion_actual),hl							; Indicamos que (Posicion_actual) = (Posicion_inicio) y saltamos a la subrutina [Inicializacion], (donde asignaremos_
  19+ 96D3 CD 5F 98     	call Inicializacion   							; _(Limite_horizontal), (Limite_vertical) y (Cuad_objeto). También asignaremos las coordenadas X e Y. (Posición 0,0)_
  20+ 96D6              ;													; _la esquina superior izquierda de la pantalla.
  21+ 96D6
  22+ 96D6 CD 06 9E     	call Inicia_Puntero_mov							; El objeto está inicializado. Antes de salir inicializamos tb el puntero de movimiento de la entidad.
  23+ 96D9
  24+ 96D9 3A 14 8C     1 ld a,(Ctrl_0)
  25+ 96DC CB 6F        	bit 5,a
  26+ 96DE 20 06        	jr nz,3F										; Si acabamos de inicializar un objeto, NO COMPROBAMOS LÍMITES.
  27+ 96E0
  28+ 96E0 CD F5 96     	call Comprueba_limite_horizontal
  29+ 96E3 CD 85 97     	call Comprueba_limite_vertical
  30+ 96E6
  31+ 96E6              ; Llegados a este punto, tengo Filas/Columnas en BC y (Cuad_objeto) en A´.
  32+ 96E6              ; -----------------------
  33+ 96E6              ; -----------------------
  34+ 96E6              ; -----------------------
  35+ 96E6
  36+ 96E6 CD DB 98     3 call calcula_CColumnass							; Define el valor de la variable (Columnas). Nº de columnas que se van a pintar de la entidad.
  37+ 96E9 CD 12 99     	call Calcula_puntero_de_impresion				; Después de ejecutar esta rutina tenemos el puntero de impresión en HL.
  38+ 96EC
  39+ 96EC 3A 14 8C     	ld a,(Ctrl_0)									; Antes de salir de la rutina REStauramos el bit5 de Ctrl_0 para que nos vuelva_
  40+ 96EF CB AF        	res 5,a											; _a ser de utilidad.
  41+ 96F1 32 14 8C     	ld (Ctrl_0),a
  42+ 96F4
  43+ 96F4 C9           	ret
  44+ 96F5
  45+ 96F5              ; *******************************************************************************************************************************************************************************************
  46+ 96F5              ;	21/01/23
  47+ 96F5              ;
  48+ 96F5              ; 	Comprueba_limite_horizontal.
  49+ 96F5              ;
  50+ 96F5              ;	La rutina comprueba si hemos sobrepasado el (Limite_horizontal) definido en la rutina [Inicializacion]. Este será:_
  51+ 96F5              ;	_ $4fc0 si partimos de los cuadrantes 1 o 2 de pantalla o $4820 si partimos de los cuadrantes 3 o 4.
  52+ 96F5              ;
  53+ 96F5              ;	Si sobrepasamos o alcanzamos el límite horizontal establecido, la rutina cargará el registro E con un "1".
  54+ 96F5              ;	Si NO HEMOS SOBREPASADO (Limite_horizontal), E="0".
  55+ 96F5              ;	E="1" indica que HEMOS SOBREPASADO el (Limite_horizontal).
  56+ 96F5              ;	E="2" indica que NO HEMOS SOBREPASADO el (Limite_horizontal) pero hemos alcanzado o superado EL CENTRO DE PANTALLA.
  57+ 96F5
  58+ 96F5
  59+ 96F5
  60+ 96F5 3A 14 8C     Comprueba_limite_horizontal ld a,(Ctrl_0)          	; Si no hemos desaparecido por arriba o por abajo, saltamos a 1F para comprobar_
  61+ 96F8 CB 57        	bit 2,a                                         ; _si hemos llegado o sobrepasado (Limite_horizontal). Seguimos con la rutina.
  62+ 96FA 28 07        	jr z,1F                                         ; Si por el contrario hemos desaparecido por arriba o por abajo, (bit2/bit3 de (Ctrl_0)="1"))_
  63+ 96FC E6 FB        	and $fb 										; _hay que modificar el puntero de posición. (E="1" y salimos de la rutina). Antes inicializaremos los_
  64+ 96FE 32 14 8C     	ld (Ctrl_0),a 									; _ bits 2 y 3 de (Ctrl_0).
  65+ 9701 18 09            jr 6F
  66+ 9703 CB 5F        1 bit 3,a
  67+ 9705 28 0A            jr z,2F
  68+ 9707 E6 F7            and $f7
  69+ 9709 32 14 8C         ld (Ctrl_0),a
  70+ 970C CD 5F 98     6 call Inicializacion
  71+ 970F 18 5B            jr 5F
  72+ 9711 E5           2 push hl						        			; Guardo (Posicion_actual), HL en la pila.
  73+ 9712
  74+ 9712              ; ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
  75+ 9712              ; Comprobamos si hemos llegado al (Limite_horizontal). E="0".
  76+ 9712
  77+ 9712 EB           	ex de,hl 										; Averiguamos si hemos llegado o sobrepasado el (Limite_horizontal). Hemos simplificado la operación SBC_
  78+ 9713 2A 28 8C     	ld hl,(Limite_horizontal) 						; _cargando el tercio de pantalla en el byte alto.
  79+ 9716 CD 5F 94     	call calcula_tercio 							; (Posicion_actual) - (Limite_horizontal).
  80+ 9719 67           	ld h,a
  81+ 971A EB           	ex de,hl 										; ARRIBA a ABAJO .......... E="1" cuando ( Z y NC ).
  82+ 971B CD 5F 94     	call calcula_tercio                             ; ABAJO a ARRIBA .......... E="1" cuando ( Z y C ).
  83+ 971E 67           	ld h,a
  84+ 971F A7           	and a
  85+ 9720 ED 52        	sbc hl,de 										; Posicíon <"menos"> Límite.
  86+ 9722 08           	ex af,af 										; Guardo el registro F con los flags resultantes de la operación SBC.
  87+ 9723 3A 26 8C     	ld a,(Cuad_objeto)
  88+ 9726 FE 02        	cp 2
  89+ 9728 38 1E        	jr c,3F
  90+ 972A 28 1C        	jr z,3F
  91+ 972C 08           	ex af,af 										; Partimos de LA MITAD INFERIOR. Recupero resultado de (Posicíon - Límite) en AF.
  92+ 972D 28 23            jr z,7F
  93+ 972F 38 21            jr c,7F 										; ABAJO a ARRIBA .......... E="1" cuando ( Z y C ). HEMOS SOBREPASADO_
  94+ 9731 1E 00         	ld e,0											; _ (Limite_horizontal), saltamos a 7F.
  95+ 9733 E1           	pop hl
  96+ 9734
  97+ 9734              ; Partimos de la mitad INFERIOR de pantalla y `NO HEMOS´ superado (Limite_horizontal). Tenemos que averiguar si hemos superado el centro de pantalla_
  98+ 9734              ; _para indicar con E="2" en caso necesario.
  99+ 9734
 100+ 9734 E5               push hl
 101+ 9735 C5               push bc
 102+ 9736 CD 5F 94     	call calcula_tercio
 103+ 9739 FE 01        	cp 1
 104+ 973B 20 07        	jr nz,11F 										; Sólo comprobamos la línea centro cuando nos encontramos en el 2º tercio de pantalla.
 105+ 973D CD 6D 97         call Comprueba_centro 							; ABAJO A ARRIBA .......... E="2" cuando ( Z y C ).
 106+ 9740 28 26            jr z,9F
 107+ 9742 38 24            jr c,9F
 108+ 9744 1E 00        11 ld e,0
 109+ 9746 18 22            jr 8F
 110+ 9748 08           3 ex af,af 											; Partimos de LA MITAD SUPERIOR. Recupero resultado de (Posicíon - Límite) en AF.
 111+ 9749 28 07        	jr z, 7F
 112+ 974B 30 05        	jr nc, 7F										; E="1" cuando ( Z y NC ).
 113+ 974D 1E 00         	ld e,0
 114+ 974F E1           	pop hl
 115+ 9750 18 04        	jr 4F
 116+ 9752 1E 01        7 ld e,1 											; SOBREPASAMOS (Limite_horizontal) !!!. E="1", pop HL y RET.
 117+ 9754 18 15            jr 10F
 118+ 9756
 119+ 9756              ; Partimos de la mitad SUPERIOR de pantalla y `NO HEMOS´ superado (Limite_horizontal). Tenemos que averiguar si hemos superado el centro de pantalla_
 120+ 9756              ; _para indicar con E="2" en caso necesario.
 121+ 9756
 122+ 9756 E5           4 push hl
 123+ 9757 C5               push bc											; Guardamos (Posicion_actual) y (Filas/Columns) en la pila.
 124+ 9758 CD 5F 94     	call calcula_tercio
 125+ 975B FE 01        	cp 1
 126+ 975D 20 0B        	jr nz,8F										; Sólo comprobamos la línea centro cuando nos encontramos en el 2º tercio de pantalla.
 127+ 975F CD 6D 97         call Comprueba_centro 							; ARRIBA a ABAJO .......... E="2" cuando ( Z y NC ).
 128+ 9762 28 04            jr z,9F
 129+ 9764 30 02            jr nc,9F
 130+ 9766 18 02        	jr 8F
 131+ 9768 1E 02        9 ld e,2
 132+ 976A C1           8 pop bc
 133+ 976B E1           10 pop hl
 134+ 976C C9           5 ret
 135+ 976D
 136+ 976D              ; --------------------
 137+ 976D              ;
 138+ 976D              ; 25/08/22
 139+ 976D
 140+ 976D CD 5F 94     Comprueba_centro call calcula_tercio
 141+ 9770 67               ld h,a
 142+ 9771 08           	ex af,af
 143+ 9772 FE 02        	cp 2
 144+ 9774 38 07        	jr c,1F
 145+ 9776 28 05        	jr z,1F
 146+ 9778 01 A0 01     	ld bc,$01a0 								  	 ; ¡¡¡¡¡ CENTRO DE PANTALLA cuando estamos en la mitad inferior de la misma. !!!!!
 147+ 977B 18 03        	jr 2F
 148+ 977D 01 60 01     1 ld bc,$0160                                     	 ; ¡¡¡¡¡ CENTRO DE PANTALLA cuando estamos en la mitad superior de la misma. !!!!!
 149+ 9780 08           2 ex af,af
 150+ 9781 A7               and a
 151+ 9782 ED 42            sbc hl,bc
 152+ 9784 C9               ret
 153+ 9785
 154+ 9785              ; *********************************************************************************************************************************************************************************************
 155+ 9785              ;
 156+ 9785              ;   16/8/22
 157+ 9785              ;
 158+ 9785              ;	Comprueba_limite_vertical
 159+ 9785              ;
 160+ 9785              ;	Modifica el registro L del puntero de pantalla cuando se sobrepasa la columna límite, (Limite2).
 161+ 9785              ;	Dependiendo del cuadrante en el que nos encontremos, sumaremos o restaremos, (Columnas-1) a L.
 162+ 9785              ;
 163+ 9785
 164+ 9785 2A 17 8C     Comprueba_limite_vertical ld hl,(Posicion_actual)
 165+ 9788 7D           	ld a,l
 166+ 9789 E6 1F        	and $1F
 167+ 978B 57           	ld d,a
 168+ 978C 3A 2A 8C     	ld a,(Limite_vertical)
 169+ 978F BA           	cp d 											; Límite - Posición.
 170+ 9790 08           	ex af,af 										; Resultado de CP d en F'.
 171+ 9791 3A 26 8C     	ld a,(Cuad_objeto)								; Averiguamos en que cuadrante estamos.
 172+ 9794 CB 47        	bit 0,a
 173+ 9796 28 10        	jr z,1F 										; Si A´es PAR, estamos en el 2º o 4º cuadrante. Saltamos a [3F], (cuadrantes 2º y 4º).
 174+ 9798
 175+ 9798              ; Hemos comparado la posición Y de la entidad con (Limite_vertical) y estamos en la mitad IZQUIERDA de la pantalla.
 176+ 9798
 177+ 9798 08           	ex af,af 										; LADO IZQUIERDO !!!!!!!!!!
 178+ 9799 38 28        	jr c,4F 										; Superamos (lIMITE_VERTICAL) cuando hay "acarreo".
 179+ 979B
 180+ 979B              ; No hay cambio de cuadrante!!!!! Estamos en el lado izquierdo de la pantalla y no hemos sobrepasado (Limite_vertical).
 181+ 979B              ; Lo primero que haremos será comprobar si hemos llegado o superado el centro de la pantalla.
 182+ 979B
 183+ 979B 3A 08 8C         ld a,(Coordenada_X)
 184+ 979E 16 0F            ld d,Centro_izquierda
 185+ 97A0 A7               and a
 186+ 97A1 92               sub d 											 ; Posición - Centro_izquierda.
 187+ 97A2 28 1E            jr z,3F
 188+ 97A4 30 1C            jr nc,3F                                         ; Si no hemos superado (Limite_vertical) pero si hemos superado el centro de la pantalla,_
 189+ 97A6              ;                                                    ; _salimos sin modificar nada.
 190+ 97A6 18 0E            jr 2F
 191+ 97A8 08           1 ex af,af 											 ; LADO DERECHO de la pantalla !!!!!!!!!!!
 192+ 97A9 30 18        	jr nc,4F 										 ; Superamos (lIMITE_VERTICAL) cuando NC.
 193+ 97AB
 194+ 97AB              ; No hay cambio de cuadrante!!!!! Estamos en el lado derecho de la pantalla y no hemos sobrepasado (Limite_vertical).
 195+ 97AB              ; Lo primero que haremos será comprobar si hemos llegado o superado el centro de la pantalla.
 196+ 97AB
 197+ 97AB 3A 08 8C         ld a,(Coordenada_X)
 198+ 97AE 16 10            ld d,Centro_derecha
 199+ 97B0 A7               and a
 200+ 97B1 92               sub d
 201+ 97B2 28 0E            jr z,3F
 202+ 97B4 38 0C            jr c,3F                                          ; Si no hemos superado (Limite_vertical) pero si hemos superado el centro de la pantalla,_
 203+ 97B6              ;                                                    ; _salimos sin modificar nada.
 204+ 97B6 CB 43        2 bit 0,e
 205+ 97B8 28 08            jr z,3F 										 ; No hemos sobrepasado (Centro_izquierda). Si E="0", salimos sin modificar posición.
 206+ 97BA C5           	push bc 										 ; Reservo (Filas) / (Columns) en la pila.
 207+ 97BB CD 4F 98         call Modificaccionne
 208+ 97BE C1           	pop bc
 209+ 97BF CD 5F 98         call Inicializacion
 210+ 97C2 C9           3 ret 				 								 ; Salimos de la rutina.
 211+ 97C3
 212+ 97C3              ; ----- ----- ----- Cambio de cuadrante ----- ----- -----
 213+ 97C3
 214+ 97C3 C5           4 push bc
 215+ 97C4 01 16 8C     	ld bc,Columns 		 	 						 ; Cambio de cuadrante. Sobrepasamos (Limite_vertical).
 216+ 97C7 0A           	ld a,(bc)
 217+ 97C8 3D           	dec a
 218+ 97C9 47           	ld b,a 											 ; Columnas-1 en B.
 219+ 97CA 7D           	ld a,l
 220+ 97CB 08           	ex af,af                                         ; Cambio de cuadrante, estamos en la parte derecha de la pantalla.
 221+ 97CC CB 47        	bit 0,a
 222+ 97CE 28 03        	jr z,5F
 223+ 97D0 08           	ex af,af 										 ; Estamos en la parte izquierda de la pantalla, (cuadrantes 1º o 3º). En ese caso, restamos (Columnas-1) a L.
 224+ 97D1 18 2E        	jr 7F
 225+ 97D3
 226+ 97D3              ; Cambio de cuadrante, partimos de la parte DERECHA de la pantalla. Por el centro ?? o desaparecemos ??.
 227+ 97D3
 228+ 97D3 08           5 ex af,af 											 ; Estamos en la parte derecha de la pantalla, (cuadrantes 2º o 4º). En ese caso, sumamos (Columnas-1) a L.
 229+ 97D4 F5           	push af                                          ; Guardo la posición, (L), en la pila, (la contiene el acumulador).
 230+ 97D5 3A 14 8C     	ld a,(Ctrl_0)
 231+ 97D8 CB 4F        	bit 1,a
 232+ 97DA 20 1D        	jr nz,6F                                         ; Cambio de cuadrante por desaparecer por la derecha!!!
 233+ 97DC F1           	pop af                                           ; Cambio de cuadrante por desaparecer por el centro!!!
 234+ 97DD
 235+ 97DD              ; Hemos sobrepasado el (Limite_vertical) de la mitad derecha a la izquierda. Ahora necesitamos saber si E="0".
 236+ 97DD
 237+ 97DD 1C               inc e
 238+ 97DE 1D               dec e
 239+ 97DF 20 07            jr nz,12F
 240+ 97E1 80           	add b 				 							 ; Si hemos sobrepasado el (Limite_vertical) pero no hemos llegado al centro horizontal_
 241+ 97E2 6F               ld l,a	 										 ; _de la pantalla, E="0" modificamos L, Inicializamos el objeto y salimos.
 242+ 97E3 22 17 8C     	ld (Posicion_actual),hl
 243+ 97E6 18 44        13 jr 9F
 244+ 97E8 CB 43        12 bit 0,e
 245+ 97EA 20 03            jr nz,14F                                        ; Si hemos sobrepasado (Limite_vertical) y hemos llegado o superado_
 246+ 97EC              ;                                                    ; _el centro horizontal de la pantalla, E="2", salimos sin modificar nada.
 247+ 97EC C1           	pop bc
 248+ 97ED 18 D3        	jr 3B
 249+ 97EF 80           14 add b
 250+ 97F0 6F               ld l,a
 251+ 97F1 22 17 8C     	ld (Posicion_actual),hl
 252+ 97F4 CD 4F 98         call Modificaccionne                             ; Si hemos sobrepasado (Limite_vertical) y (Limite_horizontal), E="1". Modificamos HL,L,_
 253+ 97F7 18 33            jr 9F 											 ; _inicializamos y salimos.
 254+ 97F9 E6 FD        6 and $fd 											 ; Cambio de cuadrante por desaparecer por la derecha!!!. Reinicializo el bit 1 de (Ctrl_0).
 255+ 97FB 32 14 8C         ld (Ctrl_0),a
 256+ 97FE F1           	pop af
 257+ 97FF 18 2B        	jr 9F
 258+ 9801
 259+ 9801              ; Cambio de cuadrante, partimos de la parte IZQUIERDA de la pantalla. Por el centro ?? o desaparecemos ??.
 260+ 9801
 261+ 9801 F5           7 push af
 262+ 9802 3A 14 8C     	ld a,(Ctrl_0)
 263+ 9805 CB 47        	bit 0,a
 264+ 9807 20 1D        	jr nz,8F
 265+ 9809 F1           	pop af
 266+ 980A
 267+ 980A              ; Hemos sobrepasado el (Limite_vertical) de la mitad IZQUIERDA a la DERECHA. Ahora necesitamos saber si E="0".
 268+ 980A
 269+ 980A 1C           	inc e
 270+ 980B 1D               dec e
 271+ 980C 20 07            jr nz,10F
 272+ 980E 90           	sub b
 273+ 980F 6F               ld l,a
 274+ 9810 22 17 8C     	ld (Posicion_actual),hl
 275+ 9813 18 17            jr 9F                                           ; Si hemos sobrepasado el (Limite_vertical) pero no hemos llegado al centro horizontal_
 276+ 9815              ;                                                   ; _de la pantalla, E="0" modificamos L, Inicializamos el objeto y salimos.
 277+ 9815 CB 43        10 bit 0,e
 278+ 9817 20 03            jr nz,16F                                       ; Si hemos sobrepasado (Limite_vertical) y hemos llegado o superado_
 279+ 9819              ;                                                   ; _el centro horizontal de la pantalla, E="2", salimos sin modificar nada.
 280+ 9819 C1           	pop bc
 281+ 981A 18 A6        	jr 3B
 282+ 981C 90           16 sub b
 283+ 981D 6F               ld l,a
 284+ 981E 22 17 8C     	ld (Posicion_actual),hl
 285+ 9821 CD 4F 98         call Modificaccionne                            ; Si hemos sobrepasado (Limite_vertical) y (Limite_horizontal), E="1". Modificamos HL,L,_
 286+ 9824 18 06            jr 9F
 287+ 9826 E6 FE        8 and $fe 											; ; Cambio de cuadrante por desaparecer por la izquierda !!!!!. Reinicializo el bit 0 de (Ctrl_0).
 288+ 9828 32 14 8C         ld (Ctrl_0),a
 289+ 982B F1           	pop af
 290+ 982C C1           9 pop bc
 291+ 982D 1E 00        	ld e,0
 292+ 982F CD 5F 98         call Inicializacion
 293+ 9832 F5               push af	 										; Antes de nada, guardo (Cuad_objeto) en A´ para acceder a él más rapido, (me va a hacer falta en la rutina calcolum).
 294+ 9833 08           	ex af,af
 295+ 9834 F1           	pop af 											; Ahora tengo (Cuad_objeto) en A y A´.
 296+ 9835 18 8B            jr 3B
 297+ 9837
 298+ 9837              ; --------------------
 299+ 9837
 300+ 9837 06 0F        Modifica_Pos_actual ld b,15                                         ; Scanlines-1 en B.
 301+ 9839 CD 82 99     1 call PreviousScan
 302+ 983C 10 FB            djnz 1B
 303+ 983E 22 17 8C     	ld (Posicion_actual),hl
 304+ 9841 AF           	xor a 											; Carry a "0". Evita que vuelva a entrar consecutivamente.
 305+ 9842 C9           	ret
 306+ 9843
 307+ 9843              ; --------------------
 308+ 9843
 309+ 9843 06 0F        Modifica_Pos_actual2 ld b,15                                         ; Scanlines-1 en B.
 310+ 9845 CD 73 99     1 call NextScan
 311+ 9848 10 FB            djnz 1B
 312+ 984A 22 17 8C     	ld (Posicion_actual),hl
 313+ 984D AF           	xor a 											; Fijo el acarreo a "0" para asegurarme de no volver a entrar en la rutina.
 314+ 984E C9           	ret
 315+ 984F
 316+ 984F              ; --------------------
 317+ 984F              ;
 318+ 984F              ;	22/01/23
 319+ 984F              ;
 320+ 984F              ;	E="1". Hemos cambiado de cuadrante.
 321+ 984F              ;	Si estamos en la mitad superior de pantalla: CALL [Modifica_Pos_actual].
 322+ 984F              ;	Si estamos en la mitad inferior de pantalla: CALL [Modifica_Pos_actual2].
 323+ 984F
 324+ 984F
 325+ 984F              Modificaccionne
 326+ 984F
 327+ 984F 3A 26 8C     	ld a,(Cuad_objeto)
 328+ 9852 FE 02        	cp 2
 329+ 9854 CC 37 98         call z,Modifica_Pos_actual                      ; Si por el contrario estamos en la mitad inferior, call Modifica_Pos_actual2.
 330+ 9857 DC 37 98         call c,Modifica_Pos_actual
 331+ 985A C8           	ret z
 332+ 985B CD 43 98         call Modifica_Pos_actual2
 333+ 985E C9               ret
 334+ 985F
 335+ 985F              ; *************************************************************************************************************************************************************************************************
 336+ 985F              ;
 337+ 985F              ;	13/8/22
 338+ 985F              ;
 339+ 985F              ;	Inicializacion
 340+ 985F              ;
 341+ 985F              ;	Entrega "1", "2", "3" o "4" en (Cuad_objeto) en función del cuadrante de pantalla en el que nos encontremos.
 342+ 985F              ;	Fija los punteros del objeto a pintar, (varían en función del cuadrante en el que nos encontremos).
 343+ 985F              ;	También calcula los límites horizontal y vertical. Estos dependen del tamaño del objeto a imprimir.
 344+ 985F              ;
 345+ 985F              ; 	La rutina se ejecuta cada vez que el objeto supera el (Limite_horizontal) y el (Limite_vertical). Esto sucede_
 346+ 985F              ;	_ cada vez que el objeto supera el centro de la pantalla tanto en sentido horizontal como vertical y cuando_
 347+ 985F              ;	_ desaparece/aparece.
 348+ 985F
 349+ 985F              ;	[Puntero_datas]: Dirección de memoria donde se encuentra el 1er byte que pinta el objeto.
 350+ 985F              ;	[Puntero_attr_datas]: Dirección de memoria donde se encuentra el byte de atributos del objeto.
 351+ 985F              ;
 352+ 985F              ;	INPUT: [HL] contendrá la dirección de pantalla a la que queremos asignar cuadrante. HL=(Posicion_inicio).
 353+ 985F              ; 		   [BC] contendrá (Filas)/(Columns) del objeto a inicializar.
 354+ 985F              ; 		   [E] ="0"
 355+ 985F
 356+ 985F              ; 	OUTPUT: DESTRUYE [AF] y [D].
 357+ 985F
 358+ 985F CD 5F 94     Inicializacion call calcula_tercio
 359+ 9862 28 36        	jr z,primit
 360+ 9864 E6 02        	and 2
 361+ 9866 20 07        	jr nz,segmit
 362+ 9868 7D           	ld a,l
 363+ 9869 FE 7F        	cp $7f
 364+ 986B 38 2D        	jr c,primit
 365+ 986D 28 2B        	jr z,primit
 366+ 986F CD D5 98     segmit call column
 367+ 9872 38 13        	jr c,tercuad
 368+ 9874 3E 04        cuarcuad ld a,4
 369+ 9876 32 26 8C     	ld (Cuad_objeto),a
 370+ 9879 21 20 48     	ld hl,$4820
 371+ 987C 22 28 8C     	ld (Limite_horizontal),hl
 372+ 987F 21 2A 8C     	ld hl,Limite_vertical
 373+ 9882 36 0D        	ld (hl),$0d
 374+ 9884 08           	ex af,af
 375+ 9885 18 3C        	jr 1F
 376+ 9887              tercuad
 377+ 9887 3E 03        	ld a,3
 378+ 9889 32 26 8C     	ld (Cuad_objeto),a
 379+ 988C 21 20 48     	ld hl,$4820
 380+ 988F 22 28 8C     	ld (Limite_horizontal),hl
 381+ 9892 21 2A 8C     	ld hl,Limite_vertical
 382+ 9895 36 12        	ld (hl),$12
 383+ 9897 08           	ex af,af
 384+ 9898 18 29        	jr 1F
 385+ 989A CD D5 98     primit call column
 386+ 989D 38 13        	jr c, primcuad
 387+ 989F              segcuad
 388+ 989F 3E 02        	ld a,2
 389+ 98A1 32 26 8C     	ld (Cuad_objeto),a
 390+ 98A4 21 C0 4F     	ld hl,$4fc0
 391+ 98A7 22 28 8C     	ld (Limite_horizontal),hl
 392+ 98AA 21 2A 8C     	ld hl,Limite_vertical
 393+ 98AD 36 0D        	ld (hl),$0d
 394+ 98AF 08           	ex af,af
 395+ 98B0 18 11        	jr 1F
 396+ 98B2              primcuad
 397+ 98B2 3E 01        	ld a,1
 398+ 98B4 32 26 8C     	ld (Cuad_objeto),a
 399+ 98B7 21 C0 4F     	ld hl,$4fc0
 400+ 98BA 22 28 8C     	ld (Limite_horizontal),hl
 401+ 98BD 21 2A 8C     	ld hl,Limite_vertical
 402+ 98C0 36 12        	ld (hl),$12
 403+ 98C2 08           	ex af,af
 404+ 98C3
 405+ 98C3 C5           1 push bc
 406+ 98C4 E5           	push hl
 407+ 98C5 D5           	push de
 408+ 98C6
 409+ 98C6 2A 17 8C     	ld hl,(Posicion_actual)
 410+ 98C9 CD 7D 94     	call Genera_coordenadas
 411+ 98CC
 412+ 98CC D1           	pop de
 413+ 98CD E1           	pop hl
 414+ 98CE C1           	pop bc
 415+ 98CF
 416+ 98CF 21 14 8C     	ld hl,Ctrl_0
 417+ 98D2 CB EE        	set 5,(hl)
 418+ 98D4 C9           	ret
 419+ 98D5
 420+ 98D5              ; ------------------------------------------------------------------------------------------------------------------
 421+ 98D5
 422+ 98D5              ; Esta pequeña subrutina determina el nº de columna en la que nos encontramos, Introducimos en A el valor absoluto de L, (0-31).
 423+ 98D5              ;
 424+ 98D5              ; OUTPUT: "FLAG C". Si se produce 1, nos encontramos en las primeras 16 columnas de pantalla, (cuadrantes 1 y 3). Si no es así, (cuadrantes 2 y 4).
 425+ 98D5
 426+ 98D5 7D           column ld a,l
 427+ 98D6 E6 1F        	and $1f
 428+ 98D8 FE 10         	cp $10
 429+ 98DA C9            	ret
 430+ 98DB
 431+ 98DB              ; --------------------------------------------------------------------------------------------------------------------
 432+ 98DB              ;
 433+ 98DB              ; Esta subrutina se encarga de asignar valor a la variable (Columnas), (nº de columnas del objeto que podemos pintar).
 434+ 98DB              ;
 435+ 98DB              ; 14/12/22
 436+ 98DB              ;
 437+ 98DB              ;	Modifica: A y BC.
 438+ 98DB
 439+ 98DB 3A 26 8C     calcula_CColumnass ld a,(Cuad_objeto)
 440+ 98DE E6 01        	and 1
 441+ 98E0 28 17        	jr z,1F
 442+ 98E2
 443+ 98E2              ; Nos encontramos en la parte izquierda de la pantalla
 444+ 98E2
 445+ 98E2 3A 08 8C     	ld a,(Coordenada_X)
 446+ 98E5 47           	ld b,a
 447+ 98E6 04           	inc b											; (Coordenada_X)+1 en B.
 448+ 98E7 79           	ld a,c
 449+ 98E8 90           	sub b											; (Columns)-[(Coordenada_X)+1] en A.
 450+ 98E9 38 08        	jr c,2F
 451+ 98EB 47           	ld b,a
 452+ 98EC 79           	ld a,c
 453+ 98ED 90           	sub b
 454+ 98EE 32 27 8C     	ld (Columnas),a
 455+ 98F1 18 1B        	jr 4F
 456+ 98F3 79           2 ld a,c
 457+ 98F4 32 27 8C     	ld (Columnas),a
 458+ 98F7 18 15        	jr 4F
 459+ 98F9
 460+ 98F9              ; Nos encontramos en la parte derecha de la pantalla.
 461+ 98F9
 462+ 98F9 3A 08 8C     1 ld a,(Coordenada_X)
 463+ 98FC 81           	add c
 464+ 98FD 3D           	dec a
 465+ 98FE D6 1F        	sub $1f
 466+ 9900 38 08        	jr c,3F
 467+ 9902 47           	ld b,a
 468+ 9903 79           	ld a,c
 469+ 9904 90           	sub b
 470+ 9905 32 27 8C     	ld (Columnas),a
 471+ 9908 18 04        	jr 4F
 472+ 990A 79           3 ld a,c
 473+ 990B 32 27 8C     	ld (Columnas),a
 474+ 990E D9           4 exx
 475+ 990F 4F           	ld c,a
 476+ 9910 D9           	exx
 477+ 9911 C9            ret
 478+ 9912
 479+ 9912              ; --------------------------------------------------------------------------------------------------------------------
 480+ 9912              ;
 481+ 9912              ;   19/7/23
 482+ 9912              ;
 483+ 9912              ;	Calcula el puntero de impresión del sprite, (arriba-izquierda).
 484+ 9912              ;	Almacena en IY (Puntero_objeto). La rutina de impresión requiere de esta dirección para situar el SP a la hora de pintar.
 485+ 9912              ;
 486+ 9912              ;	OUTPUT: IX Contienen el puntero de impresión.
 487+ 9912              ;			HL e IY Contienen (Puntero_objeto).
 488+ 9912              ;
 489+ 9912              ;	DESTRUYE: HL,B Y A.
 490+ 9912
 491+ 9912 3A 26 8C     Calcula_puntero_de_impresion ld a,(Cuad_objeto)
 492+ 9915 FE 02        	cp 2
 493+ 9917 38 18        	jr c,1F
 494+ 9919 28 16        	jr z,1F
 495+ 991B E6 01        	and 1
 496+ 991D 28 0D        	jr z,3F
 497+ 991F
 498+ 991F              ; Estamos situados en el 3er cuadrante de pantalla. ----- ----- -----
 499+ 991F
 500+ 991F CD 5B 99     	call Operandos					; (Posicion_actual) en HL y (Columnas)-1 en B.
 501+ 9922
 502+ 9922 7D           9 ld a,l
 503+ 9923 E6 1F        	and $1f
 504+ 9925 28 2A        	jr z,7F
 505+ 9927 2B           	dec hl
 506+ 9928 10 F8        	djnz 9B
 507+ 992A 18 25        	jr 7F
 508+ 992C
 509+ 992C              ; Estamos situados en el 4º cuadrante de pantalla. ----- ----- -----
 510+ 992C
 511+ 992C 2A 17 8C     3 ld hl,(Posicion_actual)
 512+ 992F 18 20        	jr 7F
 513+ 9931
 514+ 9931 28 14        1 jr z,2F
 515+ 9933
 516+ 9933              ; Estamos situados en el 1er cuadrante de pantalla. ----- ----- -----
 517+ 9933
 518+ 9933 CD 5B 99     	call Operandos					; (Posicion_actual) en HL y (Columnas)-1 en B.
 519+ 9936
 520+ 9936 7D           4 ld a,l
 521+ 9937 E6 1F        	and $1f
 522+ 9939 28 03        	jr z,6F
 523+ 993B 2B           	dec hl
 524+ 993C 10 F8        	djnz 4B
 525+ 993E 06 0F        6 ld b,15
 526+ 9940 CD 82 99     5 call PreviousScan
 527+ 9943 10 FB        	djnz 5B
 528+ 9945 18 0A        	jr 7F
 529+ 9947
 530+ 9947              ; Estamos situados en el 2º cuadrante de pantalla. ----- ----- -----
 531+ 9947
 532+ 9947 CD 5B 99     2 call Operandos					; (Posicion_actual) en HL y (Columnas)-1 en B.
 533+ 994A 06 0F        	ld b,15
 534+ 994C CD 82 99     8 call PreviousScan
 535+ 994F 10 FB        	djnz 8B
 536+ 9951
 537+ 9951 E5           7 push hl
 538+ 9952 DD E1        	pop ix
 539+ 9954
 540+ 9954 2A 19 8C     	ld hl,(Puntero_objeto)
 541+ 9957 E5           	push hl
 542+ 9958 FD E1        	pop iy
 543+ 995A
 544+ 995A C9           	ret
 545+ 995B
 546+ 995B              ; --------------------------------------------------------------------------------------------------------------------
 547+ 995B              ;
 548+ 995B              ;	2/1/23
 549+ 995B              ;
 550+ 995B              ;	Sub-rutina de [Calcula_puntero_de_impresion].
 551+ 995B              ;
 552+ 995B              ;	Tras esta rutina tenemos:
 553+ 995B              ;
 554+ 995B              ;	OUTPUT: HL contiene (Posicion_actual).
 555+ 995B              ;			B contiene (Columnas)-1. Nota: Este valor `nunca' será "0". El valor mínimo es "1".
 556+ 995B              ;
 557+ 995B              ;	DESTRUYE!!!!! HL,B y A.
 558+ 995B
 559+ 995B 2A 17 8C     Operandos ld hl,(Posicion_actual)
 560+ 995E 3A 27 8C     	ld a,(Columnas)
 561+ 9961 3D           	dec a
 562+ 9962 20 01        	jr nz,1F
 563+ 9964 3C           	inc a
 564+ 9965 47           1 ld b,a
 565+ 9966 C9           	ret
 566+ 9967
 567+ 9967              ; --------------------------------------------------------------------------------------------------------------------
 568+ 9967              ;
 569+ 9967              ;	Prepara_draw
 570+ 9967              ;
 571+ 9967              ;	Es una rutina de carga.
 572+ 9967              ;	Carga los registros BC,HL y E para posteriormente llamar a la rutina de pintado [DRAW].
 573+ 9967              ;
 574+ 9967              ;	FUNCIONAMIENTO:
 575+ 9967              ;
 576+ 9967              ;	- LD (Filas/Columns) del objeto a pintar en [BC].
 577+ 9967              ;	- LD (Posicion_actual) del objeto en [HL].
 578+ 9967              ;	- LD E,0. (Dígito de control utilizado por Draw para cálculos internos de la rutina. Ha de estar a "0").
 579+ 9967              ;
 580+ 9967              ;	DESTRUYE:
 581+ 9967              ;
 582+ 9967              ;	Logicamente, BC,HL y E quedan destruidos.
 583+ 9967
 584+ 9967 21 15 8C     Prepara_draw ld hl,Filas 		 					 					 ; Prepara los registros BC, E y HL.
 585+ 996A 46           	ld b,(hl) 														     ; Carga Filas/Columns del objeto a pintar o inicializar en BC.
 586+ 996B 23           	inc hl 												 				 ; Carga (Posicion_actual) en HL.
 587+ 996C 4E           	ld c,(hl)
 588+ 996D 2A 17 8C     	ld hl,(Posicion_actual)
 589+ 9970 1E 00        	ld e,0 																 ; Byte de control. Ha de estar a "0" cuando llamamos a [DRAW].
 590+ 9972 C9           	ret
 591+ 9973
 592+ 9973              ;----------------------------------------------------------------------------------------------------------------
 593+ 9973              ;
 594+ 9973              ;	5/08/22
 595+ 9973              ;
 596+ 9973              ;   NextScan.
 597+ 9973              ;
 598+ 9973              ;   Calcula la dirección de mem. de pantalla donde se sitúa el siguiente scanline. (Inc H, línea abajo).
 599+ 9973              ;
 600+ 9973              ;   INPUT: HL contendra la dirección de mem. de video sobre la que queremos calcular el siguiente scanline.
 601+ 9973              ;
 602+ 9973              ;   OUTPUT: HL contendrá la nueva dirección de memoria de pantalla.
 603+ 9973              ;
 604+ 9973              ;       DESTRUIDOS: AF y HL !!!
 605+ 9973              ;
 606+ 9973              ;   010T TSSS LLLC CCCC (Codificación de la memoria de pantalla). $4000 - $57FF, (256 x 192 pixeles).
 607+ 9973              ;
 608+ 9973
 609+ 9973 24           NextScan inc h          ; Incrementamos el scanline.
 610+ 9974 7C               ld a,h
 611+ 9975 E6 07            and 7
 612+ 9977 C0               ret nz              ; Salimos de la rutina si el scanline se encuentra entre (1-7).
 613+ 9978
 614+ 9978 7D           	ld a,l              ; Scanlines a "0", cambiamos de tercio. (Siempre que estemos en la última línea, LLL).
 615+ 9979 C6 20            add a,$20           ; Vamos a comprobarlo...
 616+ 997B 6F               ld l,a
 617+ 997C D8               ret c               ; Salimos si se produce el cambio de tercio.
 618+ 997D
 619+ 997D 7C               ld a,h              ; No estamos en la última línea del tercio, por lo que inicializamos H restando una_
 620+ 997E D6 08            sub 8               ; _unidad a los bits que definen el tercio TT, (sub $08).
 621+ 9980 67               ld h,a
 622+ 9981 C9               ret
 623+ 9982
 624+ 9982              ;----------------------------------------------------------------------------------------------------------------
 625+ 9982              ;
 626+ 9982              ;	5/08/22
 627+ 9982              ;
 628+ 9982              ;   PreviousScan.
 629+ 9982              ;
 630+ 9982              ;   Calcula la dirección de mem. de pantalla donde se sitúa el scanline anterior. (Dec H, línea arriba).
 631+ 9982              ;
 632+ 9982              ;   INPUT: HL contendra la dirección de mem. de video sobre la que queremos calcular el scanline anterior.
 633+ 9982              ;
 634+ 9982              ;   OUTPUT: HL contendrá la nueva dirección de memoria de pantalla.
 635+ 9982              ;
 636+ 9982              ;       DESTRUIDOS: AF y HL !!!
 637+ 9982              ;
 638+ 9982              ;   010T TSSS LLLC CCCC (Codificación de la memoria de pantalla). $4000 - $57FF, (256 x 192 pixeles).
 639+ 9982              ;
 640+ 9982
 641+ 9982 7C           PreviousScan ld a,h
 642+ 9983 25               dec h               ; Dec H.
 643+ 9984 E6 07            and 7
 644+ 9986 C0               ret nz              ; Salimos de la rutina si el scanline se encuentra entre (1-7).
 645+ 9987
 646+ 9987 7D               ld a,l              ; Estabamos en el scanline "0" y al decrementar nos situamos en el "7" y cambiamos de tercio.
 647+ 9988 D6 20            sub $20             ; Vamos a comprobarlo...
 648+ 998A 6F               ld l,a
 649+ 998B D8               ret c               ; Salimos si estábamos en la primera línea y se produce el cambio de tercio.
 650+ 998C
 651+ 998C 7C               ld a,h              ; No estamos en la primera línea del tercio, por lo que inicializamos H sumando una_
 652+ 998D C6 08            add a,8             ; _unidad a los bits que definen el tercio TT, (add a,$08).
 653+ 998F 67               ld h,a
 654+ 9990 C9               ret
 655+ 9991
 656+ 9991
 657+ 9991
 658+ 9991
 659+ 9991
 660+ 9991
 661+ 9991
 662+ 9991
 663+ 9991
 664+ 9991
 665+ 9991
 666+ 9991
# file closed: Draw_XOR.asm
2286  9991              	include "Direcciones.asm"
# file opened: Direcciones.asm
   1+ 9991
   2+ 9991              ; ******************************************************************************************************************************************************************************************
   3+ 9991              ;
   4+ 9991              ;   20/05/23
   5+ 9991              ;
   6+ 9991              ;	Recompone_posicion_inicio
   7+ 9991              ;
   8+ 9991              ; 	La rutina hace una llamada a [Mov_right] o [Mov_left] según su posición de inicio.
   9+ 9991              ;	Así conseguimios que la entidad esté completamente oculta a la hora de aparecer por la izquierda_
  10+ 9991              ;	_ o derecha. Tomaremos la columna de (Posicion_inicio) como referencia para hacer la llamada_
  11+ 9991              ;	_ a una u otra rutina.
  12+ 9991
  13+ 9991              Recompone_posicion_inicio
  14+ 9991
  15+ 9991 2A 24 8C     	ld hl,(Posicion_inicio)
  16+ 9994 7D           	ld a,l
  17+ 9995 E6 1F        	and $1f
  18+ 9997 28 16        	jr z,1F
  19+ 9999
  20+ 9999 FE 1F        	cp $1f
  21+ 999B 28 0D        	jr z,3F
  22+ 999D
  23+ 999D 21 13 8C     	ld hl,Ctrl_2
  24+ 99A0 CB C6        	set 0,(hl)
  25+ 99A2 2A 19 8C     	ld hl,(Puntero_objeto)
  26+ 99A5 22 45 8C     	ld (Repone_puntero_objeto),hl
  27+ 99A8 18 08        	jr 2F
  28+ 99AA
  29+ 99AA CD 58 9B     3 call Mov_left
  30+ 99AD 18 03        	jr 2F
  31+ 99AF
  32+ 99AF CD 35 9A     1 call Mov_right
  33+ 99B2 21 E0 EA     2 ld hl,Sprite_vacio
  34+ 99B5 22 19 8C     	ld (Puntero_objeto),hl
  35+ 99B8 C9           	ret
  36+ 99B9
  37+ 99B9              ; ******************************************************************************************************************************************************************************************
  38+ 99B9              ;
  39+ 99B9              ;   27/05/23
  40+ 99B9              ;
  41+ 99B9              ;	Mov_down
  42+ 99B9              ;
  43+ 99B9              ; 	Mueve el Sprite X px hacia abajo.
  44+ 99B9              ;
  45+ 99B9              ;
  46+ 99B9              Mov_down
  47+ 99B9
  48+ 99B9 CD 23 9A     	call Reponne_punntero_objeto									; Si la entidad no se inició en la 1ª o última columna de pantalla,_
  49+ 99BC              ;																	; _ repone (Puntero_objeto).
  50+ 99BC 21 14 8C     	ld hl,Ctrl_0
  51+ 99BF CB E6        	set 4,(hl) 														; Indicamos con el Bit4 de (Ctrl_0) que hay movimiento. Vamos a utilizar_
  52+ 99C1              ; 																	; _esta información para evitar que la entidad se vuelva borrar/pintar_
  53+ 99C1              ; 																	; _ en el caso de que no lo haya.
  54+ 99C1 3A 2F 8C     	ld a,(Vel_down)
  55+ 99C4 47           	ld b,a
  56+ 99C5 2A 17 8C         ld hl,(Posicion_actual)
  57+ 99C8 CD 5F 94     2 call calcula_tercio 												; Averiguamos el tercio de pantalla en el que nos encontramos.
  58+ 99CB E6 02        	and 2
  59+ 99CD 28 17        	jr z,1F
  60+ 99CF
  61+ 99CF              ; Nos encontramos en el último tercio de pantalla.
  62+ 99CF              ; Averiguamos si estamos en el último scanline de la última línea de pantalla.
  63+ 99CF
  64+ 99CF 7C           	ld a,h
  65+ 99D0 FE 57        	cp $57
  66+ 99D2 20 12        	jr nz,1F
  67+ 99D4
  68+ 99D4 7D           	ld a,l
  69+ 99D5 C6 20        	add $20
  70+ 99D7 30 0D        	jr nc,1F
  71+ 99D9
  72+ 99D9              ; ------------------------------
  73+ 99D9              ;
  74+ 99D9              ;	12/01/24
  75+ 99D9
  76+ 99D9              ;	call Reaparece_arriba
  77+ 99D9 CD E5 9C     	call Reinicio
  78+ 99DC
  79+ 99DC              ;	Homos generado todos los movimientos posibles de esta "Entidad_guía".
  80+ 99DC
  81+ 99DC 3A 6D 8C     	ld a,(Ctrl_3)
  82+ 99DF CB CF        	set 1,a
  83+ 99E1 32 6D 8C     	ld (Ctrl_3),a
  84+ 99E4
  85+ 99E4 18 08        	jr 3F
  86+ 99E6              ;															; El bit2 de (Ctrl_3) evita que la rutina [Main], (cuando gestione entidades), coloque_
  87+ 99E6              ;															; _a la siguiente entidad como "Entidad_guía".
  88+ 99E6              ; ------------------------------
  89+ 99E6
  90+ 99E6 CD 73 99     1 call NextScan
  91+ 99E9 22 17 8C     	ld (Posicion_actual),hl
  92+ 99EC 10 DA            djnz 2B
  93+ 99EE CD 7D 94     3 call Genera_coordenadas
  94+ 99F1 C9           	ret
  95+ 99F2
  96+ 99F2              ; ******************************************************************************************************************************************************************************************
  97+ 99F2              ;
  98+ 99F2              ;   27/05/23
  99+ 99F2              ;
 100+ 99F2              ;	Mov_up
 101+ 99F2              ;
 102+ 99F2              ; 	Mueve el Sprite hacia arriba.
 103+ 99F2              ;
 104+ 99F2              ;
 105+ 99F2              Mov_up
 106+ 99F2
 107+ 99F2 CD 23 9A     	call Reponne_punntero_objeto										; Si la entidad no se inició en la 1ª o última columna de pantalla,_
 108+ 99F5              ;																		; _ repone (Puntero_objeto).	call Reponne_punntero_objeto
 109+ 99F5 21 14 8C     	ld hl,Ctrl_0
 110+ 99F8 CB E6        	set 4,(hl) 															; Indicamos con el Bit4 de (Ctrl_0) que hay movimiento. Vamos a utilizar_
 111+ 99FA              ; 																		; _esta información para evitar que la entidad se vuelva borrar/pintar_
 112+ 99FA              ; 																		; _ en el caso de que no lo haya.
 113+ 99FA 3A 2E 8C     	ld a,(Vel_up)
 114+ 99FD 47           	ld b,a
 115+ 99FE 2A 17 8C     	ld hl,(Posicion_actual)
 116+ 9A01 CD 5F 94     3 call calcula_tercio 													; Si no estamos en el 1er tercio de la pantalla no nos preocupamos de la reaparición.
 117+ 9A04 A7           	and a
 118+ 9A05 20 10        	jr nz,1F
 119+ 9A07
 120+ 9A07              ; Nos encontramos en el 1er tercio de pantalla.
 121+ 9A07              ; Averiguamos si estamos en el primer scanline de la primera línea de pantalla.
 122+ 9A07
 123+ 9A07 7C               ld a,h 																; Si estamos en el 1er tercio de pantalla pero no nos encontramos en el 1er scanline_
 124+ 9A08 FE 40            cp $40 																; _del mismo, podemos seguir subiendo.
 125+ 9A0A 20 0B            jr nz,1F
 126+ 9A0C 7D               ld a,l
 127+ 9A0D D6 20            sub $20
 128+ 9A0F 30 06            jr nc,1F
 129+ 9A11 25               dec h
 130+ 9A12
 131+ 9A12              ; -----------------------------
 132+ 9A12 CD C6 9C         call Reaparece_abajo                                                ; El objeto ha desaparecido por la parte superior de la pantalla, H="$3f". Hacemos llamada a _
 133+ 9A15              ;	call Reinicio
 134+ 9A15              ; -----------------------------
 135+ 9A15
 136+ 9A15 18 08            jr 2F                                                               ; _ [Reaparece_abajo] para preparar la `reaparición´ por la parte inferior.
 137+ 9A17 CD 82 99     1 call PreviousScan
 138+ 9A1A 22 17 8C     	ld (Posicion_actual),hl
 139+ 9A1D 10 E2            djnz 3B
 140+ 9A1F CD 7D 94     2 call Genera_coordenadas
 141+ 9A22 C9           	ret
 142+ 9A23
 143+ 9A23              ; -----------------------------
 144+ 9A23              ;
 145+ 9A23              ;	27/5/23
 146+ 9A23              ;
 147+ 9A23              ;	Si la rutina [Recompone_posicion_inicio] no inició la entidad en la 1ª o última columna de pantalla,_
 148+ 9A23              ;	_restaurará (Puntero_objeto) con el contenido de (Repone_puntero_objeto).
 149+ 9A23              ;
 150+ 9A23              ;	Esta rutina sólo será llamada desde las rutinas de movimiento vertical, [Mov_down] y [Mov_up].
 151+ 9A23              ;	Las rutinas [Mov_left] y [Mov_right] modifican (Puntero_objeto) cada vez que se ejecutan.
 152+ 9A23              ;
 153+ 9A23              ;	Modifica: A y (Puntero_objeto).
 154+ 9A23
 155+ 9A23 3A 13 8C     Reponne_punntero_objeto	ld a,(Ctrl_2)
 156+ 9A26 CB 47        	bit 0,a
 157+ 9A28 C8           	ret z
 158+ 9A29 CB 87        	res 0,a
 159+ 9A2B 32 13 8C     	ld (Ctrl_2),a
 160+ 9A2E 2A 45 8C     	ld hl,(Repone_puntero_objeto)
 161+ 9A31 22 19 8C     	ld (Puntero_objeto),hl
 162+ 9A34 C9           	ret
 163+ 9A35
 164+ 9A35              ; ******************************************************************************************************************************************************************************************
 165+ 9A35              ;
 166+ 9A35              ;	19/10/22
 167+ 9A35              ;
 168+ 9A35              ;	Mov_right.
 169+ 9A35              ;
 170+ 9A35              ; 	Desplaza el Sprite (x)Pixels a la derecha.
 171+ 9A35              ;
 172+ 9A35
 173+ 9A35 3A 14 8C     Mov_right ld a,(Ctrl_0)
 174+ 9A38 CB 77        	bit 6,a
 175+ 9A3A 28 0B        	jr z,10F 														; Amadeus o Entidad ???
 176+ 9A3C
 177+ 9A3C CD 74 9C     	call Stop_Amadeus_right											; Estamos moviendo Amadeus???????. Si es así hemos de comprobar que no hemos llegado al char.30 de la línea, [Stop_Amadeus].
 178+ 9A3F C8           	ret z 															; Salimos de Mov_right si hemos llegado al char.30.
 179+ 9A40
 180+ 9A40 21 14 8C     	ld hl,Ctrl_0
 181+ 9A43 CB E6        	set 4,(hl)
 182+ 9A45 18 52        	jr 8F
 183+ 9A47
 184+ 9A47 21 14 8C     10 ld hl,Ctrl_0
 185+ 9A4A CB E6        	set 4,(hl) 														; Indicamos con el Bit4 de (Ctrl_0) que hay movimiento. Vamos a utilizar_
 186+ 9A4C              ; 																	; _esta información para evitar que la entidad se vuelva borrar/pintar_
 187+ 9A4C              ; 																	; _ en el caso de que no lo haya.
 188+ 9A4C 3A 08 8C     	ld a,(Coordenada_X)	 	  										; Estamos en el char. 31?
 189+ 9A4F FE 1F        	cp 31															; Si no es así, saltamos a [3] para seguir con el desplazamiento progrmado.
 190+ 9A51 20 46        	jr nz,8F
 191+ 9A53
 192+ 9A53 3A 1B 8C     	ld a,(CTRL_DESPLZ) 		 										; Estamos en el último char. de la línea. Si (CTRL_DESPLZ)="0" saltamos a_
 193+ 9A56 A7           	and a 															; _[3] para continuar con el DESPLZ.
 194+ 9A57 28 40        	jr z,8F
 195+ 9A59
 196+ 9A59              ; ---------- ---------- ----------
 197+ 9A59              ;
 198+ 9A59              ;	Estamos en el último char. de la fila y (CTRL_DESPLZ) es distinto de "0".
 199+ 9A59
 200+ 9A59 3A 2D 8C     	ld a,(Vel_right) 												; En función del factor de velocidad, iniciaremos la salida de la pantalla,_									;
 201+ 9A5C FE 02        	cp 2 															; _(Reaparece_izquierda), cuando (CTRL_DESPLZ) alcance un valor determinado.
 202+ 9A5E 28 11        	jr z,1F
 203+ 9A60 38 06        	jr c,6F
 204+ 9A62 FE 04        	cp 4
 205+ 9A64 28 14        	jr z,7F
 206+ 9A66 18 FE        	jr $ 															; Sólo se permite velocidad 1,2,4 y 8.
 207+ 9A68
 208+ 9A68              ; ---------- ---------- ----------
 209+ 9A68              ;
 210+ 9A68              ; Perfiles de velocidad
 211+ 9A68              ;
 212+ 9A68
 213+ 9A68 3A 1B 8C     6 ld a,(CTRL_DESPLZ) 												; Velocidad 1
 214+ 9A6B FE FE        	cp $fe
 215+ 9A6D 20 2A        	jr nz,8F
 216+ 9A6F 18 10        	jr 3F
 217+ 9A71 3A 1B 8C     1 ld a,(CTRL_DESPLZ) 												; Velocidad 2
 218+ 9A74 FE FD        	cp $fd
 219+ 9A76 20 21        	jr nz,8F
 220+ 9A78 18 07        	jr 3F
 221+ 9A7A 3A 1B 8C     7 ld a,(CTRL_DESPLZ) 												; Velocidad 4
 222+ 9A7D FE FB        	cp $fb
 223+ 9A7F 20 18        	jr nz,8F
 224+ 9A81
 225+ 9A81              ; ---------- ---------- ----------
 226+ 9A81
 227+ 9A81              3
 228+ 9A81 CD B4 9C     	call Reaparece_izquierda 										; Despues de haber actualizado la coordenada X del Sprite, (de 0 a 31). Si el movimiento es al char. _
 229+ 9A84              ;	call Reinicio
 230+ 9A84
 231+ 9A84              ; ---------- ---------- ----------
 232+ 9A84              ;
 233+ 9A84              ;	Esta parte de la rutina se encarga de hacer que el Sprite aparezca pixel a pixel por la izquierda.
 234+ 9A84
 235+ 9A84 06 02        	ld b,2 															; Para hacer que el objeto aparezca poco a poco, hemos de desplazarlo 2 veces: El primer desplazamiento_
 236+ 9A86 C5           5 push bc 															; _pone (CTRL_DESPLZ) a "0" y el segundo a "$ff". Con esto hacemos que el Sprite tenga espacio en blanco delante_
 237+ 9A87 CD A0 9A     	call DESPLZ_DER
 238+ 9A8A C1           	pop bc
 239+ 9A8B 10 F9        	djnz 5B
 240+ 9A8D 2A 17 8C     	ld hl,(Posicion_actual) 										; Decrementamos su posición actual, pués al desplazarlo a la derecha, volvemos a incrementar el nº de (Columns) y _
 241+ 9A90 2B           	dec hl 															; _ (Posicion_actual) ha pasado de $00 a $01.
 242+ 9A91 22 17 8C     	ld (Posicion_actual),hl
 243+ 9A94 CD 7D 94     	call Genera_coordenadas
 244+ 9A97 18 06        	jr 2F 															; Salimos para pintar la nueva posición.
 245+ 9A99
 246+ 9A99              ; ---------- ---------- ----------
 247+ 9A99
 248+ 9A99 2A 17 8C     8 ld hl,(Posicion_actual)
 249+ 9A9C CD A0 9A     	call DESPLZ_DER
 250+ 9A9F C9           2 ret
 251+ 9AA0
 252+ 9AA0              ; ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 253+ 9AA0              ;
 254+ 9AA0              ;	22/9/22
 255+ 9AA0              ;
 256+ 9AA0
 257+ 9AA0 CD AF 9A     DESPLZ_DER call Desplaza_derecha
 258+ 9AA3 CD FB 9A         call modifica_parametros_1er_DESPLZ_2
 259+ 9AA6 CD 24 9B         call Ciclo_completo
 260+ 9AA9 21 14 8C     	ld hl,Ctrl_0 													; Indica que nos hemos desplazado a la derecha.
 261+ 9AAC CB FE        	set 7,(hl)
 262+ 9AAE C9           	ret
 263+ 9AAF
 264+ 9AAF              ; ******************************************************************************************************************************************************************************************
 265+ 9AAF              ;	15/02/23
 266+ 9AAF              ;
 267+ 9AAF
 268+ 9AAF 3A 2D 8C     Desplaza_derecha ld a,(Vel_right)
 269+ 9AB2 47           	ld b,a
 270+ 9AB3 2A 20 8C     	ld hl,(Puntero_DESPLZ_der)
 271+ 9AB6 23           1 inc hl
 272+ 9AB7 23           	inc hl
 273+ 9AB8 10 FC        	djnz 1B 														; (Vel_right) indica cuantas posiciones desplazaremos el (Puntero_DESPLZ)_
 274+ 9ABA 22 20 8C     	ld (Puntero_DESPLZ_der),hl 										; _por el índice del Sprite.
 275+ 9ABD CD 5A 90     	call Extrae_address
 276+ 9AC0 22 19 8C     	ld (Puntero_objeto),hl
 277+ 9AC3
 278+ 9AC3              ; Modifica (Puntero_DESPLZ_izq).
 279+ 9AC3
 280+ 9AC3              ; Vamos a descontar a "8" el nº de movimientos que hemos efectuado a la derecha.
 281+ 9AC3              ; Cuántos movimientos hemos hecho ??
 282+ 9AC3              ; DE contiene (Puntero_DESPLZ_der).
 283+ 9AC3
 284+ 9AC3 2A 1C 8C     7 ld hl,(Indice_Sprite_der)
 285+ 9AC6 EB           	ex de,hl
 286+ 9AC7 A7           	and a
 287+ 9AC8 ED 52        	sbc hl,de
 288+ 9ACA CB 3D        	srl l
 289+ 9ACC 3E 08        6 ld a,8
 290+ 9ACE 95           	sub l
 291+ 9ACF 30 1E        	jr nc,3F
 292+ 9AD1
 293+ 9AD1              ; Hemos salido del índice. Hay que ajustar (Puntero_DESPLZ_der) dentro del mismo.
 294+ 9AD1              ; B="0".
 295+ 9AD1
 296+ 9AD1 04           4 inc b
 297+ 9AD2 3C           	inc a
 298+ 9AD3 20 FC        	jr nz,4B
 299+ 9AD5 78           	ld a,b
 300+ 9AD6 08           	ex af,af
 301+ 9AD7 2A 1C 8C     	ld hl,(Indice_Sprite_der)
 302+ 9ADA 23           5 inc hl
 303+ 9ADB 23           	inc hl
 304+ 9ADC 10 FC        	djnz 5B
 305+ 9ADE 22 20 8C     	ld (Puntero_DESPLZ_der),hl
 306+ 9AE1 CD 5A 90     	call Extrae_address
 307+ 9AE4 22 19 8C     	ld (Puntero_objeto),hl
 308+ 9AE7
 309+ 9AE7              ; Si nos hemos salido del índice es porque hemos completado un ciclo completo. Habrá que actualizar_
 310+ 9AE7              ; _(Posicion_actual).
 311+ 9AE7
 312+ 9AE7 21 17 8C     	ld hl,Posicion_actual
 313+ 9AEA 34           	inc (hl)
 314+ 9AEB 08               ex af,af
 315+ 9AEC 6F           	ld l,a
 316+ 9AED 18 DD        	jr 6B
 317+ 9AEF
 318+ 9AEF              ; Permanecemos en el índice. No hay que reajustar (Puntero_DESPLZ_izq).
 319+ 9AEF
 320+ 9AEF 47           3 ld b,a
 321+ 9AF0 2A 1E 8C     	ld hl,(Indice_Sprite_izq)
 322+ 9AF3 23           2 inc hl
 323+ 9AF4 23           	inc hl
 324+ 9AF5 10 FC        	djnz 2B
 325+ 9AF7 22 22 8C     	ld (Puntero_DESPLZ_izq),hl
 326+ 9AFA C9           8 ret
 327+ 9AFB
 328+ 9AFB              ; ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 329+ 9AFB              ;
 330+ 9AFB              ;	24/7/22
 331+ 9AFB              ;
 332+ 9AFB              ;	modifica_parametros_1er_DESPLZ_2
 333+ 9AFB              ;
 334+ 9AFB              ;	La rutina modifica el nº de columnas del objeto en el 1er desplazamiento.
 335+ 9AFB              ; 	También incrementa el byte de control de desplazamiento, (desplz. a derecha) y modifica la posición de (Puntero_datas) en función del cuadrante de pantalla en el que nos encontremos.
 336+ 9AFB              ; 	Si el desplazamiento se produce en el 2º o 4º cuadrante, la rutina decrementará (Posicion_actual).
 337+ 9AFB
 338+ 9AFB 3A 1B 8C     modifica_parametros_1er_DESPLZ_2 ld a,(CTRL_DESPLZ)		 		  ; Incrementamos el nª de (Columns) cuando desplazamos el objeto por 1ª vez.
 339+ 9AFE A7           	and a
 340+ 9AFF 20 1F        	jr nz,1F
 341+ 9B01 D6 09            sub 9                							              ; Situamos en $f7 el valor de partida de (CTRL_DESPLZ) tras el 1er desplazamiento.
 342+ 9B03 32 1B 8C         ld (CTRL_DESPLZ),a
 343+ 9B06
 344+ 9B06 21 16 8C     	ld hl,Columns
 345+ 9B09 34           	inc (hl)
 346+ 9B0A 3A 26 8C     	ld a,(Cuad_objeto)
 347+ 9B0D E6 01        	and 1
 348+ 9B0F 28 0F        	jr z,1F
 349+ 9B11 2A 17 8C     	ld hl,(Posicion_actual) 									  ; Incrementamos 1 char. el valor de (Posicion_actual), la primera vez que desplazamos el objeto y se encuentra en los _
 350+ 9B14 23           	inc hl 														  ; _ cuadrantes 1 y 3 de pantalla.
 351+ 9B15 22 17 8C     	ld (Posicion_actual),hl
 352+ 9B18 CD 7D 94     	call Genera_coordenadas
 353+ 9B1B CD 80 9C     	call Inc_CTRL_DESPLZ
 354+ 9B1E 18 03        	jr 2F
 355+ 9B20 CD 80 9C     1 call Inc_CTRL_DESPLZ
 356+ 9B23 C9           2 ret
 357+ 9B24
 358+ 9B24              ; ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 359+ 9B24              ;
 360+ 9B24              ;	24/7/22
 361+ 9B24              ;
 362+ 9B24              ;	Ciclo_completo.
 363+ 9B24              ;
 364+ 9B24              ;	FUNCIONAMIENTO: Si (CTRL_DESPLZ)="$ff" significa que nos hemos desplazado 1 char.
 365+ 9B24              ;
 366+ 9B24              ;	En ese caso, inicializamos (CTRL_DESPLZ). (CTRL_DESPLZ)="0".
 367+ 9B24              ; 	Decrementamos (Columns).
 368+ 9B24              ;	Modificamos (Posicion_actual) en función del cuadrante en el que nos encontremos.
 369+ 9B24              ;	Borramos la caja de desplazamientos, call Limpia_caja_de_DESPLZ.
 370+ 9B24
 371+ 9B24
 372+ 9B24 3A 1B 8C     Ciclo_completo ld a,(CTRL_DESPLZ)
 373+ 9B27 FE FF        	cp $ff
 374+ 9B29 28 10        	jr z,1F 												     ; Salimos de la rutina si no hemos completado 8 o más desplazamientos.
 375+ 9B2B E6 F0        	and $f0
 376+ 9B2D 20 28        	jr nz,3F
 377+ 9B2F
 378+ 9B2F              ; (CTRL_DESPLZ) fuera de rango, (por encima de $ff), hay que reajustar.
 379+ 9B2F
 380+ 9B2F 3A 1B 8C     	ld a,(CTRL_DESPLZ)
 381+ 9B32 47           	ld b,a
 382+ 9B33 3E F8        	ld a,$f8
 383+ 9B35 80           	add b
 384+ 9B36 32 1B 8C     	ld (CTRL_DESPLZ),a
 385+ 9B39 18 1C        	jr 3F
 386+ 9B3B 21 16 8C     1 ld hl,Columns													 ; Tras 8 desplazamientos el objeto desplazado es igual al original.
 387+ 9B3E 35           	dec (hl) 													 ; Decrementamos el nº de (Columns).
 388+ 9B3F AF           	xor a 														 ; Reiniciamos (CTRL_DESPLZ).
 389+ 9B40 32 1B 8C     	ld (CTRL_DESPLZ),a
 390+ 9B43 3A 26 8C     	ld a,(Cuad_objeto) 											 ; Si estamos situados en el cuadrante 1º o 3º de la pantalla no modificamos_
 391+ 9B46 E6 01        	and 1 														 ; _(Posicion_actual). Limpiamos la (Caja_de_DESPLZ) y salimos.
 392+ 9B48 20 0A        	jr nz,2F
 393+ 9B4A 2A 17 8C     	ld hl,(Posicion_actual)                                      ; Incrementamos (Posicion_actual) en los cuadrantes 2º y 4º.
 394+ 9B4D 23           	inc hl
 395+ 9B4E 22 17 8C     	ld (Posicion_actual),hl
 396+ 9B51 CD 7D 94     	call Genera_coordenadas
 397+ 9B54
 398+ 9B54              ; Inicia el puntero de Sprite.
 399+ 9B54
 400+ 9B54 CD 6F 90     2 call Inicia_puntero_objeto_der
 401+ 9B57 C9           3 ret
 402+ 9B58
 403+ 9B58              ; ******************************************************************************************************************************************************************************************
 404+ 9B58              ;
 405+ 9B58              ;	15/02/23
 406+ 9B58              ;
 407+ 9B58              ;	Mov_left.
 408+ 9B58              ;
 409+ 9B58              ; 	Desplaza el Sprite (x)Pixels a la izquierda.
 410+ 9B58              ;
 411+ 9B58              Mov_left
 412+ 9B58
 413+ 9B58 21 14 8C     	ld hl,Ctrl_0
 414+ 9B5B CB E6        	set 4,(hl) 														; Indicamos con el Bit4 de (Ctrl_0) que hay movimiento. Vamos a utilizar_
 415+ 9B5D              ; 																	; _esta información para evitar que la entidad se vuelva borrar/pintar_
 416+ 9B5D              ; 																	; _ en el caso de que no lo haya.
 417+ 9B5D 3A 14 8C     	ld a,(Ctrl_0)
 418+ 9B60 CB 77        	bit 6,a
 419+ 9B62 28 06        	jr z,11F 														; Estamos moviendo Amadeus???????. Si es así hemos de comprobar que que no hemos llegado al char.1 de la línea, [Stop_Amadeus].
 420+ 9B64
 421+ 9B64 CD 7A 9C     	call Stop_Amadeus_left
 422+ 9B67 C8           	ret z
 423+ 9B68 20 4A        	jr nz,8F
 424+ 9B6A
 425+ 9B6A 3A 08 8C     11 ld a,(Coordenada_X)
 426+ 9B6D A7           	and a
 427+ 9B6E 20 44        	jr nz,8F
 428+ 9B70
 429+ 9B70 3A 1B 8C     	ld a,(CTRL_DESPLZ) 			 									; Si el Sprite no está en el 1er char de la línea, (desaparece por la izquierda), o estando en este, _
 430+ 9B73 A7           	and a 															; _ (CTRL_DESPLZ)="0", cargamos HL con la (Posicion_actual) y ejecutamos la rutina de desplazamiento, _
 431+ 9B74 28 3E        	jr z,8F 														; _ pués aún podemos desplazarlo antes de desaparecer.
 432+ 9B76
 433+ 9B76              ; ---------- ---------- ----------
 434+ 9B76
 435+ 9B76 3A 2C 8C     	ld a,(Vel_left)
 436+ 9B79 FE 02        	cp 2
 437+ 9B7B 28 0F        	jr z,1F
 438+ 9B7D 38 04        	jr c,6F
 439+ 9B7F FE 04        	cp 4
 440+ 9B81 28 12        	jr z,7F
 441+ 9B83
 442+ 9B83              ; ---------- ---------- ----------
 443+ 9B83
 444+ 9B83 3A 1B 8C     6 ld a,(CTRL_DESPLZ)
 445+ 9B86 FE F8        	cp $f8
 446+ 9B88 20 2A        	jr nz,8F
 447+ 9B8A 18 10        	jr 4F
 448+ 9B8C 3A 1B 8C     1 ld a,(CTRL_DESPLZ)
 449+ 9B8F FE F9        	cp $f9
 450+ 9B91 20 21        	jr nz,8F
 451+ 9B93 18 07        	jr 4F
 452+ 9B95 3A 1B 8C     7 ld a,(CTRL_DESPLZ)
 453+ 9B98 FE FB        	cp $fb
 454+ 9B9A 20 18        	jr nz,8F
 455+ 9B9C
 456+ 9B9C              ; ---------- ---------- ----------
 457+ 9B9C
 458+ 9B9C              4
 459+ 9B9C CD A2 9C     	call Reaparece_derecha 											; Despues de haber actualizado la coordenada X del Sprite, (de 0 a 31). Si el movimiento es al char. _
 460+ 9B9F              ;	call Reinicio
 461+ 9B9F
 462+ 9B9F              ; ---------- ---------- ----------
 463+ 9B9F
 464+ 9B9F 06 02        	ld b,2 															; Para hacer que el objeto aparezca poco a poco, hemos de desplazarlo 2 veces: El primer desplazamiento_
 465+ 9BA1 C5           5 push bc 															; _pone (CTRL_DESPLZ) a "0" y el segundo a "$ff". Con esto hacemos que el Sprite tenga espacio en blanco delante_
 466+ 9BA2
 467+ 9BA2              ;	ld hl,(Indice_Sprite_izq)
 468+ 9BA2              ;	ld (Puntero_DESPLZ_izq),hl
 469+ 9BA2
 470+ 9BA2 CD BB 9B     	call DESPLZ_IZQ
 471+ 9BA5 C1           	pop bc
 472+ 9BA6 10 F9        	djnz 5B
 473+ 9BA8 2A 17 8C     	ld hl,(Posicion_actual) 										; Incrementamos su posición actual, pués al desplazarlo a la izquierda, volvemos a incrementar el nº de (Columns) y _
 474+ 9BAB 23           	inc hl 															; _ (Posicion_actual) ha pasado de $1f a $1e.
 475+ 9BAC 22 17 8C     	ld (Posicion_actual),hl
 476+ 9BAF CD 7D 94     	call Genera_coordenadas
 477+ 9BB2 18 06        	jr 2F 															; Salimos para pintar la nueva posición.
 478+ 9BB4
 479+ 9BB4              ; ---------- ---------- ----------
 480+ 9BB4
 481+ 9BB4              ; Movemos, no hay recolocación.
 482+ 9BB4
 483+ 9BB4 2A 17 8C     8 ld hl,(Posicion_actual)
 484+ 9BB7 CD BB 9B     	call DESPLZ_IZQ
 485+ 9BBA C9           2 ret
 486+ 9BBB
 487+ 9BBB              ; ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 488+ 9BBB              ;
 489+ 9BBB              ;	22/9/22
 490+ 9BBB
 491+ 9BBB              DESPLZ_IZQ
 492+ 9BBB
 493+ 9BBB CD CA 9B     	call Desplaza_izquierda
 494+ 9BBE CD 16 9C         call modifica_parametros_1er_DESPLZ
 495+ 9BC1 CD 3E 9C     	call Ciclo_completo_2
 496+ 9BC4 21 14 8C     	ld hl,Ctrl_0 													; Indica que nos hemos desplazado a la izquierda
 497+ 9BC7 CB BE        	res 7,(hl)
 498+ 9BC9 C9           	ret
 499+ 9BCA
 500+ 9BCA              Desplaza_izquierda
 501+ 9BCA
 502+ 9BCA 3A 2C 8C     	ld a,(Vel_left)
 503+ 9BCD 47           	ld b,a
 504+ 9BCE 2A 22 8C     	ld hl,(Puntero_DESPLZ_izq)
 505+ 9BD1 23           1 inc hl
 506+ 9BD2 23           	inc hl
 507+ 9BD3 10 FC        	djnz 1B 														; Seleccionamos FRAME en función de la velocidad del Sprite.
 508+ 9BD5 22 22 8C     	ld (Puntero_DESPLZ_izq),hl
 509+ 9BD8 CD 5A 90     	call Extrae_address
 510+ 9BDB 22 19 8C     	ld (Puntero_objeto),hl
 511+ 9BDE
 512+ 9BDE              ; Modifica (Puntero_DESPLZ_der).
 513+ 9BDE
 514+ 9BDE              ; Vamos a descontar a "8" el nº de movimientos que hemos efectuado a la izq.
 515+ 9BDE              ; Cuántos movimientos hemos hecho ??
 516+ 9BDE              ; DE contiene (Puntero_DESPLZ_izq).
 517+ 9BDE
 518+ 9BDE 2A 1E 8C     7 ld hl,(Indice_Sprite_izq)
 519+ 9BE1 EB           	ex de,hl
 520+ 9BE2 A7           	and a
 521+ 9BE3 ED 52        	sbc hl,de
 522+ 9BE5 CB 3D        	srl l
 523+ 9BE7 3E 08        6 ld a,8
 524+ 9BE9 95           	sub l
 525+ 9BEA 30 1E        	jr nc,3F
 526+ 9BEC
 527+ 9BEC              ; Hemos salido del índice. Hay que ajustar (Puntero_DESPLZ_izq) dentro del mismo.
 528+ 9BEC              ; B="0".
 529+ 9BEC
 530+ 9BEC 04           4 inc b
 531+ 9BED 3C           	inc a
 532+ 9BEE 20 FC        	jr nz,4B
 533+ 9BF0 78           	ld a,b
 534+ 9BF1 08           	ex af,af
 535+ 9BF2 2A 1E 8C     	ld hl,(Indice_Sprite_izq)
 536+ 9BF5 23           5 inc hl
 537+ 9BF6 23           	inc hl
 538+ 9BF7 10 FC        	djnz 5B
 539+ 9BF9 22 22 8C     	ld (Puntero_DESPLZ_izq),hl
 540+ 9BFC CD 5A 90     	call Extrae_address
 541+ 9BFF 22 19 8C     	ld (Puntero_objeto),hl
 542+ 9C02
 543+ 9C02              ; Si nos hemos salido del índice es porque hemos completado un ciclo completo. Habrá que actualizar_
 544+ 9C02              ; _(Posicion_actual).
 545+ 9C02
 546+ 9C02 21 17 8C     	ld hl,Posicion_actual
 547+ 9C05 35           	dec (hl)
 548+ 9C06 08           	ex af,af
 549+ 9C07 6F           	ld l,a
 550+ 9C08 18 DD        	jr 6B
 551+ 9C0A
 552+ 9C0A              ; Permanecemos en el índice. No hay que reajustar (Puntero_DESPLZ_izq).
 553+ 9C0A
 554+ 9C0A 47           3 ld b,a
 555+ 9C0B 2A 1C 8C     	ld hl,(Indice_Sprite_der)
 556+ 9C0E 23           2 inc hl
 557+ 9C0F 23           	inc hl
 558+ 9C10 10 FC        	djnz 2B
 559+ 9C12 22 20 8C     	ld (Puntero_DESPLZ_der),hl
 560+ 9C15 C9           8 ret
 561+ 9C16
 562+ 9C16              ; ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 563+ 9C16              ;
 564+ 9C16              ;	modifica_parametros_1er_DESPLZ
 565+ 9C16              ;
 566+ 9C16              ;	La rutina modifica el nº de columnas del objeto en el 1er desplazamiento.
 567+ 9C16              ; 	También decrementa el byte de control de desplazamiento, (desplz. a izq) y modifica la posición de (Puntero_datas) en función del cuadrante de pantalla en el que nos encontremos.
 568+ 9C16              ; 	Si el desplazamiento se produce en el 2º o 4º cuadrante, la rutina decrementará (Posicion_actual).
 569+ 9C16
 570+ 9C16 3A 1B 8C     modifica_parametros_1er_DESPLZ ld a,(CTRL_DESPLZ) 				    ; Incrementamos el nª de (Columns) cuando desplazamos el objeto por 1ª vez.
 571+ 9C19 A7           	and a
 572+ 9C1A 20 1E        	jr nz,1F
 573+ 9C1C 3D               dec a              							            	    ; Situamos en $f7 el valor de partida de (CTRL_DESPLZ) tras el 1er desplazamiento.
 574+ 9C1D 32 1B 8C         ld (CTRL_DESPLZ),a
 575+ 9C20 21 16 8C     	ld hl,Columns
 576+ 9C23 34           	inc (hl)
 577+ 9C24 3A 26 8C     	ld a,(Cuad_objeto)
 578+ 9C27 E6 01        	and 1
 579+ 9C29 20 0F        	jr nz,1F
 580+ 9C2B 2A 17 8C     	ld hl,(Posicion_actual) 									    ; Decrementamos 1 char. el valor de (Posicion_actual), la primera vez que desplazamos el objeto y se encuentra en los _
 581+ 9C2E 2B           	dec hl 														    ; _ cuadrantes 2 y 4 de pantalla.
 582+ 9C2F 22 17 8C     	ld (Posicion_actual),hl
 583+ 9C32 CD 7D 94     	call Genera_coordenadas
 584+ 9C35 CD 91 9C     	call Dec_CTRL_DESPLZ
 585+ 9C38 18 03        	jr 2F
 586+ 9C3A CD 91 9C     1 call Dec_CTRL_DESPLZ
 587+ 9C3D C9           2 ret
 588+ 9C3E
 589+ 9C3E              ; ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 590+ 9C3E
 591+ 9C3E 3A 1B 8C     Ciclo_completo_2 ld a,(CTRL_DESPLZ)
 592+ 9C41 FE F7        	cp $f7
 593+ 9C43 28 12        	jr z,1F 												   		; Salimos de la rutina si no hemos completado 8 o más desplazamientos.
 594+ 9C45 30 2C        	jr nc,3F
 595+ 9C47
 596+ 9C47              ; (CTRL_DESPLZ) fuera de rango, (por debajo de $f7), hay que reajustar.
 597+ 9C47
 598+ 9C47 06 00        	ld b,0
 599+ 9C49 04           4 inc b
 600+ 9C4A 3C           	inc a
 601+ 9C4B FE F7        	cp $f7
 602+ 9C4D 20 FA        	jr nz,4B
 603+ 9C4F 3E FF        	ld a,$ff
 604+ 9C51 90           	sub b
 605+ 9C52 32 1B 8C     	ld (CTRL_DESPLZ),a
 606+ 9C55 18 1C        	jr 3F
 607+ 9C57
 608+ 9C57              ; Se completa el ciclo de movimiento. (CTRL_DESPLZ)="0", se generan coordenadas y se corrige (Posicion_actual).
 609+ 9C57
 610+ 9C57 21 16 8C     1 ld hl,Columns
 611+ 9C5A 35           	dec (hl)
 612+ 9C5B AF           	xor a
 613+ 9C5C 32 1B 8C     	ld (CTRL_DESPLZ),a
 614+ 9C5F 3A 26 8C     	ld a,(Cuad_objeto)
 615+ 9C62 E6 01        	and 1
 616+ 9C64 28 0A        	jr z,2F
 617+ 9C66 2A 17 8C     	ld hl,(Posicion_actual)                                         ; Decrementamos (Posicion_actual) en los cuadrantes 2º y 4º.
 618+ 9C69 2B           	dec hl
 619+ 9C6A 22 17 8C     	ld (Posicion_actual),hl
 620+ 9C6D CD 7D 94     	call Genera_coordenadas
 621+ 9C70
 622+ 9C70              ; Inicia (Puntero_DESPLZ_izq) y (Puntero_objeto).
 623+ 9C70
 624+ 9C70 CD 82 90     2 call Inicia_puntero_objeto_izq
 625+ 9C73 C9           3 ret
 626+ 9C74
 627+ 9C74              ; ---------- ---------- ---------- ---------- ---------- ----------
 628+ 9C74              ;
 629+ 9C74              ;	19/10/22
 630+ 9C74              ;
 631+ 9C74              ;	(cp 29) para un Amadeus de 3 Columns.
 632+ 9C74              ;	(cp 30)   ""  ""    ""     2 Columns.
 633+ 9C74
 634+ 9C74 3A 08 8C     Stop_Amadeus_right ld a,(Coordenada_X)	 	  										 ; Posición horizontal de Amadeus.
 635+ 9C77 FE 1E        	cp 30																			 ; Hemos llegado al límite derecho de la pantalla??.
 636+ 9C79 C9           	ret
 637+ 9C7A
 638+ 9C7A              ; ---------- ---------- ---------- ---------- ---------- ----------
 639+ 9C7A              ;
 640+ 9C7A              ;	19/10/22
 641+ 9C7A              ;
 642+ 9C7A              ;	(cp 2) para un Amadeus de 3 Columns.
 643+ 9C7A              ;	(cp 1)   ""  ""    ""     2 Columns.
 644+ 9C7A
 645+ 9C7A 3A 08 8C     Stop_Amadeus_left ld a,(Coordenada_X)	 	  										 ; Posición horizontal de Amadeus.
 646+ 9C7D FE 01        	cp 1																			 ; Hemos llegado al límite izquierdo de la pantalla??.
 647+ 9C7F C9           	ret
 648+ 9C80
 649+ 9C80              ; ---------- ---------- ---------- ---------- ---------- ----------
 650+ 9C80              ;
 651+ 9C80              ;	24/7/22
 652+ 9C80              ;
 653+ 9C80              ;	Inc_CTRL_DESPLZ
 654+ 9C80              ;
 655+ 9C80              ;
 656+ 9C80              ;   Incrementa el valor del byte de control, (CTRL_DESPLZ) en función del nº de veces que hayamos desplazado el objeto, (Vel_right).
 657+ 9C80
 658+ 9C80 21 1B 8C     Inc_CTRL_DESPLZ ld hl,CTRL_DESPLZ
 659+ 9C83 3A 2D 8C     	ld a,(Vel_right)
 660+ 9C86 A7           	and a
 661+ 9C87 28 06        	jr z,1F
 662+ 9C89 47           	ld b,a
 663+ 9C8A 34           3 inc (hl)
 664+ 9C8B 10 FD        	djnz 3B
 665+ 9C8D 18 01        	jr 2F
 666+ 9C8F 34           1 inc (hl)
 667+ 9C90 C9           2 ret
 668+ 9C91
 669+ 9C91              ; ---------- ---------- ---------- ---------- ---------- ----------
 670+ 9C91              ;
 671+ 9C91              ;	5/2/23
 672+ 9C91              ;
 673+ 9C91              ;	Dec_CTRL_DESPLZ
 674+ 9C91              ;
 675+ 9C91              ;
 676+ 9C91              ;   Decrementa el valor del byte de control, (CTRL_DESPLZ) en función del nº de veces que hayamos desplazado el objeto, (Vel_right).
 677+ 9C91
 678+ 9C91 21 1B 8C     Dec_CTRL_DESPLZ ld hl,CTRL_DESPLZ
 679+ 9C94 3A 2C 8C     	ld a,(Vel_left)
 680+ 9C97 A7           	and a
 681+ 9C98 28 06        	jr z,1F
 682+ 9C9A 47           	ld b,a
 683+ 9C9B 35           3 dec (hl)
 684+ 9C9C 10 FD        	djnz 3B
 685+ 9C9E 18 01        	jr 2F
 686+ 9CA0 35           1 dec (hl)
 687+ 9CA1 C9           2 ret
 688+ 9CA2
 689+ 9CA2              ; ---------- ---------- ---------- ---------- ---------- ----------
 690+ 9CA2
 691+ 9CA2 2A 17 8C     Reaparece_derecha ld hl,(Posicion_actual)
 692+ 9CA5 01 1F 00     	ld bc,31
 693+ 9CA8 A7           	and a
 694+ 9CA9 ED 4A        	adc hl,bc
 695+ 9CAB 22 17 8C     	ld (Posicion_actual),hl
 696+ 9CAE 21 14 8C     	ld hl,Ctrl_0														; $xxx1
 697+ 9CB1 CB C6        	set 0,(hl)
 698+ 9CB3 C9           	ret
 699+ 9CB4
 700+ 9CB4              ; ---------- ---------- ---------- ---------- ---------- ----------
 701+ 9CB4
 702+ 9CB4 2A 17 8C     Reaparece_izquierda ld hl,(Posicion_actual)
 703+ 9CB7 01 1F 00     	ld bc,31
 704+ 9CBA A7           	and a
 705+ 9CBB ED 42        	sbc hl,bc
 706+ 9CBD 22 17 8C     	ld (Posicion_actual),hl 											; $xx1x
 707+ 9CC0 21 14 8C     	ld hl,Ctrl_0
 708+ 9CC3 CB CE        	set 1,(hl)
 709+ 9CC5 C9           	ret
 710+ 9CC6
 711+ 9CC6              ; ---------- ---------- ---------- ---------- ---------- ----------
 712+ 9CC6
 713+ 9CC6 24           Reaparece_abajo inc h
 714+ 9CC7 01 E0 17     	ld bc,$17e0
 715+ 9CCA A7           	and a
 716+ 9CCB ED 4A        	adc hl,bc
 717+ 9CCD 22 17 8C     	ld (Posicion_actual),hl
 718+ 9CD0 21 14 8C     	ld hl,Ctrl_0
 719+ 9CD3 CB D6        	set 2,(hl)
 720+ 9CD5 C9           	ret
 721+ 9CD6
 722+ 9CD6              ; ---------- ---------- ---------- ---------- ---------- ----------
 723+ 9CD6
 724+ 9CD6 01 E0 17     Reaparece_arriba ld bc,$17e0
 725+ 9CD9 A7           	and a
 726+ 9CDA ED 42        	sbc hl,bc
 727+ 9CDC 22 17 8C     	ld (Posicion_actual),hl
 728+ 9CDF 21 14 8C     	ld hl,Ctrl_0
 729+ 9CE2 CB DE        	set 3,(hl)
 730+ 9CE4 C9           	ret
 731+ 9CE5
 732+ 9CE5              ; ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 733+ 9CE5              ;
 734+ 9CE5              ;	15/07/23
 735+ 9CE5
 736+ 9CE5              Reinicio
 737+ 9CE5
 738+ 9CE5              ; Vamos a reiniciar los punteros y variables de movimiento.
 739+ 9CE5
 740+ 9CE5 AF           	xor a
 741+ 9CE6 21 3C 8C     	ld hl,Puntero_indice_mov_bucle
 742+ 9CE9 CD 07 9D     	call Limpia_contenido_hl
 743+ 9CEC
 744+ 9CEC 21 17 8C     	ld hl,Posicion_actual
 745+ 9CEF CD 07 9D     	call Limpia_contenido_hl
 746+ 9CF2
 747+ 9CF2 CD 5F 92     	call Inicializa_Puntero_indice_mov
 748+ 9CF5 CD 06 9E     	call Inicia_Puntero_mov
 749+ 9CF8
 750+ 9CF8 21 3E 8C     	ld hl,Incrementa_puntero
 751+ 9CFB 06 05        	ld b,5
 752+ 9CFD 77           1 ld (hl),a
 753+ 9CFE 23           	inc hl
 754+ 9CFF 10 FC        	djnz 1B
 755+ 9D01
 756+ 9D01 21 13 8C     	ld hl,Ctrl_2
 757+ 9D04 CB 96        	res 2,(hl)							; El movimiento de la entidad, deja de estar iniciado.
 758+ 9D06
 759+ 9D06 C9           	ret
 760+ 9D07
 761+ 9D07 77           Limpia_contenido_hl	ld (hl),a
 762+ 9D08 23           	inc hl
 763+ 9D09 77           	ld (hl),a
 764+ 9D0A C9           	ret
 765+ 9D0B
 766+ 9D0B              ; ----------------------------------------------------------------------------------------------------------------
 767+ 9D0B              ;
 768+ 9D0B              ;	18/6/24
 769+ 9D0B              ;
 770+ 9D0B
 771+ 9D0B              Amadeus_a_izquierda
 772+ 9D0B
 773+ 9D0B              ;	Actualiza contador de movimientos.
 774+ 9D0B
 775+ 9D0B 21 C5 89     	ld hl,Comm_Amadeus
 776+ 9D0E 35           	dec (hl)
 777+ 9D0F 28 10        	jr z,1F 								; 	Estamos en el extremo izquierdo de la pantalla.
 778+ 9D11
 779+ 9D11 2A C3 89     	ld hl,(Pamm_Amadeus)					;	Actualiza variable de 16 bits.
 780+ 9D14 2B           	dec hl
 781+ 9D15 2B           	dec hl
 782+ 9D16 2B           	dec hl
 783+ 9D17 2B           	dec hl
 784+ 9D18 22 C3 89     	ld (Pamm_Amadeus),hl					;	Actualiza variable de 8 bits.
 785+ 9D1B
 786+ 9D1B 21 6D 8C     	ld hl,Ctrl_3
 787+ 9D1E CB EE        	set 5,(hl)
 788+ 9D20
 789+ 9D20 C9           	ret
 790+ 9D21
 791+ 9D21 34           1 inc (hl)                                  ; 	Salimos. Damos orden de no imprimir la nave. No habrá movimiento.
 792+ 9D22 C9           	ret
 793+ 9D23
 794+ 9D23
 795+ 9D23              Amadeus_a_derecha
 796+ 9D23
 797+ 9D23              ;	Actualiza contador de movimientos.
 798+ 9D23
 799+ 9D23 21 C5 89     	ld hl,Comm_Amadeus
 800+ 9D26 34           	inc (hl)
 801+ 9D27 3E 7A        	ld a,$7a
 802+ 9D29 BE           	cp (hl)
 803+ 9D2A 28 10        	jr z,1F									; 	Estamos en el extremo derecho de la pantalla.
 804+ 9D2C
 805+ 9D2C 2A C3 89     	ld hl,(Pamm_Amadeus)					;	Actualiza variable de 16 bits.
 806+ 9D2F 23           	inc hl
 807+ 9D30 23           	inc hl
 808+ 9D31 23           	inc hl
 809+ 9D32 23           	inc hl
 810+ 9D33 22 C3 89     	ld (Pamm_Amadeus),hl					;	Actualiza variable de 8 bits.
 811+ 9D36
 812+ 9D36 21 6D 8C     	ld hl,Ctrl_3
 813+ 9D39 CB EE        	set 5,(hl)
 814+ 9D3B C9           	ret
 815+ 9D3C
 816+ 9D3C 35           1 dec (hl)									; 	Salimos. No hay movimiento. No pintamos la nave.
 817+ 9D3D C9           	ret
# file closed: Direcciones.asm
2287  9D3E              	include "Movimiento.asm"
# file opened: Movimiento.asm
   1+ 9D3E              ; ----- ----- ----- ----- -----
   2+ 9D3E              ;
   3+ 9D3E              ;   28/12/23
   4+ 9D3E
   5+ 9D3E              Movimiento
   6+ 9D3E
   7+ 9D3E              ; Nota: Previamente, la rutina [DRAW], ha iniciado la entidad, (Puntero_mov) ya apunta a su cadena de movimiento correspondiente.
   8+ 9D3E
   9+ 9D3E 3A 13 8C         ld a,(Ctrl_2)
  10+ 9D41 CB 57            bit 2,a
  11+ 9D43 20 1B            jr nz, Desplazamiento_iniciado
  12+ 9D45
  13+ 9D45 2A 3A 8C         ld hl,(Puntero_mov)
  14+ 9D48 7E               ld a,(hl)
  15+ 9D49
  16+ 9D49              ; HL contiene (Puntero_mov) y este se encuentra en el 1er byte de la cadena de movimiento, (Byte1) ..... % (Vel_up),(Vel_down).
  17+ 9D49
  18+ 9D49              Inicia_desplazamiento.
  19+ 9D49
  20+ 9D49              ; Preparamos (Incrementa_puntero). Cada vez que iniciemos un nuevo movimiento le sumaremos 2 uds.
  21+ 9D49
  22+ 9D49 CD 3C 9E         call Ajusta_velocidad_desplazamiento
  23+ 9D4C
  24+ 9D4C              ; Iniciamos (Repetimos_mov).
  25+ 9D4C
  26+ 9D4C 7E               ld a,(hl)
  27+ 9D4D E6 0F            and $0f
  28+ 9D4F 32 40 8C         ld (Repetimos_desplazamiento),a
  29+ 9D52 32 41 8C         ld (Repetimos_desplazamiento_backup),a
  30+ 9D55
  31+ 9D55              ; Iniciamos (Cola_de_desplazamiento).
  32+ 9D55
  33+ 9D55 23               inc hl
  34+ 9D56 7E               ld a,(hl)
  35+ 9D57 32 43 8C         ld (Cola_de_desplazamiento),a
  36+ 9D5A 2B               dec hl
  37+ 9D5B
  38+ 9D5B 21 13 8C         ld hl,Ctrl_2
  39+ 9D5E CB D6            set 2,(hl)
  40+ 9D60
  41+ 9D60              ; Hemos ajustado la velocidad del desplazamiento con los 2 primeros bytes del desplazamiento.
  42+ 9D60              ; El 3er byte indica la dirección del desplz., (nibble alto) y las veces que lo ejecutamos, (nibble bajo).
  43+ 9D60
  44+ 9D60              Desplazamiento_iniciado
  45+ 9D60
  46+ 9D60 CD 10 9E         call Aplica_desplazamiento
  47+ 9D63
  48+ 9D63              ; Si en el último desplazamiento aplicado hemos aplicado reinicio, salimos del movimiento.
  49+ 9D63
  50+ 9D63 3A 6D 8C         ld a,(Ctrl_3)
  51+ 9D66 CB 4F            bit 1,a
  52+ 9D68 C0               ret nz
  53+ 9D69
  54+ 9D69 21 40 8C     3 ld hl,Repetimos_desplazamiento
  55+ 9D6C 35               dec (hl)
  56+ 9D6D C0               ret nz
  57+ 9D6E
  58+ 9D6E              ; Hemos terminado de ejecutar el desplazamiento y sus ($0-$f repeticiones).
  59+ 9D6E              ; Hay que volver a ejecutar este desplazamiento ???.
  60+ 9D6E              ; Analiza (Cola_de_desplazamiento).
  61+ 9D6E
  62+ 9D6E 3A 43 8C     Cola ld a,(Cola_de_desplazamiento)
  63+ 9D71 A7               and a
  64+ 9D72 CC 65 9E         call z,Incrementa_Puntero_indice_mov                        ; Fin de la cadena de MOVIMIENTO ???.
  65+ 9D75 28 30            jr z,Reinicia_el_movimiento
  66+ 9D77
  67+ 9D77 FE FF            cp $ff
  68+ 9D79 28 2C            jr z,Reinicia_el_movimiento                                 ; Bucle infinito del MOVIMIENTO?.
  69+ 9D7B
  70+ 9D7B FE FE            cp $fe
  71+ 9D7D CC EA 9D         call z,Fijamos_bucle
  72+ 9D80 28 25            jr z,Reinicia_el_movimiento
  73+ 9D82
  74+ 9D82 FE FD            cp $fd
  75+ 9D84 20 11            jr nz,1F
  76+ 9D86
  77+ 9D86              ; ---
  78+ 9D86              ; Ya estamos ejecutando una repetición del último MOVIMIENTO ???.
  79+ 9D86
  80+ 9D86 3A 13 8C         ld a,(Ctrl_2)
  81+ 9D89 CB 5F            bit 3,a
  82+ 9D8B 20 1A            jr nz,Reinicia_el_movimiento
  83+ 9D8D
  84+ 9D8D              ; Si no es así, iniciamos la REPETICIÓN del movimiento activando el BIT 3 de Ctrl_2.
  85+ 9D8D
  86+ 9D8D 21 13 8C         ld hl,Ctrl_2                                                ; Vamos a indicar con este BIT a la rutina [Reinicia_el_movimiento],_
  87+ 9D90 CB DE            set 3,(hl)                                                  ; _ que (Cola_de_desplazamiento)="$fe", por lo que vamos a REINICIAR el_
  88+ 9D92
  89+ 9D92 CD FB 9D         call Inicia_Repetimos_movimiento
  90+ 9D95 28 10            jr z,Reinicia_el_movimiento                                 ; _ MOVIMIENTO (X nº de veces), siendo X un valor comprendido entre (1-255).
  91+ 9D97              ; ---
  92+ 9D97
  93+ 9D97 FE 01        1 cp 1
  94+ 9D99 CA D4 9D         jp z,Siguiente_desplazamiento                               ; Pasamos al siguiente desplazamiento del movimiento?.
  95+ 9D9C
  96+ 9D9C 3D               dec a
  97+ 9D9D 32 43 8C         ld (Cola_de_desplazamiento),a
  98+ 9DA0
  99+ 9DA0 3A 41 8C         ld a,(Repetimos_desplazamiento_backup)                      ; Cuando (Cola_de_desplazamiento) actúa como contador del_
 100+ 9DA3 32 40 8C         ld (Repetimos_desplazamiento),a                             ; _ desplazamiento y este no ha llegado a "0", decrementamos_
 101+ 9DA6              ;                                                               ; _ el contador y RESTAURAMOS (Repetimos_desplazamiento).
 102+ 9DA6 C9               ret
 103+ 9DA7
 104+ 9DA7              Reinicia_el_movimiento
 105+ 9DA7
 106+ 9DA7 3A 13 8C         ld a,(Ctrl_2)
 107+ 9DAA CB 5F            bit 3,a
 108+ 9DAC 28 1B            jr z,2F
 109+ 9DAE
 110+ 9DAE              ; (Cola_de_desplazamiento)="254".
 111+ 9DAE
 112+ 9DAE 21 42 8C         ld hl,Repetimos_movimiento                                  ; Decrementamos (Repetimos_movimiento) hasta completar repeticiones.
 113+ 9DB1 35               dec (hl)
 114+ 9DB2 20 15            jr nz,2F
 115+ 9DB4
 116+ 9DB4              ; Fin de las repeticiones del último movimiento.
 117+ 9DB4
 118+ 9DB4 21 13 8C         ld hl,Ctrl_2
 119+ 9DB7 CB 9E            res 3,(hl)                                                  ; Decrementamos el BIT de repeticiones de movimiento.
 120+ 9DB9
 121+ 9DB9 2A 3A 8C         ld hl,(Puntero_mov)
 122+ 9DBC 23               inc hl
 123+ 9DBD 23               inc hl
 124+ 9DBE 23               inc hl
 125+ 9DBF 22 3A 8C         ld (Puntero_mov),hl                                         ; Situamos (Puntero_mov) en (Cola_de_desplazamiento) y saltamos a `Cola'_
 126+ 9DC2              ;                                                               ; _ para ejecutar su mandato. :)
 127+ 9DC2 7E               ld a,(hl)
 128+ 9DC3 32 43 8C         ld (Cola_de_desplazamiento),a
 129+ 9DC6
 130+ 9DC6 C3 6E 9D         jp Cola
 131+ 9DC9
 132+ 9DC9 CD 06 9E     2 call Inicia_Puntero_mov
 133+ 9DCC
 134+ 9DCC 21 13 8C         ld hl,Ctrl_2
 135+ 9DCF CB 96            res 2,(hl)
 136+ 9DD1
 137+ 9DD1 C3 3E 9D         jp Movimiento
 138+ 9DD4
 139+ 9DD4              Siguiente_desplazamiento
 140+ 9DD4
 141+ 9DD4              ;   Situamos (Puntero_mov) en el siguiente desplazamiento del movimiento.
 142+ 9DD4              ;   Indicamos que hay que iniciar un nuevo desplazamiento.
 143+ 9DD4
 144+ 9DD4 21 13 8C         ld hl,Ctrl_2
 145+ 9DD7 CB 96            res 2,(hl)
 146+ 9DD9
 147+ 9DD9 2A 3A 8C         ld hl,(Puntero_mov)
 148+ 9DDC 23               inc hl
 149+ 9DDD 23               inc hl
 150+ 9DDE 22 3A 8C         ld (Puntero_mov),hl
 151+ 9DE1
 152+ 9DE1 7E               ld a,(hl)
 153+ 9DE2 A7               and a
 154+ 9DE3 CC 65 9E         call z,Incrementa_Puntero_indice_mov
 155+ 9DE6 CA A7 9D         jp z,Reinicia_el_movimiento
 156+ 9DE9
 157+ 9DE9 C9               ret
 158+ 9DEA
 159+ 9DEA              ; Subrutinas -----------------------------------------
 160+ 9DEA              ; ---------- --------- --------- ---------- ----------
 161+ 9DEA              ;
 162+ 9DEA              ;   24/07/23
 163+ 9DEA              ;
 164+ 9DEA              ;   Fijamos_bucle
 165+ 9DEA              ;
 166+ 9DEA              ;
 167+ 9DEA
 168+ 9DEA              Fijamos_bucle
 169+ 9DEA
 170+ 9DEA 3A 3E 8C         ld a,(Incrementa_puntero)
 171+ 9DED 3C               inc a
 172+ 9DEE 32 3F 8C         ld (Incrementa_puntero_backup),a
 173+ 9DF1
 174+ 9DF1 CD 65 9E         call Incrementa_Puntero_indice_mov
 175+ 9DF4 2A 38 8C         ld hl,(Puntero_indice_mov)
 176+ 9DF7 22 3C 8C         ld (Puntero_indice_mov_bucle),hl
 177+ 9DFA C9               ret
 178+ 9DFB
 179+ 9DFB              ; ---------- --------- --------- ---------- ----------
 180+ 9DFB              ;
 181+ 9DFB              ;   07/7/23
 182+ 9DFB              ;
 183+ 9DFB              ;   Inicia_Repetimos_movimiento
 184+ 9DFB              ;
 185+ 9DFB              ;
 186+ 9DFB
 187+ 9DFB              Inicia_Repetimos_movimiento
 188+ 9DFB
 189+ 9DFB              ; Iniciamos (Repetimos_movimiento).
 190+ 9DFB
 191+ 9DFB DD 2A 3A 8C      ld ix,(Puntero_mov)
 192+ 9DFF DD 7E 02         ld a,(ix+2)
 193+ 9E02 32 42 8C         ld (Repetimos_movimiento),a
 194+ 9E05
 195+ 9E05 C9               ret
 196+ 9E06
 197+ 9E06              ; ---------- --------- --------- ---------- ----------
 198+ 9E06              ;
 199+ 9E06              ;   26/6/23
 200+ 9E06              ;
 201+ 9E06              ;   Inicia_Puntero_mov
 202+ 9E06              ;
 203+ 9E06              ;
 204+ 9E06
 205+ 9E06 2A 38 8C     Inicia_Puntero_mov ld hl,(Puntero_indice_mov)
 206+ 9E09 CD 5A 90         call Extrae_address
 207+ 9E0C 22 3A 8C         ld (Puntero_mov),hl
 208+ 9E0F C9               ret
 209+ 9E10
 210+ 9E10              ; ---------- --------- --------- ---------- ----------
 211+ 9E10              ;
 212+ 9E10              ;   27/06/23
 213+ 9E10              ;
 214+ 9E10              ;   Aplica_movimiento.
 215+ 9E10
 216+ 9E10              Aplica_desplazamiento
 217+ 9E10
 218+ 9E10              ; Analizamos (bit a bit) el nibble alto del 3er byte que compone el desplazamiento y ejecutamos.
 219+ 9E10
 220+ 9E10 2A 3A 8C         ld hl, (Puntero_mov)
 221+ 9E13
 222+ 9E13 7E               ld a,(hl)
 223+ 9E14 E6 F0            and $f0
 224+ 9E16 C8               ret z                       ; Salimos de la rutina si no hay desplazamiento.
 225+ 9E17
 226+ 9E17 CB 7E            bit 7,(hl)
 227+ 9E19 28 03            jr z,1F
 228+ 9E1B CD F2 99         call Mov_up
 229+ 9E1E 2A 3A 8C     1 ld hl, (Puntero_mov)
 230+ 9E21 CB 76            bit 6,(hl)
 231+ 9E23 28 03            jr z,2F
 232+ 9E25 CD B9 99         call Mov_down
 233+ 9E28
 234+ 9E28              ; Se ha aplicado reinicio ???
 235+ 9E28              ; Si es así, dejamos de aplicar desplazamiento, (RET).
 236+ 9E28
 237+ 9E28              ;    ld a,(Ctrl_3)
 238+ 9E28              ;    bit 1,a
 239+ 9E28              ;    ret nz
 240+ 9E28
 241+ 9E28 2A 3A 8C     2 ld hl, (Puntero_mov)
 242+ 9E2B CB 6E            bit 5,(hl)
 243+ 9E2D 28 03            jr z,3F
 244+ 9E2F CD 58 9B         call Mov_left
 245+ 9E32 2A 3A 8C     3 ld hl, (Puntero_mov)
 246+ 9E35 CB 66            bit 4,(hl)
 247+ 9E37 C8               ret z
 248+ 9E38 CD 35 9A         call Mov_right
 249+ 9E3B C9               ret
 250+ 9E3C
 251+ 9E3C              ; ---------- --------- --------- ---------- ----------
 252+ 9E3C              ;
 253+ 9E3C              ;   26/06/23
 254+ 9E3C              ;
 255+ 9E3C              ;   Ajusta_velocidad_desplazamiento.
 256+ 9E3C
 257+ 9E3C              Ajusta_velocidad_desplazamiento
 258+ 9E3C
 259+ 9E3C              ; 1er byte de la cadena de movimiento.
 260+ 9E3C              ; Indica (Vel_up), (nibble alto) y (Vel_down) el nibble bajo.
 261+ 9E3C
 262+ 9E3C CD 5A 9E         call Extrae_nibble_alto
 263+ 9E3F
 264+ 9E3F 32 2E 8C         ld (Vel_up),a
 265+ 9E42 79               ld a,c
 266+ 9E43 E6 0F            and $0f
 267+ 9E45 32 2F 8C         ld (Vel_down),a
 268+ 9E48
 269+ 9E48              ; Saltamos al 2º byte de la cadena de movimiento.
 270+ 9E48              ; Indica (Vel_left), (nibble alto) y (Vel_right) el nibble bajo.
 271+ 9E48
 272+ 9E48 23               inc hl
 273+ 9E49 CD 5A 9E         call Extrae_nibble_alto
 274+ 9E4C
 275+ 9E4C 32 2C 8C         ld (Vel_left),a
 276+ 9E4F 79               ld a,c
 277+ 9E50 E6 0F            and $0f
 278+ 9E52 32 2D 8C         ld (Vel_right),a
 279+ 9E55
 280+ 9E55              ; Nos situamos en el 3er byte del desplazamiento. Actualizamos (Puntero_mov).
 281+ 9E55
 282+ 9E55 23               inc hl
 283+ 9E56 22 3A 8C         ld (Puntero_mov),hl
 284+ 9E59 C9               ret
 285+ 9E5A
 286+ 9E5A 06 04        Extrae_nibble_alto ld b,4
 287+ 9E5C 7E               ld a,(hl)
 288+ 9E5D 4F               ld c,a
 289+ 9E5E E6 F0            and $f0
 290+ 9E60 CB 3F        1 srl a
 291+ 9E62 10 FC            djnz 1B
 292+ 9E64 C9               ret
 293+ 9E65
 294+ 9E65              ; ---------- --------- --------- ---------- ----------
 295+ 9E65              ;
 296+ 9E65              ;   5/7/23
 297+ 9E65              ;
 298+ 9E65              ;   Incrementa_Puntero_indice_mov
 299+ 9E65
 300+ 9E65              Incrementa_Puntero_indice_mov
 301+ 9E65
 302+ 9E65 21 3E 8C         ld hl,Incrementa_puntero
 303+ 9E68 34               inc (hl)
 304+ 9E69
 305+ 9E69 2A 38 8C         ld hl,(Puntero_indice_mov)
 306+ 9E6C 01 02 00         ld bc,2
 307+ 9E6F A7               and a
 308+ 9E70 09               add hl,bc
 309+ 9E71 22 38 8C         ld (Puntero_indice_mov),hl
 310+ 9E74
 311+ 9E74 7E               ld a,(hl)
 312+ 9E75 A7               and a
 313+ 9E76
 314+ 9E76              ;! STOP. Fin del patrón de movimiento de la entidad.
 315+ 9E76
 316+ 9E76              ;    jr z,$
 317+ 9E76
 318+ 9E76              ;! Reinicia el Patrón de movimiento.
 319+ 9E76
 320+ 9E76 CC 7B 9E         call z,Inicializa_Puntero_indice_mov_2
 321+ 9E79
 322+ 9E79 AF               xor a                                   ; Siempre salimos de la rutina con el flag "Z" activo.
 323+ 9E7A
 324+ 9E7A C9               ret
 325+ 9E7B
 326+ 9E7B              ; ---------- --------- --------- ---------- ----------
 327+ 9E7B              ;
 328+ 9E7B              ;   15/01/24
 329+ 9E7B              ;
 330+ 9E7B              ;   Inicializa_Puntero_indice_mov
 331+ 9E7B
 332+ 9E7B              Inicializa_Puntero_indice_mov_2
 333+ 9E7B
 334+ 9E7B              ; Existe etiqueta de bucle principal???
 335+ 9E7B
 336+ 9E7B 2A 3C 8C         ld hl,(Puntero_indice_mov_bucle)
 337+ 9E7E 24               inc h
 338+ 9E7F 25               dec h
 339+ 9E80 28 05            jr z,2F
 340+ 9E82
 341+ 9E82 22 38 8C         ld (Puntero_indice_mov),hl
 342+ 9E85 18 14            jr 3F
 343+ 9E87
 344+ 9E87              ; Inicializamos (Puntero_indice_mov) con la 1ª dirección del índice del patrón de movimiento.
 345+ 9E87
 346+ 9E87 3A 3E 8C     2 ld a,(Incrementa_puntero)
 347+ 9E8A 47               ld b,a
 348+ 9E8B
 349+ 9E8B 2A 38 8C         ld hl,(Puntero_indice_mov)
 350+ 9E8E 2B           1 dec hl
 351+ 9E8F 2B               dec hl
 352+ 9E90 10 FC            djnz 1B
 353+ 9E92 22 38 8C         ld (Puntero_indice_mov),hl
 354+ 9E95
 355+ 9E95 AF               xor a
 356+ 9E96 32 3E 8C         ld (Incrementa_puntero),a
 357+ 9E99 18 06            jr 4F
 358+ 9E9B
 359+ 9E9B 3A 3F 8C     3 ld a,(Incrementa_puntero_backup)
 360+ 9E9E 32 3E 8C         ld (Incrementa_puntero),a
 361+ 9EA1 C9           4 ret
 362+ 9EA2
 363+ 9EA2              ; ----------------------------------------------------------------------
 364+ 9EA2              ;
 365+ 9EA2              ;   30/01/24
 366+ 9EA2              ;
 367+ 9EA2              ;   Sitúa HL en la dirección donde se encuentra el Contador_general_de_mov_masticados de este (Tipo) de entidad.
 368+ 9EA2
 369+ 9EA2 3A 07 8C     Situa_en_contador_general_de_mov_masticados ld a,(Tipo)
 370+ 9EA5 CD FA 93         call Calcula_salto_en_BC
 371+ 9EA8 21 30 8C         ld hl,Contador_general_de_mov_masticados_Entidad_1
 372+ 9EAB A7               and a
 373+ 9EAC ED 4A            adc hl,bc
 374+ 9EAE C9               ret
 375+ 9EAF
 376+ 9EAF              ; ----------------------------------------------------------------------
 377+ 9EAF              ;
 378+ 9EAF              ;   30/01/24
 379+ 9EAF              ;
 380+ 9EAF              ;   Transfiere los datos del Contador_general_de_mov_masticados de este (Tipo) de entidad a (Contador_de_mov_masticados).
 381+ 9EAF              ;
 382+ 9EAF              ;   INPUT: HL contiene el contador de 16 bits, (Contador_general_de_mov_masticados de este (Tipo) de entidad).
 383+ 9EAF
 384+ 9EAF 4E           Transfiere_datos_de_contadores ld c,(hl)
 385+ 9EB0 23               inc hl
 386+ 9EB1 46               ld b,(hl)                                                   ; BC contiene los mov_masticados totales de esta entidad.
 387+ 9EB2 69               ld l,c
 388+ 9EB3 60               ld h,b
 389+ 9EB4 22 10 8C         ld (Contador_de_mov_masticados),hl
 390+ 9EB7 C9               ret
 391+ 9EB8
# file closed: Movimiento.asm
2288  9EB8              	include "Disparo.asm"
# file opened: Disparo.asm
   1+ 9EB8              ; --------------------------------------------------------------------------------------
   2+ 9EB8              ;
   3+ 9EB8              ;   12/8/24
   4+ 9EB8              ;
   5+ 9EB8
   6+ 9EB8              Genera_disparo_Amadeus
   7+ 9EB8
   8+ 9EB8              ;   Exclusiones.
   9+ 9EB8
  10+ 9EB8 3A 86 8C         ld a,(Disparo_Amadeus)
  11+ 9EBB A7               and a
  12+ 9EBC C8               ret z                                                    ; Salimos si el disparo de nuestra nave no está habilitado.
  13+ 9EBD
  14+ 9EBD              Define_puntero_objeto_disparo
  15+ 9EBD
  16+ 9EBD              ;    dec a
  17+ 9EBD              ;    ld (Disparo_Amadeus),a                                  ;  Deshabilita el disparo.
  18+ 9EBD
  19+ 9EBD              ;   Inicializamos contador.
  20+ 9EBD
  21+ 9EBD 06 00            ld b,0
  22+ 9EBF 2A C1 89         ld hl,(p.imp.amadeus)
  23+ 9EC2 2C               inc l
  24+ 9EC3
  25+ 9EC3 3E 80            ld a,$80
  26+ 9EC5 BE               cp (hl)
  27+ 9EC6 28 0D            jr z,1F
  28+ 9EC8
  29+ 9EC8 04               inc b
  30+ 9EC9 3E 60            ld a,$60
  31+ 9ECB BE               cp (hl)
  32+ 9ECC 28 07            jr z,1F
  33+ 9ECE
  34+ 9ECE 04               inc b
  35+ 9ECF 3E 18            ld a,$18
  36+ 9ED1 BE               cp (hl)
  37+ 9ED2 28 01            jr z,1F
  38+ 9ED4
  39+ 9ED4 04               inc b
  40+ 9ED5
  41+ 9ED5              ;   Calcula el Puntero_de_impresión del disparo.
  42+ 9ED5
  43+ 9ED5 CD 82 99     1 call PreviousScan
  44+ 9ED8 CD 82 99         call PreviousScan
  45+ 9EDB CD 82 99         call PreviousScan
  46+ 9EDE
  47+ 9EDE 78               ld a,b
  48+ 9EDF CB 3F            srl a
  49+ 9EE1 28 03            jr z,4F
  50+ 9EE3
  51+ 9EE3              ; --- Guarda el puntero_de_impresión del disparo en la pila.
  52+ 9EE3 E5               push hl
  53+ 9EE4 18 02            jr 5F
  54+ 9EE6 2D           4 dec l
  55+ 9EE7 E5               push hl
  56+ 9EE8              ; ---
  57+ 9EE8
  58+ 9EE8              ;   Calcula el Puntero_objeto del disparo.
  59+ 9EE8
  60+ 9EE8 21 A0 83     5 ld hl,Indice_disparo
  61+ 9EEB 04               inc b
  62+ 9EEC 05               dec b
  63+ 9EED 28 04            jr z,2F
  64+ 9EEF
  65+ 9EEF              ;   Nos desplazamos por el índice de disparos.
  66+ 9EEF
  67+ 9EEF 2C           3 inc l
  68+ 9EF0 2C               inc l
  69+ 9EF1 10 FC            djnz 3B
  70+ 9EF3
  71+ 9EF3              ; --- Guarda el Puntero_objeto del disparo en la pila.
  72+ 9EF3 CD 5A 90     2 call Extrae_address
  73+ 9EF6 E5               push hl
  74+ 9EF7              ; ---
  75+ 9EF7
  76+ 9EF7              ; Almacenamos (Puntero_objeto) y (Puntero_de_impresion) en su correspondiente caja.
  77+ 9EF7              ; HL en el 1er .db de la caja y (Puntero_DESPLZ_DISPARO_AMADEUS) avanza una posición en el índice.
  78+ 9EF7
  79+ 9EF7 2A 71 8C         ld hl,(Puntero_DESPLZ_DISPARO_AMADEUS)
  80+ 9EFA CD 5A 90         call Extrae_address
  81+ 9EFD
  82+ 9EFD 06 02            ld b,2
  83+ 9EFF
  84+ 9EFF D1           6 pop de
  85+ 9F00 73               ld (hl),e
  86+ 9F01 23               inc hl
  87+ 9F02 72               ld (hl),d
  88+ 9F03 23               inc hl
  89+ 9F04
  90+ 9F04 10 F9            djnz 6B
  91+ 9F06
  92+ 9F06              Detecta_impacto_en_disparo_de_Amadeus
  93+ 9F06
  94+ 9F06 CD 3B 9F         call Detecta_impacto_en_disparo_de_Amadeus01
  95+ 9F09
  96+ 9F09 2A 71 8C         ld hl,(Puntero_DESPLZ_DISPARO_AMADEUS)
  97+ 9F0C 23               inc hl
  98+ 9F0D 23               inc hl
  99+ 9F0E CD 5A 90         call Extrae_address
 100+ 9F11 2B               dec hl                                               ;  Sitúa el puntero en el .db (Impacto) de la caja del disparo.
 101+ 9F12 28 02            jr z,7F
 102+ 9F14 3E 01            ld a,1
 103+ 9F16 77           7 ld (hl),a
 104+ 9F17 C8               ret z
 105+ 9F18
 106+ 9F18              Genera_coordenadas_de_disparo_Amadeus
 107+ 9F18
 108+ 9F18              ;   Esta parte de la rutina sólo aplica cuando un disparo nuestro alcanza a una entidad.
 109+ 9F18              ;   Genera las coordenadas de nuestro disparo certero y activa el correspondiente FLAG, (bit3 Impacto2).
 110+ 9F18
 111+ 9F18 F3               di
 112+ 9F19 18 FE            jr $
 113+ 9F1B FB               ei
 114+ 9F1C
 115+ 9F1C 2A 71 8C         ld hl,(Puntero_DESPLZ_DISPARO_AMADEUS)
 116+ 9F1F CD 5A 90         call Extrae_address
 117+ 9F22 23               inc hl
 118+ 9F23 23               inc hl
 119+ 9F24
 120+ 9F24 CD 5A 90         call Extrae_address                                 ;   Puntero_de_impresión del disparo en HL.
 121+ 9F27 CD 7D 94         call Genera_coordenadas
 122+ 9F2A
 123+ 9F2A 3D               dec a
 124+ 9F2B
 125+ 9F2B 21 76 8C         ld hl,Coordenadas_disparo_certero
 126+ 9F2E 77               ld (hl),a                                           ;   Almacenamos la Coordenada_Y, (Fila) del disparo.
 127+ 9F2F 23               inc hl
 128+ 9F30 3A 08 8C         ld a,(Coordenada_X)
 129+ 9F33 77               ld (hl),a                                           ;   Almacenamos la Coordenada_X, (Columna) del disparo.
 130+ 9F34
 131+ 9F34 21 73 8C         ld hl,Impacto2
 132+ 9F37 CB DE            set 3,(hl)                                          ;   Indica que un disparo de nuestra nave ha alcanzado a una entidad.
 133+ 9F39
 134+ 9F39 AF               xor a                                               ;   Siempre "Z" cuando ejecutamos [Genera_disparo_Amadeus].
 135+ 9F3A C9               ret
 136+ 9F3B
 137+ 9F3B              ; ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
 138+ 9F3B              ; ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
 139+ 9F3B              ; ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
 140+ 9F3B
 141+ 9F3B              ; ----------------------------------------------
 142+ 9F3B              ;
 143+ 9F3B              ;   12/08/24
 144+ 9F3B              ;
 145+ 9F3B
 146+ 9F3B
 147+ 9F3B              Detecta_impacto_en_disparo_de_Amadeus01
 148+ 9F3B
 149+ 9F3B              Extraccion_de_datos
 150+ 9F3B
 151+ 9F3B 21 56 89         ld hl,Indice_de_disparos_Amadeus
 152+ 9F3E CD 5A 90         call Extrae_address
 153+ 9F41
 154+ 9F41 5E               ld e,(hl)
 155+ 9F42 23               inc hl
 156+ 9F43 56               ld d,(hl)
 157+ 9F44 23               inc hl                                                 ;    Puntero_objeto del disparo en DE.
 158+ 9F45
 159+ 9F45 4E               ld c,(hl)
 160+ 9F46 23               inc hl
 161+ 9F47 46               ld b,(hl)
 162+ 9F48 23               inc hl                                                 ;    Puntero_de_impresión del disparo en BC.
 163+ 9F49
 164+ 9F49 C5               push bc
 165+ 9F4A E1               pop hl                                                 ;    Puntero_de_impresión del disparo en HL.
 166+ 9F4B
 167+ 9F4B              Detecta_impacto_
 168+ 9F4B
 169+ 9F4B 1A               ld a,(de)
 170+ 9F4C A6               and (hl)
 171+ 9F4D C0               ret nz
 172+ 9F4E
 173+ 9F4E 13               inc de
 174+ 9F4F 23               inc hl
 175+ 9F50
 176+ 9F50 1A               ld a,(de)
 177+ 9F51 A6               and (hl)
 178+ 9F52 C9               ret
 179+ 9F53
 180+ 9F53              ; -------------------------------------------------------------------------------------------------------------
 181+ 9F53              ;
 182+ 9F53              ;   8/8/24
 183+ 9F53              ;
 184+ 9F53              ;   La entidad se encuentra en la fila $14,$15 o $16 de pantalla.
 185+ 9F53              ;   Vamos a comprobar si la entidad ocupa alguna de las columnas ocupadas por Amadeus y por lo_
 186+ 9F53              ;   _ tanto, existe riesgo alto de colisión entre ambas.
 187+ 9F53              ;
 188+ 9F53              ;   MODIFICA: HL,DE,BC y A.
 189+ 9F53              ;   OUTPUTS: (Coordenadas_X_Entidad) y (Coordenadas_X_Amadeus) contienen el nº de las columnas que ocupan en pantalla.
 190+ 9F53              ;            (Impacto) se coloca a "1" si coincide alguna de las columnas. Alto riesgo de colisión.
 191+ 9F53
 192+ 9F53              Colision_Entidad_Amadeus
 193+ 9F53
 194+ 9F53              ; Posible contacto de entidad con Amadeus. ?????
 195+ 9F53
 196+ 9F53              ; Exclusiones:
 197+ 9F53
 198+ 9F53 3A 92 8C         ld a,(Shield)
 199+ 9F56 A7               and a
 200+ 9F57 C0               ret nz                                                 ; No comprobamos contacto si existe Shield.
 201+ 9F58
 202+ 9F58 21 6D 8C         ld hl,Ctrl_3
 203+ 9F5B CB 76            bit 6,(hl)
 204+ 9F5D C0               ret nz                                                 ; Salimos si Amadeus ha sido destruido y estamos esperando nueva nave o mensaje final.
 205+ 9F5E
 206+ 9F5E 21 73 8C         ld hl,Impacto2                                         ; Salimos si tenemos una posible colisión de una entidad anterior. Tenemos almacenadas las coordenadas X de otra entidad.
 207+ 9F61 CB 56            bit 2,(hl)
 208+ 9F63 C0               ret nz
 209+ 9F64
 210+ 9F64 3A 09 8C     	ld a,(Coordenada_y)
 211+ 9F67 FE 14        	cp $14
 212+ 9F69 D8           	ret c                                                  ; Salimos si la entidad no está en zona de Amadeus.
 213+ 9F6A
 214+ 9F6A 3A C0 89         ld a,(Impacto_Amadeus)                                 ; Evita que se produzca colisión con dos entidades a la vez.
 215+ 9F6D A7               and a
 216+ 9F6E C0               ret nz
 217+ 9F6F
 218+ 9F6F              Genera_coordenadas_X
 219+ 9F6F
 220+ 9F6F              ;   Guardamos las coordenadas_X de la entidad y Amadeus en sus correspondientes almacenes.
 221+ 9F6F              ;   DRAW tiene almacenados, en este momento, los datos de la última ENTIDAD que hemos desplazado.
 222+ 9F6F
 223+ 9F6F              ;   Limpiamos almacenes.
 224+ 9F6F
 225+ 9F6F              ;    call Limpia_Coordenadas_X
 226+ 9F6F
 227+ 9F6F              ;   Almacenamos las coordenadas X de la entidad peligrosa, (en curso).
 228+ 9F6F
 229+ 9F6F 21 78 8C         ld hl,Coordenadas_X_Entidad
 230+ 9F72 3A 08 8C         ld a,(Coordenada_X)
 231+ 9F75 CD 97 9F         call Guarda_coordenadas_X
 232+ 9F78
 233+ 9F78              ;   Almacenamos las coordenadas X de Amadeus.
 234+ 9F78
 235+ 9F78 3A BD 89         ld a,(CX_Amadeus)
 236+ 9F7B CD 97 9F         call Guarda_coordenadas_X
 237+ 9F7E CD AB 9F         call Compara_coordenadas_X
 238+ 9F81 C0               ret nz
 239+ 9F82
 240+ 9F82 3E 01            ld a,1                                               ; El .db (Impacto)="1" indica que es altamente probable que esta_
 241+ 9F84 32 0B 8C         ld (Impacto),a                                       ; _ entidad colisione con Amadeus, (ha superado, o está en la fila $14) y
 242+ 9F87
 243+ 9F87 2A 47 8C         ld hl,(Puntero_store_caja)
 244+ 9F8A 2C               inc l
 245+ 9F8B 2C               inc l
 246+ 9F8C 2C               inc l
 247+ 9F8D 2C               inc l
 248+ 9F8E 22 74 8C         ld (Entidad_sospechosa_de_colision),hl               ; En caso de que no exista colisión con Amadeus hemos de poner el .db (Impacto) de la (Entidad_sospechosa_de_colision) a "0" más adelante.
 249+ 9F91
 250+ 9F91 21 73 8C         ld hl,Impacto2                                       ; _ alguna de las columnas_X que ocupa coinciden con las de Amadeus.
 251+ 9F94 CB D6            set 2,(hl)
 252+ 9F96
 253+ 9F96 C9               ret
 254+ 9F97
 255+ 9F97               ; ----- ----- ----- ----- -----
 256+ 9F97
 257+ 9F97 77           Guarda_coordenadas_X ld (hl),a
 258+ 9F98 3C               inc a
 259+ 9F99 2C               inc l
 260+ 9F9A 77               ld (hl),a
 261+ 9F9B 3C               inc a
 262+ 9F9C 2C               inc l
 263+ 9F9D 77               ld (hl),a
 264+ 9F9E 2C               inc l
 265+ 9F9F C9               ret
 266+ 9FA0
 267+ 9FA0 AF           Limpia_Coordenadas_X xor a
 268+ 9FA1 06 06            ld b,6
 269+ 9FA3 21 7B 8C         ld hl,Coordenadas_X_Amadeus
 270+ 9FA6 77           1 ld (hl),a
 271+ 9FA7 23               inc hl
 272+ 9FA8 10 FC            djnz 1B
 273+ 9FAA C9               ret
 274+ 9FAB
 275+ 9FAB              ; ----- ----- ----- ----- -----
 276+ 9FAB
 277+ 9FAB              Compara_coordenadas_X
 278+ 9FAB
 279+ 9FAB DD 21 78 8C      ld ix,Coordenadas_X_Entidad
 280+ 9FAF DD 7E 00         ld a,(ix+0)
 281+ 9FB2 CD C0 9F         call Comparando
 282+ 9FB5 C8               ret z
 283+ 9FB6
 284+ 9FB6 3C               inc a
 285+ 9FB7 CD CF 9F         call Comparando_1
 286+ 9FBA C8               ret z
 287+ 9FBB
 288+ 9FBB 3C               inc a
 289+ 9FBC CD CF 9F         call Comparando_1
 290+ 9FBF C9               ret
 291+ 9FC0
 292+ 9FC0              ; ----- ----- ----- ----- -----
 293+ 9FC0              ;
 294+ 9FC0              ;   4/12/23
 295+ 9FC0              ;
 296+ 9FC0              ;   Sub. de [Compara_coordenadas_X]. Deja de comparar cuando encuentra coincidencia.
 297+ 9FC0
 298+ 9FC0              Comparando
 299+ 9FC0
 300+ 9FC0 DD 2C            inc ixl
 301+ 9FC2 DD 2C            inc ixl
 302+ 9FC4 DD 2C            inc ixl
 303+ 9FC6
 304+ 9FC6 DD 46 00         ld b,(ix+0)
 305+ 9FC9 DD 4E 01         ld c,(ix+1)
 306+ 9FCC DD 56 02         ld d,(ix+2)
 307+ 9FCF
 308+ 9FCF B8           Comparando_1 cp b
 309+ 9FD0 C8               ret z
 310+ 9FD1 B9               cp c
 311+ 9FD2 C8               ret z
 312+ 9FD3 BA               cp d
 313+ 9FD4 C9               ret
 314+ 9FD5
 315+ 9FD5              ; -----------------------------------------------------------------------
 316+ 9FD5              ;
 317+ 9FD5              ;   04/7/24
 318+ 9FD5              ;
 319+ 9FD5
 320+ 9FD5              Detecta_colision_nave_entidad
 321+ 9FD5
 322+ 9FD5              ; Exclusiones:
 323+ 9FD5
 324+ 9FD5              ; Salimos de la rutina si no hay advertencia de posible colisión.
 325+ 9FD5
 326+ 9FD5 21 73 8C     	ld hl,Impacto2
 327+ 9FD8 CB 56        	bit 2,(hl)
 328+ 9FDA C8           	ret z
 329+ 9FDB
 330+ 9FDB              ; Detección byte a byte de colisión ENTIDAD-NAVE.
 331+ 9FDB
 332+ 9FDB 2A C3 89         ld hl,(Pamm_Amadeus)
 333+ 9FDE CD 5A 90         call Extrae_address
 334+ 9FE1 54               ld d,h
 335+ 9FE2 5D               ld e,l                                         ; (Puntero_objeto) en DE.
 336+ 9FE3
 337+ 9FE3 2A C1 89         ld hl,(p.imp.amadeus)                          ; (Puntero_de_impresion) en HL.
 338+ 9FE6 06 10            ld b,16                                        ; Contador de scanlines en B.
 339+ 9FE8 FD 2E 03         ld iyl,3                                       ; Contador de impacto. Si su valor es "0" se considera "Colisión". Esto me permitirá ajustar la sensibilidad de la colisión en Amadeus.
 340+ 9FEB
 341+ 9FEB C5           1 push bc
 342+ 9FEC 06 03            ld b,3
 343+ 9FEE E5               push hl
 344+ 9FEF
 345+ 9FEF              ; .db
 346+ 9FEF
 347+ 9FEF 1A           3 ld a,(de)
 348+ 9FF0 A7               and a
 349+ 9FF1 20 03            jr nz,4F
 350+ 9FF3
 351+ 9FF3 2C               inc l
 352+ 9FF4 18 08            jr 2F                                         ; No aplica CPI, no hay píxels en este .db.
 353+ 9FF6
 354+ 9FF6 ED A1        4 cpi                                             ; Comparamos el 1er .db de los tres de ancho que tiene el sprite de Amadeus.
 355+ 9FF8 28 04            jr z,2F
 356+ 9FFA
 357+ 9FFA              ; Impacto.
 358+ 9FFA FD 2D            dec iyl
 359+ 9FFC 28 22            jr z,5F
 360+ 9FFE
 361+ 9FFE 1C           2 inc e
 362+ 9FFF 10 EE            djnz 3B
 363+ A001
 364+ A001 E1               pop hl
 365+ A002
 366+ A002              ; Hay salto de línea en el puntero de impresión ???
 367+ A002
 368+ A002 7C               ld a,h
 369+ A003 D6 57            sub $57
 370+ A005 20 0A            jr nz,6F
 371+ A007
 372+ A007              ; Comprobamos la parte baja de Amadeus. Modifico manualmente el salto de línea en HL para no haver llamadas a [NextScan].
 373+ A007
 374+ A007 2A C1 89         ld hl,(p.imp.amadeus)
 375+ A00A 3E 20            ld a,$20
 376+ A00C A7               and a
 377+ A00D 85               add l
 378+ A00E 6F               ld l,a
 379+ A00F 18 01            jr 7F
 380+ A011
 381+ A011 24           6 inc h
 382+ A012
 383+ A012 C1           7 pop bc
 384+ A013 10 D6            djnz 1B
 385+ A015
 386+ A015              ;   Fin de la comparativa.
 387+ A015
 388+ A015              ;   NO HAY COLISIÓN !!!!!.
 389+ A015              ;
 390+ A015              ;   .db (Impacto) de Amadeus a "0".
 391+ A015              ;   RES el bit2 de (Impacto2).
 392+ A015              ;
 393+ A015              ;   Nota: El .db (Impacto) de la entidad implicada lo puso a "1" la rutina [Compara_coordenadas_X].
 394+ A015              ;   Lo colocamos a "0".
 395+ A015
 396+ A015 21 73 8C         ld hl,Impacto2
 397+ A018 CB 96            res 2,(hl)
 398+ A01A 2A 74 8C         ld hl,(Entidad_sospechosa_de_colision)
 399+ A01D 36 00            ld (hl),0                                       ; Coloca a "0" el .db (Impacto) de la (Entidad_sospechosa_de_colision).
 400+ A01F C9               ret
 401+ A020
 402+ A020              ;   POSIBLE COLISIÓN !!!!!.
 403+ A020              ;
 404+ A020              ;   .db (Impacto) de Amadeus a "1".
 405+ A020              ;   SET el bit3 de (Impacto2).
 406+ A020              ;
 407+ A020              ;   Nota: El .db (Impacto) de la entidad implicada lo puso a "1" la rutina [Compara_coordenadas_X].
 408+ A020
 409+ A020 E1           5 pop hl
 410+ A021 C1               pop bc
 411+ A022
 412+ A022 21 C0 89         ld hl,Impacto_Amadeus
 413+ A025 36 01            ld (hl),1
 414+ A027 21 73 8C         ld hl,Impacto2                                 ; Cuando se produce Colisión, RES el bit2 de (Impacto2) y_
 415+ A02A CB 96            res 2,(hl)                                     ; _ SET el bit3. El bit3 de (Impacto2) indica que hay contacto_
 416+ A02C
 417+ A02C 11 D0 87         ld de,Indice_Explosion_entidades
 418+ A02F 2A 74 8C         ld hl,(Entidad_sospechosa_de_colision)         ; Situamos el (Puntero_de_almacen_de_mov_masticados) de la entidad impactada en la primera palabra del índice de explosiones.
 419+ A032 2C               inc l
 420+ A033 2C               inc l
 421+ A034 2C               inc l
 422+ A035 73               ld (hl),e
 423+ A036 2C               inc l
 424+ A037 72               ld (hl),d
 425+ A038
 426+ A038              ; Situamos también el (Puntero_de_almacen_de_mov_masticados) de Amadeus en la primero explosión.
 427+ A038
 428+ A038 11 90 88         ld de,Indice_Explosion_Amadeus
 429+ A03B 21 C3 89         ld hl,Pamm_Amadeus
 430+ A03E 73               ld (hl),e
 431+ A03F 2C               inc l
 432+ A040 72               ld (hl),d
 433+ A041
 434+ A041 C9               ret
 435+ A042
 436+ A042
 437+ A042
# file closed: Disparo.asm
2289  A042
2290  A042              	SAVESNA "Pruebas.sna", START
2291  A042
2292  A042
2293  A042
2294  A042
# file closed: Banco_de_pruebas.asm
